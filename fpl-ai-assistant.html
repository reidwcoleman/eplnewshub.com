<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL AI Expert - Fantasy Premier League Assistant</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #38003c 0%, #00ff87 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-container {
            width: 90%;
            max-width: 900px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(56, 0, 60, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #38003c, #00ff87);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .chat-header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .chat-header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .training-panel {
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            padding: 15px 20px;
            display: none;
        }
        
        .training-panel.active {
            display: block;
        }
        
        .training-input {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical;
            outline: none;
        }
        
        .training-input:focus {
            border-color: #38003c;
        }
        
        .training-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #38003c;
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease-in;
        }
        
        .user-message {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background: #6b7280;
        }
        
        .ai-avatar {
            background: linear-gradient(135deg, #38003c, #00ff87);
        }
        
        .message-content {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.6;
        }
        
        .user-message .message-content {
            background: #38003c;
            color: white;
        }
        
        .ai-message .message-content {
            background: white;
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }
        
        .thinking-indicator {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .thinking-content {
            background: #f3f4f6;
            padding: 15px 20px;
            border-radius: 18px;
            color: #6b7280;
            font-style: italic;
            max-width: 70%;
        }
        
        .thinking-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 10px;
        }
        
        .thinking-dots span {
            width: 6px;
            height: 6px;
            background: #38003c;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .chat-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .chat-input:focus {
            border-color: #38003c;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .send-button, .train-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            font-size: 1.2rem;
        }
        
        .send-button {
            background: linear-gradient(135deg, #38003c, #00ff87);
            color: white;
        }
        
        .train-button {
            background: #f59e0b;
            color: white;
        }
        
        .send-button:hover, .train-button:hover {
            transform: scale(1.05);
        }
        
        .send-button:disabled, .train-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-indicator {
            position: absolute;
            top: 15px;
            right: 20px;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-online {
            background: #10b981;
            color: white;
        }
        
        .status-trained {
            background: #f59e0b;
            color: white;
        }
        
        .fpl-stats {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .knowledge-indicator {
            background: #ecfdf5;
            border: 1px solid #d1fae5;
            color: #065f46;
            padding: 8px 12px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 0.85rem;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .chat-container {
                width: 95%;
                height: 95vh;
                border-radius: 15px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .chat-header h1 {
                font-size: 1.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>‚öΩ FPL AI Expert</h1>
            <p>Fantasy Premier League AI Assistant with Custom Training</p>
            <div id="statusIndicator" class="status-indicator status-online">üü¢ Ready</div>
        </div>
        
        <div id="trainingPanel" class="training-panel">
            <h3 style="margin-bottom: 10px; color: #38003c;">üìö Train FPL Knowledge</h3>
            <textarea id="trainingInput" class="training-input" placeholder="Paste FPL data, articles, or information here to train the AI..."></textarea>
            <div class="training-buttons">
                <button onclick="trainAI()" class="btn btn-primary">üß† Train AI</button>
                <button onclick="toggleTraining()" class="btn btn-secondary">‚ùå Cancel</button>
                <button onclick="clearKnowledge()" class="btn btn-secondary">üóëÔ∏è Clear Knowledge</button>
            </div>
        </div>
        
        <div id="chatMessages" class="chat-messages">
            <!-- Messages will be added here -->
        </div>
        
        <div class="chat-input-container">
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="Ask me anything about FPL..." class="chat-input" autocomplete="off">
            </div>
            <div class="action-buttons">
                <button id="trainButton" onclick="toggleTraining()" class="train-button" title="Train AI with FPL data">
                    üìö
                </button>
                <button id="sendButton" onclick="sendMessage()" class="send-button" aria-label="Send Message">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        let isTyping = false;
        let messageCount = 0;
        let fplKnowledge = [];
        let trainingMode = false;
        
        // Initialize chat
        document.addEventListener('DOMContentLoaded', () => {
            loadKnowledge();
            showWelcomeMessage();
            
            // Handle Enter key
            document.getElementById('userInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });
        
        function loadKnowledge() {
            const saved = localStorage.getItem('fplKnowledge');
            if (saved) {
                fplKnowledge = JSON.parse(saved);
                updateKnowledgeStatus();
            }
        }
        
        function saveKnowledge() {
            localStorage.setItem('fplKnowledge', JSON.stringify(fplKnowledge));
            updateKnowledgeStatus();
        }
        
        function updateKnowledgeStatus() {
            const statusEl = document.getElementById('statusIndicator');
            if (fplKnowledge.length > 0) {
                statusEl.textContent = `üìö ${fplKnowledge.length} trained items`;
                statusEl.className = 'status-indicator status-trained';
            } else {
                statusEl.textContent = 'üü¢ Ready to train';
                statusEl.className = 'status-indicator status-online';
            }
        }
        
        function toggleTraining() {
            trainingMode = !trainingMode;
            const panel = document.getElementById('trainingPanel');
            const button = document.getElementById('trainButton');
            
            if (trainingMode) {
                panel.classList.add('active');
                button.style.background = '#ef4444';
                button.title = 'Close training panel';
                document.getElementById('trainingInput').focus();
            } else {
                panel.classList.remove('active');
                button.style.background = '#f59e0b';
                button.title = 'Train AI with FPL data';
            }
        }
        
        function trainAI() {
            const input = document.getElementById('trainingInput');
            const text = input.value.trim();
            
            if (!text) {
                alert('Please enter some FPL data to train on.');
                return;
            }
            
            // Parse and store training data
            const trainingItem = {
                id: Date.now(),
                content: text,
                timestamp: new Date().toISOString(),
                keywords: extractKeywords(text)
            };
            
            fplKnowledge.push(trainingItem);
            saveKnowledge();
            
            // Clear input and close panel
            input.value = '';
            toggleTraining();
            
            // Show confirmation
            displayAIMessage(`‚úÖ **Training complete!** 

I've learned from your FPL data. I now have **${fplKnowledge.length}** pieces of FPL knowledge to help answer your questions.

The information included: ${trainingItem.keywords.slice(0, 5).join(', ')}${trainingItem.keywords.length > 5 ? '...' : ''}

Try asking me something related to this data!`);
        }
        
        function extractKeywords(text) {
            const fplTerms = [
                'haaland', 'salah', 'palmer', 'saka', 'son', 'bruno', 'kdb', 'watkins', 'isak', 'nunez',
                'captain', 'transfer', 'wildcard', 'free hit', 'bench boost', 'triple captain',
                'gameweek', 'fixture', 'form', 'price', 'ownership', 'differential', 'template',
                'defender', 'midfielder', 'forward', 'goalkeeper', 'premium', 'budget',
                'rotation', 'injury', 'suspension', 'yellow', 'red card', 'clean sheet',
                'goal', 'assist', 'bonus', 'save', 'penalty', 'corners', 'crosses'
            ];
            
            const words = text.toLowerCase().split(/\W+/);
            const keywords = [];
            
            for (const term of fplTerms) {
                if (words.some(word => word.includes(term) || term.includes(word))) {
                    keywords.push(term);
                }
            }
            
            // Add any capitalized words (likely player names)
            const caps = text.match(/\b[A-Z][a-z]+\b/g) || [];
            keywords.push(...caps.slice(0, 10));
            
            return [...new Set(keywords)];
        }
        
        function clearKnowledge() {
            if (confirm('Are you sure you want to clear all FPL training data?')) {
                fplKnowledge = [];
                saveKnowledge();
                toggleTraining();
                displayAIMessage('üóëÔ∏è **Knowledge cleared.** All training data has been removed. You can train me with new FPL information using the training panel.');
            }
        }
        
        function showWelcomeMessage() {
            setTimeout(() => {
                const knowledgeCount = fplKnowledge.length;
                const message = `‚öΩ **Welcome to your FPL AI Expert!**

I'm a Fantasy Premier League specialist powered by **Llama AI** that you can train with your own data. I can help with:

‚Ä¢ **Player Analysis** - Form, fixtures, differentials
‚Ä¢ **Transfer Strategy** - When to buy/sell, price predictions  
‚Ä¢ **Captain Picks** - EO analysis, fixture difficulty
‚Ä¢ **Chip Strategy** - Wildcard, Free Hit, Bench Boost timing
‚Ä¢ **Team Building** - Template vs differential approaches
‚Ä¢ **Gameweek Planning** - Short and long-term strategy

ü¶ô **Powered by:** Llama AI (Hugging Face & Replicate APIs)
üìö **Current Knowledge:** ${knowledgeCount > 0 ? `${knowledgeCount} trained items` : 'Ready for training'}
üéØ **Specialized in:** FPL strategy and analysis
‚ö° **Trainable:** Use the üìö button to teach me new FPL data

${knowledgeCount === 0 ? 
'**Get started:** Click the üìö button to train me with FPL articles, stats, or insights!' : 
'What FPL question can I help you with?'}`;
                
                displayAIMessage(message);
            }, 500);
        }
        
        async function sendMessage() {
            if (isTyping) return;
            
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Rate limiting
            if (messageCount >= 20) {
                displayErrorMessage('Rate limit reached. Please refresh the page to continue.');
                return;
            }
            
            messageCount++;
            
            // Display user message
            displayUserMessage(message);
            
            // Clear input
            input.value = '';
            
            // Disable send button
            toggleSendButton(false);
            
            // Show thinking and get AI response
            await getFPLResponse(message);
            
            // Re-enable send button
            toggleSendButton(true);
        }
        
        function displayUserMessage(message) {
            const messagesDiv = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message user-message';
            msgDiv.innerHTML = `
                <div class="message-content">${escapeHtml(message)}</div>
                <div class="message-avatar user-avatar">üë§</div>
            `;
            messagesDiv.appendChild(msgDiv);
            scrollToBottom();
        }
        
        function displayAIMessage(message) {
            const messagesDiv = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ai-message';
            
            msgDiv.innerHTML = `
                <div class="message-avatar ai-avatar">‚öΩ</div>
                <div class="message-content">${formatMessage(message)}</div>
            `;
            messagesDiv.appendChild(msgDiv);
            scrollToBottom();
        }
        
        function displayErrorMessage(errorText) {
            const messagesDiv = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = errorText;
            messagesDiv.appendChild(errorDiv);
            scrollToBottom();
        }
        
        async function getFPLResponse(message) {
            // Show thinking indicator
            showThinking();
            
            try {
                // Get real Llama AI response with FPL expertise and training context
                const response = await queryLlamaAI(message);
                
                // Remove thinking indicator
                removeThinking();
                
                // Display response
                displayAIMessage(response);
                
            } catch (error) {
                console.error('Llama AI error:', error);
                removeThinking();
                displayAIMessage('Sorry, I encountered an error with the Llama AI service. Please try again in a moment.');
            }
        }
        
        async function queryLlamaAI(query) {
            try {
                // Build context from training data
                const relevantKnowledge = findRelevantKnowledge(query);
                const trainingContext = relevantKnowledge.map(item => item.content).join('\n\n');
                
                // Build comprehensive FPL system prompt with training data
                const systemPrompt = `You are an expert Fantasy Premier League (FPL) AI assistant powered by Llama. You have deep knowledge of:

- Player statistics, form, and performance analysis
- Transfer strategy and timing
- Captain selection and effective ownership
- Chip usage (Wildcard, Free Hit, Bench Boost, Triple Captain)
- Gameweek planning and fixture analysis
- Price changes and market dynamics
- Team building and squad structure

${trainingContext ? `CUSTOM TRAINING DATA:
${trainingContext}

Use this training data to provide more specific and personalized advice.` : ''}

Provide expert FPL advice that is:
- Specific and actionable
- Data-driven when possible
- Concise but comprehensive
- Helpful for FPL strategy

User question: ${query}

FPL Expert Response:`;

                // Try Hugging Face Inference API first (free tier available)
                try {
                    const response = await fetch('https://api-inference.huggingface.co/models/meta-llama/Llama-2-7b-chat-hf', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer YOUR_HF_TOKEN', // User would need to add their token
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            inputs: systemPrompt,
                            parameters: {
                                max_new_tokens: 400,
                                temperature: 0.7,
                                top_p: 0.9,
                                do_sample: true
                            }
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data[0] && data[0].generated_text) {
                            const fullResponse = data[0].generated_text;
                            // Extract only the new response after our prompt
                            const aiResponse = fullResponse.replace(systemPrompt, '').trim();
                            if (aiResponse.length > 50) {
                                return aiResponse;
                            }
                        }
                    }
                } catch (error) {
                    console.log('Hugging Face API failed:', error.message);
                }
                
                // Fallback to Replicate API (also supports Llama)
                try {
                    const response = await fetch('https://api.replicate.com/v1/predictions', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Token YOUR_REPLICATE_TOKEN', // User would need to add their token
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            version: "meta/llama-2-7b-chat",
                            input: {
                                prompt: systemPrompt,
                                max_new_tokens: 400,
                                temperature: 0.7
                            }
                        })
                    });
                    
                    if (response.ok) {
                        const prediction = await response.json();
                        // Poll for completion (simplified for demo)
                        const result = await pollReplicateResult(prediction.id);
                        if (result && result.output) {
                            return result.output.join('');
                        }
                    }
                } catch (error) {
                    console.log('Replicate API failed:', error.message);
                }
                
                // Final fallback: Simulate Llama-style response with training data integration
                console.log('Using Llama-style fallback with training data');
                return generateLlamaStyleResponse(query, relevantKnowledge);
                
            } catch (error) {
                console.error('All Llama services failed:', error);
                return generateLlamaStyleResponse(query, []);
            }
        }
        
        async function pollReplicateResult(predictionId) {
            // Simplified polling - in production you'd want proper polling with delays
            try {
                const response = await fetch(`https://api.replicate.com/v1/predictions/${predictionId}`, {
                    headers: {
                        'Authorization': 'Token YOUR_REPLICATE_TOKEN'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'succeeded') {
                        return data;
                    }
                }
            } catch (error) {
                console.log('Polling failed:', error);
            }
            return null;
        }
        
        function generateLlamaStyleResponse(query, knowledge) {
            const lowerQuery = query.toLowerCase();
            
            // Start with Llama-style greeting
            let response = "As your FPL AI assistant powered by Llama, let me analyze your question:\n\n";
            
            // Add training data context if available
            if (knowledge.length > 0) {
                response += "üìö **Based on your training data:**\n";
                const bestMatch = knowledge[0];
                response += `${bestMatch.content.substring(0, 200)}...\n\n`;
                response += "**My Llama AI analysis:**\n";
            }
            
            // Generate contextual FPL advice
            if (lowerQuery.includes('captain') || lowerQuery.includes('(c)')) {
                response += "For captaincy decisions, I recommend analyzing:\n\n";
                response += "‚Ä¢ **Fixture difficulty** - Target teams playing weaker opponents\n";
                response += "‚Ä¢ **Recent form** - Players with consistent returns over last 3-5 games\n";
                response += "‚Ä¢ **Effective ownership** - Balance between safe and differential picks\n";
                response += "‚Ä¢ **Minutes certainty** - Avoid rotation risks during busy periods\n\n";
                response += "Current top options typically include Haaland (vs weak defenses), Salah (consistent performer), and Palmer (form-dependent).";
                
            } else if (lowerQuery.includes('transfer') || lowerQuery.includes('buy') || lowerQuery.includes('sell')) {
                response += "For transfer strategy, consider these principles:\n\n";
                response += "‚Ä¢ **Form over fixtures** - Prioritize in-form players over easy matchups\n";
                response += "‚Ä¢ **Price trajectory** - Buy before rises, sell before drops\n";
                response += "‚Ä¢ **Fixture runs** - Plan transfers 3-4 gameweeks ahead\n";
                response += "‚Ä¢ **Team needs** - Maintain balanced squad structure\n\n";
                response += "Always use your free transfer first, and only take hits for urgent moves or excellent opportunities.";
                
            } else if (lowerQuery.includes('wildcard') || lowerQuery.includes('free hit') || lowerQuery.includes('chip')) {
                response += "Chip strategy should be planned strategically:\n\n";
                response += "‚Ä¢ **Wildcard** - International breaks or when 4+ transfers needed\n";
                response += "‚Ä¢ **Free Hit** - Blank gameweeks or when most team can't play\n";
                response += "‚Ä¢ **Bench Boost** - Double gameweeks with strong 15-man squad\n";
                response += "‚Ä¢ **Triple Captain** - Double gameweeks with safe, high-scoring pick\n\n";
                response += "Timing is crucial - don't waste chips on reactive decisions.";
                
            } else if (containsPlayerName(lowerQuery)) {
                const playerName = extractPlayerName(query);
                response += `Analyzing ${playerName} for FPL consideration:\n\n`;
                response += "‚Ä¢ **Recent form** - Goals, assists, and bonus points trends\n";
                response += "‚Ä¢ **Underlying stats** - xG, xA, shots, key passes per game\n";
                response += "‚Ä¢ **Fixture analysis** - Upcoming opponent difficulty ratings\n";
                response += "‚Ä¢ **Price trends** - Current ownership and potential changes\n";
                response += "‚Ä¢ **Injury status** - Fitness and rotation risk assessment\n\n";
                response += `Without current data, I'd recommend checking ${playerName}'s last 5 gameweek performance and upcoming fixtures.`;
                
            } else if (lowerQuery.includes('gameweek') || lowerQuery.includes('gw')) {
                response += "For gameweek planning, focus on:\n\n";
                response += "‚Ä¢ **Fixture analysis** - Identify favorable matchups\n";
                response += "‚Ä¢ **Team news** - Monitor press conferences and training updates\n";
                response += "‚Ä¢ **Price changes** - Time transfers around predicted rises/falls\n";
                response += "‚Ä¢ **Captain options** - Shortlist 2-3 viable choices\n";
                response += "‚Ä¢ **Differentials** - Consider low-owned players with good fixtures\n\n";
                response += "Plan transfers early in the week but finalize team selection close to deadline.";
                
            } else {
                response += "Here are key FPL principles I recommend:\n\n";
                response += "‚Ä¢ **Follow form** - Recent performance often continues short-term\n";
                response += "‚Ä¢ **Plan ahead** - Think 3-4 gameweeks when making decisions\n";
                response += "‚Ä¢ **Stay patient** - Avoid knee-jerk reactions to single bad weeks\n";
                response += "‚Ä¢ **Monitor underlying stats** - xG, xA, shots, key passes\n";
                response += "‚Ä¢ **Balance template vs differential** - Mix safe and unique picks\n\n";
                response += "Would you like me to analyze anything more specific about your FPL strategy?";
            }
            
            if (knowledge.length === 0) {
                response += "\n\nüí° **Tip:** Train me with FPL articles, player stats, or expert analysis using the üìö button for more personalized Llama AI responses!";
            }
            
            return response;
        }
        
        
        function findRelevantKnowledge(query) {
            const queryWords = query.toLowerCase().split(/\W+/);
            const relevant = [];
            
            for (const item of fplKnowledge) {
                let score = 0;
                const content = item.content.toLowerCase();
                
                // Score based on keyword matches
                for (const keyword of item.keywords) {
                    if (queryWords.some(word => word.includes(keyword.toLowerCase()) || keyword.toLowerCase().includes(word))) {
                        score += 10;
                    }
                }
                
                // Score based on direct content matches
                for (const word of queryWords) {
                    if (word.length > 3 && content.includes(word)) {
                        score += 5;
                    }
                }
                
                if (score > 0) {
                    relevant.push({ ...item, score });
                }
            }
            
            return relevant.sort((a, b) => b.score - a.score).slice(0, 3);
        }
        
        
        function containsPlayerName(query) {
            const commonPlayers = [
                'haaland', 'salah', 'palmer', 'saka', 'son', 'bruno', 'kdb', 'de bruyne',
                'watkins', 'isak', 'nunez', 'diaz', 'jota', 'rashford', 'fernandes',
                'bowen', 'paqueta', 'gordon', 'barnes', 'wissa', 'solanke'
            ];
            return commonPlayers.some(player => query.includes(player));
        }
        
        function extractPlayerName(query) {
            const words = query.split(' ');
            const capitalized = words.find(word => /^[A-Z][a-z]+$/.test(word));
            return capitalized || 'this player';
        }
        
        function showThinking() {
            isTyping = true;
            const messagesDiv = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'thinking-indicator';
            thinkingDiv.id = 'thinkingIndicator';
            
            const thoughts = [
                "‚öΩ Analyzing FPL data...",
                "üß† Processing your FPL question...",
                "üìä Consulting training knowledge...",
                "üéØ Generating expert advice...",
                "üìà Reviewing player stats...",
                "üîç Checking fixture data..."
            ];
            const thought = thoughts[Math.floor(Math.random() * thoughts.length)];
            
            thinkingDiv.innerHTML = `
                <div class="message-avatar ai-avatar">‚öΩ</div>
                <div class="thinking-content">
                    ${thought}
                    <div class="thinking-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            messagesDiv.appendChild(thinkingDiv);
            scrollToBottom();
        }
        
        function removeThinking() {
            const indicator = document.getElementById('thinkingIndicator');
            if (indicator) {
                indicator.remove();
            }
            isTyping = false;
        }
        
        function toggleSendButton(enabled) {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = !enabled;
        }
        
        function formatMessage(message) {
            return message
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">$1</code>')
                .replace(/‚Ä¢ /g, '‚Ä¢ ');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function scrollToBottom() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Add example FPL questions
        function addFPLExamples() {
            setTimeout(() => {
                const examples = [
                    "Who should I captain this week?",
                    "Is Haaland worth his price?",
                    "When should I use my wildcard?",
                    "Best defender under 5m?"
                ];
                
                const messagesDiv = document.getElementById('chatMessages');
                const exampleDiv = document.createElement('div');
                exampleDiv.className = 'message ai-message';
                exampleDiv.innerHTML = `
                    <div class="message-avatar ai-avatar">üí°</div>
                    <div class="message-content">
                        <p><strong>Try these FPL questions:</strong></p>
                        <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
                            ${examples.map(ex => `
                                <button onclick="askExample('${ex}')" style="
                                    background: #f0fdf4; 
                                    border: 1px solid #bbf7d0; 
                                    border-radius: 20px; 
                                    padding: 8px 16px; 
                                    font-size: 0.9rem; 
                                    cursor: pointer;
                                    transition: all 0.2s;
                                    color: #166534;
                                " onmouseover="this.style.background='#dcfce7'" onmouseout="this.style.background='#f0fdf4'">
                                    ${ex}
                                </button>
                            `).join('')}
                        </div>
                        <p style="margin-top: 15px; font-size: 0.9rem; color: #6b7280;">
                            üí° <strong>Pro tip:</strong> Use the üìö button to train me with FPL articles, player stats, or expert analysis for more personalized advice!
                        </p>
                    </div>
                `;
                messagesDiv.appendChild(exampleDiv);
                scrollToBottom();
            }, 2000);
        }
        
        function askExample(question) {
            document.getElementById('userInput').value = question;
            sendMessage();
        }
        
        // Add FPL examples after welcome
        setTimeout(addFPLExamples, 1000);
    </script>
</body>
</html>