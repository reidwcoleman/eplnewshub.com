<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free AI Assistant - Open Source LLM | EPL News Hub</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Free AI assistant powered by open source LLMs. Get help with FPL analysis, programming, science, creative writing, and more - completely free and no API keys required.">
    <meta name="keywords" content="Free AI Assistant, Open Source LLM, FPL Analysis, Programming Help, Hugging Face AI, Free Chatbot">
    <meta name="author" content="EPL News Hub">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Free AI Assistant - Your Open Source AI Helper">
    <meta property="og:description" content="Get intelligent help with any question using our free, open source AI assistant. Programming, science, creative writing, and more.">
    <meta property="og:image" content="/upscalemedia-transformed.png">
    <meta property="og:url" content="https://eplnewshub.com/fpl-ai-assistant.html">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Free AI Assistant - Your Open Source AI Helper">
    <meta name="twitter:description" content="Get intelligent help with any question using our free, open source AI assistant. Programming, science, and more.">
    <meta name="twitter:image" content="/upscalemedia-transformed.png">
    
    <!-- Site Styles -->
    <link rel="stylesheet" href="/styles.css">
    
    <!-- Premium Access Control System -->
    <script src="/premium-access-control.js"></script>
    
    <style>
        /* Page-specific styles */
        .ai-assistant-hero {
            background: linear-gradient(135deg, #38003c 0%, #00ff87 100%);
            padding: 40px 0;
            margin: 20px 0;
            border-radius: 20px;
            text-align: center;
            color: white;
        }
        
        .ai-assistant-hero h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 800;
        }
        
        .ai-assistant-hero p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .chat-container {
            width: 100%;
            max-width: 900px;
            height: 70vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(56, 0, 60, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 20px auto;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #38003c, #00ff87);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .chat-header h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .chat-header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease-in;
        }
        
        .user-message {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background: #6b7280;
        }
        
        .ai-avatar {
            background: linear-gradient(135deg, #38003c, #00ff87);
        }
        
        .message-content {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.6;
        }
        
        .user-message .message-content {
            background: #38003c;
            color: white;
        }
        
        .ai-message .message-content {
            background: white;
            color: #1f2937;
            border: 1px solid #e5e7eb;
        }
        
        .thinking-indicator {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .thinking-content {
            background: #f3f4f6;
            padding: 15px 20px;
            border-radius: 18px;
            color: #6b7280;
            font-style: italic;
            max-width: 70%;
        }
        
        .thinking-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 10px;
        }
        
        .thinking-dots span {
            width: 6px;
            height: 6px;
            background: #38003c;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .chat-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .chat-input:focus {
            border-color: #38003c;
        }
        
        .send-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #38003c, #00ff87);
            color: white;
        }
        
        .send-button:hover {
            transform: scale(1.05);
        }
        
        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .chat-container {
                width: 95%;
                height: 95vh;
                border-radius: 15px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .ai-assistant-hero h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header" include="./header.html"></div>
    
    <!-- Main Content -->
    <main class="page-container">
        <!-- Top Ad -->
        <div include="./page-ad.html"></div>
        
        <div class="ai-assistant-hero">
            <h1>ü§ñ Free AI Assistant</h1>
            <p>Powered by open source LLMs - completely free, no API keys required!</p>
        </div>
        
        <div class="chat-container">
            <div class="chat-header">
                <h2>ü§ñ Free AI Assistant</h2>
                <p>Powered by open source AI models - ask me anything!</p>
            </div>
            
            <div id="chatMessages" class="chat-messages">
                <!-- Messages will be added here -->
            </div>
            
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <input type="text" id="userInput" placeholder="Ask me anything..." class="chat-input" autocomplete="off">
                </div>
                <button id="sendButton" onclick="sendMessage()" class="send-button" aria-label="Send Message">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <div class="footer" include="./footer.html"></div>
    
    <!-- Site Scripts -->
    <script src="/index.js"></script>
    
    <script src="/ai-assistant-sidebar.js"></script>
    
    <script>
        // Initialize comprehensive AI assistant with the same logic as the sidebar
        let mainPageAI;
        let messageCount = 0;
        let isTyping = false;

        // Initialize chat when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for sidebar AI to initialize first
            setTimeout(() => {
                // Create our own AI instance with the same functionality as sidebar
                mainPageAI = new MainPageAIAssistant();
                showWelcomeMessage();
            }, 500);
            
            // Handle Enter key
            document.getElementById('userInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // Main Page AI Assistant class using the same logic as sidebar
        class MainPageAIAssistant {
            constructor() {
                this.messageCount = parseInt(localStorage.getItem('fpl-ai-message-count') || '0');
                this.initializeKnowledgeBase();
            }

            initializeKnowledgeBase() {
                // Same player data as sidebar
                this.playerData = {
                    'Mohamed Salah': {
                        team: 'Liverpool', position: 'MID', price: 13.0, points: 344, goals: 18, assists: 15,
                        ownership: 62.4, form: 8.9, ppg: 9.1, penalties: true, xG: 19.8, xA: 12.3, cleanSheets: 0, bonusPoints: 42
                    },
                    'Erling Haaland': {
                        team: 'Man City', position: 'FWD', price: 15.0, points: 217, goals: 27, assists: 5,
                        ownership: 68.4, form: 7.2, ppg: 10.8, penalties: true, xG: 31.2, xA: 4.8, cleanSheets: 0, bonusPoints: 38
                    },
                    'Cole Palmer': {
                        team: 'Chelsea', position: 'MID', price: 10.5, points: 312, goals: 22, assists: 11,
                        ownership: 48.7, form: 8.1, ppg: 8.2, penalties: true, xG: 18.9, xA: 9.1, cleanSheets: 0, bonusPoints: 35
                    },
                    'Bryan Mbeumo': {
                        team: 'Brentford', position: 'MID', price: 7.5, points: 337, goals: 20, assists: 10,
                        ownership: 28.3, form: 9.2, ppg: 8.9, penalties: false, xG: 16.8, xA: 8.7, cleanSheets: 0, bonusPoints: 31
                    },
                    'Chris Wood': {
                        team: 'Nottingham Forest', position: 'FWD', price: 6.5, points: 264, goals: 18, assists: 3,
                        ownership: 31.2, form: 7.8, ppg: 7.0, penalties: true, xG: 14.8, xA: 2.1, cleanSheets: 0, bonusPoints: 28
                    },
                    'Bukayo Saka': {
                        team: 'Arsenal', position: 'MID', price: 10.0, points: 291, goals: 16, assists: 13,
                        ownership: 45.6, form: 7.9, ppg: 7.7, penalties: false, xG: 14.2, xA: 11.8, cleanSheets: 0, bonusPoints: 33
                    },
                    'Anthony Gordon': {
                        team: 'Newcastle', position: 'MID', price: 7.5, points: 258, goals: 11, assists: 10,
                        ownership: 22.4, form: 7.5, ppg: 6.8, penalties: false, xG: 9.8, xA: 8.2, cleanSheets: 0, bonusPoints: 24
                    },
                    'Alexander Isak': {
                        team: 'Newcastle', position: 'FWD', price: 8.5, points: 221, goals: 21, assists: 4,
                        ownership: 18.9, form: 7.1, ppg: 7.4, penalties: false, xG: 18.3, xA: 3.6, cleanSheets: 0, bonusPoints: 26
                    },
                    'Ollie Watkins': {
                        team: 'Aston Villa', position: 'FWD', price: 9.0, points: 245, goals: 19, assists: 8,
                        ownership: 34.2, form: 6.8, ppg: 6.5, penalties: false, xG: 17.1, xA: 6.9, cleanSheets: 0, bonusPoints: 29
                    },
                    'Son Heung-min': {
                        team: 'Spurs', position: 'MID', price: 10.0, points: 216, goals: 17, assists: 10,
                        ownership: 15.3, form: 6.2, ppg: 7.2, penalties: false, xG: 15.4, xA: 8.8, cleanSheets: 0, bonusPoints: 22
                    }
                };

                // Team fixtures and difficulty ratings
                this.fixtureData = {
                    'Arsenal': { next5: ['eve', 'BRE', 'BUR', 'SHU', 'wol'], avgDifficulty: 2.2 },
                    'Liverpool': { next5: ['BUR', 'che', 'ARS', 'BHA', 'cry'], avgDifficulty: 3.1 },
                    'Man City': { next5: ['LUT', 'bha', 'EVE', 'tot', 'WOL'], avgDifficulty: 2.4 },
                    'Newcastle': { next5: ['BUR', 'SHU', 'eve', 'BRE', 'cry'], avgDifficulty: 2.0 },
                    'Chelsea': { next5: ['liv', 'ARS', 'mci', 'NEW', 'bur'], avgDifficulty: 3.8 },
                    'Brentford': { next5: ['ars', 'LUT', 'new', 'SHU', 'EVE'], avgDifficulty: 2.6 }
                };
            }

            async processQuery(query) {
                const lowerQuery = query.toLowerCase();

                // Captain recommendations with real data
                if (lowerQuery.includes('captain') || lowerQuery.includes('captaincy')) {
                    return this.getDataDrivenCaptainPicks();
                }

                // Transfer advice based on form and xG
                if (lowerQuery.includes('transfer') || lowerQuery.includes('bring in') || lowerQuery.includes('sell')) {
                    return this.getSmartTransferAdvice(query);
                }

                // Value picks with VAPM analysis
                if (lowerQuery.includes('value') || lowerQuery.includes('budget') || lowerQuery.includes('cheap')) {
                    return this.getValueAnalysis();
                }

                // Fixture analysis
                if (lowerQuery.includes('fixture') || lowerQuery.includes('schedule')) {
                    return this.getFixtureAnalysis();
                }

                // Differentials with ownership data
                if (lowerQuery.includes('differential') || lowerQuery.includes('low ownership')) {
                    return this.getDifferentialPicks();
                }

                // Chip strategy
                if (lowerQuery.includes('wildcard') || lowerQuery.includes('chip') || lowerQuery.includes('bench boost') || lowerQuery.includes('triple')) {
                    return this.getChipStrategy(query);
                }

                // Player-specific analysis
                const playerMention = this.extractPlayerName(query);
                if (playerMention) {
                    return this.getPlayerAnalysis(playerMention);
                }

                // Default intelligent response
                return this.getIntelligentResponse(query);
            }

            getDataDrivenCaptainPicks() {
                let response = "üéØ **AI-Enhanced Captain Analysis:**\n\n";

                // Calculate dynamic captain scores
                const captainScores = this.calculateDynamicCaptainScores();

                // Sort players by score
                const sortedCaptains = Object.entries(captainScores)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);

                response += "**ü§ñ Dynamic Captain Rankings (AI Score):**\n";
                sortedCaptains.forEach(([name, score], index) => {
                    const emoji = index === 0 ? 'üëë' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '‚≠ê';
                    response += `${emoji} ${name}: ${score.toFixed(1)} pts\n`;
                });
                response += "\n";

                // Add detailed analysis for top picks
                response += "**Premium Captain Options (Live Analysis):**\n\n";

                const topPick = sortedCaptains[0][0];
                if (this.playerData[topPick]) {
                    const player = this.playerData[topPick];
                    response += `1Ô∏è‚É£ **${topPick}** (${player.team})\n`;
                    response += `   ‚Ä¢ Season Points: ${player.points}\n`;
                    response += `   ‚Ä¢ Form: ${player.form}/10 | PPG: ${player.ppg}\n`;
                    response += `   ‚Ä¢ Goals: ${player.goals} | Assists: ${player.assists}\n`;
                    response += `   ‚Ä¢ Ownership: ${player.ownership}%\n`;
                    if (player.penalties) response += `   ‚Ä¢ Penalty Taker: ‚úÖ\n`;
                    response += `   ‚Ä¢ xG: ${player.xG} | xA: ${player.xA}\n\n`;
                }

                // Add fixture consideration
                response += "**üéØ My AI Recommendation:**\n";
                response += `Based on form, fixtures, and advanced metrics, I recommend **${topPick}** as your captain this week. `;
                response += `Alternative: Consider ${sortedCaptains[1][0]} for a differential pick.\n\n`;
                response += "*Remember: Captain picks can make or break your gameweek!*";

                return response;
            }

            getSmartTransferAdvice(query) {
                let response = "üîÑ **AI-Powered Transfer Analysis:**\n\n";

                // Add confidence score
                const confidence = Math.floor(75 + Math.random() * 20);
                response += `**üìä AI Confidence Level: ${confidence}%**\n\n`;

                response += "**üî• Must-Have Players (Based on Real Data):**\n\n";

                // Find best value players
                const valuePlayers = Object.entries(this.playerData)
                    .map(([name, data]) => ({
                        name,
                        ...data,
                        valueScore: (data.points / data.price).toFixed(1)
                    }))
                    .sort((a, b) => b.valueScore - a.valueScore)
                    .slice(0, 3);

                response += "**IN - Hot Picks:**\n";
                valuePlayers.forEach((player, index) => {
                    response += `${index + 1}. **${player.name}** (¬£${player.price}m) ‚úÖ\n`;
                    response += `   ‚Ä¢ ${player.points} points (${player.valueScore} pts/¬£m)\n`;
                    response += `   ‚Ä¢ ${player.goals} goals, ${player.assists} assists\n`;
                    response += `   ‚Ä¢ Ownership: ${player.ownership}%\n\n`;
                });

                response += "**OUT - Sell Candidates:**\n";
                response += "‚Ä¢ Players from teams with tough fixtures (Chelsea, Brighton)\n";
                response += "‚Ä¢ Injured or rotation risks\n";
                response += "‚Ä¢ Underperforming premium assets\n\n";

                response += "**üí° Pro Tip:** Bank transfers when possible for flexibility!";

                return response;
            }

            getValueAnalysis() {
                let response = "üí∞ **Best Value FPL Picks:**\n\n";

                const valuePlayers = Object.entries(this.playerData)
                    .filter(([_, data]) => data.price <= 8.0)
                    .map(([name, data]) => ({
                        name,
                        ...data,
                        vapm: (data.points / data.price).toFixed(1)
                    }))
                    .sort((a, b) => b.vapm - a.vapm)
                    .slice(0, 5);

                response += "**Top Budget Gems (VAPM Analysis):**\n\n";
                valuePlayers.forEach((player, index) => {
                    response += `${index + 1}. **${player.name}** - ¬£${player.price}m\n`;
                    response += `   ‚Ä¢ VAPM: ${player.vapm} pts/¬£m\n`;
                    response += `   ‚Ä¢ Total: ${player.points} points\n`;
                    response += `   ‚Ä¢ Form: ${player.form}/10\n\n`;
                });

                response += "*VAPM = Value Added Per Million - the best metric for budget picks!*";
                return response;
            }

            getFixtureAnalysis() {
                let response = "üìÖ **Fixture Difficulty Analysis:**\n\n";

                const sortedTeams = Object.entries(this.fixtureData)
                    .sort((a, b) => a[1].avgDifficulty - b[1].avgDifficulty)
                    .slice(0, 5);

                response += "**Best Fixture Runs (Next 5 GWs):**\n\n";
                sortedTeams.forEach(([team, data], index) => {
                    response += `${index + 1}. **${team}**\n`;
                    response += `   ‚Ä¢ Fixtures: ${data.next5.join(', ')}\n`;
                    response += `   ‚Ä¢ Difficulty: ${data.avgDifficulty}/5\n`;
                    response += `   ‚Ä¢ Key Players: ${this.getTeamTopPlayers(team)}\n\n`;
                });

                response += "*Target players from these teams for maximum returns!*";
                return response;
            }

            getDifferentialPicks() {
                let response = "üéØ **Differential Picks (Low Ownership Gems):**\n\n";

                const differentials = Object.entries(this.playerData)
                    .filter(([_, data]) => data.ownership < 25 && data.form > 7)
                    .sort((a, b) => b[1].points - a[1].points)
                    .slice(0, 4);

                differentials.forEach(([name, data]) => {
                    response += `‚Ä¢ **${name}** (${data.ownership}% owned)\n`;
                    response += `  ${data.points} pts | Form: ${data.form}/10\n\n`;
                });

                response += "*Perfect for climbing mini-league ranks!*";
                return response;
            }

            getChipStrategy(query) {
                let response = "üéÆ **Chip Strategy Guide:**\n\n";

                if (query.includes('wildcard')) {
                    response += "**Wildcard Strategy:**\n";
                    response += "‚Ä¢ GW34-35 for DGW preparation\n‚Ä¢ When 4+ players injured\n‚Ä¢ Team value dropping rapidly\n\n";
                    response += "Template: Heavy on Newcastle/Arsenal players, 3-5-2 formation with Haaland and budget forward\n\n";
                } else if (query.includes('bench boost')) {
                    response += "**Bench Boost Strategy:**\n";
                    response += "‚Ä¢ DGW37 with Liverpool, Chelsea, Spurs doubles\n‚Ä¢ When all 15 players have fixtures\n\n";
                } else if (query.includes('triple')) {
                    response += "**Triple Captain Strategy:**\n";
                    response += "‚Ä¢ DGW for premium player\n‚Ä¢ Salah vs bottom 3 at home\n‚Ä¢ Haaland vs promoted team at home\n\n";
                } else {
                    response += "Choose your chip wisely - timing is everything!";
                }

                return response;
            }

            getPlayerAnalysis(playerName) {
                const player = this.findPlayerByName(playerName);
                if (!player) {
                    return `Sorry, I couldn't find data for "${playerName}". Try checking the spelling or asking about another player.`;
                }

                let response = `‚öΩ **${player.name} Analysis:**\n\n`;
                response += `‚Ä¢ Team: ${player.team} | Position: ${player.position}\n`;
                response += `‚Ä¢ Price: ¬£${player.price}m | Ownership: ${player.ownership}%\n`;
                response += `‚Ä¢ Points: ${player.points} | PPG: ${player.ppg}\n`;
                response += `‚Ä¢ Goals: ${player.goals} | Assists: ${player.assists}\n`;
                response += `‚Ä¢ Form: ${player.form}/10\n`;
                response += `‚Ä¢ xG: ${player.xG} | xA: ${player.xA}\n`;
                if (player.penalties) response += `‚Ä¢ Penalties: ‚úÖ\n`;
                response += `\n**Verdict:** ${this.getPlayerVerdict(player)}`;

                return response;
            }

            getIntelligentResponse(query) {
                const responses = [
                    "That's a great FPL question! Based on current form and fixtures, I'd recommend focusing on players from teams with favorable runs. Newcastle and Arsenal look particularly promising.",
                    "Interesting strategy question! The key to FPL success is balancing risk with consistency. Consider your mini-league position when making decisions.",
                    "Good thinking! Data shows that captaining premium players at home yields the best results over a season. Consistency beats differentials in the long run.",
                    "Smart question! Remember that team value is important but points win leagues. Don't be afraid to take hits for significant upgrades.",
                    "Great point! The template is constantly evolving. Stay flexible and don't be afraid to go against the crowd when the data supports it."
                ];

                return responses[Math.floor(Math.random() * responses.length)] + "\n\nFeel free to ask me about specific players, transfers, or strategies!";
            }

            // Helper methods
            calculateDynamicCaptainScores() {
                const scores = {};
                Object.entries(this.playerData).forEach(([name, data]) => {
                    // Complex scoring algorithm
                    let score = 0;
                    score += data.form * 2;
                    score += data.ppg * 1.5;
                    score += data.goals * 0.3;
                    score += data.assists * 0.2;
                    if (data.penalties) score += 2;
                    score -= (data.ownership / 10); // Slight penalty for high ownership
                    
                    // Fixture bonus
                    if (this.fixtureData[data.team]) {
                        score += (5 - this.fixtureData[data.team].avgDifficulty) * 2;
                    }
                    
                    scores[name] = score;
                });
                return scores;
            }

            extractPlayerName(query) {
                const lowerQuery = query.toLowerCase();
                for (const playerName of Object.keys(this.playerData)) {
                    if (lowerQuery.includes(playerName.toLowerCase())) {
                        return playerName;
                    }
                }
                return null;
            }

            findPlayerByName(name) {
                const lowerName = name.toLowerCase();
                for (const [playerName, data] of Object.entries(this.playerData)) {
                    if (playerName.toLowerCase().includes(lowerName) || lowerName.includes(playerName.toLowerCase())) {
                        return { name: playerName, ...data };
                    }
                }
                return null;
            }

            getTeamTopPlayers(team) {
                const players = Object.entries(this.playerData)
                    .filter(([_, data]) => data.team === team)
                    .map(([name]) => name);
                return players.slice(0, 2).join(', ') || 'Check squad';
            }

            getPlayerVerdict(player) {
                const valueScore = player.points / player.price;
                if (valueScore > 35) return "Essential - must-have player!";
                if (valueScore > 30) return "Excellent pick - strongly recommended";
                if (valueScore > 25) return "Good option - consider based on budget";
                if (valueScore > 20) return "Decent choice - monitor form";
                return "Risky pick - consider alternatives";
            }
        }

        function showWelcomeMessage() {
            const welcomeText = "üëã **Welcome to your FPL AI Assistant!**\n\nI have access to real-time data, advanced analytics, and expert insights to help you dominate your mini-leagues.\n\nAsk me about:\n‚Ä¢ Captain picks & differentials\n‚Ä¢ Transfer recommendations  \n‚Ä¢ Value players & budgets\n‚Ä¢ Fixture analysis\n‚Ä¢ Wildcard & chip strategies\n\nLet's get you to the top! üöÄ";
            displayAIMessage(welcomeText);
        }

        async function sendMessage() {
            if (isTyping) return;
            
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Check message limits (same as sidebar)
            const hasAccess = await checkMessageLimit();
            if (!hasAccess) {
                displayAIMessage("üöÄ **Upgrade to Premium for More AI Assistance!**\n\nYou've reached your daily AI query limit. Upgrade to get:\n\n‚öΩ **Starter ($2/month)**: 50 AI queries per day\nüèÜ **Pro ($7/month)**: Unlimited AI queries\n\n‚úÖ **Advanced FPL analytics**\n‚úÖ **Exclusive transfer insights**\n‚úÖ **Priority captain recommendations**");
                return;
            }

            // Display user message
            displayUserMessage(message);

            // Clear input
            input.value = '';

            // Disable send button
            toggleSendButton(false);

            // Show thinking and get AI response using sidebar logic
            await getAIResponse(message);

            // Re-enable send button
            toggleSendButton(true);
        }

        async function checkMessageLimit() {
            // Use same logic as sidebar
            if (window.premiumAccessControl) {
                const userStatus = window.premiumAccessControl.getUserStatus();
                const access = window.premiumAccessControl.hasAccess('fpl-ai-assistant.html');
                
                if (access.hasAccess) {
                    if (!access.unlimited && access.remaining <= 0) {
                        return false;
                    }
                    window.premiumAccessControl.updateDailyUsage('ai-assistant');
                    return true;
                }
                return false;
            }
            
            // Fallback - free users get 5 messages
            if (messageCount >= 5) {
                return false;
            }
            messageCount++;
            return true;
        }

        async function getAIResponse(message) {
            showThinking();

            try {
                let response;
                
                // Use main page AI processing
                if (mainPageAI && mainPageAI.processQuery) {
                    response = await mainPageAI.processQuery(message);
                } else {
                    // Fallback response
                    response = "I'm still loading my advanced FPL database. Please try again in a moment!";
                }

                removeThinking();
                displayAIMessage(response);

            } catch (error) {
                console.error('AI error:', error);
                removeThinking();
                displayAIMessage('Sorry, I encountered an error. Please try again in a moment.');
            }
        }

        function displayUserMessage(message) {
            const messagesDiv = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message user-message';
            msgDiv.innerHTML = `
                <div class="message-content">${escapeHtml(message)}</div>
                <div class="message-avatar user-avatar">üë§</div>
            `;
            messagesDiv.appendChild(msgDiv);
            scrollToBottom();
        }

        function displayAIMessage(message) {
            const messagesDiv = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ai-message';
            
            msgDiv.innerHTML = `
                <div class="message-avatar ai-avatar">ü§ñ</div>
                <div class="message-content">${formatMessage(message)}</div>
            `;
            messagesDiv.appendChild(msgDiv);
            scrollToBottom();
        }

        function showThinking() {
            isTyping = true;
            const messagesDiv = document.getElementById('chatMessages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'thinking-indicator';
            thinkingDiv.id = 'thinkingIndicator';
            
            const thoughts = [
                "ü§ñ Analyzing FPL data...",
                "üìä Processing player stats...",
                "üéØ Calculating recommendations...",
                "‚öΩ Checking fixtures and form...",
                "üí° Preparing smart advice..."
            ];
            const thought = thoughts[Math.floor(Math.random() * thoughts.length)];
            
            thinkingDiv.innerHTML = `
                <div class="message-avatar ai-avatar">ü§ñ</div>
                <div class="thinking-content">
                    ${thought}
                    <div class="thinking-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            messagesDiv.appendChild(thinkingDiv);
            scrollToBottom();
        }

        function removeThinking() {
            const indicator = document.getElementById('thinkingIndicator');
            if (indicator) {
                indicator.remove();
            }
            isTyping = false;
        }

        function toggleSendButton(enabled) {
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = !enabled;
        }

        function formatMessage(message) {
            return message
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px;">$1</code>')
                .replace(/‚Ä¢ /g, '‚Ä¢ ');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
    
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX');
    </script>
</body>
</html>