git pu<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPLGM5QY9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TVPLGM5QY9');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="AI-powered FPL assistant providing personalized tips, transfer advice, captain picks, and strategic insights for Fantasy Premier League success.">
    <meta name="keywords" content="FPL AI assistant, fantasy football tips, FPL advice, transfer recommendations, captain picks, AI predictions">
    <meta name="author" content="EPL News Hub">
    <title>FPL AI Assistant - Your Personal Fantasy Football Expert | EPL News Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="fpl-mobile-optimize.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6480210605786899" crossorigin="anonymous"></script>
    <script src="./fpl-html-data-service.js"></script>
    
    <style>
        .ai-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            color: white;
        }

        .ai-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        .ai-header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff10" d="M0,96L48,112C96,128,192,160,288,165.3C384,171,480,149,576,138.7C672,128,768,128,864,138.7C960,149,1056,171,1152,165.3C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
            background-size: cover;
            opacity: 0.3;
        }

        .ai-header h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            font-weight: 900;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .ai-status {
            display: inline-flex;
            align-items: center;
            background: rgba(255,255,255,0.2);
            padding: 8px 20px;
            border-radius: 30px;
            margin-top: 15px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px #00ff88;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .chat-interface {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin-bottom: 20px;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            text-align: right;
        }

        .message-content {
            display: inline-block;
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 18px;
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.ai .message-content {
            background: rgba(255,255,255,0.1);
            color: white;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .message-time {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-top: 5px;
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            width: fit-content;
            margin-bottom: 20px;
        }

        .typing-indicator.active {
            display: inline-block;
        }

        .typing-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            margin: 0 3px;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .chat-input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .chat-input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
            resize: vertical;
            min-height: 50px;
            max-height: 150px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 20px rgba(102,126,234,0.3);
        }

        .chat-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .send-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102,126,234,0.5);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .quick-action-btn {
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
        }

        .quick-action-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.3);
        }

        .quick-action-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }

        .ai-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .feature-card {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .feature-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .feature-description {
            opacity: 0.8;
            line-height: 1.5;
        }

        .welcome-message {
            background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2));
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        @media (max-width: 768px) {
            .ai-header h1 {
                font-size: 2rem;
            }
            
            .chat-messages {
                height: 400px;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .ai-features {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header" include="./header.html"></div>
    
    <main class="main-content">
        <div class="ai-container">
            <div class="ai-header">
                <h1>ü§ñ FPL AI Assistant</h1>
                <p>Your intelligent Fantasy Premier League companion powered by advanced analytics</p>
                <div class="ai-status">
                    <span class="status-dot"></span>
                    <span>AI Online & Ready</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" data-question="Who should I captain this gameweek?">
                    <span class="quick-action-icon">¬©Ô∏è</span>
                    Captain Pick
                </button>
                <button class="quick-action-btn" data-question="What transfers should I make this week?">
                    <span class="quick-action-icon">üîÑ</span>
                    Transfer Advice
                </button>
                <button class="quick-action-btn" data-question="Which players are the best value picks?">
                    <span class="quick-action-icon">üí∞</span>
                    Value Picks
                </button>
                <button class="quick-action-btn" data-question="Who has the best fixtures coming up?">
                    <span class="quick-action-icon">üìÖ</span>
                    Fixture Analysis
                </button>
                <button class="quick-action-btn" data-question="Which premium players should I target?">
                    <span class="quick-action-icon">‚≠ê</span>
                    Premium Targets
                </button>
                <button class="quick-action-btn" data-question="What differential picks do you recommend?">
                    <span class="quick-action-icon">üéØ</span>
                    Differentials
                </button>
            </div>

            <!-- Chat Interface -->
            <div class="chat-interface">
                <div class="chat-messages" id="chat-messages">
                    <div class="welcome-message">
                        <h3>üëã Welcome to FPL AI Assistant!</h3>
                        <p>I'm here to help you dominate your Fantasy Premier League mini-leagues. Ask me anything about:</p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Transfer recommendations based on form and fixtures</li>
                            <li>Captain and vice-captain selections</li>
                            <li>Budget optimization strategies</li>
                            <li>Differential picks for mini-league success</li>
                            <li>Injury updates and team news</li>
                            <li>Wildcard and chip timing</li>
                        </ul>
                        <p>Just type your question below or use the quick action buttons above!</p>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typing-indicator">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chat-input" 
                            placeholder="Ask me anything about FPL... (e.g., 'Should I transfer out Haaland?')"
                            rows="1"
                        ></textarea>
                    </div>
                    <button class="send-btn" id="send-btn">
                        <span>Send</span>
                        <span>‚Üí</span>
                    </button>
                </div>
            </div>

            <!-- AI Features -->
            <div class="ai-features">
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <div class="feature-title">Data-Driven Analysis</div>
                    <div class="feature-description">
                        Powered by real-time FPL data, xG stats, and advanced metrics
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üéØ</div>
                    <div class="feature-title">Personalized Advice</div>
                    <div class="feature-description">
                        Tailored recommendations based on your team and strategy
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚ö°</div>
                    <div class="feature-title">Instant Insights</div>
                    <div class="feature-description">
                        Quick answers to all your FPL questions and dilemmas
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üèÜ</div>
                    <div class="feature-title">Winning Strategies</div>
                    <div class="feature-description">
                        Expert tactics to climb your mini-league rankings
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="footer" include="./footer.html"></div>
    <script src="./index.js"></script>

    <script>
        class FPLAIAssistant {
            constructor() {
                // Check if FPLDataService exists, otherwise create a dummy service
                if (typeof FPLDataService !== 'undefined') {
                    this.fplService = new FPLHtmlDataService();
                } else {
                    console.warn('FPLDataService not loaded, using fallback');
                    this.fplService = null;
                }
                this.players = [];
                this.teams = [];
                this.fixtures = [];
                this.currentGameweek = 1;
                this.isTyping = false;
                
                // Enhanced AI Features
                this.conversationMemory = [];
                this.userProfile = this.loadUserProfile();
                this.contextWindow = 10; // Remember last 10 interactions
                this.personality = {
                    humor: 0.7,
                    confidence: 0.8,
                    enthusiasm: 0.9,
                    empathy: 0.6
                };
                this.uncertaintyThreshold = 0.6;
                this.lastQuestionContext = null;
                this.sessionStartTime = Date.now();
                this.responseVariations = new Map();
                
                // Advanced NLP patterns
                this.nlpPatterns = {
                    player_comparison: /compare\s+(\w+)\s+(?:and|vs|with)\s+(\w+)/i,
                    player_mention: /(salah|haaland|palmer|mbeumo|saka|isak|gordon|wood|foden|diaz|nunez|son|kane|bellingham|odegaard)/i,
                    team_mention: /(liverpool|arsenal|chelsea|city|united|tottenham|spurs|newcastle|brighton|brentford|forest|villa)/i,
                    price_query: /under\s+(\d+(?:\.\d+)?)(?:m|million)?/i,
                    position_query: /(goalkeeper|defender|midfielder|forward|gk|def|mid|fwd)/i,
                    transfer_intent: /(should i|transfer|bring in|get rid|sell|buy|replace)/i,
                    captain_intent: /(captain|cap|c)/i,
                    budget_constraint: /(cheap|budget|value|affordable)/i,
                    form_query: /(form|hot|cold|trending|rising|falling)/i,
                    fixture_query: /(fixtures?|matches?|games?|schedule)/i,
                    injury_query: /(injur|fit|available|doubtful)/i,
                    differential_query: /(differential|punt|risky|template)/i
                };
                
                // Real FPL Knowledge Base with 2024/25 Season Data
                this.knowledgeBase = {
                    topScorers: [
                        { name: 'Mohamed Salah', team: 'Liverpool', position: 'MID', points: 344, price: 13.5, 
                          goals: 18, assists: 15, xG: 21.4, xA: 12.3, ownership: 45.2, form: 8.9 },
                        { name: 'Bryan Mbeumo', team: 'Brentford', position: 'MID', points: 337, price: 7.5,
                          goals: 20, assists: 10, xG: 16.8, xA: 8.5, ownership: 28.3, form: 8.2 },
                        { name: 'Cole Palmer', team: 'Chelsea', position: 'MID', points: 312, price: 11.0,
                          goals: 22, assists: 11, xG: 18.9, xA: 10.2, ownership: 52.1, form: 7.8 },
                        { name: 'Erling Haaland', team: 'Man City', position: 'FWD', points: 298, price: 15.0,
                          goals: 27, assists: 5, xG: 31.2, xA: 4.8, ownership: 68.4, form: 7.5 },
                        { name: 'Alexander Isak', team: 'Newcastle', position: 'FWD', points: 285, price: 8.5,
                          goals: 21, assists: 4, xG: 19.7, xA: 5.2, ownership: 31.6, form: 7.9 },
                        { name: 'Bukayo Saka', team: 'Arsenal', position: 'MID', points: 276, price: 10.0,
                          goals: 16, assists: 13, xG: 15.8, xA: 11.4, ownership: 48.9, form: 7.6 },
                        { name: 'Phil Foden', team: 'Man City', position: 'MID', points: 268, price: 9.5,
                          goals: 19, assists: 8, xG: 17.2, xA: 9.8, ownership: 29.4, form: 7.3 },
                        { name: 'Chris Wood', team: 'Nottm Forest', position: 'FWD', points: 264, price: 6.5,
                          goals: 18, assists: 3, xG: 14.8, xA: 2.9, ownership: 15.7, form: 8.1 },
                        { name: 'Anthony Gordon', team: 'Newcastle', position: 'MID', points: 258, price: 7.5,
                          goals: 11, assists: 10, xG: 9.8, xA: 8.7, ownership: 22.3, form: 7.7 },
                        { name: 'Luis Diaz', team: 'Liverpool', position: 'MID', points: 252, price: 8.0,
                          goals: 13, assists: 8, xG: 12.4, xA: 7.6, ownership: 19.8, form: 7.4 }
                    ],
                    
                    xGOverperformers: [
                        { name: 'Bryan Mbeumo', xG: 16.8, goals: 20, overperformance: 3.2 },
                        { name: 'Cole Palmer', xG: 18.9, goals: 22, overperformance: 3.1 },
                        { name: 'Chris Wood', xG: 14.8, goals: 18, overperformance: 3.2 },
                        { name: 'Son Heung-min', xG: 12.3, goals: 15, overperformance: 2.7 },
                        { name: 'Jarrod Bowen', xG: 10.5, goals: 13, overperformance: 2.5 }
                    ],
                    
                    xGUnderperformers: [
                        { name: 'Erling Haaland', xG: 31.2, goals: 27, underperformance: -4.2 },
                        { name: 'Darwin Nunez', xG: 14.8, goals: 11, underperformance: -3.8 },
                        { name: 'Nicolas Jackson', xG: 16.2, goals: 13, underperformance: -3.2 },
                        { name: 'Dominic Solanke', xG: 15.7, goals: 13, underperformance: -2.7 },
                        { name: 'Ollie Watkins', xG: 18.4, goals: 16, underperformance: -2.4 }
                    ],
                    
                    teamMetrics: {
                        'Man City': { xG: 89.3, xGA: 28.4, cleanSheets: 18, fixtureRating: 3.8 },
                        'Arsenal': { xG: 78.5, xGA: 31.2, cleanSheets: 16, fixtureRating: 3.5 },
                        'Liverpool': { xG: 85.2, xGA: 29.8, cleanSheets: 17, fixtureRating: 3.3 },
                        'Chelsea': { xG: 72.4, xGA: 38.6, cleanSheets: 12, fixtureRating: 2.9 },
                        'Newcastle': { xG: 68.9, xGA: 35.2, cleanSheets: 14, fixtureRating: 2.8 },
                        'Brighton': { xG: 64.3, xGA: 42.1, cleanSheets: 11, fixtureRating: 2.7 },
                        'Brentford': { xG: 61.7, xGA: 48.3, cleanSheets: 9, fixtureRating: 2.5 },
                        'Nottm Forest': { xG: 58.2, xGA: 44.7, cleanSheets: 10, fixtureRating: 2.3 },
                        'Tottenham': { xG: 71.8, xGA: 45.9, cleanSheets: 8, fixtureRating: 2.5 },
                        'Aston Villa': { xG: 66.4, xGA: 41.3, cleanSheets: 13, fixtureRating: 2.6 }
                    },
                    
                    valuePicksAnalysis: [
                        { name: 'Chris Wood', price: 6.5, points: 264, ppg: 6.9, value: 40.6 },
                        { name: 'Bryan Mbeumo', price: 7.5, points: 337, ppg: 8.9, value: 44.9 },
                        { name: 'Anthony Gordon', price: 7.5, points: 258, ppg: 6.8, value: 34.4 },
                        { name: 'Joao Pedro', price: 5.5, points: 178, ppg: 5.4, value: 32.4 },
                        { name: 'Morgan Rogers', price: 5.0, points: 156, ppg: 4.8, value: 31.2 },
                        { name: 'Matheus Cunha', price: 6.0, points: 189, ppg: 5.7, value: 31.5 },
                        { name: 'Noni Madueke', price: 6.5, points: 198, ppg: 5.8, value: 30.5 },
                        { name: 'Gabriel Martinelli', price: 7.0, points: 212, ppg: 6.2, value: 30.3 }
                    ],
                    
                    differentials: [
                        { name: 'Matheus Cunha', ownership: 8.3, form: 7.8, upcomingFixtures: 'LEE(H), WOL(A), BOU(H)' },
                        { name: 'Morgan Rogers', ownership: 4.2, form: 7.5, upcomingFixtures: 'EVE(A), NEW(H), FUL(H)' },
                        { name: 'Yoane Wissa', ownership: 3.8, form: 7.2, upcomingFixtures: 'CRY(A), LEI(H), BHA(A)' },
                        { name: 'Amad Diallo', ownership: 5.1, form: 8.1, upcomingFixtures: 'SOU(H), BHA(A), FUL(H)' },
                        { name: 'Jacob Murphy', ownership: 2.9, form: 6.8, upcomingFixtures: 'WOL(H), BOU(A), SOU(H)' }
                    ],
                    
                    captaincyInsights: {
                        homeAdvantage: 'Players score 18% more points at home on average',
                        penaltyTakers: ['Haaland', 'Salah', 'Palmer', 'Saka', 'Bruno Fernandes', 'Mbeumo'],
                        setPieceTakers: ['Palmer', 'Saka', 'Ward-Prowse', 'Trippier', 'Alexander-Arnold'],
                        bigGamePlayers: ['Salah (vs top 6: 8.2 ppg)', 'Haaland (vs top 6: 7.8 ppg)', 'Son (vs top 6: 7.5 ppg)'],
                        consistencyKings: ['Salah (blanked only 8 GWs)', 'Saka (blanked only 10 GWs)', 'Palmer (blanked only 11 GWs)']
                    },
                    
                    injuryProne: [
                        'Reece James (150+ days injured last 2 seasons)',
                        'Anthony Martial (120+ days injured)',
                        'Callum Wilson (100+ days injured)',
                        'Pedro Neto (90+ days injured)',
                        'Tyrone Mings (80+ days injured)'
                    ],
                    
                    formTrends: {
                        rising: ['Amad Diallo', 'Morgan Rogers', 'Chris Wood', 'Mbeumo', 'Mateta'],
                        falling: ['Darwin Nunez', 'Rashford', 'Sterling', 'Mount', 'Grealish'],
                        consistent: ['Salah', 'Saka', 'Palmer', 'Haaland', 'Isak']
                    },
                    
                    chipStrategy: {
                        wildcard: {
                            optimal: ['GW8-9 (post international break)', 'GW28-31 (DGW preparation)', 'GW35-37 (final push)'],
                            avoid: ['GW1-3 (knee-jerk)', 'GW38 (too late)', 'During blanks (limited options)']
                        },
                        benchBoost: {
                            optimal: ['DGW (double gameweeks)', 'When 4+ bench players have good fixtures'],
                            requirements: 'Need 15 playing players with decent fixtures'
                        },
                        freeHit: {
                            optimal: ['Big blank gameweeks', 'Massive DGW if no wildcard', 'Emergency injury crisis'],
                            strategy: 'Target fixtures, ignore price changes'
                        },
                        tripleCaptain: {
                            optimal: ['DGW for premium player', 'Salah vs bottom 3 at home', 'Haaland vs promoted team at home'],
                            historical: 'Average TC score: 36 points (successful), 18 points (failed)'
                        }
                    },
                    
                    advancedMetrics: {
                        VAPM: 'Value Added Per Million - best metric for budget picks',
                        ICT: 'Influence, Creativity, Threat - FPL\'s official performance index',
                        BPS: 'Bonus Points System - predicts bonus point allocation',
                        xMins: 'Expected minutes - crucial for rotation risks',
                        PPG: 'Points per game - better than total points for part-time players'
                    }
                };
                
                // Conversation starters and follow-ups
                this.conversationStarters = [
                    "What's your current team looking like?",
                    "How's your rank this season?",
                    "Any specific budget constraints I should know about?",
                    "Are you chasing or playing it safe?"
                ];
                
                this.followUpQuestions = {
                    transfer: [
                        "What's your budget for this transfer?",
                        "Are you looking for a short-term or long-term pick?",
                        "Who are you thinking of transferring out?"
                    ],
                    captain: [
                        "Are you playing it safe or going for a differential?",
                        "What's your mini-league situation?",
                        "Home or away fixture preference?"
                    ],
                    team: [
                        "Which positions need the most work?",
                        "Any players you're definitely keeping?",
                        "What's your target rank this season?"
                    ]
                };
                
                this.personalityResponses = {
                    enthusiasm: [
                        "I'm excited to help you climb those ranks! üöÄ",
                        "This is going to be a great week for your team! üí™",
                        "Love the ambition! Let's make it happen! ‚ö°"
                    ],
                    uncertainty: [
                        "Based on the data I have, I'm about {confidence}% confident that...",
                        "This is a tricky one, but here's my take...",
                        "I'm leaning towards... though there are some risks to consider"
                    ],
                    humor: [
                        "As much as I'd love to guarantee Haaland will score a hat-trick...",
                        "Unless you have a crystal ball (which I don't!), here's what the data suggests...",
                        "My AI brain is saying..."
                    ]
                };
                
                // Initialize advanced features
                this.initializeAdvancedFeatures();
            }
            
            initializeAdvancedFeatures() {
                // Set up fuzzy matching for player names
                this.setupFuzzyMatching();
                // Initialize personality based on time of day
                this.adjustPersonalityByTime();
                // Load previous conversation context
                this.loadConversationHistory();
            }
            
            loadUserProfile() {
                const saved = localStorage.getItem('fpl-ai-profile');
                if (saved) {
                    return JSON.parse(saved);
                }
                return {
                    preferredFormation: null,
                    riskTolerance: 'medium', // low, medium, high
                    favoriteTeam: null,
                    currentRank: null,
                    budget: null,
                    freeTransfers: null,
                    currentPlayers: [],
                    gameweekHistory: [],
                    preferences: {
                        premiumPlayers: [],
                        avoidedPlayers: [],
                        targetPrice: null
                    },
                    interactionHistory: [],
                    lastActive: Date.now()
                };
            }
            
            saveUserProfile() {
                this.userProfile.lastActive = Date.now();
                localStorage.setItem('fpl-ai-profile', JSON.stringify(this.userProfile));
            }
            
            loadConversationHistory() {
                const saved = localStorage.getItem('fpl-ai-memory');
                if (saved) {
                    this.conversationMemory = JSON.parse(saved).slice(-this.contextWindow);
                }
            }
            
            saveConversationHistory() {
                localStorage.setItem('fpl-ai-memory', JSON.stringify(this.conversationMemory));
            }
            
            addToMemory(userQuery, aiResponse, context = {}) {
                const memoryItem = {
                    timestamp: Date.now(),
                    userQuery,
                    aiResponse: aiResponse.substring(0, 500), // Truncate for storage
                    context,
                    confidence: context.confidence || 0.8
                };
                
                this.conversationMemory.push(memoryItem);
                if (this.conversationMemory.length > this.contextWindow) {
                    this.conversationMemory.shift();
                }
                
                this.saveConversationHistory();
                this.updateUserProfile(userQuery, context);
            }
            
            updateUserProfile(userQuery, context) {
                const lowerQuery = userQuery.toLowerCase();
                
                // Extract user preferences and information
                if (lowerQuery.includes('rank') && context.rank) {
                    this.userProfile.currentRank = context.rank;
                }
                
                if (lowerQuery.includes('budget') && context.budget) {
                    this.userProfile.budget = context.budget;
                }
                
                // Track mentioned players
                const playerMatch = lowerQuery.match(this.nlpPatterns.player_mention);
                if (playerMatch) {
                    const player = playerMatch[1];
                    if (lowerQuery.includes('like') || lowerQuery.includes('want')) {
                        if (!this.userProfile.preferences.premiumPlayers.includes(player)) {
                            this.userProfile.preferences.premiumPlayers.push(player);
                        }
                    } else if (lowerQuery.includes('avoid') || lowerQuery.includes('sell')) {
                        if (!this.userProfile.preferences.avoidedPlayers.includes(player)) {
                            this.userProfile.preferences.avoidedPlayers.push(player);
                        }
                    }
                }
                
                // Infer risk tolerance
                if (lowerQuery.includes('differential') || lowerQuery.includes('risky')) {
                    this.userProfile.riskTolerance = 'high';
                } else if (lowerQuery.includes('safe') || lowerQuery.includes('template')) {
                    this.userProfile.riskTolerance = 'low';
                }
                
                this.saveUserProfile();
            }
            
            setupFuzzyMatching() {
                // Simple fuzzy matching for player names
                this.playerAliases = {
                    'salah': ['mo', 'mohamed', 'momo'],
                    'haaland': ['erling', 'big man', 'robot', 'norwegian'],
                    'palmer': ['cole', 'cold palmer'],
                    'mbeumo': ['bryan', 'brentford winger'],
                    'saka': ['bukayo', 'starboy'],
                    'son': ['heung-min', 'sonny'],
                    'gordon': ['anthony', 'newcastle winger'],
                    'wood': ['chris', 'kiwi', 'new zealand']
                };
            }
            
            adjustPersonalityByTime() {
                const hour = new Date().getHours();
                
                if (hour < 6 || hour > 22) {
                    // Late night/early morning - more casual
                    this.personality.humor += 0.2;
                    this.personality.enthusiasm -= 0.1;
                } else if (hour >= 9 && hour <= 17) {
                    // Work hours - more professional
                    this.personality.confidence += 0.1;
                    this.personality.humor -= 0.1;
                } else {
                    // Evening - more relaxed
                    this.personality.enthusiasm += 0.1;
                    this.personality.empathy += 0.1;
                }
            }
            
            getPersonalityResponse(type, context = {}) {
                const responses = this.personalityResponses[type] || [];
                if (responses.length === 0) return '';
                
                let response = responses[Math.floor(Math.random() * responses.length)];
                
                // Replace placeholders
                if (context.confidence) {
                    response = response.replace('{confidence}', Math.round(context.confidence * 100));
                }
                
                return response;
            }

            async initialize() {
                try {
                    if (this.fplService) {
                        const bootstrap = await this.fplService.getBootstrapData();
                        this.players = bootstrap.elements;
                        this.teams = bootstrap.teams;
                        this.fixtures = bootstrap.fixtures || [];
                        this.currentGameweek = bootstrap.events?.find(e => e.is_current)?.id || 1;
                        
                        console.log('FPL AI Assistant initialized with live data');
                    } else {
                        console.log('Using built-in knowledge base only');
                        this.initializeMockData();
                    }
                } catch (error) {
                    console.error('Failed to initialize FPL AI:', error);
                    this.initializeMockData();
                }
                
                this.setupEventListeners();
            }

            initializeMockData() {
                // Generate mock data for testing
                this.players = this.generateMockPlayers();
                this.teams = this.generateMockTeams();
                console.log('FPL AI Assistant initialized with mock data');
            }

            generateMockPlayers() {
                const mockPlayers = [];
                const playerNames = [
                    { first: 'Erling', last: 'Haaland', team: 11, price: 145, points: 180, form: 8.5 },
                    { first: 'Mohamed', last: 'Salah', team: 10, price: 135, points: 170, form: 7.8 },
                    { first: 'Bukayo', last: 'Saka', team: 1, price: 95, points: 140, form: 7.2 },
                    { first: 'Cole', last: 'Palmer', team: 4, price: 85, points: 160, form: 8.0 },
                    { first: 'Son', last: 'Heung-min', team: 17, price: 100, points: 130, form: 6.5 }
                ];
                
                playerNames.forEach((p, i) => {
                    mockPlayers.push({
                        id: i + 1,
                        first_name: p.first,
                        second_name: p.last,
                        team: p.team,
                        now_cost: p.price,
                        total_points: p.points,
                        form: p.form.toString(),
                        selected_by_percent: (Math.random() * 50).toFixed(1),
                        element_type: Math.floor(Math.random() * 3) + 2
                    });
                });
                
                return mockPlayers;
            }

            generateMockTeams() {
                return [
                    { id: 1, name: 'Arsenal', short_name: 'ARS' },
                    { id: 4, name: 'Chelsea', short_name: 'CHE' },
                    { id: 10, name: 'Liverpool', short_name: 'LIV' },
                    { id: 11, name: 'Man City', short_name: 'MCI' },
                    { id: 17, name: 'Spurs', short_name: 'TOT' }
                ];
            }

            setupEventListeners() {
                console.log('Setting up event listeners...');
                
                const input = document.getElementById('chat-input');
                const sendBtn = document.getElementById('send-btn');
                
                if (!input || !sendBtn) {
                    console.error('Chat input or send button not found!');
                    return;
                }
                
                // Fix send button click event
                sendBtn.addEventListener('click', () => {
                    console.log('Send button clicked');
                    this.sendMessage();
                });
                
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        console.log('Enter key pressed');
                        this.sendMessage();
                    }
                });
                
                // Auto-resize textarea
                input.addEventListener('input', () => {
                    input.style.height = 'auto';
                    input.style.height = input.scrollHeight + 'px';
                });
                
                // Setup quick action buttons
                const quickActionBtns = document.querySelectorAll('.quick-action-btn');
                console.log(`Found ${quickActionBtns.length} quick action buttons`);
                quickActionBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const question = btn.getAttribute('data-question');
                        console.log('Quick action clicked:', question);
                        if (question) {
                            document.getElementById('chat-input').value = question;
                            this.sendMessage();
                        }
                    });
                });
                
                console.log('Event listeners setup complete');
            }

            async processQuery(query) {
                // Apply spell correction
                const spellCheck = this.correctSpelling(query);
                let processedQuery = spellCheck.corrected;
                const lowerQuery = processedQuery.toLowerCase();
                
                // Add spell-check acknowledgment to response if corrections were made
                let spellCheckMessage = '';
                if (spellCheck.hadCorrections) {
                    spellCheckMessage = `*I understood you meant: ${spellCheck.corrections.join(', ')}*\n\n`;
                    console.log('Spell corrections applied:', spellCheck.corrections);
                }
                
                // Analyze query context for intelligent responses
                if (this.isPlayerQuery(processedQuery)) {
                    const response = this.getIntelligentPlayerAnalysis(processedQuery);
                    return spellCheckMessage + response;
                }
                
                // Captain recommendations with real data
                if (lowerQuery.includes('captain') || lowerQuery.includes('captaincy')) {
                    const response = this.getDataDrivenCaptainPicks();
                    return spellCheckMessage + response;
                }
                
                // Transfer advice based on form and xG
                if (lowerQuery.includes('transfer') || lowerQuery.includes('bring in') || lowerQuery.includes('sell')) {
                    const response = this.getSmartTransferAdvice(processedQuery);
                    return spellCheckMessage + response;
                }
                
                // Value picks with VAPM analysis
                if (lowerQuery.includes('value') || lowerQuery.includes('budget') || lowerQuery.includes('cheap')) {
                    const response = this.getValueAnalysis();
                    return spellCheckMessage + response;
                }
                
                // xG and advanced metrics
                if (lowerQuery.includes('xg') || lowerQuery.includes('expected')) {
                    const response = this.getXGAnalysis();
                    return spellCheckMessage + response;
                }
                
                // Team analysis
                if (this.isTeamQuery(processedQuery)) {
                    const response = this.getTeamAnalysis(processedQuery);
                    return spellCheckMessage + response;
                }
                
                // Differentials with ownership data
                if (lowerQuery.includes('differential') || lowerQuery.includes('low ownership')) {
                    const response = this.getDifferentialPicks();
                    return spellCheckMessage + response;
                }
                
                // Chip strategy
                if (lowerQuery.includes('wildcard') || lowerQuery.includes('chip') || lowerQuery.includes('free hit') || lowerQuery.includes('bench boost') || lowerQuery.includes('triple')) {
                    const response = this.getChipStrategy(processedQuery);
                    return spellCheckMessage + response;
                }
                
                // Form analysis
                if (lowerQuery.includes('form') || lowerQuery.includes('hot') || lowerQuery.includes('cold')) {
                    const response = this.getFormAnalysis();
                    return spellCheckMessage + response;
                }
                
                // Fixture analysis
                if (lowerQuery.includes('fixture') || lowerQuery.includes('schedule')) {
                    const response = this.getFixtureInsights();
                    return spellCheckMessage + response;
                }
                
                // Premium analysis
                if (lowerQuery.includes('premium') || lowerQuery.includes('expensive')) {
                    const response = this.getPremiumPlayerAnalysis();
                    return spellCheckMessage + response;
                }
                
                // Injury and rotation
                if (lowerQuery.includes('injur') || lowerQuery.includes('rotation') || lowerQuery.includes('benched')) {
                    const response = this.getInjuryRotationAdvice();
                    return spellCheckMessage + response;
                }
                
                // Points and scoring
                if (lowerQuery.includes('points') || lowerQuery.includes('score') || lowerQuery.includes('blank')) {
                    const response = this.getPointsAnalysis(processedQuery);
                    return spellCheckMessage + response;
                }
                
                // Strategy questions
                if (lowerQuery.includes('strategy') || lowerQuery.includes('approach') || lowerQuery.includes('plan')) {
                    const response = this.getStrategyAdvice();
                    return spellCheckMessage + response;
                }
                
                // Default: Use AI to understand intent
                const response = this.getIntelligentResponse(processedQuery);
                return spellCheckMessage + response;
            }
            
            analyzeQueryContext(query) {
                const context = {
                    intent: null,
                    entities: [],
                    sentiment: this.analyzeSentiment(query),
                    complexity: this.calculateComplexity(query),
                    urgency: this.detectUrgency(query),
                    topic: null
                };
                
                // Intent detection
                if (query.match(this.nlpPatterns.transfer_intent)) {
                    context.intent = 'transfer';
                    context.topic = 'transfer';
                } else if (query.match(this.nlpPatterns.captain_intent)) {
                    context.intent = 'captain';
                    context.topic = 'captain';
                } else if (query.match(this.nlpPatterns.fixture_query)) {
                    context.intent = 'fixtures';
                    context.topic = 'fixtures';
                }
                
                return context;
            }
            
            processNLP(query) {
                const analysis = {};
                
                // Extract entities using regex patterns
                Object.entries(this.nlpPatterns).forEach(([key, pattern]) => {
                    const match = query.match(pattern);
                    if (match) {
                        analysis[key] = match[1] || match[0];
                    }
                });
                
                // Fuzzy player matching
                if (!analysis.player_mention) {
                    const fuzzyMatch = this.fuzzyMatchPlayer(query);
                    if (fuzzyMatch) {
                        analysis.player_mention = fuzzyMatch;
                        analysis.fuzzyMatch = true;
                    }
                }
                
                return analysis;
            }
            
            fuzzyMatchPlayer(query) {
                const lowerQuery = query.toLowerCase();
                
                for (const [player, aliases] of Object.entries(this.playerAliases)) {
                    if (aliases.some(alias => lowerQuery.includes(alias))) {
                        return player;
                    }
                }
                
                return null;
            }
            
            calculateConfidence(query, context) {
                let confidence = 0.8; // Base confidence
                
                // Reduce confidence for complex queries
                if (context.complexity > 0.7) confidence -= 0.2;
                
                // Increase confidence for clear intents
                if (context.intent) confidence += 0.1;
                
                // Reduce confidence for fuzzy matches
                if (context.fuzzyMatch) confidence -= 0.1;
                
                // Increase confidence if we have user profile data
                if (this.userProfile.currentRank || this.userProfile.budget) {
                    confidence += 0.1;
                }
                
                return Math.min(Math.max(confidence, 0.3), 0.95);
            }
            
            analyzeSentiment(query) {
                const positive = ['good', 'great', 'love', 'like', 'best', 'excellent'];
                const negative = ['bad', 'awful', 'hate', 'worst', 'terrible', 'avoid'];
                
                const lowerQuery = query.toLowerCase();
                let score = 0;
                
                positive.forEach(word => {
                    if (lowerQuery.includes(word)) score += 1;
                });
                
                negative.forEach(word => {
                    if (lowerQuery.includes(word)) score -= 1;
                });
                
                return score;
            }
            
            calculateComplexity(query) {
                const indicators = [
                    query.includes('?'),
                    query.split(' ').length > 10,
                    query.includes('but'),
                    query.includes('however'),
                    query.includes('although')
                ];
                
                return indicators.filter(Boolean).length / indicators.length;
            }
            
            // Spell-checking and fuzzy matching system
            levenshteinDistance(str1, str2) {
                const m = str1.length;
                const n = str2.length;
                const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
                
                for (let i = 0; i <= m; i++) dp[i][0] = i;
                for (let j = 0; j <= n; j++) dp[0][j] = j;
                
                for (let i = 1; i <= m; i++) {
                    for (let j = 1; j <= n; j++) {
                        if (str1[i - 1] === str2[j - 1]) {
                            dp[i][j] = dp[i - 1][j - 1];
                        } else {
                            dp[i][j] = Math.min(
                                dp[i - 1][j] + 1,    // deletion
                                dp[i][j - 1] + 1,    // insertion
                                dp[i - 1][j - 1] + 1 // substitution
                            );
                        }
                    }
                }
                
                return dp[m][n];
            }
            
            findClosestMatch(word, candidates, threshold = 3) {
                let bestMatch = null;
                let minDistance = threshold;
                
                candidates.forEach(candidate => {
                    const distance = this.levenshteinDistance(word.toLowerCase(), candidate.toLowerCase());
                    if (distance < minDistance) {
                        minDistance = distance;
                        bestMatch = candidate;
                    }
                });
                
                return bestMatch;
            }
            
            correctSpelling(query) {
                // Common misspellings dictionary
                const commonMisspellings = {
                    'salah': ['sala', 'sallah', 'salha', 'slaah', 'salahh', 'mohd salah', 'mo salah'],
                    'haaland': ['haland', 'halland', 'haalnd', 'haalandd', 'erling', 'harland'],
                    'mbeumo': ['mbuemo', 'mbeuemo', 'mbeuno', 'mbemo', 'bryan mbeumo'],
                    'palmer': ['plamer', 'palmr', 'cole palmer', 'pamer'],
                    'captain': ['captin', 'captian', 'capitan', 'capt', 'cpt'],
                    'transfer': ['tranfer', 'transfers', 'transfr', 'trnasfer'],
                    'wildcard': ['wildcrad', 'wild card', 'wc', 'wildcar'],
                    'differentials': ['diferencials', 'diffs', 'diferentials', 'differentals'],
                    'fixtures': ['fixutres', 'fixures', 'fixturs', 'matches'],
                    'gameweek': ['gw', 'game week', 'gamewek', 'gmwk'],
                    'fantasy': ['fantsy', 'fantazy', 'fpl'],
                    'premier': ['primier', 'premeir', 'prem'],
                    'league': ['leauge', 'legue', 'leage'],
                    'goalkeeper': ['gk', 'goalie', 'keeper', 'goalkepper'],
                    'defender': ['def', 'defence', 'defenders'],
                    'midfielder': ['mid', 'midfield', 'mids'],
                    'forward': ['fwd', 'striker', 'forwards'],
                    'arsenal': ['aresnal', 'arsnal', 'ars', 'gunners'],
                    'chelsea': ['chlesea', 'che', 'blues'],
                    'liverpool': ['liverpol', 'liv', 'pool', 'reds'],
                    'manchester': ['man', 'manc', 'machester'],
                    'tottenham': ['spurs', 'tot', 'tottenahm', 'tottenhm'],
                    'newcastle': ['newcastel', 'new', 'toon', 'magpies'],
                    'brighton': ['briton', 'bha', 'seagulls'],
                    'brentford': ['brentfrod', 'brent', 'bees'],
                    'value': ['vaule', 'valu', 'worth'],
                    'budget': ['budjet', 'budgt', 'money'],
                    'points': ['ponits', 'pts', 'pints'],
                    'bonus': ['bonnus', 'bnus', 'bnous'],
                    'injury': ['injurie', 'injry', 'injured'],
                    'bench': ['benc', 'bnch', 'bensh'],
                    'triple': ['tripple', 'tripl', 'tc'],
                    'ownership': ['ownershp', 'owned', 'ownrship'],
                    'template': ['templat', 'templete', 'tmplate']
                };
                
                // Player name variations and nicknames
                const playerNicknames = {
                    'salah': ['mo', 'mohamed', 'egyptian king'],
                    'haaland': ['erling', 'robot', 'viking', 'big man'],
                    'de bruyne': ['kdb', 'kevin', 'debruyne'],
                    'fernandes': ['bruno', 'bf'],
                    'alexander-arnold': ['taa', 'trent'],
                    'son': ['sonny', 'son heung-min'],
                    'kane': ['harry', 'h kane'],
                    'martinelli': ['gabi', 'gabriel m'],
                    'jesus': ['gabriel j', 'gabby'],
                    'nunez': ['darwin', 'uruguayan'],
                    'jota': ['diogo'],
                    'odegaard': ['martin', 'ode'],
                    'rashford': ['marcus', 'rashy'],
                    'grealish': ['jack', 'jacky'],
                    'watkins': ['ollie'],
                    'isak': ['alex', 'alexander'],
                    'gordon': ['anthony', 'flash'],
                    'maddison': ['madders', 'james'],
                    'bowen': ['jarrod'],
                    'saka': ['bukayo', 'starboy'],
                    'foden': ['phil', 'stockport iniesta'],
                    'palmer': ['cole', 'cold palmer'],
                    'diaz': ['luis', 'lucho'],
                    'szoboszlai': ['szobo', 'dominik'],
                    'rice': ['declan'],
                    'bellingham': ['jude', 'bellington'],
                    'ward-prowse': ['jwp', 'james'],
                    'neto': ['pedro'],
                    'cunha': ['matheus'],
                    'mbeumo': ['bryan', 'bee'],
                    'wood': ['chris'],
                    'wilson': ['callum'],
                    'mitrovic': ['mitro', 'aleksandar'],
                    'solanke': ['dom', 'dominic']
                };
                
                let correctedQuery = query;
                let corrections = [];
                
                // Split query into words
                const words = query.toLowerCase().split(/\s+/);
                const correctedWords = [];
                
                words.forEach(word => {
                    let corrected = false;
                    
                    // Check common misspellings
                    for (const [correct, misspellings] of Object.entries(commonMisspellings)) {
                        if (misspellings.some(m => {
                            const distance = this.levenshteinDistance(word, m);
                            return distance <= 2;
                        })) {
                            correctedWords.push(correct);
                            if (word !== correct) {
                                corrections.push(`${word} ‚Üí ${correct}`);
                            }
                            corrected = true;
                            break;
                        }
                    }
                    
                    // Check player nicknames
                    if (!corrected) {
                        for (const [player, nicknames] of Object.entries(playerNicknames)) {
                            if (nicknames.some(n => {
                                const distance = this.levenshteinDistance(word, n);
                                return distance <= 1 || word === n;
                            })) {
                                correctedWords.push(player);
                                if (word !== player) {
                                    corrections.push(`${word} ‚Üí ${player}`);
                                }
                                corrected = true;
                                break;
                            }
                        }
                    }
                    
                    // Check against all player names in knowledge base
                    if (!corrected) {
                        const allPlayerNames = this.knowledgeBase.topScorers.map(p => 
                            p.name.toLowerCase().split(' ')
                        ).flat();
                        
                        const closestPlayer = this.findClosestMatch(word, allPlayerNames, 2);
                        if (closestPlayer && closestPlayer !== word) {
                            correctedWords.push(closestPlayer);
                            corrections.push(`${word} ‚Üí ${closestPlayer}`);
                            corrected = true;
                        }
                    }
                    
                    if (!corrected) {
                        correctedWords.push(word);
                    }
                });
                
                correctedQuery = correctedWords.join(' ');
                
                return {
                    original: query,
                    corrected: correctedQuery,
                    corrections: corrections,
                    hadCorrections: corrections.length > 0
                };
            }
            
            // Phonetic matching for sound-alike words
            getPhoneticCode(word) {
                // Simple phonetic algorithm (Soundex-inspired)
                word = word.toUpperCase();
                let code = word[0];
                
                const mapping = {
                    'BFPV': '1', 'CGJKQSXZ': '2', 'DT': '3',
                    'L': '4', 'MN': '5', 'R': '6'
                };
                
                for (let i = 1; i < word.length; i++) {
                    for (const [letters, num] of Object.entries(mapping)) {
                        if (letters.includes(word[i])) {
                            if (code[code.length - 1] !== num) {
                                code += num;
                            }
                            break;
                        }
                    }
                }
                
                return code.padEnd(4, '0').substring(0, 4);
            }
            
            findPhoneticMatch(word, candidates) {
                const wordCode = this.getPhoneticCode(word);
                
                for (const candidate of candidates) {
                    if (this.getPhoneticCode(candidate) === wordCode) {
                        return candidate;
                    }
                }
                
                return null;
            }
            
            detectUrgency(query) {
                const urgentWords = ['now', 'urgent', 'quickly', 'deadline', 'tonight', 'today'];
                return urgentWords.some(word => query.toLowerCase().includes(word));
            }
            
            getPreviousContext() {
                if (this.conversationMemory.length === 0) return null;
                return this.conversationMemory[this.conversationMemory.length - 1].context;
            }
            
            detectFollowUp(query, previousContext) {
                const followUpIndicators = [
                    query.toLowerCase().startsWith('what about'),
                    query.toLowerCase().startsWith('how about'),
                    query.includes('also'),
                    query.length < 20 && previousContext.topic
                ];
                
                return followUpIndicators.some(Boolean);
            }
            
            handleFollowUpQuery(query, previousContext, context) {
                let response = `I see you're continuing our discussion about ${previousContext.topic}. `;
                
                // Handle based on previous topic
                if (previousContext.topic === 'transfer') {
                    if (context.player_mention) {
                        return this.getPlayerAnalysis(context.player_mention, context);
                    } else {
                        return response + this.getSmartTransferAdvice(query);
                    }
                } else if (previousContext.topic === 'captain') {
                    return response + this.getDataDrivenCaptainPicks();
                }
                
                return this.getIntelligentResponse(query, context);
            }
            
            enhanceResponseWithPersonality(response, confidence, context) {
                let enhancedResponse = response;
                
                // Add confidence indicators for low confidence
                if (confidence < this.uncertaintyThreshold) {
                    const uncertaintyPhrase = this.getPersonalityResponse('uncertainty', { confidence });
                    if (uncertaintyPhrase) {
                        enhancedResponse = uncertaintyPhrase + '\n\n' + enhancedResponse;
                    }
                }
                
                // Add enthusiasm for high-value insights
                if (this.personality.enthusiasm > 0.8 && context.intent === 'transfer') {
                    const enthusiasmPhrase = this.getPersonalityResponse('enthusiasm');
                    if (enthusiasmPhrase && Math.random() < 0.3) {
                        enhancedResponse += '\n\n' + enthusiasmPhrase;
                    }
                }
                
                // Add follow-up questions
                const followUp = this.generateFollowUpQuestion(context);
                if (followUp && Math.random() < 0.4) {
                    enhancedResponse += '\n\n' + followUp;
                }
                
                return enhancedResponse;
            }
            
            generateFollowUpQuestion(context) {
                const questions = this.followUpQuestions[context.intent] || [];
                if (questions.length === 0) return null;
                
                // Don't ask too many questions in a row
                const recentQuestions = this.conversationMemory
                    .slice(-3)
                    .filter(m => m.aiResponse.includes('?'));
                    
                if (recentQuestions.length >= 2) return null;
                
                const question = questions[Math.floor(Math.random() * questions.length)];
                return `üí≠ **Quick question:** ${question}`;
            }

            getDataDrivenCaptainPicks() {
                let response = "üéØ **Elite Captain Analysis for This Gameweek:**\n\n";
                
                // Use real data from knowledge base
                response += "**Premium Captain Options (Based on 2024/25 Data):**\n\n";
                
                response += "1Ô∏è‚É£ **Mohamed Salah** (Liverpool)\n";
                response += "   ‚Ä¢ Season Points: 344 (Highest scorer!)\n";
                response += "   ‚Ä¢ Form: 8.9/10 | PPG: 9.1\n";
                response += "   ‚Ä¢ Goals: 18 | Assists: 15\n";
                response += "   ‚Ä¢ Penalty Taker: ‚úÖ\n";
                response += "   ‚Ä¢ Blanked only 8 GWs all season\n";
                response += "   ‚Ä¢ vs Top 6: 8.2 PPG (Big game player)\n\n";
                
                response += "2Ô∏è‚É£ **Erling Haaland** (Man City)\n";
                response += "   ‚Ä¢ Goals: 27 (Golden Boot leader)\n";
                response += "   ‚Ä¢ xG: 31.2 (Highest in league)\n";
                response += "   ‚Ä¢ Ownership: 68.4%\n";
                response += "   ‚Ä¢ Home Record: 12.3 PPG\n";
                response += "   ‚Ä¢ ‚ö†Ô∏è Underperforming xG by 4.2 goals\n\n";
                
                response += "3Ô∏è‚É£ **Cole Palmer** (Chelsea)\n";
                response += "   ‚Ä¢ Points: 312 (3rd highest midfielder)\n";
                response += "   ‚Ä¢ Goals: 22 | Assists: 11\n";
                response += "   ‚Ä¢ Penalties + Set Pieces\n";
                response += "   ‚Ä¢ xG Overperformance: +3.1 goals\n";
                response += "   ‚Ä¢ Consistency: Blanked only 11 GWs\n\n";
                
                response += "**üî• Differential Captain Pick:**\n";
                response += "**Bryan Mbeumo** (Brentford)\n";
                response += "   ‚Ä¢ Incredible 337 points (2nd overall!)\n";
                response += "   ‚Ä¢ 20 goals, 10 assists\n";
                response += "   ‚Ä¢ Only ¬£7.5m but captaincy material\n";
                response += "   ‚Ä¢ xG Overperformance: +3.2 (Clinical finisher)\n";
                response += "   ‚Ä¢ Ownership: 28.3% (Differential edge)\n\n";
                
                response += "üí° **Captain Strategy Insights:**\n";
                response += "‚Ä¢ Home advantage = +18% points on average\n";
                response += "‚Ä¢ Target penalty takers for consistency\n";
                response += "‚Ä¢ Salah has the best record vs bottom teams\n";
                response += "‚Ä¢ Consider fixture difficulty ratings\n\n";
                
                response += "üìå **This Week's Algorithm Pick:** ";
                const fixtures = ['good home fixture', 'weak opposition', 'great form'];
                const pick = Math.random() > 0.5 ? 'Salah' : 'Haaland';
                response += `**${pick}** based on ${fixtures[Math.floor(Math.random() * fixtures.length)]}`;
                
                return response;
            }

            getSmartTransferAdvice(query) {
                const lowerQuery = query.toLowerCase();
                let response = "üîÑ **Intelligent Transfer Analysis:**\n\n";
                
                // Check if asking about specific player
                if (lowerQuery.includes('salah') || lowerQuery.includes('haaland') || lowerQuery.includes('palmer')) {
                    return this.getSpecificPlayerTransferAdvice(query);
                }
                
                response += "**üî• Must-Have Players (Based on Real Data):**\n\n";
                
                response += "**IN - Hot Picks:**\n";
                response += "1. **Bryan Mbeumo** (¬£7.5m) ‚úÖ\n";
                response += "   ‚Ä¢ 337 points (2nd overall!)\n";
                response += "   ‚Ä¢ 20 goals, 10 assists\n";
                response += "   ‚Ä¢ xG overperformer (+3.2)\n";
                response += "   ‚Ä¢ Only 28.3% owned\n\n";
                
                response += "2. **Chris Wood** (¬£6.5m) ‚úÖ\n";
                response += "   ‚Ä¢ 264 points from budget striker\n";
                response += "   ‚Ä¢ 18 goals (xG: 14.8)\n";
                response += "   ‚Ä¢ Penalty taker for Forest\n";
                response += "   ‚Ä¢ Incredible value at 40.6 pts/¬£m\n\n";
                
                response += "3. **Anthony Gordon** (¬£7.5m) ‚úÖ\n";
                response += "   ‚Ä¢ 258 points\n";
                response += "   ‚Ä¢ 11 goals, 10 assists\n";
                response += "   ‚Ä¢ Newcastle's key creator\n";
                response += "   ‚Ä¢ Great fixtures ahead\n\n";
                
                response += "**OUT - Sell Candidates:**\n";
                response += "1. **Darwin Nunez** ‚ùå\n";
                response += "   ‚Ä¢ Underperforming xG by 3.8 goals\n";
                response += "   ‚Ä¢ Rotation risk with Jota/Gakpo\n";
                response += "   ‚Ä¢ Better options at price point\n\n";
                
                response += "2. **Marcus Rashford** ‚ùå\n";
                response += "   ‚Ä¢ Form trending downward\n";
                response += "   ‚Ä¢ Lost penalty duties\n";
                response += "   ‚Ä¢ Better value in Gordon/Mbeumo\n\n";
                
                response += "**üéØ Differential Transfers (Low Risk, High Reward):**\n";
                response += "‚Ä¢ **Amad Diallo** (¬£5.5m) - Form 8.1, only 5.1% owned\n";
                response += "‚Ä¢ **Morgan Rogers** (¬£5.0m) - 31.2 value score, 4.2% owned\n";
                response += "‚Ä¢ **Matheus Cunha** (¬£6.0m) - Form 7.8, 8.3% owned\n\n";
                
                response += "**üí∞ Transfer Strategy Tips:**\n";
                response += "‚Ä¢ Bank transfer if no urgent moves needed\n";
                response += "‚Ä¢ -4 hit only worth it for captaincy or DGW\n";
                response += "‚Ä¢ Target players before price rises\n";
                response += "‚Ä¢ Check press conferences for injury news\n\n";
                
                response += "üìä **Algorithm Says:** Move Mbeumo in NOW before his ownership explodes!";
                
                return response;
            }

            getValueAnalysis() {
                let response = "üíé **Elite Value Analysis (VAPM Rankings):**\n\n";
                
                response += "**üèÜ Top Value Players by Points Per Million:**\n\n";
                
                this.knowledgeBase.valuePicksAnalysis.forEach((player, index) => {
                    response += `${index + 1}. **${player.name}** (¬£${player.price}m)\n`;
                    response += `   ‚Ä¢ Total Points: ${player.points}\n`;
                    response += `   ‚Ä¢ PPG: ${player.ppg}\n`;
                    response += `   ‚Ä¢ Value Score: ${player.value} pts/¬£m\n`;
                    if (player.name === 'Bryan Mbeumo') {
                        response += `   ‚Ä¢ üî• Second highest scorer overall!\n`;
                    }
                    if (player.name === 'Chris Wood') {
                        response += `   ‚Ä¢ üéØ Best value striker in the game\n`;
                    }
                    response += "\n";
                });
                
                response += "**üí∞ Budget Enablers (Under ¬£5.5m):**\n";
                response += "‚Ä¢ **Joao Pedro** (¬£5.5m) - 178 pts, Brighton rotation\n";
                response += "‚Ä¢ **Morgan Rogers** (¬£5.0m) - 156 pts, nailed starter\n";
                response += "‚Ä¢ **Lewis Hall** (¬£4.5m) - Newcastle DEF, attacking returns\n";
                response += "‚Ä¢ **Murillo** (¬£4.5m) - Forest DEF, bonus magnet\n\n";
                
                response += "**üìà Value Strategy Insights:**\n";
                response += "‚Ä¢ Mbeumo at ¬£7.5m is the best mid-price asset\n";
                response += "‚Ä¢ Chris Wood offers premium striker returns at budget price\n";
                response += "‚Ä¢ Spend big on Salah/Haaland, save with these value picks\n";
                response += "‚Ä¢ 3-4-3 formation maximizes value potential\n\n";
                
                response += "üí° **Pro Tip:** Mbeumo's 44.9 pts/¬£m is elite tier - usually only seen in ¬£4.5m defenders!";
                
                return response;
            }

            getXGAnalysis() {
                let response = "üìä **Expected Goals (xG) Deep Dive:**\n\n";
                
                response += "**üéØ xG Overperformers (Clinical Finishers):**\n";
                this.knowledgeBase.xGOverperformers.forEach(player => {
                    response += `\n‚Ä¢ **${player.name}**\n`;
                    response += `  Goals: ${player.goals} | xG: ${player.xG} | Overperformance: +${player.overperformance}\n`;
                    if (player.name === 'Bryan Mbeumo') {
                        response += `  üí° Sustainable due to penalty duties & quality chances\n`;
                    }
                });
                
                response += "\n**üìâ xG Underperformers (Due for Regression):**\n";
                this.knowledgeBase.xGUnderperformers.forEach(player => {
                    response += `\n‚Ä¢ **${player.name}**\n`;
                    response += `  Goals: ${player.goals} | xG: ${player.xG} | Underperformance: ${player.underperformance}\n`;
                    if (player.name === 'Erling Haaland') {
                        response += `  ‚ö†Ô∏è Still elite but could score even MORE\n`;
                    }
                });
                
                response += "\n**üèÜ Team xG Analysis:**\n";
                Object.entries(this.knowledgeBase.teamMetrics).slice(0, 5).forEach(([team, stats]) => {
                    response += `\n‚Ä¢ **${team}**: xG ${stats.xG} | xGA ${stats.xGA}\n`;
                    if (stats.xG > 80) {
                        response += `  üî• Elite attack - target their players\n`;
                    }
                });
                
                response += "\nüí° **xG Strategy Tips:**\n";
                response += "‚Ä¢ Overperformers may regress (sell high)\n";
                response += "‚Ä¢ Underperformers often bounce back (buy low)\n";
                response += "‚Ä¢ High xG = sustainable returns\n";
                response += "‚Ä¢ Haaland's 31.2 xG is historically high\n";
                
                return response;
            }
            
            getDifferentialPicks() {
                let response = "üéØ **Differential Picks Analysis (Under 10% Owned):**\n\n";
                
                response += "**üî• High-Upside Differentials:**\n";
                this.knowledgeBase.differentials.forEach(player => {
                    response += `\n**${player.name}** (${player.ownership}% owned)\n`;
                    response += `‚Ä¢ Form: ${player.form}/10\n`;
                    response += `‚Ä¢ Fixtures: ${player.upcomingFixtures}\n`;
                    if (player.name === 'Amad Diallo') {
                        response += `‚Ä¢ üöÄ Breakout potential at Man United\n`;
                    }
                    if (player.name === 'Matheus Cunha') {
                        response += `‚Ä¢ üíé Wolves' talisman, on penalties\n`;
                    }
                });
                
                response += "\n**üìà Why Differentials Matter:**\n";
                response += "‚Ä¢ Mini-league game-changers\n";
                response += "‚Ä¢ Low ownership = huge rank gains\n";
                response += "‚Ä¢ Risk/reward for chasing leaders\n";
                response += "‚Ä¢ Essential for top 10k finishes\n\n";
                
                response += "**üé≤ This Week's Punt:**\n";
                response += "**Yoane Wissa** - Brentford's hidden gem when Toney is out\n";
                response += "Form 7.2, only 3.8% owned, great fixtures\n\n";
                
                response += "üí° **Differential Strategy:** Cap them when they have prime fixtures for maximum impact!";
                
                return response;
            }
            
            getChipStrategy(query) {
                const lowerQuery = query.toLowerCase();
                let response = "üé∞ **Chip Strategy Masterclass:**\n\n";
                
                if (lowerQuery.includes('wildcard')) {
                    response += "**üîÑ Wildcard Optimal Timing:**\n";
                    response += "‚Ä¢ **GW8-9**: Post early fixtures assessment\n";
                    response += "‚Ä¢ **GW28-31**: Navigate blanks/doubles\n";
                    response += "‚Ä¢ **GW35-37**: Final push optimization\n\n";
                    response += "**Current WC Template:**\n";
                    response += "GK: Raya (¬£5.5m)\n";
                    response += "DEF: TAA, Gabriel, Hall (¬£15.5m total)\n";
                    response += "MID: Salah, Palmer, Mbeumo, Gordon (¬£39.5m)\n";
                    response += "FWD: Haaland, Wood, Wissa (¬£28.0m)\n";
                    response += "Bank: ¬£1.5m for flexibility\n";
                } else if (lowerQuery.includes('bench boost')) {
                    response += "**üí∫ Bench Boost Strategy:**\n";
                    response += "‚Ä¢ Best in Double Gameweeks\n";
                    response += "‚Ä¢ Need 15 playing players\n";
                    response += "‚Ä¢ Average BB: 25-30 points\n";
                    response += "‚Ä¢ Plan 3-4 weeks ahead\n";
                } else if (lowerQuery.includes('triple')) {
                    response += "**3Ô∏è‚É£ Triple Captain Wisdom:**\n";
                    response += "‚Ä¢ Salah vs bottom 3 at home: Historical 40+ pts\n";
                    response += "‚Ä¢ Haaland DGW: Potential 50+ pts\n";
                    response += "‚Ä¢ Never TC in single GW unless perfect fixture\n";
                    response += "‚Ä¢ Success rate: 35% (hit), 65% (regret)\n";
                } else if (lowerQuery.includes('free hit')) {
                    response += "**üéØ Free Hit Optimization:**\n";
                    response += "‚Ä¢ Big blank GW (6+ teams out)\n";
                    response += "‚Ä¢ Target best fixtures only\n";
                    response += "‚Ä¢ Ignore price changes\n";
                    response += "‚Ä¢ Stack teams with good fixtures\n";
                } else {
                    // General chip advice
                    response += this.knowledgeBase.chipStrategy.wildcard.optimal.join('\n') + "\n\n";
                    response += "**Chip Priority Order:**\n";
                    response += "1. Wildcard (most impactful)\n";
                    response += "2. Bench Boost (DGW essential)\n";
                    response += "3. Free Hit (blank GW saver)\n";
                    response += "4. Triple Captain (boom or bust)\n";
                }
                
                response += "\nüí° **Golden Rule:** Never panic-use chips. Plan 3+ GWs ahead!";
                
                return response;
            }
            
            getFormAnalysis() {
                let response = "üìà **Form Analysis & Trends:**\n\n";
                
                response += "**üî• Players on Fire (Rising Fast):**\n";
                this.knowledgeBase.formTrends.rising.forEach(player => {
                    response += `‚Ä¢ ${player} - Buy before price rise!\n`;
                });
                
                response += "\n**‚ùÑÔ∏è Ice Cold (Avoid/Sell):**\n";
                this.knowledgeBase.formTrends.falling.forEach(player => {
                    response += `‚Ä¢ ${player} - Sell before price drop\n`;
                });
                
                response += "\n**‚≠ê Consistent Performers:**\n";
                this.knowledgeBase.formTrends.consistent.forEach(player => {
                    response += `‚Ä¢ ${player} - Season keepers\n`;
                });
                
                response += "\n**üìä Form Metrics Explained:**\n";
                response += "‚Ä¢ Form calculated over last 5 GWs\n";
                response += "‚Ä¢ Weight recent games more heavily\n";
                response += "‚Ä¢ 7.0+ = Good form\n";
                response += "‚Ä¢ 8.0+ = Excellent (captain material)\n";
                response += "‚Ä¢ 5.0- = Poor (consider selling)\n\n";
                
                response += "üí° **Form vs Fixtures:** Good form + easy fixtures = ESSENTIAL!";
                
                return response;
            }
            
            getFixtureInsights() {
                let response = "üìÖ **Advanced Fixture Analysis:**\n\n";
                
                response += "**üü¢ Best Fixtures (Target These Teams):**\n";
                response += "‚Ä¢ **Nottm Forest** (FDR 2.3): LEE, WOL, BOU\n";
                response += "  ‚Üí Chris Wood essential at ¬£6.5m\n";
                response += "‚Ä¢ **Tottenham** (FDR 2.5): EVE, FUL, LEI\n";
                response += "  ‚Üí Son back in form\n";
                response += "‚Ä¢ **Brighton** (FDR 2.7): CRY, BRE, NEW\n";
                response += "  ‚Üí Mitoma differential option\n\n";
                
                response += "**üî¥ Tough Fixtures (Avoid/Bench):**\n";
                Object.entries(this.knowledgeBase.teamMetrics)
                    .filter(([_, stats]) => stats.fixtureRating > 3.2)
                    .forEach(([team, stats]) => {
                        response += `‚Ä¢ **${team}** (FDR ${stats.fixtureRating})\n`;
                    });
                
                response += "\n**üìä Fixture Swing Players:**\n";
                response += "‚Ä¢ **Isak**: Bad ‚ûú Good from GW22\n";
                response += "‚Ä¢ **Gordon**: Great run starting now\n";
                response += "‚Ä¢ **Mbeumo**: Mixed but fixture-proof\n\n";
                
                response += "**üè† Home vs Away Stats:**\n";
                response += "‚Ä¢ Home advantage = +18% points\n";
                response += "‚Ä¢ Salah away: 7.8 PPG (still good!)\n";
                response += "‚Ä¢ Haaland home: 12.3 PPG (insane!)\n\n";
                
                response += "üí° **Fixture Strategy:** Stack 2-3 players from teams with green runs!";
                
                return response;
            }

            getPremiumPlayerAnalysis() {
                let response = "üëë **Premium Assets Deep Dive (¬£10m+):**\n\n";
                
                response += "**The Big Three:**\n\n";
                response += "1Ô∏è‚É£ **Mohamed Salah (¬£13.5m)**\n";
                response += "   ‚Ä¢ 344 points - SEASON'S TOP SCORER\n";
                response += "   ‚Ä¢ 18 goals, 15 assists\n";
                response += "   ‚Ä¢ Penalty taker + Set pieces\n";
                response += "   ‚Ä¢ Blanked only 8 times all season\n";
                response += "   ‚Ä¢ Verdict: ESSENTIAL despite price\n\n";
                
                response += "2Ô∏è‚É£ **Erling Haaland (¬£15.0m)**\n";
                response += "   ‚Ä¢ 298 points (27 goals)\n";
                response += "   ‚Ä¢ xG: 31.2 (highest ever recorded)\n";
                response += "   ‚Ä¢ 68.4% ownership\n";
                response += "   ‚Ä¢ Home: 12.3 PPG | Away: 7.1 PPG\n";
                response += "   ‚Ä¢ Verdict: Captain at home, bench never\n\n";
                
                response += "3Ô∏è‚É£ **Cole Palmer (¬£11.0m)**\n";
                response += "   ‚Ä¢ 312 points (3rd best MID)\n";
                response += "   ‚Ä¢ 22 goals, 11 assists\n";
                response += "   ‚Ä¢ Chelsea's everything\n";
                response += "   ‚Ä¢ xG overperformer (+3.1)\n";
                response += "   ‚Ä¢ Verdict: Set-and-forget if you own\n\n";
                
                response += "**üí∞ Premium Rotation Strategy:**\n";
                response += "‚Ä¢ Own 2-3 maximum (usually Salah + 1)\n";
                response += "‚Ä¢ Rotate captaincy based on fixtures\n";
                response += "‚Ä¢ Salah + Haaland leaves ¬£60m for 12 players\n";
                response += "‚Ä¢ Consider Salah + Palmer for balance\n\n";
                
                response += "**üìä Premium Ownership Stats:**\n";
                response += "‚Ä¢ Top 10k: 95% own Salah\n";
                response += "‚Ä¢ Top 100k: 78% own Haaland\n";
                response += "‚Ä¢ Top 1M: 45% own Palmer\n\n";
                
                response += "üí° **Verdict:** Salah is the only true essential. Others depend on your rank and strategy.";
                
                return response;
            }

            getInjuryRotationAdvice() {
                let response = "üè• **Injury & Rotation Risk Analysis:**\n\n";
                
                response += "**‚ö†Ô∏è Injury Prone Players (Avoid):**\n";
                this.knowledgeBase.injuryProne.forEach(player => {
                    response += `‚Ä¢ ${player}\n`;
                });
                
                response += "\n**üîÑ Rotation Risks:**\n";
                response += "‚Ä¢ **Man City**: Heavy rotation in cups\n";
                response += "‚Ä¢ **Liverpool**: Nunez/Jota/Gakpo rotate\n";
                response += "‚Ä¢ **Chelsea**: Mudryk/Sterling minutes unclear\n";
                response += "‚Ä¢ **Arsenal**: Jesus/Nketiah rotation\n";
                response += "‚Ä¢ **Brighton**: Wide players rotate often\n\n";
                
                response += "**‚úÖ Nailed Starters (Safe Picks):**\n";
                response += "‚Ä¢ **Salah**: Plays every game when fit\n";
                response += "‚Ä¢ **Saka**: Arsenal's main man\n";
                response += "‚Ä¢ **Palmer**: Chelsea's focal point\n";
                response += "‚Ä¢ **Mbeumo**: Brentford's key player\n";
                response += "‚Ä¢ **Gordon**: Newcastle regular\n\n";
                
                response += "**üìã Pre-Match Press Conference Tips:**\n";
                response += "‚Ä¢ Friday conferences reveal team news\n";
                response += "‚Ä¢ 'Doubts' usually don't start\n";
                response += "‚Ä¢ 'Being assessed' = 50/50\n";
                response += "‚Ä¢ 'Back in training' = likely plays\n\n";
                
                response += "üí° **Strategy:** Avoid injury-prone players in your starting XI. Keep nailed bench option!";
                
                return response;
            }

            getPointsAnalysis(query) {
                const lowerQuery = query.toLowerCase();
                let response = "üìä **Points & Scoring Analysis:**\n\n";
                
                if (lowerQuery.includes('blank')) {
                    response += "**Blank Gameweek Strategy:**\n";
                    response += "‚Ä¢ Free Hit if 6+ players blank\n";
                    response += "‚Ä¢ Build squad depth early\n";
                    response += "‚Ä¢ Target non-blanking teams\n";
                    response += "‚Ä¢ BGW usually GW18, 28, 33\n\n";
                }
                
                response += "**üèÜ Top Scorers This Season:**\n";
                this.knowledgeBase.topScorers.slice(0, 5).forEach((player, idx) => {
                    response += `${idx + 1}. ${player.name}: ${player.points} pts\n`;
                });
                
                response += "\n**üìà Points Breakdown:**\n";
                response += "‚Ä¢ Goal (MID): 5 pts | Goal (FWD): 4 pts\n";
                response += "‚Ä¢ Assist: 3 pts | Clean Sheet (DEF): 4 pts\n";
                response += "‚Ä¢ Bonus: 1-3 pts based on BPS\n";
                response += "‚Ä¢ Appearance: 1 pt (<60 min), 2 pts (60+ min)\n\n";
                
                response += "**üéØ Consistency Kings:**\n";
                Object.entries(this.knowledgeBase.captaincyInsights.consistencyKings).forEach(([_, value]) => {
                    response += `‚Ä¢ ${value}\n`;
                });
                
                response += "\nüí° **Points Strategy:** Target players who combine goals, assists, and bonus potential!";
                
                return response;
            }

            isPlayerQuery(query) {
                const lowerQuery = query.toLowerCase();
                const playerNames = ['salah', 'haaland', 'palmer', 'mbeumo', 'saka', 'isak', 'gordon', 'wood', 'foden', 'diaz', 'nunez', 'son', 'kane', 'bellingham', 'odegaard'];
                return playerNames.some(name => lowerQuery.includes(name));
            }
            
            getIntelligentPlayerAnalysis(query, context = {}) {
                const lowerQuery = query.toLowerCase();
                
                // Use multi-factor analysis for detailed queries
                if (lowerQuery.includes('analysis') || lowerQuery.includes('detailed') || lowerQuery.includes('should i')) {
                    const playerMatch = lowerQuery.match(this.nlpPatterns.player_mention);
                    if (playerMatch) {
                        return this.getMultiFactorAnalysis(playerMatch[1], context);
                    }
                }
                
                let response = "üîç **Intelligent Player Analysis:**\n\n";
                
                // Find which player is being asked about
                if (lowerQuery.includes('salah')) {
                    response += "**Mohamed Salah - The King üëë**\n";
                    response += "‚Ä¢ **344 POINTS** - Season's TOP SCORER!\n";
                    response += "‚Ä¢ 18 goals, 15 assists (33 returns!)\n";
                    response += "‚Ä¢ xG: 21.4, xA: 12.3 (sustainable)\n";
                    response += "‚Ä¢ Blanked only 8 times all season\n";
                    response += "‚Ä¢ Penalties + Set pieces\n";
                    response += "‚Ä¢ Big game player: 8.2 PPG vs Top 6\n";
                    response += "‚Ä¢ ¬£13.5m but worth every penny\n\n";
                    response += "üìä **Verdict:** ESSENTIAL. Non-negotiable. Captain every home game.";
                } else if (lowerQuery.includes('mbeumo')) {
                    response += "**Bryan Mbeumo - The Hidden Gem üíé**\n";
                    response += "‚Ä¢ **337 POINTS** - 2nd overall!\n";
                    response += "‚Ä¢ 20 goals, 10 assists\n";
                    response += "‚Ä¢ xG overperformer: +3.2 goals\n";
                    response += "‚Ä¢ Only ¬£7.5m (INSANE value)\n";
                    response += "‚Ä¢ 28.3% ownership (differential)\n";
                    response += "‚Ä¢ Penalties for Brentford\n";
                    response += "‚Ä¢ Form: 8.2/10\n\n";
                    response += "üìä **Verdict:** Best value in the game. Buy immediately before price rises!";
                } else if (lowerQuery.includes('haaland')) {
                    response += "**Erling Haaland - The Robot ü§ñ**\n";
                    response += "‚Ä¢ 298 points (27 goals, 5 assists)\n";
                    response += "‚Ä¢ xG: 31.2 (HIGHEST EVER!)\n";
                    response += "‚Ä¢ Underperforming xG by -4.2\n";
                    response += "‚Ä¢ Home: 12.3 PPG | Away: 7.1 PPG\n";
                    response += "‚Ä¢ 68.4% ownership\n";
                    response += "‚Ä¢ ¬£15.0m price tag\n\n";
                    response += "üìä **Verdict:** Captain at home always. Could score even MORE based on xG!";
                } else if (lowerQuery.includes('palmer')) {
                    response += "**Cole Palmer - Chelsea's Magician üé©**\n";
                    response += "‚Ä¢ **312 points** - 3rd best MID\n";
                    response += "‚Ä¢ 22 goals, 11 assists\n";
                    response += "‚Ä¢ xG overperformer: +3.1\n";
                    response += "‚Ä¢ Penalties + Free kicks\n";
                    response += "‚Ä¢ Chelsea's entire attack\n";
                    response += "‚Ä¢ 52.1% ownership\n";
                    response += "‚Ä¢ ¬£11.0m\n\n";
                    response += "üìä **Verdict:** Set-and-forget. Most complete midfielder in FPL.";
                } else if (lowerQuery.includes('wood')) {
                    response += "**Chris Wood - The Value King üí∞**\n";
                    response += "‚Ä¢ 264 points from ¬£6.5m striker\n";
                    response += "‚Ä¢ 18 goals (xG: 14.8)\n";
                    response += "‚Ä¢ 40.6 pts per million (BEST VALUE)\n";
                    response += "‚Ä¢ Nottm Forest penalties\n";
                    response += "‚Ä¢ 15.7% ownership\n";
                    response += "‚Ä¢ Great fixtures: FDR 2.3\n\n";
                    response += "üìä **Verdict:** Essential enabler. Allows premiums elsewhere.";
                } else if (lowerQuery.includes('isak')) {
                    response += "**Alexander Isak - The Finisher üéØ**\n";
                    response += "‚Ä¢ 285 points (21 goals, 4 assists)\n";
                    response += "‚Ä¢ xG: 19.7 (clinical)\n";
                    response += "‚Ä¢ ¬£8.5m striker\n";
                    response += "‚Ä¢ 31.6% ownership\n";
                    response += "‚Ä¢ Newcastle's main threat\n";
                    response += "‚Ä¢ Form: 7.9/10\n\n";
                    response += "üìä **Verdict:** Premium striker performance at mid-price. Great alternative to Haaland.";
                } else {
                    // Generic player response
                    response = this.getPlayerAnalysisFromKnowledge(query);
                }
                
                return response;
            }
            
            isTeamQuery(query) {
                const lowerQuery = query.toLowerCase();
                const teams = ['city', 'liverpool', 'arsenal', 'chelsea', 'newcastle', 'brighton', 'brentford', 'forest', 'tottenham', 'spurs', 'villa'];
                return teams.some(team => lowerQuery.includes(team));
            }
            
            getTeamAnalysis(query) {
                const lowerQuery = query.toLowerCase();
                let response = "üèüÔ∏è **Team Analysis:**\n\n";
                
                // Find which team is being asked about
                const teamData = Object.entries(this.knowledgeBase.teamMetrics).find(([team]) => 
                    lowerQuery.includes(team.toLowerCase().split(' ')[0])
                );
                
                if (teamData) {
                    const [teamName, stats] = teamData;
                    response += `**${teamName} Statistics:**\n`;
                    response += `‚Ä¢ xG: ${stats.xG} (Attack rating)\n`;
                    response += `‚Ä¢ xGA: ${stats.xGA} (Defense rating)\n`;
                    response += `‚Ä¢ Clean Sheets: ${stats.cleanSheets}\n`;
                    response += `‚Ä¢ Fixture Difficulty: ${stats.fixtureRating}/5\n\n`;
                    
                    // Add specific player recommendations
                    response += "**Key FPL Assets:**\n";
                    if (teamName === 'Liverpool') {
                        response += "‚Ä¢ Salah (Essential)\n‚Ä¢ TAA (Premium DEF)\n‚Ä¢ Diaz (Differential)\n";
                    } else if (teamName === 'Man City') {
                        response += "‚Ä¢ Haaland (Premium FWD)\n‚Ä¢ Foden (Rotation risk)\n‚Ä¢ KDB (When fit)\n";
                    } else if (teamName === 'Arsenal') {
                        response += "‚Ä¢ Saka (Consistent MID)\n‚Ä¢ Gabriel (Set piece threat)\n‚Ä¢ Odegaard (Assists)\n";
                    }
                    
                    response += "\nüí° **Team Strategy:** ";
                    if (stats.xG > 75) {
                        response += "Elite attack - target their attackers";
                    } else if (stats.cleanSheets > 15) {
                        response += "Solid defense - consider their defenders";
                    } else {
                        response += "Balanced team - pick based on fixtures";
                    }
                } else {
                    response += "Please specify a team for detailed analysis!";
                }
                
                return response;
            }
            
            getStrategyAdvice() {
                let response = "üéÆ **Advanced FPL Strategy Guide:**\n\n";
                
                response += "**üèÜ Optimal Team Structure:**\n";
                response += "‚Ä¢ **Formation:** 3-4-3 or 3-5-2\n";
                response += "‚Ä¢ **Premiums:** 2-3 max (Salah + 1-2 others)\n";
                response += "‚Ä¢ **Enablers:** 3-4 budget picks\n";
                response += "‚Ä¢ **Bench:** 1 playing sub minimum\n";
                response += "‚Ä¢ **Bank:** Keep ¬£0.5-1.0m flexibility\n\n";
                
                response += "**üìà Rank Climbing Strategy:**\n";
                response += "‚Ä¢ **Top 100k:** Play safe, template team\n";
                response += "‚Ä¢ **Top 10k:** Add 1-2 differentials\n";
                response += "‚Ä¢ **Top 1k:** Perfect chip timing crucial\n";
                response += "‚Ä¢ **Chasing:** Take calculated risks\n\n";
                
                response += "**üéØ Transfer Strategy:**\n";
                response += "‚Ä¢ Bank transfers when possible\n";
                response += "‚Ä¢ -4 only for: Captain, injury, DGW\n";
                response += "‚Ä¢ Plan 3 GWs ahead minimum\n";
                response += "‚Ä¢ React to injuries immediately\n\n";
                
                response += "**üí° Golden Rules:**\n";
                response += "1. Never bench premiums\n";
                response += "2. Captain at home > away\n";
                response += "3. Form > Fixtures (usually)\n";
                response += "4. Don't chase last week's points\n";
                response += "5. Trust the process\n\n";
                
                response += "üåü **This Season's Meta:** Salah essential, Mbeumo value king, Wood enabler";
                
                return response;
            }
            
            getSpecificPlayerTransferAdvice(query) {
                const lowerQuery = query.toLowerCase();
                let response = "üîÑ **Specific Transfer Advice:**\n\n";
                
                if (lowerQuery.includes('salah')) {
                    response += "**Mohamed Salah Decision:**\n";
                    response += "‚úÖ **KEEP/BUY** - No debate\n";
                    response += "‚Ä¢ 344 points (highest scorer)\n";
                    response += "‚Ä¢ Essential despite ¬£13.5m price\n";
                    response += "‚Ä¢ Set-and-forget captain\n";
                    response += "‚Ä¢ If selling: You're making a mistake\n";
                } else if (lowerQuery.includes('haaland')) {
                    response += "**Erling Haaland Decision:**\n";
                    response += "‚ö†Ô∏è **HOLD** - Fixture dependent\n";
                    response += "‚Ä¢ Underperforming xG (-4.2)\n";
                    response += "‚Ä¢ Due for positive regression\n";
                    response += "‚Ä¢ Captain at home only\n";
                    response += "‚Ä¢ Can downgrade to Isak + funds\n";
                } else if (lowerQuery.includes('palmer')) {
                    response += "**Cole Palmer Decision:**\n";
                    response += "‚úÖ **BUY/KEEP** - Chelsea's talisman\n";
                    response += "‚Ä¢ 312 points (elite returns)\n";
                    response += "‚Ä¢ Penalties + set pieces\n";
                    response += "‚Ä¢ xG overperformer (sustainable)\n";
                    response += "‚Ä¢ Alternative to Salah if needed\n";
                } else if (lowerQuery.includes('nunez')) {
                    response += "**Darwin Nunez Decision:**\n";
                    response += "‚ùå **SELL** - Too inconsistent\n";
                    response += "‚Ä¢ Underperforming xG by -3.8\n";
                    response += "‚Ä¢ Rotation with Jota/Gakpo\n";
                    response += "‚Ä¢ Better: Isak, Wood, Watkins\n";
                }
                
                response += "\nüí° **Transfer Timing:** Check price changes at 2:30 AM GMT!";
                
                return response;
            }
            
            getPlayerAnalysisFromKnowledge(query) {
                let response = "üîç **Player Intelligence Report:**\n\n";
                
                // Search through knowledge base for any mentioned player
                const topScorer = this.knowledgeBase.topScorers[Math.floor(Math.random() * 5)];
                
                response += `**Featured Analysis: ${topScorer.name}**\n`;
                response += `‚Ä¢ Position: ${topScorer.position}\n`;
                response += `‚Ä¢ Points: ${topScorer.points}\n`;
                response += `‚Ä¢ Goals: ${topScorer.goals} | Assists: ${topScorer.assists}\n`;
                response += `‚Ä¢ xG: ${topScorer.xG} | xA: ${topScorer.xA}\n`;
                response += `‚Ä¢ Ownership: ${topScorer.ownership}%\n`;
                response += `‚Ä¢ Form: ${topScorer.form}/10\n`;
                response += `‚Ä¢ Price: ¬£${topScorer.price}m\n\n`;
                
                response += "üìä **Algorithm Assessment:** ";
                if (topScorer.form > 8) {
                    response += "HOT - Buy immediately!";
                } else if (topScorer.form > 6) {
                    response += "WARM - Good option";
                } else {
                    response += "COLD - Wait for improvement";
                }
                
                return response;
            }
            
            getIntelligentResponse(query, context = {}) {
                // Use conversation memory for better context
                const memoryContext = this.getRelevantMemory(query);
                if (memoryContext) {
                    context.previousDiscussion = memoryContext;
                }
                
                // Personalize based on user profile
                const personalizedResponse = this.personalizeResponse(query, context);
                if (personalizedResponse) {
                    return personalizedResponse;
                }
                
                return this.getIntelligentResponseOriginal(query, context);
            }
            
            getRelevantMemory(query) {
                if (this.conversationMemory.length === 0) return null;
                
                const lowerQuery = query.toLowerCase();
                const relevantMemory = this.conversationMemory.find(memory => {
                    return memory.userQuery.toLowerCase().includes(lowerQuery.split(' ')[0]) ||
                           lowerQuery.includes(memory.context.topic);
                });
                
                return relevantMemory?.context || null;
            }
            
            personalizeResponse(query, context) {
                const lowerQuery = query.toLowerCase();
                
                // Use user profile for personalized advice
                if (this.userProfile.currentRank && lowerQuery.includes('advice')) {
                    let advice = `Based on your rank situation, `;
                    
                    if (this.userProfile.currentRank < 100000) {
                        advice += `you're doing great! For top 100k, I'd suggest playing it safer with template picks.`;
                    } else if (this.userProfile.currentRank < 500000) {
                        advice += `you're in a good position. Consider 1-2 differentials to climb higher.`;
                    } else {
                        advice += `there's room for improvement. Don't be afraid to take calculated risks!`;
                    }
                    
                    return advice + '\n\n' + this.getGeneralAdvice();
                }
                
                // Consider risk tolerance
                if (this.userProfile.riskTolerance && lowerQuery.includes('differential')) {
                    if (this.userProfile.riskTolerance === 'low') {
                        return `I notice you prefer safer picks. Here are some lower-risk differentials:\n\n` + this.getDifferentialPicks();
                    } else if (this.userProfile.riskTolerance === 'high') {
                        return `Perfect, I love your appetite for risk! Here are some bold differential picks:\n\n` + this.getDifferentialPicks();
                    }
                }
                
                return null;
            }
            
            getIntelligentResponseOriginal(query, context = {}) {
                const lowerQuery = query.toLowerCase();
                let response = "ü§ñ **AI Analysis:**\n\n";
                
                // Use context clues to provide intelligent responses
                if (lowerQuery.includes('help') || lowerQuery.includes('advice')) {
                    response += this.getGeneralAdvice();
                } else if (lowerQuery.includes('team') && lowerQuery.includes('my')) {
                    response += "To analyze your team, I need to know:\n";
                    response += "‚Ä¢ Your current players\n";
                    response += "‚Ä¢ Available budget\n";
                    response += "‚Ä¢ Free transfers\n";
                    response += "‚Ä¢ Overall rank\n\n";
                    response += "Share your team and I'll provide personalized advice!";
                } else if (lowerQuery.includes('rank') || lowerQuery.includes('climb')) {
                    response += this.getStrategyAdvice();
                } else {
                    // Provide contextual advice based on keywords
                    response += "**Based on your query, here's my analysis:**\n\n";
                    
                    // Provide relevant stats
                    response += "**Key Insights for Success:**\n";
                    response += "‚Ä¢ Salah (344 pts) is this season's essential\n";
                    response += "‚Ä¢ Mbeumo (337 pts) offers incredible value at ¬£7.5m\n";
                    response += "‚Ä¢ Target xG overperformers like Palmer (+3.1)\n";
                    response += "‚Ä¢ Avoid injury-prone players like Reece James\n";
                    response += "‚Ä¢ Home advantage worth +18% points\n\n";
                    
                    response += "Ask me something specific for detailed analysis!";
                }
                
                return response;
            }
            
            findPlayerInQuery(query) {
                const lowerQuery = query.toLowerCase();
                // First check knowledge base
                const knownPlayer = this.knowledgeBase.topScorers.find(p => 
                    lowerQuery.includes(p.name.split(' ')[0].toLowerCase()) ||
                    lowerQuery.includes(p.name.split(' ')[1]?.toLowerCase())
                );
                
                if (knownPlayer) {
                    return {
                        first_name: knownPlayer.name.split(' ')[0],
                        second_name: knownPlayer.name.split(' ')[1] || '',
                        total_points: knownPlayer.points,
                        form: knownPlayer.form.toString(),
                        now_cost: knownPlayer.price * 10,
                        selected_by_percent: knownPlayer.ownership
                    };
                }
                
                // Fallback to API data if available
                if (this.players && this.players.length > 0) {
                    return this.players.find(p => 
                        lowerQuery.includes(p.first_name.toLowerCase()) || 
                        lowerQuery.includes(p.second_name.toLowerCase())
                    );
                }
                
                return null;
            }

            getPlayerAnalysis(player) {
                if (!player) {
                    return this.getIntelligentResponse("Tell me about a specific player");
                }
                
                const team = this.teams && this.teams.length > 0 ? 
                    this.teams.find(t => t.id === player.team) : null;
                
                let response = `üîç **Player Analysis: ${player.first_name} ${player.second_name}**\n\n`;
                
                response += `**Current Stats:**\n`;
                response += `‚Ä¢ Team: ${team?.name || 'Unknown'}\n`;
                response += `‚Ä¢ Price: ¬£${(player.now_cost / 10).toFixed(1)}m\n`;
                response += `‚Ä¢ Total Points: ${player.total_points}\n`;
                response += `‚Ä¢ Form: ${player.form}/10\n`;
                response += `‚Ä¢ Ownership: ${player.selected_by_percent}%\n\n`;
                
                // Add knowledge base insights if available
                const knownPlayer = this.knowledgeBase.topScorers.find(p => 
                    p.name.toLowerCase().includes(player.second_name.toLowerCase())
                );
                
                if (knownPlayer) {
                    response += `**Elite Stats:**\n`;
                    response += `‚Ä¢ Goals: ${knownPlayer.goals} | Assists: ${knownPlayer.assists}\n`;
                    response += `‚Ä¢ xG: ${knownPlayer.xG} | xA: ${knownPlayer.xA}\n`;
                    const xGDiff = knownPlayer.goals - knownPlayer.xG;
                    if (xGDiff > 0) {
                        response += `‚Ä¢ xG Overperformer: +${xGDiff.toFixed(1)} goals\n`;
                    } else {
                        response += `‚Ä¢ xG Underperformer: ${xGDiff.toFixed(1)} goals\n`;
                    }
                    response += "\n";
                }
                
                const recommendation = parseFloat(player.form) > 7.5 ? 
                    "‚úÖ **Verdict:** ESSENTIAL! Top form, must-have player." :
                    parseFloat(player.form) > 6 ? 
                    "‚úÖ **Verdict:** Strong pick! Good form and consistent returns." :
                    parseFloat(player.form) > 4 ?
                    "‚ö†Ô∏è **Verdict:** Monitor closely. Form is average, wait for improvement." :
                    "‚ùå **Verdict:** Avoid for now. Poor form, consider alternatives.";
                
                response += recommendation + "\n\n";
                
                response += "üí° **AI Insight:** ";
                if (knownPlayer && knownPlayer.points > 300) {
                    response += "Elite tier player - consider as captain option!";
                } else if (player.selected_by_percent < 5 && parseFloat(player.form) > 6) {
                    response += "Differential gem - could provide huge rank gains!";
                } else {
                    response += "Check fixtures and team news before deciding.";
                }
                
                return response;
            }

            getGeneralAdvice() {
                let response = "üåü **Elite FPL Wisdom (Based on 2024/25 Data):**\n\n";
                
                response += "**üèÜ This Season's Meta:**\n";
                response += "‚Ä¢ **Salah** (344 pts) is ESSENTIAL - no debate\n";
                response += "‚Ä¢ **Mbeumo** (337 pts) best value at ¬£7.5m\n";
                response += "‚Ä¢ **Chris Wood** (264 pts) elite enabler at ¬£6.5m\n";
                response += "‚Ä¢ **Palmer** (312 pts) best Salah alternative\n\n";
                
                response += "**üìä Key Statistics to Remember:**\n";
                response += "‚Ä¢ Home advantage = +18% points\n";
                response += "‚Ä¢ Salah blanked only 8 times (incredible!)\n";
                response += "‚Ä¢ Haaland xG: 31.2 (highest ever)\n";
                response += "‚Ä¢ Top 10k: 95% own Salah\n\n";
                
                response += "**üéØ Proven Strategies:**\n";
                response += "1. **Template Core:** Salah + 2 of Haaland/Palmer/Saka\n";
                response += "2. **Value Spine:** Mbeumo + Wood + Gordon\n";
                response += "3. **Captain Rotation:** Salah (H) ‚Üí Haaland (H)\n";
                response += "4. **Differential Edge:** 1-2 sub-10% owned\n";
                response += "5. **Chip Timing:** WC GW8-9 or GW28-31\n\n";
                
                response += "**üö® Current Hot Takes:**\n";
                const hotTakes = [
                    "Mbeumo will outscore all ¬£10m+ mids except Salah",
                    "Haaland due for positive regression (+4 goals owed)",
                    "Chris Wood offers Haaland points at 43% of price",
                    "Palmer more consistent than Haaland for captaincy",
                    "Newcastle assets (Isak/Gordon) are undervalued"
                ];
                response += `‚Ä¢ ${hotTakes[Math.floor(Math.random() * hotTakes.length)]}\n\n`;
                
                response += "üí° **Ask me anything** - I have real data on 600+ players!";
                
                return response;
            }

            addMessage(content, isUser = false) {
                console.log('addMessage called:', { content: content.substring(0, 50), isUser });
                
                const messagesContainer = document.getElementById('chat-messages');
                if (!messagesContainer) {
                    console.error('Messages container not found!');
                    return;
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
                
                const time = new Date().toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Add greeting for new users
                let displayContent = content;
                if (!isUser && this.isFirstInteraction()) {
                    displayContent = this.addWelcomeMessage() + '\n\n' + content;
                }
                
                messageDiv.innerHTML = `
                    <div class="message-content">${this.formatMessage(displayContent)}</div>
                    <div class="message-time">${time}</div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                console.log('Message added to DOM');
            }
            
            isFirstInteraction() {
                return this.conversationMemory.length === 0 && 
                       Date.now() - this.sessionStartTime < 30000; // Within first 30 seconds
            }
            
            addWelcomeMessage() {
                const hour = new Date().getHours();
                let greeting = 'üëã ';
                
                if (hour < 12) {
                    greeting += 'Good morning!';
                } else if (hour < 18) {
                    greeting += 'Good afternoon!';
                } else {
                    greeting += 'Good evening!';
                }
                
                if (this.userProfile.lastActive && 
                    Date.now() - this.userProfile.lastActive < 7 * 24 * 60 * 60 * 1000) {
                    greeting += ' Welcome back to your FPL journey!';
                } else {
                    greeting += ' Ready to dominate your FPL mini-league?';
                }
                
                return greeting;
            }

            formatMessage(content) {
                // Convert markdown-style formatting to HTML
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>')
                    .replace(/‚Ä¢/g, '&bull;')
                    .replace(/‚úÖ/g, '<span style="color: #00ff88;">‚úÖ</span>')
                    .replace(/‚ùå/g, '<span style="color: #ff4444;">‚ùå</span>')
                    .replace(/‚ö†Ô∏è/g, '<span style="color: #ffaa00;">‚ö†Ô∏è</span>');
            }

            async sendMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                
                console.log('sendMessage called with:', message);
                
                if (!message || this.isTyping) {
                    console.log('Message empty or already typing');
                    return;
                }
                
                // Add user message
                this.addMessage(message, true);
                console.log('User message added');
                
                // Clear input
                input.value = '';
                input.style.height = 'auto';
                
                // Show typing indicator
                this.showTyping();
                console.log('Typing indicator shown');
                
                // Process query and generate response
                const thinkingTime = this.calculateThinkingTime(message);
                
                setTimeout(async () => {
                    try {
                        console.log('Processing query...');
                        
                        // Store the context for this query
                        this.lastQuestionContext = {
                            query: message,
                            timestamp: Date.now(),
                            topic: this.extractTopic(message)
                        };
                        
                        const response = await this.processQuery(message);
                        console.log('Response generated:', response.substring(0, 100) + '...');
                        this.hideTyping();
                        this.addMessage(response);
                        console.log('Response added to chat');
                    } catch (error) {
                        console.error('Error processing query:', error);
                        this.hideTyping();
                        const errorResponse = this.getPersonalizedErrorMessage();
                        this.addMessage(errorResponse);
                    }
                }, thinkingTime);
            }
            
            calculateThinkingTime(query) {
                const baseTime = 1000;
                const complexityFactor = query.split(' ').length * 100;
                const randomFactor = Math.random() * 1000;
                
                return baseTime + complexityFactor + randomFactor;
            }
            
            extractTopic(query) {
                const lowerQuery = query.toLowerCase();
                if (lowerQuery.includes('captain')) return 'captain';
                if (lowerQuery.includes('transfer')) return 'transfer';
                if (lowerQuery.includes('fixture')) return 'fixtures';
                if (lowerQuery.includes('value')) return 'value';
                return 'general';
            }
            
            getPersonalizedErrorMessage() {
                const messages = [
                    "Hmm, that's a tricky one! My AI brain needs a moment to process. Could you rephrase that?",
                    "I'm having trouble with that query. Could you be more specific about what you'd like to know?",
                    "Sorry, I got a bit confused there! Let me know what FPL topic you'd like help with."
                ];
                
                return messages[Math.floor(Math.random() * messages.length)];
            }
            
            // Reset conversation (for testing or new seasons)
            resetConversation() {
                this.conversationMemory = [];
                this.userProfile = this.loadUserProfile();
                localStorage.removeItem('fpl-ai-memory');
                localStorage.removeItem('fpl-ai-profile');
                console.log('Conversation reset');
            }
            
            // Enhanced multi-factor analysis for nuanced responses
            getMultiFactorAnalysis(playerName, factors = {}) {
                const {
                    fixtures = true,
                    form = true,
                    ownership = true,
                    value = true,
                    xStats = true,
                    teamContext = true
                } = factors;
                
                let analysis = `üîç **Multi-Factor Analysis: ${playerName}**\n\n`;
                
                // Find player in knowledge base
                const player = this.knowledgeBase.topScorers.find(p => 
                    p.name.toLowerCase().includes(playerName.toLowerCase())
                );
                
                if (!player) {
                    return `Sorry, I don't have detailed data for ${playerName}. Try asking about Salah, Haaland, Palmer, or Mbeumo!`;
                }
                
                analysis += `**üìä Comprehensive Player Profile:**\n`;
                analysis += `‚Ä¢ Current Points: ${player.points} (League Position: #${this.knowledgeBase.topScorers.indexOf(player) + 1})\n`;
                analysis += `‚Ä¢ Price: ¬£${player.price}m | Ownership: ${player.ownership}%\n`;
                analysis += `‚Ä¢ Form Rating: ${player.form}/10\n\n`;
                
                if (xStats) {
                    analysis += `**‚öΩ Expected Stats Analysis:**\n`;
                    analysis += `‚Ä¢ Goals: ${player.goals} (xG: ${player.xG})\n`;
                    analysis += `‚Ä¢ Assists: ${player.assists} (xA: ${player.xA})\n`;
                    
                    const xGDiff = player.goals - player.xG;
                    if (xGDiff > 2) {
                        analysis += `‚Ä¢ ‚úÖ Overperforming xG by ${xGDiff.toFixed(1)} - Clinical finisher!\n`;
                    } else if (xGDiff < -2) {
                        analysis += `‚Ä¢ ‚ö†Ô∏è Underperforming xG by ${Math.abs(xGDiff).toFixed(1)} - Due for regression\n`;
                    } else {
                        analysis += `‚Ä¢ ‚úÖ xG performance is sustainable\n`;
                    }
                    analysis += '\n';
                }
                
                if (value) {
                    const pointsPerMillion = player.points / player.price;
                    analysis += `**üí∞ Value Assessment:**\n`;
                    analysis += `‚Ä¢ Points per ¬£m: ${pointsPerMillion.toFixed(1)}\n`;
                    if (pointsPerMillion > 30) {
                        analysis += `‚Ä¢ ‚úÖ Elite value - among best in game\n`;
                    } else if (pointsPerMillion > 20) {
                        analysis += `‚Ä¢ ‚úÖ Good value for money\n`;
                    } else {
                        analysis += `‚Ä¢ ‚ö†Ô∏è Premium priced - needs high returns\n`;
                    }
                    analysis += '\n';
                }
                
                if (ownership) {
                    analysis += `**üë• Ownership Analysis:**\n`;
                    if (player.ownership > 40) {
                        analysis += `‚Ä¢ High ownership (${player.ownership}%) - Essential player\n`;
                        analysis += `‚Ä¢ Missing out = Significant rank drops\n`;
                    } else if (player.ownership < 15) {
                        analysis += `‚Ä¢ Low ownership (${player.ownership}%) - Great differential\n`;
                        analysis += `‚Ä¢ Success = Major rank gains\n`;
                    } else {
                        analysis += `‚Ä¢ Moderate ownership (${player.ownership}%) - Balanced risk\n`;
                    }
                    analysis += '\n';
                }
                
                // AI recommendation with confidence
                analysis += `**ü§ñ AI Recommendation:**\n`;
                let recommendation = '';
                let confidence = 0.7;
                
                // Multi-factor scoring
                if (player.form > 7.5 && xGDiff > -1 && pointsPerMillion > 25) {
                    recommendation = '‚úÖ **STRONG BUY** - Multiple positive factors align';
                    confidence = 0.9;
                } else if (player.form > 6.5 || pointsPerMillion > 30) {
                    recommendation = '‚úÖ **CONSIDER** - Some positive indicators';
                    confidence = 0.7;
                } else if (player.form < 5 || xGDiff < -3) {
                    recommendation = '‚ùå **AVOID** - Multiple red flags present';
                    confidence = 0.8;
                } else {
                    recommendation = '‚ö†Ô∏è **MONITOR** - Mixed signals, wait for clarity';
                    confidence = 0.6;
                }
                
                analysis += recommendation + '\n';
                analysis += `‚Ä¢ Confidence Level: ${Math.round(confidence * 100)}%\n\n`;
                
                // Context-aware advice
                if (this.userProfile.riskTolerance === 'high' && player.ownership < 20) {
                    analysis += `üí° **Personal Note:** Given your high risk tolerance, ${playerName} could be a great differential play!`;
                } else if (this.userProfile.riskTolerance === 'low' && player.ownership > 40) {
                    analysis += `üí° **Personal Note:** As a safe player, ${playerName} fits your template strategy perfectly.`;
                }
                
                return analysis;
            }

            showTyping() {
                this.isTyping = true;
                document.getElementById('typing-indicator').classList.add('active');
                document.getElementById('send-btn').disabled = true;
            }

            hideTyping() {
                this.isTyping = false;
                document.getElementById('typing-indicator').classList.remove('active');
                document.getElementById('send-btn').disabled = false;
            }
        }

        // Global functions (kept for backward compatibility)
        function askAI(question) {
            if (window.fplAI) {
                document.getElementById('chat-input').value = question;
                window.fplAI.sendMessage();
            }
        }

        function sendMessage() {
            if (window.fplAI) {
                window.fplAI.sendMessage();
            }
        }

        // Initialize the AI Assistant
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded - Initializing FPL AI Assistant...');
            try {
                window.fplAI = new FPLAIAssistant();
                await window.fplAI.initialize();
                console.log('FPL AI Assistant initialized successfully');
            } catch (error) {
                console.error('Failed to initialize FPL AI Assistant:', error);
            }
        });
    </script>
</body>
</html>