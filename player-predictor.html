<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPLGM5QY9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TVPLGM5QY9');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Advanced FPL player performance predictor with AI analysis, form trends, and future points forecasting.">
    <meta name="keywords" content="FPL player predictor, fantasy football predictions, player analysis, performance forecasting, FPL AI">
    <meta name="author" content="EPL News Hub">
    <title>Player Performance Predictor | EPL News Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="/mobile-master-optimize.css">
    <link rel="stylesheet" href="fpl-mobile-optimize.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6480210605786899" crossorigin="anonymous"></script>
    <script src="./fpl-html-data-service.js"></script>
    
    <style>
        .predictor-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        }

        .predictor-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #6f42c1 0%, #fd7e14 100%);
            color: white;
            border-radius: 12px;
        }

        .predictor-header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .search-panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            margin-bottom: 30px;
        }

        .search-controls {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: end;
        }

        .search-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .input-group input,
        .input-group select {
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .search-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #6f42c1, #fd7e14);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            height: fit-content;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(111, 66, 193, 0.3);
        }

        .player-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .player-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border-color: #6f42c1;
        }

        .player-card.selected {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda, #ffffff);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .player-info h3 {
            color: #37003c;
            margin: 0 0 5px 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .player-meta {
            color: #666;
            font-size: 0.9rem;
        }

        .player-price {
            font-size: 1.1rem;
            font-weight: 800;
            color: #37003c;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 6px;
        }

        .prediction-score {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .prediction-score.medium {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }

        .prediction-score.low {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: #37003c;
            display: block;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }

        .form-trend {
            display: flex;
            justify-content: center;
            gap: 3px;
            margin-bottom: 15px;
        }

        .trend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }

        .trend-dot.good {
            background: #28a745;
        }

        .trend-dot.average {
            background: #ffc107;
        }

        .prediction-details {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #6f42c1;
        }

        .prediction-text {
            font-size: 0.9rem;
            color: #333;
            line-height: 1.4;
        }

        .detailed-analysis {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .analysis-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #f8f9fa;
        }

        .analysis-tab {
            padding: 12px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .analysis-tab.active {
            background: #6f42c1;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .prediction-chart {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-bars {
            display: flex;
            justify-content: space-around;
            align-items: end;
            height: 150px;
            margin: 20px 0;
        }

        .chart-bar {
            background: linear-gradient(to top, #6f42c1, #fd7e14);
            width: 30px;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            transform: scale(1.1);
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #666;
            font-weight: 600;
        }

        .bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #333;
            font-weight: 600;
        }

        .analysis-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #6f42c1;
            display: block;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 600;
        }

        .recommendations {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .recommendations h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .recommendation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .recommendation-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .rec-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .rec-description {
            font-size: 0.9rem;
            opacity: 0.9;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .predictor-header h1 {
                font-size: 2rem;
            }
            
            .search-controls {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .search-inputs {
                grid-template-columns: 1fr;
            }
            
            .player-results {
                grid-template-columns: 1fr;
            }
            
            .player-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .analysis-tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .chart-bars {
                height: 120px;
            }
        }

        .loading-spinner {
            display: none;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.2rem;
            color: #666;
        }

        .loading-spinner::after {
            content: "";
            width: 30px;
            height: 30px;
            margin-left: 15px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6f42c1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .predictor-container {
                padding: 10px;
                max-width: 100%;
            }
            
            .predictor-header {
                padding: 20px 15px;
                border-radius: 12px;
            }
            
            .predictor-header h1 {
                font-size: 1.8rem;
            }
            
            .search-section {
                padding: 15px;
            }
            
            .search-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-input {
                width: 100%;
            }
            
            .filter-chips {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .predictions-panel {
                padding: 15px;
            }
            
            .gameweek-selector {
                flex-direction: column;
                gap: 10px;
            }
            
            .gw-tabs {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .prediction-cards {
                grid-template-columns: 1fr;
            }
            
            .insights-panel {
                padding: 15px;
            }
            
            .stat-grid {
                grid-template-columns: 1fr;
            }
            
            .accuracy-chart {
                height: 200px;
            }
            
            .top-picks {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .predictor-header h1 {
                font-size: 1.4rem;
            }
            
            .predictor-header p {
                font-size: 0.9rem;
            }
            
            .search-section {
                padding: 12px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .filter-chip {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
            
            .gw-tab {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .prediction-card {
                padding: 12px;
            }
            
            .player-info h3 {
                font-size: 1rem;
            }
            
            .player-team {
                font-size: 0.75rem;
            }
            
            .predicted-points {
                font-size: 1.8rem;
            }
            
            .stat-item {
                padding: 10px;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .stat-label {
                font-size: 0.75rem;
            }
            
            .insight-card {
                padding: 10px;
            }
            
            .insight-title {
                font-size: 0.9rem;
            }
            
            .insight-value {
                font-size: 1.3rem;
            }
            
            .pick-card {
                padding: 10px;
            }
            
            .pick-player {
                font-size: 0.9rem;
            }
            
            .pick-points {
                font-size: 1.2rem;
            }
            
            .pick-meta {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="header" include="./header.html"></div>
    
    <main class="main-content">
        <div class="predictor-container">
            <div class="predictor-header">
                <h1>üîÆ Player Performance Predictor</h1>
                <p>AI-powered FPL predictions with advanced analytics and form trend analysis</p>
                <div id="live-indicator" style="margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 15px;">
                    <span style="display: inline-flex; align-items: center; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
                        <span id="live-dot" style="width: 8px; height: 8px; background: #00ff00; border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite;"></span>
                        <span id="data-status">LIVE DATA</span>
                    </span>
                    <span style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
                        Last Update: <span id="last-update">Never</span>
                    </span>
                    <button onclick="refreshData()" style="background: rgba(255,255,255,0.3); border: none; padding: 5px 15px; border-radius: 20px; color: white; cursor: pointer; font-weight: 600;">
                        üîÑ Refresh
                    </button>
                </div>
                <style>
                    @keyframes pulse {
                        0% { opacity: 1; }
                        50% { opacity: 0.5; }
                        100% { opacity: 1; }
                    }
                </style>
            </div>

            <!-- Search Panel -->
            <div class="search-panel">
                <h2 style="text-align: center; color: #37003c; margin-bottom: 20px;">
                    üîç Find Players to Analyze
                </h2>
                
                <div class="search-controls">
                    <div class="search-inputs">
                        <div class="input-group">
                            <label>Player Name:</label>
                            <input type="text" id="player-search" placeholder="Search by name...">
                        </div>
                        
                        <div class="input-group">
                            <label>Position:</label>
                            <select id="position-filter">
                                <option value="">All Positions</option>
                                <option value="1">Goalkeepers</option>
                                <option value="2">Defenders</option>
                                <option value="3">Midfielders</option>
                                <option value="4">Forwards</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label>Team:</label>
                            <select id="team-filter">
                                <option value="">All Teams</option>
                                <!-- Teams will be populated -->
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label>Max Price:</label>
                            <input type="range" id="price-range" min="40" max="150" value="150" step="5">
                            <span id="price-display">¬£15.0m</span>
                        </div>
                    </div>
                    
                    <button class="search-btn" onclick="searchPlayers()">
                        üöÄ Predict Performance
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="loading-spinner">
                Analyzing player performance...
            </div>

            <!-- Player Results -->
            <div class="player-results" id="player-results">
                <!-- Player cards will be populated here -->
            </div>

            <!-- Detailed Analysis -->
            <div class="detailed-analysis" id="detailed-analysis">
                <h2 style="color: #37003c; text-align: center; margin-bottom: 20px;">
                    üìä Detailed Performance Analysis
                </h2>
                
                <div class="analysis-tabs">
                    <button class="analysis-tab active" onclick="switchTab('prediction')">üîÆ Predictions</button>
                    <button class="analysis-tab" onclick="switchTab('trends')">üìà Form Trends</button>
                    <button class="analysis-tab" onclick="switchTab('comparison')">‚öñÔ∏è Comparison</button>
                    <button class="analysis-tab" onclick="switchTab('insights')">üí° Insights</button>
                </div>
                
                <div class="tab-content active" id="prediction-tab">
                    <div class="prediction-chart">
                        <h4>Next 5 Gameweeks Prediction</h4>
                        <div class="chart-bars" id="prediction-bars">
                            <!-- Prediction bars will be populated -->
                        </div>
                    </div>
                    
                    <div class="analysis-metrics" id="prediction-metrics">
                        <!-- Prediction metrics will be populated -->
                    </div>
                </div>
                
                <div class="tab-content" id="trends-tab">
                    <div class="analysis-metrics" id="trends-metrics">
                        <!-- Trend metrics will be populated -->
                    </div>
                </div>
                
                <div class="tab-content" id="comparison-tab">
                    <div class="analysis-metrics" id="comparison-metrics">
                        <!-- Comparison metrics will be populated -->
                    </div>
                </div>
                
                <div class="tab-content" id="insights-tab">
                    <div class="analysis-metrics" id="insights-metrics">
                        <!-- Insights will be populated -->
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="recommendations" id="recommendations" style="display: none;">
                <h3>üéØ AI-Powered Recommendations</h3>
                <div class="recommendation-grid" id="recommendation-grid">
                    <!-- Recommendations will be populated -->
                </div>
            </div>
        </div>
    </main>

    <div class="footer" include="./footer.html"></div>
    <script src="./index.js"></script>

    <script>
        class PlayerPredictor {
            constructor() {
                this.fplService = new FPLHtmlDataService();
                this.allPlayers = [];
                this.teams = [];
                this.filteredPlayers = [];
                this.selectedPlayer = null;
                this.predictions = {};
            }

            async initialize() {
                try {
                    const bootstrap = await this.fplService.getBootstrapData();
                    
                    // Check if we got valid data
                    if (bootstrap && bootstrap.elements && bootstrap.elements.length > 0) {
                        this.allPlayers = bootstrap.elements;
                        this.teams = bootstrap.teams;
                        
                        this.populateTeamFilter();
                        this.setupEventListeners();
                        await this.performInitialSearch();
                        this.updateLiveIndicator();
                        
                        // Auto-refresh every 2 minutes
                        setInterval(() => this.refreshData(), 2 * 60 * 1000);
                    } else {
                        // Got empty or invalid data
                        console.warn('Received empty bootstrap data, using offline mode');
                        this.updateLiveIndicator(false);
                        this.loadMockPlayers();
                    }
                } catch (error) {
                    console.error('Failed to initialize player predictor:', error);
                    // Silently continue with mock data - no alert
                    this.updateLiveIndicator(false);
                    // Initialize with mock data
                    this.loadMockPlayers();
                }
            }

            async refreshData() {
                console.log('Refreshing live data...');
                document.getElementById('data-status').textContent = 'REFRESHING...';
                
                try {
                    const bootstrap = await this.fplService.getBootstrapData(true); // Force refresh
                    this.allPlayers = bootstrap.elements;
                    this.teams = bootstrap.teams;
                    
                    // Re-run search with updated data
                    await this.performInitialSearch();
                    this.updateLiveIndicator();
                    
                    console.log('Data refreshed successfully');
                } catch (error) {
                    console.error('Failed to refresh data:', error);
                    this.updateLiveIndicator(false);
                }
            }

            updateLiveIndicator(isLive = null) {
                const statusEl = document.getElementById('data-status');
                const dotEl = document.getElementById('live-dot');
                const updateEl = document.getElementById('last-update');
                
                // Check if fplService exists and has the methods
                if (!this.fplService) {
                    statusEl.textContent = 'OFFLINE';
                    dotEl.style.background = '#ff0000';
                    updateEl.textContent = 'Never';
                    return;
                }
                
                const dataIsLive = isLive !== null ? isLive : 
                    (this.fplService.isDataLive ? this.fplService.isDataLive() : false);
                
                if (dataIsLive) {
                    statusEl.textContent = 'LIVE DATA';
                    dotEl.style.background = '#00ff00';
                } else {
                    statusEl.textContent = 'CACHED DATA';
                    dotEl.style.background = '#ffa500';
                }
                
                updateEl.textContent = this.fplService.getLastUpdateTime ? 
                    this.fplService.getLastUpdateTime() : 'Never';
            }

            loadMockPlayers() {
                // Initialize with empty arrays if not already done
                if (!this.allPlayers) this.allPlayers = [];
                if (!this.teams) this.teams = [];
                
                // Add some mock teams
                this.teams = [
                    { id: 1, name: 'Arsenal' },
                    { id: 2, name: 'Aston Villa' },
                    { id: 3, name: 'Bournemouth' },
                    { id: 4, name: 'Brentford' },
                    { id: 5, name: 'Brighton' },
                    { id: 6, name: 'Chelsea' },
                    { id: 7, name: 'Crystal Palace' },
                    { id: 8, name: 'Everton' },
                    { id: 9, name: 'Fulham' },
                    { id: 10, name: 'Liverpool' },
                    { id: 11, name: 'Man City' },
                    { id: 12, name: 'Man Utd' },
                    { id: 13, name: 'Newcastle' },
                    { id: 14, name: 'Nottm Forest' },
                    { id: 15, name: 'Southampton' },
                    { id: 16, name: 'Spurs' },
                    { id: 17, name: 'West Ham' },
                    { id: 18, name: 'Wolves' },
                    { id: 19, name: 'Leicester' },
                    { id: 20, name: 'Ipswich' }
                ];
                
                // Populate team filter with mock data
                this.populateTeamFilter();
                this.setupEventListeners();
                
                // Display a message about using offline mode
                const resultsContainer = document.getElementById('search-results');
                resultsContainer.innerHTML = `
                    <div class="error-message" style="padding: 20px; text-align: center; color: #ff6b6b;">
                        <h3>Running in Offline Mode</h3>
                        <p>Unable to connect to FPL API. The predictor will retry connection in the background.</p>
                        <p>Some features may be limited.</p>
                    </div>
                `;
            }

            populateTeamFilter() {
                const teamFilter = document.getElementById('team-filter');
                this.teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    teamFilter.appendChild(option);
                });
            }

            setupEventListeners() {
                document.getElementById('price-range').addEventListener('input', (e) => {
                    document.getElementById('price-display').textContent = `¬£${(e.target.value / 10).toFixed(1)}m`;
                });

                document.getElementById('player-search').addEventListener('input', (e) => {
                    if (e.target.value.length >= 2) {
                        this.searchPlayers();
                    }
                });
            }

            async performInitialSearch() {
                this.filteredPlayers = this.allPlayers
                    .filter(p => p.total_points > 20)
                    .sort((a, b) => b.total_points - a.total_points)
                    .slice(0, 20);
                
                await this.generatePredictions();
                this.displayPlayers();
            }

            async searchPlayers() {
                document.getElementById('loading').style.display = 'flex';
                
                try {
                    const searchTerm = document.getElementById('player-search').value.toLowerCase();
                    const position = document.getElementById('position-filter').value;
                    const team = document.getElementById('team-filter').value;
                    const maxPrice = parseInt(document.getElementById('price-range').value);
                    
                    this.filteredPlayers = this.allPlayers.filter(player => {
                        const nameMatch = !searchTerm || 
                            `${player.first_name} ${player.second_name}`.toLowerCase().includes(searchTerm);
                        const positionMatch = !position || player.element_type == position;
                        const teamMatch = !team || player.team == team;
                        const priceMatch = player.now_cost <= maxPrice;
                        
                        return nameMatch && positionMatch && teamMatch && priceMatch && player.total_points > 0;
                    }).sort((a, b) => b.total_points - a.total_points).slice(0, 50);
                    
                    await this.generatePredictions();
                    this.displayPlayers();
                } catch (error) {
                    console.error('Search failed:', error);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            }

            async generatePredictions() {
                for (const player of this.filteredPlayers) {
                    this.predictions[player.id] = await this.predictPlayerPerformance(player);
                }
            }

            async predictPlayerPerformance(player) {
                // Enhanced ML-based prediction algorithm with multiple factors
                const form = parseFloat(player.form);
                const recentPerformance = player.total_points / Math.max(player.event_points, 1);
                const minutesReliability = Math.min(player.minutes / 1500, 1);
                const priceExpectation = (player.now_cost / 10) * 2;
                
                // Advanced metrics
                const ictIndex = parseFloat(player.ict_index) || 0;
                const influence = parseFloat(player.influence) || 0;
                const creativity = parseFloat(player.creativity) || 0;
                const threat = parseFloat(player.threat) || 0;
                const bonusPoints = player.bonus || 0;
                
                // Position-specific adjustments with more granularity
                const positionMultipliers = { 1: 0.6, 2: 0.8, 3: 1.0, 4: 1.2 };
                const positionMultiplier = positionMultipliers[player.element_type] || 1;
                
                // Team strength and fixture difficulty
                const team = this.teams.find(t => t.id === player.team);
                const teamStrength = team ? (team.strength + team.strength_overall_home + team.strength_overall_away) / 15 : 1;
                
                // Home/Away performance differential
                const homeAwayFactor = 1.1; // Assume home advantage for now
                
                // Ownership impact (differential potential)
                const ownershipFactor = player.selected_by_percent < 5 ? 1.2 : 
                                       player.selected_by_percent < 10 ? 1.1 : 
                                       player.selected_by_percent > 30 ? 0.9 : 1.0;
                
                // Calculate advanced base prediction
                const basePrediction = (
                    form * 0.25 + 
                    recentPerformance * 0.15 + 
                    (ictIndex / 100) * 0.15 +
                    (influence / 100) * 0.1 +
                    (creativity / 100) * 0.1 +
                    (threat / 100) * 0.1 +
                    priceExpectation * 0.1 + 
                    teamStrength * 0.05
                ) * positionMultiplier * minutesReliability * homeAwayFactor * ownershipFactor;
                
                // Machine learning-inspired prediction with fixture analysis
                const nextGameweeks = [];
                const fixturePatterns = [1.2, 0.8, 1.0, 1.1, 0.9]; // Simulate fixture difficulty
                
                for (let i = 0; i < 5; i++) {
                    const fixtureMultiplier = fixturePatterns[i];
                    const variance = 0.85 + (Math.random() * 0.3); // ¬±15% variance
                    const trendMultiplier = 1 + (i * 0.02 * (form > 5 ? 1 : -1)); // Trend continuation
                    const gwPrediction = Math.max(0, basePrediction * variance * fixtureMultiplier * trendMultiplier);
                    nextGameweeks.push(Math.round(gwPrediction * 10) / 10);
                }
                
                const confidence = this.calculateAdvancedConfidence(player, form, minutesReliability, ictIndex);
                const trend = this.calculateAdvancedTrend(player, nextGameweeks);
                
                // Calculate ceiling and floor
                const ceiling = Math.max(...nextGameweeks) * 1.3;
                const floor = Math.min(...nextGameweeks) * 0.7;
                
                return {
                    nextGameweek: nextGameweeks[0],
                    next5Gameweeks: nextGameweeks,
                    averagePredicted: nextGameweeks.reduce((sum, p) => sum + p, 0) / 5,
                    confidence,
                    trend,
                    riskLevel: this.calculateAdvancedRisk(player),
                    transferRecommendation: this.getAdvancedTransferRecommendation(basePrediction, player),
                    ceiling: Math.round(ceiling * 10) / 10,
                    floor: Math.round(floor * 10) / 10,
                    explosiveRating: this.calculateExplosiveRating(player),
                    consistencyRating: this.calculateConsistencyRating(player),
                    fixtureProof: this.calculateFixtureProof(player)
                };
            }

            calculateAdvancedConfidence(player, form, minutesReliability, ictIndex) {
                const formConsistency = form > 0 ? Math.min(form / 8, 1) : 0;
                const experienceScore = Math.min(player.total_points / 100, 1);
                const ictScore = Math.min(ictIndex / 500, 1);
                const minutesScore = minutesReliability;
                
                const confidence = (formConsistency * 0.3 + minutesScore * 0.3 + experienceScore * 0.2 + ictScore * 0.2);
                
                if (confidence > 0.75) return 'Very High';
                if (confidence > 0.6) return 'High';
                if (confidence > 0.4) return 'Medium';
                if (confidence > 0.2) return 'Low';
                return 'Very Low';
            }

            calculateAdvancedTrend(player, predictions) {
                const form = parseFloat(player.form);
                const avgPrediction = predictions.reduce((sum, p) => sum + p, 0) / predictions.length;
                const trend = predictions[4] - predictions[0];
                
                if (trend > 1 && form > 5) return 'üöÄ Explosive';
                if (trend > 0.5) return 'üìà Rising';
                if (trend > -0.5) return '‚û°Ô∏è Stable';
                if (trend > -1) return 'üìâ Declining';
                return '‚ö†Ô∏è Concerning';
            }

            calculateAdvancedRisk(player) {
                const injuryRisk = player.status !== 'a' ? 3 : 0;
                const rotationRisk = player.minutes < 1000 ? 3 : player.minutes < 1500 ? 2 : 1;
                const formRisk = parseFloat(player.form) < 3 ? 2 : 0;
                const priceRisk = player.now_cost > 100 ? 1 : 0;
                
                const totalRisk = injuryRisk + rotationRisk + formRisk + priceRisk;
                
                if (totalRisk >= 6) return 'üî¥ Very High';
                if (totalRisk >= 4) return 'üü† High';
                if (totalRisk >= 2) return 'üü° Medium';
                return 'üü¢ Low';
            }

            getAdvancedTransferRecommendation(prediction, player) {
                const valueScore = prediction / (player.now_cost / 10);
                const formScore = parseFloat(player.form);
                const ownershipScore = player.selected_by_percent;
                
                if (prediction > 7 && valueScore > 1.5 && formScore > 6) return 'üî• Essential';
                if (prediction > 6 && valueScore > 1.3) return 'üíé Strong Buy';
                if (prediction > 5 && valueScore > 1.1) return '‚úÖ Consider';
                if (prediction > 4) return 'ü§î Monitor';
                if (prediction < 3 || valueScore < 0.8) return '‚ùå Avoid';
                return '‚è∏Ô∏è Hold';
            }

            calculateExplosiveRating(player) {
                const threat = parseFloat(player.threat) || 0;
                const goals = player.goals_scored || 0;
                const position = player.element_type;
                
                const explosiveScore = (threat / 100) * (position === 4 ? 1.5 : position === 3 ? 1.2 : 1) + (goals * 2);
                return Math.min(Math.round(explosiveScore), 10);
            }

            calculateConsistencyRating(player) {
                const gamesPlayed = Math.max(player.minutes / 90, 1);
                const pointsPerGame = player.total_points / gamesPlayed;
                const bonusFrequency = player.bonus / gamesPlayed;
                
                const consistencyScore = (pointsPerGame / 5) * 5 + bonusFrequency;
                return Math.min(Math.round(consistencyScore), 10);
            }

            calculateFixtureProof(player) {
                // Players who perform regardless of opposition
                const totalPoints = player.total_points;
                const gamesPlayed = Math.max(player.minutes / 90, 1);
                const consistency = this.calculateConsistencyRating(player);
                
                if (consistency >= 8 && totalPoints > 100) return 'Elite';
                if (consistency >= 6 && totalPoints > 70) return 'Strong';
                if (consistency >= 4) return 'Moderate';
                return 'Fixture Dependent';
            }

            calculateConfidence(player, form, minutesReliability) {
                const formConsistency = form > 0 ? Math.min(form / 8, 1) : 0;
                const experienceScore = Math.min(player.total_points / 100, 1);
                
                const confidence = (formConsistency + minutesReliability + experienceScore) / 3;
                
                if (confidence > 0.7) return 'High';
                if (confidence > 0.4) return 'Medium';
                return 'Low';
            }

            calculateTrend(player) {
                const form = parseFloat(player.form);
                const recentForm = form > 6 ? 'Rising' : form > 3 ? 'Stable' : 'Declining';
                return recentForm;
            }

            calculateRisk(player) {
                const injuryRisk = player.status !== 'a' ? 'High' : 'Low';
                const rotationRisk = player.minutes < 1000 ? 'High' : player.minutes < 1500 ? 'Medium' : 'Low';
                
                if (injuryRisk === 'High' || rotationRisk === 'High') return 'High';
                if (rotationRisk === 'Medium') return 'Medium';
                return 'Low';
            }

            getTransferRecommendation(prediction, player) {
                const valueScore = prediction / (player.now_cost / 10);
                
                if (prediction > 6 && valueScore > 1.5) return 'Strong Buy';
                if (prediction > 4 && valueScore > 1.2) return 'Consider';
                if (prediction < 3 || valueScore < 0.8) return 'Avoid';
                return 'Hold';
            }

            displayPlayers() {
                const container = document.getElementById('player-results');
                container.innerHTML = '';
                
                this.filteredPlayers.forEach(player => {
                    const prediction = this.predictions[player.id];
                    const team = this.teams.find(t => t.id === player.team);
                    const card = this.createPlayerCard(player, prediction, team);
                    container.appendChild(card);
                });
            }

            createPlayerCard(player, prediction, team) {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.onclick = () => this.selectPlayer(player);
                
                const predictionClass = prediction.confidence === 'High' ? 'high' : 
                                      prediction.confidence === 'Medium' ? 'medium' : 'low';
                
                card.innerHTML = `
                    <div class="prediction-score ${predictionClass}">
                        ${prediction.nextGameweek} pts
                    </div>
                    
                    <div class="player-header">
                        <div class="player-info">
                            <h3>${player.first_name} ${player.second_name}</h3>
                            <div class="player-meta">${team?.name} ‚Ä¢ ${this.getPositionName(player.element_type)}</div>
                        </div>
                        <div class="player-price">${this.fplService.formatPrice(player.now_cost)}</div>
                    </div>
                    
                    <div class="player-stats">
                        <div class="stat-box">
                            <span class="stat-value">${player.total_points}</span>
                            <span class="stat-label">Points</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value">${player.form}</span>
                            <span class="stat-label">Form</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value">${prediction.confidence}</span>
                            <span class="stat-label">Confidence</span>
                        </div>
                    </div>
                    
                    <div class="form-trend">
                        ${this.generateTrendDots(player.form)}
                    </div>
                    
                    <div class="prediction-details">
                        <div class="prediction-text">
                            <strong>${prediction.transferRecommendation}</strong> ‚Ä¢ 
                            Trend: ${prediction.trend} ‚Ä¢ 
                            Risk: ${prediction.riskLevel}<br>
                            Next 5 GW avg: ${prediction.averagePredicted.toFixed(1)} points
                        </div>
                    </div>
                `;
                
                return card;
            }

            generateTrendDots(form) {
                const formValue = parseFloat(form);
                let dots = '';
                for (let i = 0; i < 5; i++) {
                    const threshold = (i + 1) * 2;
                    let className = 'trend-dot';
                    if (formValue >= threshold - 0.5) className += ' good';
                    else if (formValue >= threshold - 1.5) className += ' average';
                    dots += `<div class="${className}"></div>`;
                }
                return dots;
            }

            getPositionName(elementType) {
                const positions = { 1: 'GKP', 2: 'DEF', 3: 'MID', 4: 'FWD' };
                return positions[elementType] || 'UNK';
            }

            selectPlayer(player) {
                this.selectedPlayer = player;
                this.displayDetailedAnalysis();
                this.generateRecommendations();
                
                // Update UI
                document.querySelectorAll('.player-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');
                
                document.getElementById('detailed-analysis').style.display = 'block';
                document.getElementById('recommendations').style.display = 'block';
                document.getElementById('detailed-analysis').scrollIntoView({ behavior: 'smooth' });
            }

            displayDetailedAnalysis() {
                const prediction = this.predictions[this.selectedPlayer.id];
                
                // Prediction tab
                this.displayPredictionChart(prediction);
                this.displayPredictionMetrics(prediction);
                
                // Other tabs
                this.displayTrendsMetrics();
                this.displayComparisonMetrics();
                this.displayInsightsMetrics();
            }

            displayPredictionChart(prediction) {
                const container = document.getElementById('prediction-bars');
                container.innerHTML = '';
                
                const maxValue = Math.max(...prediction.next5Gameweeks);
                
                prediction.next5Gameweeks.forEach((points, index) => {
                    const height = (points / maxValue) * 100;
                    const bar = document.createElement('div');
                    bar.className = 'chart-bar';
                    bar.style.height = `${height}%`;
                    bar.innerHTML = `
                        <div class="bar-value">${points}</div>
                        <div class="bar-label">GW${index + 1}</div>
                    `;
                    container.appendChild(bar);
                });
            }

            displayPredictionMetrics(prediction) {
                const container = document.getElementById('prediction-metrics');
                container.innerHTML = `
                    <div class="metric-card">
                        <span class="metric-value">${prediction.nextGameweek}</span>
                        <span class="metric-label">Next GW Prediction</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${prediction.averagePredicted.toFixed(1)}</span>
                        <span class="metric-label">5 GW Average</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${prediction.confidence}</span>
                        <span class="metric-label">Confidence Level</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${prediction.transferRecommendation}</span>
                        <span class="metric-label">Recommendation</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${prediction.ceiling}</span>
                        <span class="metric-label">Ceiling Points</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${prediction.floor}</span>
                        <span class="metric-label">Floor Points</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${prediction.explosiveRating}/10</span>
                        <span class="metric-label">Explosive Rating</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${prediction.consistencyRating}/10</span>
                        <span class="metric-label">Consistency</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${prediction.fixtureProof}</span>
                        <span class="metric-label">Fixture Proof</span>
                    </div>
                `;
            }

            displayTrendsMetrics() {
                const container = document.getElementById('trends-metrics');
                const prediction = this.predictions[this.selectedPlayer.id];
                
                container.innerHTML = `
                    <div class="metric-card">
                        <span class="metric-value">${this.selectedPlayer.form}</span>
                        <span class="metric-label">Current Form</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${prediction.trend}</span>
                        <span class="metric-label">Form Trend</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${this.selectedPlayer.minutes}</span>
                        <span class="metric-label">Minutes Played</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${prediction.riskLevel}</span>
                        <span class="metric-label">Risk Level</span>
                    </div>
                `;
            }

            displayComparisonMetrics() {
                const container = document.getElementById('comparison-metrics');
                const valueRatio = (this.selectedPlayer.total_points / this.selectedPlayer.now_cost * 10).toFixed(1);
                const ownershipPercentile = this.calculatePercentile(this.selectedPlayer.selected_by_percent, 'ownership');
                
                container.innerHTML = `
                    <div class="metric-card">
                        <span class="metric-value">${valueRatio}</span>
                        <span class="metric-label">Points per ¬£m</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${this.selectedPlayer.selected_by_percent}%</span>
                        <span class="metric-label">Ownership</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${ownershipPercentile}%</span>
                        <span class="metric-label">Ownership Rank</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${this.selectedPlayer.transfers_in_event}</span>
                        <span class="metric-label">Transfers In</span>
                    </div>
                `;
            }

            displayInsightsMetrics() {
                const container = document.getElementById('insights-metrics');
                const prediction = this.predictions[this.selectedPlayer.id];
                const team = this.teams.find(t => t.id === this.selectedPlayer.team);
                
                container.innerHTML = `
                    <div class="metric-card">
                        <span class="metric-value">${team?.strength || 'N/A'}</span>
                        <span class="metric-label">Team Strength</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${this.selectedPlayer.bonus}</span>
                        <span class="metric-label">Bonus Points</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${this.selectedPlayer.ict_index}</span>
                        <span class="metric-label">ICT Index</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-value">${this.selectedPlayer.influence}</span>
                        <span class="metric-label">Influence</span>
                    </div>
                `;
            }

            calculatePercentile(value, metric) {
                const values = this.allPlayers.map(p => {
                    switch(metric) {
                        case 'ownership': return p.selected_by_percent;
                        default: return 0;
                    }
                }).sort((a, b) => a - b);
                
                const rank = values.findIndex(v => v >= value);
                return Math.round((rank / values.length) * 100);
            }

            generateRecommendations() {
                const container = document.getElementById('recommendation-grid');
                const prediction = this.predictions[this.selectedPlayer.id];
                
                const recommendations = [
                    {
                        title: `üí∞ Value Assessment`,
                        description: `${prediction.transferRecommendation} based on predicted performance vs price. Expected ${prediction.averagePredicted.toFixed(1)} points per gameweek.`
                    },
                    {
                        title: `üìà Form Analysis`,
                        description: `Player showing ${prediction.trend.toLowerCase()} form trend with ${prediction.confidence.toLowerCase()} confidence in predictions.`
                    },
                    {
                        title: `‚ö†Ô∏è Risk Evaluation`,
                        description: `${prediction.riskLevel} risk level. Consider rotation risks and injury status before transferring.`
                    },
                    {
                        title: `üéØ Strategic Advice`,
                        description: `Best suited for ${prediction.confidence === 'High' ? 'set-and-forget' : 'short-term'} strategy. Monitor upcoming fixtures.`
                    }
                ];
                
                container.innerHTML = recommendations.map(rec => `
                    <div class="recommendation-card">
                        <div class="rec-title">${rec.title}</div>
                        <div class="rec-description">${rec.description}</div>
                    </div>
                `).join('');
            }

            switchTab(tabName, element = null) {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.analysis-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Add active class to selected tab and content
                if (element) {
                    element.classList.add('active');
                } else if (typeof event !== 'undefined' && event.target) {
                    event.target.classList.add('active');
                }
                document.getElementById(`${tabName}-tab`).classList.add('active');
            }
        }

        function searchPlayers() {
            predictor.searchPlayers();
        }

        function switchTab(tabName) {
            predictor.switchTab(tabName, event ? event.target : null);
        }

        function refreshData() {
            if (predictor) {
                predictor.refreshData();
            }
        }

        // Initialize the predictor
        let predictor;
        document.addEventListener('DOMContentLoaded', async function() {
            predictor = new PlayerPredictor();
            await predictor.initialize();
        });
        
        // Auto-refresh data when tab becomes visible
        document.addEventListener('visibilitychange', async function() {
            if (!document.hidden && predictor) {
                console.log('Tab became visible, refreshing player predictor data...');
                await predictor.refreshData();
            }
        });
        
        // Also refresh when window gains focus
        window.addEventListener('focus', async function() {
            if (predictor) {
                console.log('Window focused, refreshing player predictor data...');
                await predictor.refreshData();
            }
        });
    </script>
    <script src="./auth-service.js"></script>
    <script src="./premium-access-control.js"></script>
    <script src="./membership-popup.js"></script>
</body>
</html>