<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPLGM5QY9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TVPLGM5QY9');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Intelligent FPL budget optimizer with AI-powered team building, value analysis, and optimal squad recommendations.">
    <meta name="keywords" content="FPL budget optimizer, fantasy football optimizer, team builder, value picks, FPL AI assistant">
    <meta name="author" content="EPL News Hub">
    <title>FPL Budget Optimizer | EPL News Hub</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="/mobile-master-optimize.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6480210605786899" crossorigin="anonymous"></script>
    <script src="./fpl-html-data-service.js"></script>
    <script src="./budget-optimizer-enhanced.js"></script>
    <script src="./fixture-difficulty-service.js"></script>
    <script src="./squad-manager.js"></script>
    <script src="./gameweek-planner.js"></script>
    
    <style>
        .optimizer-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            min-height: 100vh;
        }

        .optimizer-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px;
            background: linear-gradient(135deg, #6f42c1 0%, #667eea 50%, #17a2b8 100%);
            background-size: 200% 200%;
            animation: gradientShift 6s ease infinite;
            color: white;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }

        .optimizer-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .optimizer-header h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            font-weight: 900;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }

        .strategy-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .strategy-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .strategy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .strategy-card.selected {
            border-color: #6f42c1;
            background: linear-gradient(135deg, #f3e8ff, #ffffff);
        }

        .strategy-card h3 {
            color: #37003c;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .strategy-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .constraints-panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            margin-bottom: 30px;
        }

        .constraints-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .constraint-section h3 {
            color: #37003c;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .budget-input {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .budget-input label {
            font-weight: 600;
            color: #333;
            min-width: 100px;
        }

        .budget-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 1rem;
        }

        .budget-display {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .budget-amount {
            font-size: 2rem;
            font-weight: 800;
            display: block;
        }

        .position-constraints {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .position-constraint {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .position-constraint label {
            font-weight: 600;
            color: #333;
        }

        .constraint-inputs {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .constraint-inputs input {
            width: 50px;
            padding: 5px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            text-align: center;
        }

        .optimization-controls {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .optimize-btn {
            padding: 18px 35px;
            background: linear-gradient(135deg, #6f42c1, #667eea, #17a2b8);
            background-size: 200% 200%;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 8px 20px rgba(111, 66, 193, 0.3);
            position: relative;
            overflow: hidden;
            min-width: 200px;
            animation: gradientShift 4s ease infinite;
        }

        .optimize-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .optimize-btn:hover::before {
            left: 100%;
        }

        .optimize-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(111, 66, 193, 0.4);
        }

        .optimize-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            animation: none;
        }

        .btn-totw {
            background: linear-gradient(135deg, #ffd700, #ff6b6b, #ffd700) !important;
            background-size: 200% 200% !important;
            animation: goldShift 3s ease infinite !important;
        }

        @keyframes goldShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .btn-reset {
            background: linear-gradient(135deg, #dc3545, #fd7e14) !important;
        }

        .results-container {
            display: none;
        }

        .squad-display {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .squad-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .squad-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .squad-stat {
            text-align: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #37003c;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
        }

        .formation-display {
            display: grid;
            grid-template-rows: repeat(4, 1fr);
            gap: 20px;
            min-height: 400px;
            background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .position-line {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .player-slot {
            background: white;
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            min-width: 140px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .player-slot:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .player-name {
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }

        .player-team {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .player-price {
            color: #37003c;
            font-weight: 700;
            font-size: 0.9rem;
            background: #f8f9fa;
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .player-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .stat-item {
            color: #666;
        }

        .alternatives-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .alternatives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .alternative-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .alternative-group h4 {
            color: #37003c;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .alternative-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
        }

        .alternative-info {
            flex: 1;
        }

        .alternative-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .alternative-details {
            font-size: 0.8rem;
            color: #666;
        }

        .alternative-price {
            color: #37003c;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .value-analysis {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            color: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .value-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .value-metric {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 800;
            display: block;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6f42c1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .optimizer-header h1 {
                font-size: 2rem;
            }
            
            .strategy-selector {
                grid-template-columns: 1fr;
            }
            
            .constraints-grid {
                grid-template-columns: 1fr;
            }
            
            .squad-stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .formation-display {
                padding: 15px;
                gap: 15px;
            }
            
            .position-line {
                gap: 10px;
            }
            
            .player-slot {
                min-width: 120px;
                padding: 10px;
            }
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .optimizer-container {
                padding: 10px;
                max-width: 100%;
            }
            
            .optimizer-header {
                padding: 20px 15px;
                border-radius: 12px;
            }
            
            .optimizer-header h1 {
                font-size: 1.8rem;
            }
            
            .optimizer-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .left-section {
                order: 2;
            }
            
            .right-section {
                order: 1;
            }
            
            .constraint-section {
                padding: 15px;
            }
            
            .position-constraints {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .budget-input {
                flex-direction: column;
                align-items: stretch;
            }
            
            .budget-input label {
                min-width: auto;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-btn {
                width: 100%;
            }
            
            .optimized-team {
                padding: 15px;
            }
            
            .player-card {
                padding: 12px;
            }
            
            .player-stats {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .stat-chip {
                padding: 3px 8px;
                font-size: 0.75rem;
            }
            
            .value-metrics {
                grid-template-columns: 1fr;
            }
            
            .alternatives-section {
                padding: 15px;
            }
            
            .formation-selector {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .formation-option {
                min-width: 100px;
            }
        }
        
        @media (max-width: 480px) {
            .optimizer-header h1 {
                font-size: 1.4rem;
            }
            
            .optimizer-header p {
                font-size: 0.9rem;
            }
            
            .constraint-section {
                padding: 12px;
            }
            
            .constraint-section h3 {
                font-size: 1rem;
            }
            
            .budget-amount {
                font-size: 1.6rem;
            }
            
            .position-constraint {
                padding: 8px;
            }
            
            .constraint-label {
                font-size: 0.85rem;
            }
            
            .player-card {
                padding: 10px;
            }
            
            .player-name {
                font-size: 0.9rem;
            }
            
            .player-team {
                font-size: 0.75rem;
            }
            
            .player-price {
                font-size: 0.95rem;
            }
            
            .formation-chips {
                gap: 5px;
            }
            
            .formation-chip {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
            
            .alternative-player {
                padding: 8px;
            }
            
            .alternative-name {
                font-size: 0.85rem;
            }
            
            .alternative-details {
                font-size: 0.75rem;
            }
            
            .value-metric h4 {
                font-size: 0.85rem;
            }
            
            .value-metric .metric-value {
                font-size: 1.3rem;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
        }
    </style>
    <link rel="icon" type="image/png" href="/eplnewshub_logo.png">
    <link rel="shortcut icon" href="/eplnewshub_logo.png">
</head>
<body>
    <div class="header" include="../../components/layout/header.html"></div>
    
    <main class="main-content">
        <div class="optimizer-container">
            <!-- Top Ad -->
            <div include="./page-ad.html"></div>
            
            <div class="optimizer-header">
                <h1>🧠 AI Budget Optimizer</h1>
                <p>Build the perfect FPL squad with intelligent budget allocation and value optimization</p>
                <div id="live-indicator" style="margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 15px;">
                    <span style="display: inline-flex; align-items: center; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
                        <span id="live-dot" style="width: 8px; height: 8px; background: #00ff00; border-radius: 50%; margin-right: 8px; animation: pulse 2s infinite;"></span>
                        <span id="data-status">LIVE DATA</span>
                    </span>
                    <span style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
                        Last Update: <span id="last-update">Never</span>
                    </span>
                    <button onclick="refreshData()" style="background: rgba(255,255,255,0.3); border: none; padding: 5px 15px; border-radius: 20px; color: white; cursor: pointer; font-weight: 600;">
                        🔄 Refresh
                    </button>
                </div>
                <style>
                    @keyframes pulse {
                        0% { opacity: 1; }
                        50% { opacity: 0.5; }
                        100% { opacity: 1; }
                    }
                </style>
            </div>

            <!-- Enhanced Controls Bar -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <div style="display: flex; gap: 10px;">
                    <button onclick="showAdvancedOptions()" style="padding: 8px 16px; background: linear-gradient(135deg, #6f42c1, #17a2b8); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ⚡ Advanced Mode
                    </button>
                    <button onclick="showSquadManager()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        📁 Saved Squads
                    </button>
                    <button onclick="showGameweekPlanner()" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        📅 GW Planner
                    </button>
                    <button onclick="showDifferentials()" style="padding: 8px 16px; background: #fd7e14; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        💎 Differentials
                    </button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="font-size: 0.9rem; color: #666;">Algorithm:</span>
                    <select id="algorithm-selector" style="padding: 6px 12px; border: 1px solid #e9ecef; border-radius: 6px;">
                        <option value="standard">Standard</option>
                        <option value="genetic">Genetic Algorithm</option>
                        <option value="annealing">Simulated Annealing</option>
                        <option value="hybrid">Hybrid AI</option>
                    </select>
                </div>
            </div>

            <!-- Advanced Options Panel (Hidden by default) -->
            <div id="advanced-options" style="display: none; background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #6f42c1;">
                <h3 style="color: #6f42c1; margin-bottom: 20px;">⚡ Advanced Optimization Settings</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Population Size (Genetic)</label>
                        <input type="number" id="population-size" value="100" min="50" max="500" style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Generations</label>
                        <input type="number" id="generations" value="50" min="10" max="200" style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Mutation Rate</label>
                        <input type="range" id="mutation-rate" value="10" min="5" max="30" style="width: 100%;">
                        <span id="mutation-display">10%</span>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Temperature (Annealing)</label>
                        <input type="number" id="temperature" value="1000" min="100" max="5000" style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 6px;">
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="use-ml-predictions" checked>
                        <span>Use ML Player Predictions</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                        <input type="checkbox" id="consider-injuries" checked>
                        <span>Consider Injury/Suspension Status</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                        <input type="checkbox" id="fixture-weighting" checked>
                        <span>Apply Fixture Difficulty Weighting</span>
                    </label>
                </div>
            </div>

            <!-- Squad Manager Panel (Hidden by default) -->
            <div id="squad-manager-panel" style="display: none; background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #28a745;">
                <h3 style="color: #28a745; margin-bottom: 20px;">📁 Squad Manager</h3>
                <div id="saved-squads-list" style="max-height: 400px; overflow-y: auto;">
                    <!-- Saved squads will be populated here -->
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button onclick="compareSquads()" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Compare Selected
                    </button>
                    <button onclick="clearAllSquads()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Gameweek Planner Panel (Hidden by default) -->
            <div id="gameweek-planner-panel" style="display: none; background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #17a2b8;">
                <h3 style="color: #17a2b8; margin-bottom: 20px;">📅 Multi-Gameweek Planner</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Plan Horizon</label>
                        <select id="plan-horizon" style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 6px;">
                            <option value="3">Next 3 GWs</option>
                            <option value="6" selected>Next 6 GWs</option>
                            <option value="10">Next 10 GWs</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Free Transfers</label>
                        <input type="number" id="free-transfers" value="1" min="0" max="2" style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Max Hits</label>
                        <input type="number" id="max-hits" value="8" min="0" max="20" step="4" style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 6px;">
                    </div>
                </div>
                <button onclick="generateTransferPlan()" style="padding: 12px 24px; background: linear-gradient(135deg, #17a2b8, #20c997); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700;">
                    Generate Transfer Plan
                </button>
                <div id="transfer-plan-results" style="margin-top: 20px;">
                    <!-- Transfer plan will be displayed here -->
                </div>
            </div>

            <!-- Mid-Page Ad -->
            <div include="./page-ad.html"></div>
            
            <!-- Differential Analysis Panel (Hidden by default) -->
            <div id="differential-panel" style="display: none; background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #fd7e14;">
                <h3 style="color: #fd7e14; margin-bottom: 20px;">💎 Differential Analysis</h3>
                <div id="differential-results" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Differential analysis will be displayed here -->
                </div>
            </div>

            <!-- Team of the Week Section -->
            <div id="team-of-week" style="display: none; background: linear-gradient(135deg, #ffd700, #ff6b6b); padding: 25px; border-radius: 12px; margin-bottom: 30px; color: white; box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; font-size: 2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        🏆 Team of the Week - Gameweek 1
                    </h2>
                    <p style="margin-top: 10px; opacity: 0.95;">
                        Expert picks based on pre-season form, fixtures, and value (3-5-2 • £100m)
                    </p>
                </div>
                
                <div style="background: rgba(255,255,255,0.95); border-radius: 10px; padding: 20px; color: #333;">
                    <!-- Team Display Grid -->
                    <div id="totw-display" style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <!-- Goalkeeper -->
                        <div style="background: linear-gradient(135deg, #28a745, #20c997); padding: 12px; border-radius: 8px; color: white;">
                            <strong>GK:</strong> David Raya (Arsenal) - £5.5m
                            <small style="display: block; opacity: 0.9;">Solid pre-season, great fixtures</small>
                        </div>
                        
                        <!-- Defenders -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; border-left: 4px solid #28a745;">
                                <strong>DEF:</strong> Trent Alexander-Arnold (Liverpool) - £7.0m
                                <small style="display: block; color: #666;">Attacking threat vs Bournemouth</small>
                            </div>
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; border-left: 4px solid #28a745;">
                                <strong>DEF:</strong> Ezri Konsa (Aston Villa) - £4.5m
                                <small style="display: block; color: #666;">Value pick with rotation potential</small>
                            </div>
                            <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; border-left: 4px solid #28a745;">
                                <strong>DEF:</strong> Marc Guehi (Crystal Palace) - £4.5m
                                <small style="display: block; color: #666;">Reliable, good early run</small>
                            </div>
                        </div>
                        
                        <!-- Midfielders -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                            <div style="background: linear-gradient(135deg, #ffd700, #ffa500); padding: 10px; border-radius: 6px; color: white;">
                                <strong>MID:</strong> Mohamed Salah (Liverpool) - £12.5m ⚡
                                <small style="display: block;">CAPTAIN - Explosive vs Bournemouth</small>
                            </div>
                            <div style="background: #fff3e0; padding: 10px; border-radius: 6px; border-left: 4px solid #ff9800;">
                                <strong>MID:</strong> Bruno Fernandes (Man Utd) - £8.5m
                                <small style="display: block; color: #666;">Penalty taker, pre-season goals</small>
                            </div>
                            <div style="background: #fff3e0; padding: 10px; border-radius: 6px; border-left: 4px solid #ff9800;">
                                <strong>MID:</strong> Eberechi Eze (Crystal Palace) - £7.0m
                                <small style="display: block; color: #666;">Set pieces, value mid</small>
                            </div>
                            <div style="background: #fff3e0; padding: 10px; border-radius: 6px; border-left: 4px solid #ff9800;">
                                <strong>MID:</strong> Jarrod Bowen (West Ham) - £7.5m
                                <small style="display: block; color: #666;">Consistent scorer, favorable start</small>
                            </div>
                            <div style="background: #fff3e0; padding: 10px; border-radius: 6px; border-left: 4px solid #ff9800;">
                                <strong>MID:</strong> Pape Sarr (Tottenham) - £4.5m
                                <small style="display: block; color: #666;">Budget enabler with rotation upside</small>
                            </div>
                        </div>
                        
                        <!-- Forwards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                            <div style="background: #fce4ec; padding: 10px; border-radius: 6px; border-left: 4px solid #e91e63;">
                                <strong>FWD:</strong> Erling Haaland (Man City) - £15.0m
                                <small style="display: block; color: #666;">Goal machine, Golden Boot contender</small>
                            </div>
                            <div style="background: #fce4ec; padding: 10px; border-radius: 6px; border-left: 4px solid #e91e63;">
                                <strong>FWD:</strong> Ollie Watkins (Aston Villa) - £9.0m
                                <small style="display: block; color: #666;">In-form striker, great fixtures</small>
                            </div>
                        </div>
                        
                        <!-- Bench -->
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 10px;">
                            <strong>Bench Suggestions:</strong>
                            <div style="display: flex; gap: 15px; margin-top: 10px; flex-wrap: wrap;">
                                <span style="background: white; padding: 5px 10px; border-radius: 4px;">GK: Neto (£4.0m)</span>
                                <span style="background: white; padding: 5px 10px; border-radius: 4px;">DEF: Lewis Dunk (£4.5m)</span>
                                <span style="background: white; padding: 5px 10px; border-radius: 4px;">MID: Andreas Pereira (£5.0m)</span>
                                <span style="background: white; padding: 5px 10px; border-radius: 4px;">FWD: Yoane Wissa (£6.0m)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Summary -->
                    <div style="display: flex; justify-content: space-around; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <strong style="display: block; color: #6f42c1; font-size: 1.5rem;">£100.0m</strong>
                            <small>Total Cost</small>
                        </div>
                        <div style="text-align: center;">
                            <strong style="display: block; color: #28a745; font-size: 1.5rem;">3-5-2</strong>
                            <small>Formation</small>
                        </div>
                        <div style="text-align: center;">
                            <strong style="display: block; color: #fd7e14; font-size: 1.5rem;">~85pts</strong>
                            <small>Expected GW1</small>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="useTeamOfWeek()" style="padding: 12px 30px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                            📋 Use This Squad
                        </button>
                        <button onclick="optimizeFromTOTW()" style="padding: 12px 30px; background: linear-gradient(135deg, #6f42c1, #17a2b8); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1.1rem;">
                            🔧 Optimize Similar
                        </button>
                        <button onclick="toggleTOTWDetails()" style="padding: 12px 30px; background: #17a2b8; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
                            📊 Analysis
                        </button>
                    </div>
                    
                    <!-- Detailed Analysis (Hidden by default) -->
                    <div id="totw-analysis" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="color: #37003c; margin-bottom: 15px;">📈 Why This Squad?</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 10px;">✅ <strong>Premium Balance:</strong> Salah + Haaland provide explosive captain options</li>
                            <li style="margin-bottom: 10px;">✅ <strong>Fixture Focus:</strong> Liverpool (BOU H), Arsenal (NFO H), Palace (SHU H) have excellent GW1</li>
                            <li style="margin-bottom: 10px;">✅ <strong>Value Picks:</strong> Konsa, Guehi, Sarr enable premium investments</li>
                            <li style="margin-bottom: 10px;">✅ <strong>Set Piece Threat:</strong> TAA, Bruno, Eze all on dead balls</li>
                            <li style="margin-bottom: 10px;">✅ <strong>Flexibility:</strong> Easy downgrades if needed for future transfers</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 6px;">
                            <strong>🎯 GW1 Strategy:</strong> Captain Salah vs Bournemouth (H), Vice Haaland vs Burnley (A). 
                            Consider benching Sarr for first sub. Monitor Eze's injury status pre-deadline.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strategy Selector -->
            <div class="strategy-selector">
                <div class="strategy-card selected" data-strategy="balanced" onclick="selectStrategy('balanced')">
                    <h3>⚖️ Balanced</h3>
                    <div class="strategy-description">
                        Mix of premium and budget players for consistent returns with good value picks
                    </div>
                </div>
                
                <div class="strategy-card" data-strategy="best" onclick="selectStrategy('best')">
                    <h3>🏆 Best Team</h3>
                    <div class="strategy-description">
                        AI-optimized squad with highest predicted points for maximum performance
                    </div>
                </div>
                
                <div class="strategy-card" data-strategy="budget" onclick="selectStrategy('budget')">
                    <h3>💰 Budget Team</h3>
                    <div class="strategy-description">
                        Cost-effective squad under £95m with focus on value and emerging talents
                    </div>
                </div>
                
                <div class="strategy-card" data-strategy="wildcard" onclick="selectStrategy('wildcard')">
                    <h3>🎰 Wildcard</h3>
                    <div class="strategy-description">
                        Complete squad overhaul targeting form players and fixture swings
                    </div>
                </div>
            </div>

            <!-- Constraints Panel -->
            <div class="constraints-panel">
                <h2 style="text-align: center; color: #37003c; margin-bottom: 25px;">
                    ⚙️ Optimization Constraints
                </h2>
                
                <div class="constraints-grid">
                    <div class="constraint-section">
                        <h3>💰 Budget Settings</h3>
                        <div class="budget-display">
                            <span class="budget-amount" id="budget-display">£100.0m</span>
                            <small>Available Budget</small>
                        </div>
                        <div class="budget-input">
                            <label>Budget:</label>
                            <input type="range" id="budget-slider" min="800" max="1000" value="1000" step="5">
                            <span id="budget-value">£100.0m</span>
                        </div>
                    </div>
                    
                    <div class="constraint-section">
                        <h3>🏟️ Formation</h3>
                        <div class="position-constraints">
                            <div class="position-constraint">
                                <label>Goalkeepers:</label>
                                <div class="constraint-inputs">
                                    <input type="number" id="gkp-min" min="1" max="2" value="2">
                                    <span>/2</span>
                                </div>
                            </div>
                            <div class="position-constraint">
                                <label>Defenders:</label>
                                <div class="constraint-inputs">
                                    <input type="number" id="def-play" min="3" max="5" value="4">
                                    <span>/5</span>
                                </div>
                            </div>
                            <div class="position-constraint">
                                <label>Midfielders:</label>
                                <div class="constraint-inputs">
                                    <input type="number" id="mid-play" min="2" max="5" value="4">
                                    <span>/5</span>
                                </div>
                            </div>
                            <div class="position-constraint">
                                <label>Forwards:</label>
                                <div class="constraint-inputs">
                                    <input type="number" id="fwd-play" min="1" max="3" value="2">
                                    <span>/3</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="constraint-section">
                        <h3>🎯 Preferences</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="include-captains" checked>
                                <span>Include captain candidates</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="avoid-rotation" checked>
                                <span>Avoid rotation risks</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="consider-fixtures">
                                <span>Prioritize good fixtures</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="differential-picks">
                                <span>Include differential picks</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Optimization Controls -->
            <div class="optimization-controls">
                <button class="optimize-btn btn-totw" onclick="getTeamOfTheWeek()" id="totw-button">
                    🏆 Team of the Week
                </button>
                <button class="optimize-btn" onclick="optimizeTeam()" id="optimize-button">
                    🚀 Optimize My Squad
                </button>
                <button class="optimize-btn btn-reset" onclick="resetTeam()" id="reset-button">
                    🔄 Reset Team
                </button>
            </div>

            <!-- Results Container -->
            <div class="results-container" id="results-container">
                <!-- Squad Display -->
                <div class="squad-display">
                    <div class="squad-header">
                        <h2 style="color: #37003c; margin: 0;">🏆 Optimized Squad</h2>
                        <div class="squad-stats" id="squad-stats">
                            <!-- Stats will be populated here -->
                        </div>
                    </div>
                    
                    <div class="formation-display" id="formation-display">
                        <!-- Formation will be populated here -->
                    </div>
                </div>

                <!-- Value Analysis -->
                <div class="value-analysis" id="value-analysis">
                    <h3 style="text-align: center; margin-bottom: 10px;">📊 Value Analysis</h3>
                    <p style="text-align: center; opacity: 0.9; margin-bottom: 20px;">
                        Your optimized squad's performance metrics and value breakdown
                    </p>
                    <div class="value-metrics" id="value-metrics">
                        <!-- Metrics will be populated here -->
                    </div>
                </div>

                <!-- Alternatives Section -->
                <div class="alternatives-section" id="alternatives-section">
                    <h3 style="color: #37003c; text-align: center; margin-bottom: 10px;">
                        🔄 Alternative Options
                    </h3>
                    <p style="text-align: center; color: #666; margin-bottom: 20px;">
                        Similar players you can consider for your optimized positions
                    </p>
                    <div class="alternatives-grid" id="alternatives-grid">
                        <!-- Alternatives will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 style="color: #37003c; margin-bottom: 10px;">Optimizing Your Squad</h3>
            <p style="color: #666; margin: 0;">
                Analyzing thousands of player combinations to find your perfect team...
            </p>
        </div>
    </div>

    <!-- SEO Content Section -->
    <section class="seo-content-section" style="max-width: 1600px; margin: 60px auto 40px; padding: 40px 20px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.08);">
        <div style="max-width: 1200px; margin: 0 auto;">
            <h2 style="font-size: 2.5rem; color: #37003c; text-align: center; margin-bottom: 30px; font-weight: 800;">Maximize Your FPL Budget with Intelligent Optimization</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; margin-bottom: 40px;">
                <div style="background: white; padding: 30px; border-radius: 12px; border-left: 4px solid #6f42c1; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                    <h3 style="color: #37003c; margin-bottom: 15px; font-size: 1.4rem;">💰 Intelligent Budget Distribution</h3>
                    <p style="color: #666; line-height: 1.6; margin-bottom: 15px;">The FPL Budget Optimizer uses advanced algorithms to distribute your £100m budget optimally across all positions. Unlike manual team building, our AI considers price trends, fixture schedules, and player performance data to suggest the most efficient budget allocation.</p>
                    <p style="color: #666; line-height: 1.6;">Find the perfect balance between premium picks and budget gems, ensuring you maximize points while maintaining squad depth and flexibility for future transfers.</p>
                </div>
                
                <div style="background: white; padding: 30px; border-radius: 12px; border-left: 4px solid #667eea; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                    <h3 style="color: #37003c; margin-bottom: 15px; font-size: 1.4rem;">🎯 Value-Driven Player Selection</h3>
                    <p style="color: #666; line-height: 1.6; margin-bottom: 15px;">Our optimizer identifies players offering exceptional value for money by analyzing points-per-million ratios, upcoming fixtures, and ownership trends. Discover hidden gems before they become popular, giving you a competitive edge.</p>
                    <p style="color: #666; line-height: 1.6;">The tool continuously monitors price changes and suggests optimal entry points for premium players, helping you avoid buying at peak prices and maximize your budget efficiency.</p>
                </div>
            </div>

            <h3 style="color: #37003c; margin-bottom: 25px; font-size: 2rem; text-align: center;">Essential Budget Optimization Strategies for FPL</h3>
            
            <div style="background: white; padding: 35px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <h4 style="color: #6f42c1; margin-bottom: 20px; font-size: 1.3rem;">Understanding Budget Allocation Principles</h4>
                <p style="color: #666; line-height: 1.7; margin-bottom: 15px;">Successful FPL managers understand that budget allocation is more art than science. The optimizer helps you follow proven principles: invest heavily in positions that score the most points (typically forwards and attacking midfielders), find reliable budget options in defense, and maintain flexibility for future transfers.</p>
                <p style="color: #666; line-height: 1.7; margin-bottom: 15px;">The 3-5-2 formation often provides the best budget efficiency, allowing you to field three premium attackers while finding value in defense and midfield. Our optimizer calculates the optimal price points for each position based on current player performance and availability.</p>
                <p style="color: #666; line-height: 1.7;">Remember that budget optimization isn't just about the initial team selection – it's about maintaining the right balance throughout the season to enable strategic transfers without taking unnecessary point hits.</p>
            </div>

            <div style="background: white; padding: 35px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <h4 style="color: #6f42c1; margin-bottom: 20px; font-size: 1.3rem;">Identifying Value Picks and Hidden Gems</h4>
                <p style="color: #666; line-height: 1.7; margin-bottom: 15px;">The Budget Optimizer excels at identifying players who offer exceptional value for their price point. Look for newly-promoted teams' key attackers, players returning from injury at reduced prices, and defenders from teams with improved defensive records.</p>
                <p style="color: #666; line-height: 1.7; margin-bottom: 15px;">Budget defenders (£4.0-5.0m) can be particularly valuable if they play for teams with good defensive records and offer attacking threat from set pieces. The optimizer identifies defenders who contribute to goals and assists while maintaining clean sheet potential.</p>
                <p style="color: #666; line-height: 1.7;">In midfield, target players from attacking teams priced under £6.0m who play advanced positions or take set pieces. These players often provide similar output to more expensive options while freeing up budget for premium forwards.</p>
            </div>

            <div style="background: white; padding: 35px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <h4 style="color: #6f42c1; margin-bottom: 20px; font-size: 1.3rem;">Advanced Budget Management Techniques</h4>
                <p style="color: #666; line-height: 1.7; margin-bottom: 15px;">Effective budget management extends beyond initial team selection. The optimizer helps you plan price changes by identifying players likely to rise in value, allowing you to bank profit for future upgrades. Monitor ownership trends and performance metrics to spot rising stars early.</p>
                <p style="color: #666; line-height: 1.7; margin-bottom: 15px;">Use the "enabler" strategy for the final spots in your squad – cheap players who rarely play but allow you to afford premium options elsewhere. The optimizer identifies the most reliable £4.0m defenders and £4.5m midfielders for this purpose.</p>
                <p style="color: #666; line-height: 1.7;">Plan your budget around key decision points in the season: the first wildcard, winter transfers, and fixture swings. The optimizer helps you maintain the right budget distribution to take advantage of these crucial moments.</p>
            </div>

            <h3 style="color: #37003c; margin-bottom: 25px; font-size: 2rem; text-align: center;">How to Use the Budget Optimizer Effectively</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px;">
                <div style="background: linear-gradient(135deg, #28a745, #20c997); padding: 25px; border-radius: 12px; color: white;">
                    <h4 style="margin-bottom: 15px; font-size: 1.2rem;">Step 1: Set Your Strategy</h4>
                    <p style="opacity: 0.9; line-height: 1.6;">Choose your preferred formation and risk tolerance. Aggressive strategies focus on expensive attackers, while balanced approaches spread budget more evenly. Conservative strategies prioritize consistent performers.</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #6f42c1, #667eea); padding: 25px; border-radius: 12px; color: white;">
                    <h4 style="margin-bottom: 15px; font-size: 1.2rem;">Step 2: Analyze Suggestions</h4>
                    <p style="opacity: 0.9; line-height: 1.6;">Review the optimizer's suggestions and understand the reasoning behind each pick. Consider fixtures, form, and long-term potential when evaluating recommended players.</p>
                </div>
                
                <div style="background: linear-gradient(135deg, #17a2b8, #20c997); padding: 25px; border-radius: 12px; color: white;">
                    <h4 style="margin-bottom: 15px; font-size: 1.2rem;">Step 3: Customize & Refine</h4>
                    <p style="opacity: 0.9; line-height: 1.6;">Make personal adjustments based on your preferences and local knowledge. The optimizer provides the framework, but your final decisions should reflect your own analysis and risk appetite.</p>
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: 35px; border-radius: 12px; border: 2px solid #e9ecef;">
                <h4 style="color: #37003c; margin-bottom: 20px; font-size: 1.4rem; text-align: center;">💎 Advanced Budget Optimization Tips</h4>
                <ul style="list-style: none; padding: 0; margin: 0;">
                    <li style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #28a745;">
                        <strong style="color: #37003c;">Position-Based Value Analysis:</strong> Defenders and goalkeepers offer the best value at lower price points, while forwards typically require higher investment for consistent returns.
                    </li>
                    <li style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #6f42c1;">
                        <strong style="color: #37003c;">Fixture-Aware Budgeting:</strong> Allocate more budget to players with favorable early fixtures, then plan transfers to players with better long-term schedules.
                    </li>
                    <li style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <strong style="color: #37003c;">Price Change Strategy:</strong> Target players likely to rise in price early in the season, banking value that can be used for strategic upgrades later.
                    </li>
                    <li style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #fd7e14;">
                        <strong style="color: #37003c;">Template vs Differential Balance:</strong> The optimal squad balances popular template players with unique differentials, managing risk while maintaining upside potential.
                    </li>
                    <li style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <strong style="color: #37003c;">Emergency Budget Reserve:</strong> Always maintain some budget flexibility for injury replacements and unexpected opportunities throughout the season.
                    </li>
                </ul>
            </div>
        </div>
    </section>

    <div class="footer" include="../../components/layout/footer.html"></div>
    <script src="./index.js"></script>

    <script>
        class BudgetOptimizer {
            constructor() {
                this.fplService = new FPLHtmlDataService();
                
                // Initialize advanced features only if available
                try {
                    if (typeof AdvancedBudgetOptimizer !== 'undefined') {
                        this.advancedOptimizer = new AdvancedBudgetOptimizer();
                    } else {
                        console.warn('Advanced optimizer not available, using standard optimization');
                        this.advancedOptimizer = null;
                    }
                } catch (e) {
                    console.warn('Could not initialize advanced optimizer:', e);
                    this.advancedOptimizer = null;
                }
                
                try {
                    if (typeof FixtureDifficultyService !== 'undefined') {
                        this.fixtureService = new FixtureDifficultyService();
                    } else {
                        this.fixtureService = null;
                    }
                } catch (e) {
                    this.fixtureService = null;
                }
                
                try {
                    if (typeof SquadManager !== 'undefined') {
                        this.squadManager = new SquadManager();
                    } else {
                        this.squadManager = null;
                    }
                } catch (e) {
                    this.squadManager = null;
                }
                
                try {
                    if (typeof DifferentialAnalyzer !== 'undefined') {
                        this.differentialAnalyzer = new DifferentialAnalyzer();
                    } else {
                        this.differentialAnalyzer = null;
                    }
                } catch (e) {
                    this.differentialAnalyzer = null;
                }
                
                this.gameweekPlanner = null; // Will be initialized after fixture service
                this.selectedStrategy = 'balanced';
                this.selectedAlgorithm = 'standard';
                this.allPlayers = [];
                this.teams = [];
                this.optimizedSquad = null;
                this.alternatives = {};
                this.optimizationProgress = null;
            }

            async initialize() {
                try {
                    const bootstrap = await this.fplService.getBootstrapData();
                    
                    if (bootstrap && bootstrap.elements && bootstrap.elements.length > 0) {
                        this.allPlayers = bootstrap.elements;
                        this.teams = bootstrap.teams || [];
                        this.updateLiveIndicator(true);
                    } else {
                        throw new Error('Invalid or empty data received');
                    }
                    
                    // Initialize advanced services if available
                    if (this.fixtureService) {
                        try {
                            await this.fixtureService.loadFixtures();
                            if (this.squadManager && typeof GameweekPlanner !== 'undefined') {
                                this.gameweekPlanner = new GameweekPlanner(this.fixtureService, this.squadManager);
                            }
                            if (this.advancedOptimizer) {
                                this.advancedOptimizer.setFixtureData(this.fixtureService.fixtureData);
                            }
                        } catch (e) {
                            console.warn('Could not initialize fixture service:', e);
                        }
                    }
                    
                    // Set up progress callback for advanced algorithms
                    if (this.advancedOptimizer) {
                        this.advancedOptimizer.setProgressCallback((progress) => {
                            this.updateOptimizationProgress(progress);
                        });
                    }
                    
                    this.setupEventListeners();
                    this.updateBudgetDisplay();
                    if (this.squadManager) {
                        this.loadSavedSquads();
                    }
                    
                    // Auto-refresh every 2 minutes
                    setInterval(() => this.refreshData(), 2 * 60 * 1000);
                } catch (error) {
                    console.error('Failed to initialize budget optimizer:', error);
                    console.log('Falling back to mock data...');
                    // Continue with mock data initialization
                    this.initializeMockData();
                    this.setupEventListeners();
                    this.updateBudgetDisplay();
                    this.updateLiveIndicator(false);
                }
            }
            
            generateMockPlayersForPosition(position, count = 20) {
                const players = [];
                const positionNames = {
                    1: ['Goalkeeper', 'GK'],
                    2: ['Defender', 'DEF'],
                    3: ['Midfielder', 'MID'],
                    4: ['Forward', 'FWD']
                };
                
                for (let i = 0; i < count; i++) {
                    const price = position === 1 ? 40 + Math.random() * 20 : // GKP: 4.0-6.0
                                  position === 2 ? 40 + Math.random() * 40 : // DEF: 4.0-8.0
                                  position === 3 ? 45 + Math.random() * 60 : // MID: 4.5-10.5
                                  45 + Math.random() * 50; // FWD: 4.5-9.5
                    
                    players.push({
                        id: `mock_${position}_${i}`,
                        first_name: positionNames[position][1],
                        second_name: `Player${i + 1}`,
                        element_type: position,
                        team: Math.floor(Math.random() * 20) + 1,
                        now_cost: Math.floor(price),
                        total_points: Math.floor(Math.random() * 150),
                        form: (Math.random() * 10).toFixed(1),
                        selected_by_percent: (Math.random() * 50).toFixed(1),
                        minutes: Math.floor(Math.random() * 3000),
                        starts: Math.floor(Math.random() * 30),
                        expected_goals: (Math.random() * 10).toFixed(2),
                        expected_assists: (Math.random() * 8).toFixed(2),
                        transfers_in_event: Math.floor(Math.random() * 50000),
                        transfers_out_event: Math.floor(Math.random() * 25000)
                    });
                }
                
                return players;
            }
            
            initializeMockData() {
                // Generate mock players for testing
                const firstNames = ['Mohamed', 'Erling', 'Bukayo', 'Marcus', 'Phil', 'Kevin', 'Bruno', 'Harry', 'Son', 'Cole'];
                const lastNames = ['Salah', 'Haaland', 'Saka', 'Rashford', 'Foden', 'De Bruyne', 'Fernandes', 'Kane', 'Heung-min', 'Palmer'];
                
                this.teams = [
                    { id: 1, name: 'Arsenal', short_name: 'ARS' },
                    { id: 2, name: 'Chelsea', short_name: 'CHE' },
                    { id: 3, name: 'Liverpool', short_name: 'LIV' },
                    { id: 4, name: 'Man City', short_name: 'MCI' },
                    { id: 5, name: 'Man Utd', short_name: 'MUN' },
                    { id: 6, name: 'Tottenham', short_name: 'TOT' },
                    { id: 7, name: 'Newcastle', short_name: 'NEW' },
                    { id: 8, name: 'Brighton', short_name: 'BHA' },
                    { id: 9, name: 'Fulham', short_name: 'FUL' },
                    { id: 10, name: 'West Ham', short_name: 'WHU' }
                ];
                
                this.allPlayers = [];
                
                // Generate premium players
                const premiumPlayers = [
                    { first_name: 'Mohamed', second_name: 'Salah', element_type: 3, team: 3, now_cost: 130, total_points: 211 },
                    { first_name: 'Erling', second_name: 'Haaland', element_type: 4, team: 4, now_cost: 140, total_points: 185 },
                    { first_name: 'Bukayo', second_name: 'Saka', element_type: 3, team: 1, now_cost: 100, total_points: 165 },
                    { first_name: 'Cole', second_name: 'Palmer', element_type: 3, team: 2, now_cost: 105, total_points: 178 },
                    { first_name: 'Son', second_name: 'Heung-min', element_type: 3, team: 6, now_cost: 95, total_points: 145 }
                ];
                
                // Add premium players
                premiumPlayers.forEach((player, index) => {
                    this.allPlayers.push({
                        ...player,
                        id: index + 1,
                        form: (7 + Math.random() * 3).toFixed(1),
                        selected_by_percent: (20 + Math.random() * 30).toFixed(1),
                        minutes: 2500 + Math.floor(Math.random() * 500),
                        starts: 25 + Math.floor(Math.random() * 10),
                        expected_goals: (10 + Math.random() * 10).toFixed(2),
                        expected_assists: (5 + Math.random() * 10).toFixed(2),
                        transfers_in_event: Math.floor(Math.random() * 100000),
                        transfers_out_event: Math.floor(Math.random() * 50000)
                    });
                });
                
                // Generate regular players
                for (let i = premiumPlayers.length; i < 600; i++) {
                    const position = Math.floor(i / 150) + 1;
                    const price = position === 1 ? Math.floor(Math.random() * 10 + 40) : // GKP: 4.0-5.0
                                  position === 2 ? Math.floor(Math.random() * 30 + 40) : // DEF: 4.0-7.0
                                  position === 3 ? Math.floor(Math.random() * 50 + 45) : // MID: 4.5-9.5
                                  Math.floor(Math.random() * 40 + 45); // FWD: 4.5-8.5
                    
                    this.allPlayers.push({
                        id: i + 1,
                        first_name: firstNames[Math.floor(Math.random() * firstNames.length)],
                        second_name: lastNames[Math.floor(Math.random() * lastNames.length)] + i,
                        element_type: position,
                        team: Math.floor(Math.random() * 10) + 1,
                        now_cost: price,
                        total_points: Math.floor(Math.random() * 150),
                        form: (Math.random() * 10).toFixed(1),
                        selected_by_percent: (Math.random() * 30).toFixed(1),
                        minutes: Math.floor(Math.random() * 3000),
                        starts: Math.floor(Math.random() * 30),
                        expected_goals: (Math.random() * 8).toFixed(2),
                        expected_assists: (Math.random() * 6).toFixed(2),
                        transfers_in_event: Math.floor(Math.random() * 50000),
                        transfers_out_event: Math.floor(Math.random() * 25000)
                    });
                }
                
                // Fix: teams array was not defined
                const teamNames = ['Arsenal', 'Chelsea', 'Liverpool', 'Man City', 'Man Utd', 
                                   'Tottenham', 'Newcastle', 'Brighton', 'Fulham', 'West Ham'];
                this.teams = this.teams.length > 0 ? this.teams : teamNames.map((name, i) => ({
                    id: i + 1,
                    short_name: name.substring(0, 3).toUpperCase(),
                    name: name
                }));
                
                this.setupEventListeners();
                this.updateBudgetDisplay();
            }

            async refreshData() {
                console.log('Refreshing live data...');
                document.getElementById('data-status').textContent = 'REFRESHING...';
                
                try {
                    const bootstrap = await this.fplService.getBootstrapData(true); // Force refresh
                    this.allPlayers = bootstrap.elements;
                    this.teams = bootstrap.teams;
                    
                    this.updateLiveIndicator();
                    
                    console.log('Data refreshed successfully');
                } catch (error) {
                    console.error('Failed to refresh data:', error);
                    this.updateLiveIndicator(false);
                }
            }

            updateLiveIndicator(isLive = null) {
                const statusEl = document.getElementById('data-status');
                const dotEl = document.getElementById('live-dot');
                const updateEl = document.getElementById('last-update');
                
                if (!statusEl || !dotEl || !updateEl) return;
                
                const dataIsLive = isLive !== null ? isLive : (this.fplService && this.fplService.isDataLive ? this.fplService.isDataLive() : false);
                
                if (dataIsLive) {
                    statusEl.textContent = 'LIVE DATA';
                    dotEl.style.background = '#00ff00';
                } else {
                    statusEl.textContent = 'MOCK DATA';
                    dotEl.style.background = '#ffa500';
                }
                
                // Check if getLastUpdateTime exists before calling
                if (this.fplService && typeof this.fplService.getLastUpdateTime === 'function') {
                    updateEl.textContent = this.fplService.getLastUpdateTime();
                } else {
                    updateEl.textContent = new Date().toLocaleTimeString();
                }
            }

            setupEventListeners() {
                const budgetSlider = document.getElementById('budget-slider');
                budgetSlider.addEventListener('input', () => {
                    this.updateBudgetDisplay();
                });

                // Formation validation
                ['def-play', 'mid-play', 'fwd-play'].forEach(id => {
                    document.getElementById(id).addEventListener('change', () => {
                        this.validateFormation();
                    });
                });
            }

            updateBudgetDisplay() {
                const budget = parseInt(document.getElementById('budget-slider').value);
                const budgetText = `£${(budget / 10).toFixed(1)}m`;
                document.getElementById('budget-display').textContent = budgetText;
                document.getElementById('budget-value').textContent = budgetText;
            }

            validateFormation() {
                const def = parseInt(document.getElementById('def-play').value) || 5;
                const mid = parseInt(document.getElementById('mid-play').value) || 5;
                const fwd = parseInt(document.getElementById('fwd-play').value) || 3;
                
                // Check individual position constraints
                if (def < 3 || def > 5) {
                    alert('Defenders must be between 3 and 5 (currently ' + def + ')');
                    return false;
                }
                if (mid < 2 || mid > 5) {
                    alert('Midfielders must be between 2 and 5 (currently ' + mid + ')');
                    return false;
                }
                if (fwd < 1 || fwd > 3) {
                    alert('Forwards must be between 1 and 3 (currently ' + fwd + ')');
                    return false;
                }
                
                // Allow flexibility - recommend but don't require exactly 10
                const total = def + mid + fwd;
                if (total < 10) {
                    const addMore = confirm('You have ' + total + ' outfield players. A full squad has 10. Continue anyway?');
                    if (!addMore) return false;
                } else if (total > 10) {
                    alert('Too many outfield players! Maximum is 10 (currently ' + total + ')');
                    // Auto-adjust to valid formation
                    if (total === 11) {
                        if (def === 5 && mid === 5) {
                            document.getElementById('mid-play').value = 4;
                        } else if (def === 5) {
                            document.getElementById('def-play').value = 4;
                        }
                    }
                    return false;
                }
                return true;
            }

            selectStrategy(strategy) {
                this.selectedStrategy = strategy;
                document.querySelectorAll('.strategy-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-strategy="${strategy}"]`).classList.add('selected');
            }

            async optimizeTeam() {
                // Validate formation with flexibility
                if (!this.validateFormation()) return;
                
                // Ensure we have player data
                if (!this.allPlayers || this.allPlayers.length === 0) {
                    console.log('No player data available, initializing mock data...');
                    this.initializeMockData();
                    
                    // Ensure mock data was created
                    if (!this.allPlayers || this.allPlayers.length === 0) {
                        alert('Failed to load player data. Please refresh the page.');
                        return;
                    }
                }

                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('optimize-button').disabled = true;
                
                // Update loading message based on algorithm with progress tracking
                const loadingMessage = document.querySelector('#loading-overlay p');
                const progressUpdates = [
                    'Analyzing player data and statistics...',
                    'Calculating optimal budget distribution...',
                    'Running advanced optimization algorithms...',
                    'Evaluating thousands of player combinations...',
                    'Fine-tuning squad selections...',
                    'Finalizing optimal team structure...'
                ];
                
                let updateIndex = 0;
                const updateInterval = setInterval(() => {
                    if (updateIndex < progressUpdates.length) {
                        loadingMessage.textContent = progressUpdates[updateIndex];
                        updateIndex++;
                    }
                }, 800);
                
                // Clear interval when optimization completes
                setTimeout(() => clearInterval(updateInterval), 5000);
                
                if (this.selectedAlgorithm === 'genetic') {
                    loadingMessage.textContent = '🧬 Running genetic algorithm to evolve optimal squad...';
                } else if (this.selectedAlgorithm === 'annealing') {
                    loadingMessage.textContent = '🔥 Applying simulated annealing optimization...';
                } else if (this.selectedAlgorithm === 'hybrid') {
                    loadingMessage.textContent = '🤖 Using hybrid AI to find the perfect squad...';
                } else {
                    loadingMessage.textContent = '⚡ Analyzing thousands of player combinations...';
                }

                try {
                    // Adjust budget for budget team strategy
                    if (this.selectedStrategy === 'budget') {
                        document.getElementById('budget-slider').value = 950; // £95m
                        this.updateBudgetDisplay();
                    } else if (this.selectedStrategy === 'best') {
                        document.getElementById('budget-slider').value = 1000; // £100m
                        this.updateBudgetDisplay();
                    }
                    
                    const constraints = this.gatherConstraints();
                    const startTime = Date.now();
                    
                    console.log('Starting optimization with constraints:', constraints);
                    console.log('Players available:', this.allPlayers.length);
                    
                    // Use selected algorithm
                    try {
                        if (this.selectedAlgorithm === 'genetic' && this.advancedOptimizer) {
                            const squad = await this.advancedOptimizer.geneticAlgorithm(this.allPlayers, constraints);
                            this.optimizedSquad = this.formatOptimizedSquadResult(squad, constraints);
                        } else if (this.selectedAlgorithm === 'annealing' && this.advancedOptimizer) {
                            const squad = await this.advancedOptimizer.simulatedAnnealing(this.allPlayers, constraints);
                            this.optimizedSquad = this.formatOptimizedSquadResult(squad, constraints);
                        } else if (this.selectedAlgorithm === 'hybrid' && this.advancedOptimizer) {
                            // Run both and pick best
                            const genetic = await this.advancedOptimizer.geneticAlgorithm(this.allPlayers, constraints);
                            const annealing = await this.advancedOptimizer.simulatedAnnealing(this.allPlayers, constraints);
                            const geneticFitness = this.advancedOptimizer.calculateFitness(genetic, constraints);
                            const annealingFitness = this.advancedOptimizer.calculateFitness(annealing, constraints);
                            const bestSquad = geneticFitness > annealingFitness ? genetic : annealing;
                            this.optimizedSquad = this.formatOptimizedSquadResult(bestSquad, constraints);
                        } else {
                            // Standard optimization (fallback)
                            console.log('Using standard optimization');
                            this.optimizedSquad = await this.generateOptimalSquad(constraints);
                        }
                    } catch (algoError) {
                        console.error('Algorithm failed, using standard optimization:', algoError);
                        // Fallback to standard optimization
                        this.optimizedSquad = await this.generateOptimalSquad(constraints);
                    }
                    
                    // Comprehensive squad validation
                    if (!this.optimizedSquad || !this.optimizedSquad.squad) {
                        throw new Error('Failed to generate valid squad');
                    }
                    
                    const validationResult = this.validateOptimizedSquad(this.optimizedSquad);
                    if (!validationResult.isValid) {
                        console.warn('Squad validation issues:', validationResult.issues);
                        // Try to fix minor issues
                        this.optimizedSquad = this.fixSquadIssues(this.optimizedSquad, validationResult.issues);
                    }
                    
                    // Final check
                    if (!this.optimizedSquad || this.getTotalPlayers(this.optimizedSquad.squad) === 0) {
                        throw new Error('Generated squad has no players after validation');
                    }
                    
                    console.log('Optimization successful:', this.optimizedSquad);
                    
                    // Track optimization
                    const duration = Date.now() - startTime;
                    this.squadManager.trackOptimization(this.optimizedSquad, this.selectedAlgorithm, duration, 100);
                    
                    // Save squad automatically
                    this.optimizedSquad.strategy = this.selectedStrategy;
                    const squadId = this.squadManager.saveSquad(this.optimizedSquad, `${this.selectedStrategy} - ${new Date().toLocaleDateString()}`);
                    
                    this.alternatives = await this.generateAlternatives(this.optimizedSquad);
                    
                    this.displayResults();
                    this.displaySaveOptions(squadId);
                    document.getElementById('results-container').style.display = 'block';
                    document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
                } catch (error) {
                    console.error('Optimization failed:', error);
                    alert('Optimization failed. Please try again.');
                } finally {
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('optimize-button').disabled = false;
                }
            }

            gatherConstraints() {
                // Get formation values with defaults
                const def = parseInt(document.getElementById('def-play').value) || 4;
                const mid = parseInt(document.getElementById('mid-play').value) || 4;
                const fwd = parseInt(document.getElementById('fwd-play').value) || 2;
                
                // Adjust GKP count based on total squad size
                const outfieldTotal = def + mid + fwd;
                const gkpCount = outfieldTotal >= 10 ? 2 : 1; // Only 1 GKP if partial squad
                
                return {
                    budget: parseInt(document.getElementById('budget-slider').value),
                    strategy: this.selectedStrategy,
                    formation: {
                        gkp: gkpCount,
                        def: def,
                        mid: mid,
                        fwd: fwd
                    },
                    preferences: {
                        includeCaptains: document.getElementById('include-captains').checked,
                        avoidRotation: document.getElementById('avoid-rotation').checked,
                        considerFixtures: document.getElementById('consider-fixtures').checked,
                        differentialPicks: document.getElementById('differential-picks').checked
                    }
                };
            }

            async generateOptimalSquad(constraints) {
                const positionPlayers = this.categorizePlayersByPosition();
                const squad = { 1: [], 2: [], 3: [], 4: [] };
                let remainingBudget = constraints.budget;

                // Strategy-based allocation
                const budgetAllocation = this.getBudgetAllocation(constraints.strategy, constraints.budget);

                // Optimize each position
                for (let position = 1; position <= 4; position++) {
                    const positionBudget = budgetAllocation[position];
                    const requiredCount = this.getRequiredCount(position, constraints.formation);
                    
                    const selectedPlayers = await this.optimizePosition(
                        positionPlayers[position],
                        positionBudget,
                        requiredCount,
                        constraints
                    );
                    
                    squad[position] = selectedPlayers;
                    selectedPlayers.forEach(player => {
                        remainingBudget -= player.now_cost;
                    });
                }

                return {
                    squad,
                    totalCost: constraints.budget - remainingBudget,
                    remainingBudget,
                    predictedPoints: this.calculatePredictedPoints(squad),
                    valueScore: this.calculateValueScore(squad)
                };
            }

            categorizePlayersByPosition() {
                const positions = { 1: [], 2: [], 3: [], 4: [] };
                
                // Make sure we have players
                if (!this.allPlayers || this.allPlayers.length === 0) {
                    console.error('No players available for categorization');
                    // Generate some basic mock data if needed
                    this.initializeMockData();
                }
                
                this.allPlayers.forEach(player => {
                    // More lenient filtering - include players even with 0 points if they have other stats
                    if (player && player.element_type >= 1 && player.element_type <= 4) {
                        if (!positions[player.element_type]) {
                            positions[player.element_type] = [];
                        }
                        positions[player.element_type].push(player);
                    }
                });
                
                // Ensure each position has at least some players
                for (let pos = 1; pos <= 4; pos++) {
                    if (!positions[pos] || positions[pos].length === 0) {
                        console.warn(`No players found for position ${pos}, generating mock players`);
                        positions[pos] = this.generateMockPlayersForPosition(pos, 20);
                    }
                }
                
                return positions;
            }

            getBudgetAllocation(strategy, totalBudget) {
                // Enhanced budget allocation based on strategy and formation
                const baseAllocations = {
                    balanced: { 1: 0.08, 2: 0.28, 3: 0.38, 4: 0.26 },
                    best: { 1: 0.07, 2: 0.25, 3: 0.35, 4: 0.33 }, // More on forwards for premium strategy
                    budget: { 1: 0.10, 2: 0.33, 3: 0.37, 4: 0.20 }, // Focus on defense/midfield value
                    wildcard: { 1: 0.08, 2: 0.26, 3: 0.40, 4: 0.26 } // Midfield heavy for form
                };

                const allocation = baseAllocations[strategy] || baseAllocations.balanced;
                
                // Adjust allocation based on formation (if available)
                const formationAdjustment = this.getFormationAdjustment();
                const adjustedAllocation = { ...allocation };
                
                if (formationAdjustment) {
                    // Slightly increase budget for positions with more players
                    adjustedAllocation[2] *= formationAdjustment.defenseMultiplier;
                    adjustedAllocation[3] *= formationAdjustment.midfieldMultiplier;
                    adjustedAllocation[4] *= formationAdjustment.forwardMultiplier;
                    
                    // Normalize to ensure total = 1
                    const total = Object.values(adjustedAllocation).reduce((sum, val) => sum + val, 0);
                    Object.keys(adjustedAllocation).forEach(pos => {
                        adjustedAllocation[pos] /= total;
                    });
                }
                
                // Calculate actual budget amounts
                const budgetAllocation = {
                    1: Math.floor(totalBudget * adjustedAllocation[1]),
                    2: Math.floor(totalBudget * adjustedAllocation[2]),
                    3: Math.floor(totalBudget * adjustedAllocation[3]),
                    4: Math.floor(totalBudget * adjustedAllocation[4])
                };
                
                // Ensure total doesn't exceed budget due to rounding
                const allocatedTotal = Object.values(budgetAllocation).reduce((sum, val) => sum + val, 0);
                if (allocatedTotal > totalBudget) {
                    // Reduce from highest allocation
                    const positions = Object.keys(budgetAllocation).sort((a, b) => budgetAllocation[b] - budgetAllocation[a]);
                    budgetAllocation[positions[0]] -= (allocatedTotal - totalBudget);
                }
                
                return budgetAllocation;
            }
            
            getFormationAdjustment() {
                try {
                    const def = parseInt(document.getElementById('def-play')?.value) || 4;
                    const mid = parseInt(document.getElementById('mid-play')?.value) || 4;
                    const fwd = parseInt(document.getElementById('fwd-play')?.value) || 2;
                    
                    // Calculate multipliers based on formation
                    const totalOutfield = def + mid + fwd;
                    if (totalOutfield === 0) return null;
                    
                    return {
                        defenseMultiplier: def / totalOutfield * 3, // Base multiplier
                        midfieldMultiplier: mid / totalOutfield * 3,
                        forwardMultiplier: fwd / totalOutfield * 3
                    };
                } catch (error) {
                    console.warn('Could not get formation adjustment:', error);
                    return null;
                }
            }

            getRequiredCount(position, formation) {
                const counts = { 1: formation.gkp, 2: formation.def, 3: formation.mid, 4: formation.fwd };
                return counts[position];
            }

            async optimizePosition(players, budget, count, constraints) {
                // Ensure we have players to work with
                if (!players || players.length === 0) {
                    console.error('No players available for position optimization');
                    return [];
                }
                
                // Sort players by multiple criteria based on strategy
                const scoredPlayers = players.map(player => {
                    try {
                        return {
                            ...player,
                            score: this.calculatePlayerScore(player, constraints.strategy, constraints.preferences)
                        };
                    } catch (e) {
                        console.warn('Error scoring player:', player, e);
                        return { ...player, score: 0 };
                    }
                }).filter(p => p.score > 0).sort((a, b) => b.score - a.score);
                
                if (scoredPlayers.length === 0) {
                    console.warn('No valid scored players, using unscored players');
                    return players.slice(0, count);
                }

                // Use knapsack-style optimization
                const result = this.knapsackOptimization(scoredPlayers, budget, count);
                
                // If knapsack didn't return enough players, fill with cheapest
                if (result.length < count) {
                    const remaining = count - result.length;
                    const usedIds = new Set(result.map(p => p.id));
                    const additionalPlayers = scoredPlayers
                        .filter(p => !usedIds.has(p.id))
                        .sort((a, b) => a.now_cost - b.now_cost)
                        .slice(0, remaining);
                    result.push(...additionalPlayers);
                }
                
                return result;
            }

            calculatePlayerScore(player, strategy, preferences) {
                let score = 0;
                
                // Safely parse values with defaults
                const totalPoints = player.total_points || 0;
                const form = parseFloat(player.form || 0);
                const nowCost = player.now_cost || 50;
                const minutes = player.minutes || 0;
                const starts = player.starts || 1;
                const expectedGoals = parseFloat(player.expected_goals || 0);
                const expectedAssists = parseFloat(player.expected_assists || 0);
                const selectedBy = parseFloat(player.selected_by_percent || 0);
                const transfersIn = player.transfers_in_event || 0;
                const transfersOut = player.transfers_out_event || 0;
                
                // Base metrics with safe calculations
                const pointsScore = totalPoints / 10;
                const formScore = form * 2;
                const valueScore = nowCost > 0 ? (totalPoints / nowCost) * 100 : 0;
                const xGIScore = (expectedGoals + expectedAssists) * 10;
                const minutesRatio = starts > 0 ? minutes / starts / 90 : 0;
                
                // Strategy adjustments
                switch (strategy) {
                    case 'best':
                        // Focus on highest performing players regardless of cost
                        score = pointsScore * 0.35 + formScore * 0.35 + xGIScore * 0.2 + minutesRatio * 0.1;
                        // Bonus for consistent high scorers
                        if (player.total_points > 100) score *= 1.3;
                        if (player.total_points > 150) score *= 1.5;
                        break;
                    
                    case 'budget':
                        // Maximize value under budget constraints
                        score = valueScore * 0.45 + formScore * 0.25 + pointsScore * 0.2 + minutesRatio * 0.1;
                        // Boost cheaper players with good returns
                        if (player.now_cost < 60 && player.total_points > 50) score *= 1.4;
                        if (player.now_cost < 50 && player.total_points > 40) score *= 1.6;
                        break;
                    
                    case 'wildcard':
                        // Focus on form and upcoming fixtures
                        score = formScore * 0.45 + xGIScore * 0.25 + pointsScore * 0.2 + minutesRatio * 0.1;
                        // Boost in-form players
                        if (parseFloat(player.form) > 6) score *= 1.3;
                        if (parseFloat(player.form) > 8) score *= 1.5;
                        // Consider recent transfers
                        if (player.transfers_in_event > player.transfers_out_event * 2) score *= 1.2;
                        break;
                    
                    default: // balanced
                        score = pointsScore * 0.35 + formScore * 0.25 + valueScore * 0.25 + xGIScore * 0.15;
                }

                // Preference adjustments with safe checks
                if (preferences.includeCaptains && totalPoints > 80) {
                    score *= 1.2;
                }
                if (preferences.avoidRotation && minutes < 1500) {
                    score *= 0.8;
                }
                if (preferences.differentialPicks && selectedBy < 10) {
                    score *= 1.1;
                }
                if (preferences.considerFixtures && player.team) {
                    // Boost players from teams with easier fixtures
                    const easyFixtureTeams = [14, 17, 15, 1, 3]; // Example team IDs with easier fixtures
                    if (easyFixtureTeams.includes(player.team)) {
                        score *= 1.15;
                    }
                }
                
                // Ensure score is a valid number
                if (isNaN(score) || !isFinite(score)) {
                    score = 0;
                }

                return score;
            }

            knapsackOptimization(players, budget, count) {
                // Enhanced knapsack optimization for FPL with dynamic programming
                const selected = [];
                let remainingBudget = budget;
                let remainingCount = count;
                
                // Safety check
                if (!players || players.length === 0 || count <= 0) {
                    console.warn('Invalid input to knapsack optimization');
                    return [];
                }
                
                // Sort players by score/cost ratio for better selections
                const sortedPlayers = [...players].sort((a, b) => {
                    const ratioA = a.score / Math.max(a.now_cost, 1);
                    const ratioB = b.score / Math.max(b.now_cost, 1);
                    return ratioB - ratioA;
                });
                
                // Use a hybrid approach: strategic distribution + optimization
                const distribution = this.getOptimalDistribution(count, this.selectedStrategy);
                const priceRanges = {
                    premium: sortedPlayers.filter(p => p.now_cost >= 100),
                    mid: sortedPlayers.filter(p => p.now_cost >= 65 && p.now_cost < 100),
                    budget: sortedPlayers.filter(p => p.now_cost < 65)
                };
                
                // Phase 1: Strategic distribution selection
                for (const [range, targetCount] of Object.entries(distribution)) {
                    const rangePlayers = priceRanges[range];
                    let selectedFromRange = 0;
                    
                    for (const player of rangePlayers) {
                        if (selectedFromRange >= targetCount || remainingCount <= 0) break;
                        
                        if (player.now_cost <= remainingBudget) {
                            selected.push(player);
                            remainingBudget -= player.now_cost;
                            remainingCount--;
                            selectedFromRange++;
                        }
                    }
                }
                
                // Phase 2: Fill remaining slots with optimal combination
                if (remainingCount > 0 && remainingBudget > 0) {
                    const usedIds = new Set(selected.map(p => p.id));
                    const available = sortedPlayers.filter(p => 
                        !usedIds.has(p.id) && 
                        p.now_cost <= remainingBudget &&
                        p.now_cost <= (remainingBudget / remainingCount) * 1.5 // Allow some flexibility
                    );
                    
                    if (available.length > 0) {
                        // Use dynamic programming for remaining selections
                        const bestCombination = this.dynamicProgrammingSelection(
                            available,
                            remainingBudget,
                            remainingCount
                        );
                        selected.push(...bestCombination);
                        
                        // Update remaining values
                        bestCombination.forEach(player => {
                            remainingBudget -= player.now_cost;
                            remainingCount--;
                        });
                    }
                }
                
                // Phase 3: Emergency fill with cheapest available players
                if (remainingCount > 0) {
                    const usedIds = new Set(selected.map(p => p.id));
                    const cheapest = sortedPlayers
                        .filter(p => !usedIds.has(p.id))
                        .sort((a, b) => a.now_cost - b.now_cost)
                        .slice(0, remainingCount);
                    
                    selected.push(...cheapest);
                }
                
                return selected.slice(0, count);
            }
            
            dynamicProgrammingSelection(players, budget, count) {
                if (count <= 0 || budget <= 0 || players.length === 0) return [];
                
                // For performance, limit the problem size
                const maxPlayers = Math.min(players.length, 50);
                const limitedPlayers = players.slice(0, maxPlayers);
                
                // Create DP table: dp[i][j][k] = max score using first i players, j budget, k selections
                const dp = Array(limitedPlayers.length + 1).fill(null).map(() =>
                    Array(budget + 1).fill(null).map(() =>
                        Array(count + 1).fill(-1)
                    )
                );
                
                // Initialize base case
                for (let i = 0; i <= limitedPlayers.length; i++) {
                    for (let j = 0; j <= budget; j++) {
                        dp[i][j][0] = 0;
                    }
                }
                
                // Fill DP table
                for (let i = 1; i <= limitedPlayers.length; i++) {
                    const player = limitedPlayers[i - 1];
                    for (let j = 0; j <= budget; j++) {
                        for (let k = 1; k <= count; k++) {
                            // Option 1: Don't take current player
                            dp[i][j][k] = dp[i - 1][j][k];
                            
                            // Option 2: Take current player (if possible)
                            if (j >= player.now_cost && dp[i - 1][j - player.now_cost][k - 1] >= 0) {
                                const newScore = dp[i - 1][j - player.now_cost][k - 1] + player.score;
                                if (newScore > dp[i][j][k]) {
                                    dp[i][j][k] = newScore;
                                }
                            }
                        }
                    }
                }
                
                // Backtrack to find the actual selection
                const selected = [];
                let i = limitedPlayers.length;
                let j = budget;
                let k = count;
                
                while (i > 0 && k > 0 && j >= 0) {
                    if (dp[i][j][k] !== dp[i - 1][j][k]) {
                        // Player i-1 was selected
                        const player = limitedPlayers[i - 1];
                        selected.push(player);
                        j -= player.now_cost;
                        k--;
                    }
                    i--;
                }
                
                return selected;
            }
            
            validateOptimizedSquad(optimizedSquad) {
                const issues = [];
                let isValid = true;
                
                if (!optimizedSquad || !optimizedSquad.squad) {
                    return { isValid: false, issues: ['No squad data'] };
                }
                
                const squad = optimizedSquad.squad;
                
                // Check each position has players
                for (let pos = 1; pos <= 4; pos++) {
                    if (!squad[pos] || !Array.isArray(squad[pos])) {
                        issues.push(`Position ${pos} has no players array`);
                        isValid = false;
                    } else if (squad[pos].length === 0) {
                        issues.push(`Position ${pos} is empty`);
                        isValid = false;
                    }
                }
                
                // Check total cost doesn't exceed budget
                const totalCost = this.calculateTotalCost(squad);
                const budget = parseInt(document.getElementById('budget-slider')?.value) || 1000;
                if (totalCost > budget) {
                    issues.push(`Total cost ${totalCost} exceeds budget ${budget}`);
                    isValid = false;
                }
                
                // Check formation requirements
                const formation = this.getCurrentFormation();
                if (formation) {
                    if (squad[1] && squad[1].length !== formation.gkp) {
                        issues.push(`Goalkeeper count mismatch: ${squad[1].length} vs ${formation.gkp}`);
                    }
                    if (squad[2] && squad[2].length !== formation.def) {
                        issues.push(`Defender count mismatch: ${squad[2].length} vs ${formation.def}`);
                    }
                    if (squad[3] && squad[3].length !== formation.mid) {
                        issues.push(`Midfielder count mismatch: ${squad[3].length} vs ${formation.mid}`);
                    }
                    if (squad[4] && squad[4].length !== formation.fwd) {
                        issues.push(`Forward count mismatch: ${squad[4].length} vs ${formation.fwd}`);
                    }
                }
                
                // Check for duplicate players
                const allPlayerIds = [];
                Object.values(squad).forEach(position => {
                    if (Array.isArray(position)) {
                        position.forEach(player => {
                            if (player && player.id) {
                                if (allPlayerIds.includes(player.id)) {
                                    issues.push(`Duplicate player ID: ${player.id}`);
                                    isValid = false;
                                }
                                allPlayerIds.push(player.id);
                            }
                        });
                    }
                });
                
                return { isValid, issues };
            }
            
            fixSquadIssues(optimizedSquad, issues) {
                // Attempt to fix common squad issues
                const squad = { ...optimizedSquad.squad };
                
                // Fill empty positions with cheapest available players
                for (let pos = 1; pos <= 4; pos++) {
                    if (!squad[pos] || squad[pos].length === 0) {
                        const cheapestInPosition = this.allPlayers
                            .filter(p => p.element_type === pos)
                            .sort((a, b) => a.now_cost - b.now_cost)
                            .slice(0, 1);
                        
                        if (cheapestInPosition.length > 0) {
                            squad[pos] = cheapestInPosition;
                        }
                    }
                }
                
                return {
                    ...optimizedSquad,
                    squad: squad,
                    totalCost: this.calculateTotalCost(squad)
                };
            }
            
            getCurrentFormation() {
                try {
                    return {
                        gkp: parseInt(document.getElementById('gkp-play')?.value) || 2,
                        def: parseInt(document.getElementById('def-play')?.value) || 5,
                        mid: parseInt(document.getElementById('mid-play')?.value) || 5,
                        fwd: parseInt(document.getElementById('fwd-play')?.value) || 3
                    };
                } catch (error) {
                    return null;
                }
            }
            
            getTotalPlayers(squad) {
                let total = 0;
                Object.values(squad).forEach(position => {
                    if (Array.isArray(position)) {
                        total += position.length;
                    }
                });
                return total;
            }
            
            calculateTotalCost(squad) {
                let total = 0;
                Object.values(squad).forEach(position => {
                    if (Array.isArray(position)) {
                        position.forEach(player => {
                            if (player && player.now_cost) {
                                total += player.now_cost;
                            }
                        });
                    }
                });
                return total;
            }
            
            getOptimalDistribution(count, strategy) {
                const distributions = {
                    best: { premium: Math.ceil(count * 0.4), mid: Math.ceil(count * 0.4), budget: Math.floor(count * 0.2) },
                    budget: { premium: Math.floor(count * 0.1), mid: Math.ceil(count * 0.3), budget: Math.ceil(count * 0.6) },
                    wildcard: { premium: Math.ceil(count * 0.3), mid: Math.ceil(count * 0.4), budget: Math.floor(count * 0.3) },
                    balanced: { premium: Math.ceil(count * 0.25), mid: Math.ceil(count * 0.45), budget: Math.floor(count * 0.3) }
                };
                
                return distributions[strategy] || distributions.balanced;
            }
            
            findBestCombination(players, budget, count) {
                // Simple greedy approach for performance
                const sorted = players.sort((a, b) => b.score - a.score);
                const result = [];
                let remaining = budget;
                
                for (const player of sorted) {
                    if (result.length >= count) break;
                    if (player.now_cost <= remaining) {
                        result.push(player);
                        remaining -= player.now_cost;
                    }
                }
                
                // If we don't have enough players, add cheapest
                if (result.length < count) {
                    const cheapest = players
                        .filter(p => !result.includes(p))
                        .sort((a, b) => a.now_cost - b.now_cost)
                        .slice(0, count - result.length);
                    result.push(...cheapest);
                }
                
                return result;
            }

            calculatePredictedPoints(squad) {
                let total = 0;
                Object.values(squad).forEach(position => {
                    position.forEach(player => {
                        // Simple prediction based on form and recent points
                        const predicted = parseFloat(player.form) * 1.2 + (player.total_points / 20);
                        total += predicted;
                    });
                });
                return Math.round(total);
            }

            calculateValueScore(squad) {
                let totalValue = 0;
                let totalCost = 0;
                Object.values(squad).forEach(position => {
                    position.forEach(player => {
                        totalValue += player.total_points;
                        totalCost += player.now_cost;
                    });
                });
                return (totalValue / totalCost * 100).toFixed(1);
            }

            async generateAlternatives(optimizedSquad) {
                const alternatives = {};
                
                Object.keys(optimizedSquad.squad).forEach(position => {
                    alternatives[position] = [];
                    const positionPlayers = this.allPlayers.filter(p => p.element_type == position);
                    const selectedIds = optimizedSquad.squad[position].map(p => p.id);
                    
                    // Find similar alternatives
                    optimizedSquad.squad[position].forEach(player => {
                        const similar = positionPlayers
                            .filter(p => !selectedIds.includes(p.id))
                            .filter(p => Math.abs(p.now_cost - player.now_cost) <= 10)
                            .sort((a, b) => b.total_points - a.total_points)
                            .slice(0, 3);
                        
                        alternatives[position].push({
                            original: player,
                            alternatives: similar
                        });
                    });
                });
                
                return alternatives;
            }

            displayResults() {
                this.displaySquadStats();
                this.displayFormation();
                this.displayValueAnalysis();
                this.displayAlternatives();
            }

            displaySquadStats() {
                const stats = document.getElementById('squad-stats');
                stats.innerHTML = `
                    <div class="squad-stat">
                        <span class="stat-value">£${(this.optimizedSquad.totalCost / 10).toFixed(1)}m</span>
                        <span class="stat-label">Total Cost</span>
                    </div>
                    <div class="squad-stat">
                        <span class="stat-value">${this.optimizedSquad.predictedPoints}</span>
                        <span class="stat-label">Predicted Points</span>
                    </div>
                    <div class="squad-stat">
                        <span class="stat-value">${this.optimizedSquad.valueScore}</span>
                        <span class="stat-label">Value Score</span>
                    </div>
                    <div class="squad-stat">
                        <span class="stat-value">£${(this.optimizedSquad.remainingBudget / 10).toFixed(1)}m</span>
                        <span class="stat-label">Remaining</span>
                    </div>
                `;
            }

            displayFormation() {
                const formation = document.getElementById('formation-display');
                const positionNames = ['', 'Goalkeeper', 'Defenders', 'Midfielders', 'Forwards'];
                
                formation.innerHTML = '';
                
                for (let position = 1; position <= 4; position++) {
                    const line = document.createElement('div');
                    line.className = 'position-line';
                    
                    this.optimizedSquad.squad[position].forEach(player => {
                        const team = this.teams.find(t => t.id === player.team);
                        const slot = document.createElement('div');
                        slot.className = 'player-slot';
                        slot.innerHTML = `
                            <div class="player-name">${player.first_name} ${player.second_name}</div>
                            <div class="player-team">${team?.short_name || 'UNK'}</div>
                            <div class="player-price">${this.fplService.formatPrice(player.now_cost)}</div>
                            <div class="player-stats">
                                <span class="stat-item">Pts: ${player.total_points}</span>
                                <span class="stat-item">Form: ${player.form}</span>
                            </div>
                        `;
                        line.appendChild(slot);
                    });
                    
                    formation.appendChild(line);
                }
            }

            displayValueAnalysis() {
                const metrics = document.getElementById('value-metrics');
                
                // Calculate additional metrics
                const totalOwnership = Object.values(this.optimizedSquad.squad).flat()
                    .reduce((sum, p) => sum + p.selected_by_percent, 0) / 15;
                
                const averageForm = Object.values(this.optimizedSquad.squad).flat()
                    .reduce((sum, p) => sum + parseFloat(p.form), 0) / 15;

                metrics.innerHTML = `
                    <div class="value-metric">
                        <span class="metric-value">${this.optimizedSquad.valueScore}</span>
                        <span class="metric-label">Points per £m</span>
                    </div>
                    <div class="value-metric">
                        <span class="metric-value">${totalOwnership.toFixed(1)}%</span>
                        <span class="metric-label">Avg Ownership</span>
                    </div>
                    <div class="value-metric">
                        <span class="metric-value">${averageForm.toFixed(1)}</span>
                        <span class="metric-label">Avg Form</span>
                    </div>
                    <div class="value-metric">
                        <span class="metric-value">${Object.values(this.optimizedSquad.squad).flat().length}</span>
                        <span class="metric-label">Total Players</span>
                    </div>
                `;
            }

            formatOptimizedSquadResult(squad, constraints) {
                let totalCost = 0;
                Object.values(squad).forEach(position => {
                    if (Array.isArray(position)) {
                        position.forEach(player => {
                            totalCost += player.now_cost;
                        });
                    }
                });
                
                return {
                    squad,
                    totalCost,
                    remainingBudget: constraints.budget - totalCost,
                    predictedPoints: this.calculatePredictedPoints(squad),
                    valueScore: this.calculateValueScore(squad)
                };
            }

            displayAlternatives() {
                const grid = document.getElementById('alternatives-grid');
                grid.innerHTML = '';
                
                const positionNames = { 1: 'Goalkeepers', 2: 'Defenders', 3: 'Midfielders', 4: 'Forwards' };
                
                Object.keys(this.alternatives).forEach(position => {
                    if (this.alternatives[position].length > 0) {
                        const group = document.createElement('div');
                        group.className = 'alternative-group';
                        group.innerHTML = `<h4>${positionNames[position]} Alternatives</h4>`;
                        
                        this.alternatives[position].slice(0, 3).forEach(item => {
                            item.alternatives.slice(0, 2).forEach(alt => {
                                const team = this.teams.find(t => t.id === alt.team);
                                const altDiv = document.createElement('div');
                                altDiv.className = 'alternative-player';
                                altDiv.innerHTML = `
                                    <div class="alternative-info">
                                        <div class="alternative-name">${alt.first_name} ${alt.second_name}</div>
                                        <div class="alternative-details">${team?.short_name} • ${alt.total_points} pts • Form: ${alt.form}</div>
                                    </div>
                                    <div class="alternative-price">${this.fplService.formatPrice(alt.now_cost)}</div>
                                `;
                                group.appendChild(altDiv);
                            });
                        });
                        
                        grid.appendChild(group);
                    }
                });
            }
        }

        // Team of the Week data
        const teamOfWeekData = {
            gameweek: 1,
            formation: '3-5-2',
            budget: 1000, // £100m in FPL units
            squad: {
                GK: [
                    { name: 'David Raya', team: 'Arsenal', price: 55, id: 'raya' }
                ],
                DEF: [
                    { name: 'Trent Alexander-Arnold', team: 'Liverpool', price: 70, id: 'taa' },
                    { name: 'Ezri Konsa', team: 'Aston Villa', price: 45, id: 'konsa' },
                    { name: 'Marc Guehi', team: 'Crystal Palace', price: 45, id: 'guehi' }
                ],
                MID: [
                    { name: 'Mohamed Salah', team: 'Liverpool', price: 125, id: 'salah', captain: true },
                    { name: 'Bruno Fernandes', team: 'Man Utd', price: 85, id: 'bruno' },
                    { name: 'Eberechi Eze', team: 'Crystal Palace', price: 70, id: 'eze' },
                    { name: 'Jarrod Bowen', team: 'West Ham', price: 75, id: 'bowen' },
                    { name: 'Pape Sarr', team: 'Tottenham', price: 45, id: 'sarr' }
                ],
                FWD: [
                    { name: 'Erling Haaland', team: 'Man City', price: 150, id: 'haaland' },
                    { name: 'Ollie Watkins', team: 'Aston Villa', price: 90, id: 'watkins' }
                ],
                BENCH: [
                    { name: 'Neto', team: 'Bournemouth', price: 40, position: 'GK' },
                    { name: 'Lewis Dunk', team: 'Brighton', price: 45, position: 'DEF' },
                    { name: 'Andreas Pereira', team: 'Fulham', price: 50, position: 'MID' },
                    { name: 'Yoane Wissa', team: 'Brentford', price: 60, position: 'FWD' }
                ]
            }
        };
        
        function toggleTOTWDetails() {
            const analysis = document.getElementById('totw-analysis');
            if (analysis.style.display === 'none') {
                analysis.style.display = 'block';
            } else {
                analysis.style.display = 'none';
            }
        }
        
        function useTeamOfWeek() {
            // Set formation to match TOTW
            document.getElementById('def-play').value = 3;
            document.getElementById('mid-play').value = 5;
            document.getElementById('fwd-play').value = 2;
            
            // Set budget to 100m
            document.getElementById('budget-slider').value = 1000;
            optimizer.updateBudgetDisplay();
            
            // If optimizer has mock data capability, populate with TOTW players
            if (optimizer) {
                // Create a custom squad based on TOTW
                const totwSquad = {
                    1: [], // GKP
                    2: [], // DEF
                    3: [], // MID
                    4: []  // FWD
                };
                
                // Add TOTW players (this would need real player IDs in production)
                alert('Team of the Week template loaded! Formation set to 3-5-2. Click "Optimize My Squad" to find similar players in the database.');
                
                // Scroll to optimization section
                document.querySelector('.constraints-panel').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function optimizeFromTOTW() {
            // Use TOTW as template but optimize with current player pool
            useTeamOfWeek();
            
            // Set strategy to best
            optimizer.selectStrategy('best');
            
            // Auto-trigger optimization
            setTimeout(() => {
                optimizer.optimizeTeam();
            }, 500);
        }

        function selectStrategy(strategy) {
            optimizer.selectStrategy(strategy);
        }

        async function optimizeTeam() {
            console.log('Optimize team button clicked');
            if (!optimizer) {
                alert('Optimizer not initialized. Please refresh the page.');
                return;
            }
            
            try {
                console.log('Starting optimization...');
                await optimizer.optimizeTeam();
                console.log('Optimization completed successfully');
            } catch (error) {
                console.error('Optimization failed:', error);
                alert('Optimization failed: ' + error.message);
            }
        }

        function resetTeam() {
            console.log('Reset team button clicked');
            if (!optimizer) {
                alert('Optimizer not initialized. Please refresh the page.');
                return;
            }
            
            try {
                // Reset all settings to default
                document.getElementById('budget-slider').value = 1000;
                document.getElementById('def-play').value = 4;
                document.getElementById('mid-play').value = 4;
                document.getElementById('fwd-play').value = 2;
                
                // Update budget display
                optimizer.updateBudgetDisplay();
                
                // Clear results
                const resultsContainer = document.getElementById('results-container');
                if (resultsContainer) {
                    resultsContainer.style.display = 'none';
                }
                
                // Reset strategy to balanced
                optimizer.selectStrategy('balanced');
                
                // Hide TOTW section if visible
                const totwSection = document.getElementById('team-of-week');
                const totwButton = document.getElementById('totw-button');
                if (totwSection) {
                    totwSection.style.display = 'none';
                }
                if (totwButton) {
                    totwButton.innerHTML = '🏆 Team of the Week';
                    totwButton.style.background = 'linear-gradient(135deg, #ffd700, #ff6b6b, #ffd700)';
                }
                
                console.log('Team reset successfully');
                alert('✅ Team settings reset to default!');
            } catch (error) {
                console.error('Reset failed:', error);
                alert('Reset failed: ' + error.message);
            }
        }

        function refreshData() {
            if (optimizer) {
                optimizer.refreshData();
            }
        }

        function resetTeam() {
            // Reset all settings to default (4-4-2 formation)
            document.getElementById('budget-slider').value = 1000;
            document.getElementById('def-play').value = 4;
            document.getElementById('mid-play').value = 4;
            document.getElementById('fwd-play').value = 2;
            document.getElementById('include-captains').checked = true;
            document.getElementById('avoid-rotation').checked = true;
            document.getElementById('consider-fixtures').checked = false;
            document.getElementById('differential-picks').checked = false;
            
            // Reset strategy to balanced
            if (optimizer) {
                optimizer.selectStrategy('balanced');
                optimizer.updateBudgetDisplay();
            }
            
            // Hide results
            document.getElementById('results-container').style.display = 'none';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Show confirmation
            const resetBtn = document.getElementById('reset-button');
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = '✅ Reset Complete!';
            resetBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
            
            setTimeout(() => {
                resetBtn.innerHTML = originalText;
                resetBtn.style.background = 'linear-gradient(135deg, #dc3545, #fd7e14)';
            }, 2000);
        }

        // Additional helper functions for new features
        function formatOptimizedSquad(squad, constraints) {
            let totalCost = 0;
            Object.values(squad).forEach(position => {
                position.forEach(player => {
                    totalCost += player.now_cost;
                });
            });
            
            return {
                squad,
                totalCost,
                remainingBudget: constraints.budget - totalCost,
                predictedPoints: optimizer ? optimizer.calculatePredictedPoints(squad) : 0,
                valueScore: optimizer ? optimizer.calculateValueScore(squad) : 0
            };
        }
        
        function updateOptimizationProgress(progress) {
            // Update UI with optimization progress
            const overlay = document.getElementById('loading-overlay');
            if (overlay && overlay.style.display !== 'none') {
                const content = overlay.querySelector('.loading-content');
                if (content) {
                    const progressHtml = `
                        <div style="margin-top: 15px;">
                            <div style="background: #e9ecef; border-radius: 20px; overflow: hidden; height: 10px;">
                                <div style="background: linear-gradient(90deg, #6f42c1, #17a2b8); height: 100%; width: ${(progress.generation || progress.temperature) ? ((progress.generation / 50) * 100 || (1000 - progress.temperature) / 10) : 0}%; transition: width 0.3s;"></div>
                            </div>
                            <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                                ${progress.generation ? `Generation ${progress.generation}/50` : `Temperature: ${Math.round(progress.temperature)}`}
                            </p>
                        </div>
                    `;
                    
                    const existingProgress = content.querySelector('div[style*="margin-top: 15px"]');
                    if (existingProgress) {
                        existingProgress.outerHTML = progressHtml;
                    } else {
                        content.insertAdjacentHTML('beforeend', progressHtml);
                    }
                }
            }
        }
        
        function displaySaveOptions(squadId) {
            const resultsContainer = document.getElementById('results-container');
            if (!resultsContainer) return;
            
            const saveOptionsHtml = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <h4 style="color: #28a745; margin-bottom: 15px;">✅ Squad Saved Successfully!</h4>
                    <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <button onclick="shareSquad('${squadId}')" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            📤 Share Squad
                        </button>
                        <button onclick="exportToFPL('${squadId}')" style="padding: 10px 20px; background: #6f42c1; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            🎮 Export to FPL
                        </button>
                        <button onclick="planTransfers('${squadId}')" style="padding: 10px 20px; background: #fd7e14; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            📊 Plan Transfers
                        </button>
                    </div>
                </div>
            `;
            
            const existingSave = resultsContainer.querySelector('div[style*="background: #f8f9fa"]');
            if (existingSave) {
                existingSave.outerHTML = saveOptionsHtml;
            } else {
                resultsContainer.insertAdjacentHTML('afterbegin', saveOptionsHtml);
            }
        }
        
        function loadSavedSquads() {
            if (!optimizer || !optimizer.squadManager) return;
            
            const savedSquads = optimizer.squadManager.getSavedSquads();
            const listEl = document.getElementById('saved-squads-list');
            if (!listEl) return;
            
            if (savedSquads.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #666;">No saved squads yet</p>';
                return;
            }
            
            let html = '';
            savedSquads.forEach(squad => {
                html += `
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0; color: #333;">${squad.name}</h4>
                                <p style="margin: 5px 0; color: #666; font-size: 0.9rem;">
                                    ${squad.formation} • £${(squad.totalCost / 10).toFixed(1)}m • ${squad.predictedPoints} pts
                                </p>
                                <p style="margin: 0; color: #999; font-size: 0.8rem;">
                                    Created: ${new Date(squad.dateCreated).toLocaleDateString()}
                                </p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="loadSquad('${squad.id}')" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Load
                                </button>
                                <button onclick="deleteSquad('${squad.id}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Delete
                                </button>
                                <input type="checkbox" value="${squad.id}" class="squad-compare-checkbox">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }
        
        function showAdvancedOptions() {
            const panel = document.getElementById('advanced-options');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function showSquadManager() {
            const panel = document.getElementById('squad-manager-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                loadSavedSquads();
            }
        }
        
        function showGameweekPlanner() {
            const panel = document.getElementById('gameweek-planner-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function showDifferentials() {
            const panel = document.getElementById('differential-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            if (panel.style.display === 'block') {
                analyzeDifferentials();
            }
        }
        
        function analyzeDifferentials() {
            const analysis = optimizer.differentialAnalyzer.analyzeDifferentials(optimizer.allPlayers);
            const resultsEl = document.getElementById('differential-results');
            
            let html = '';
            
            // Top Differentials
            if (analysis.topDifferentials.length > 0) {
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #fd7e14; margin-bottom: 15px;">🎯 Top Differentials</h4>
                        ${analysis.topDifferentials.slice(0, 5).map(p => `
                            <div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px;">
                                <strong>${p.first_name} ${p.second_name}</strong>
                                <span style="float: right; color: #666;">£${(p.now_cost / 10).toFixed(1)}m</span>
                                <br>
                                <small style="color: #999;">Score: ${p.differentialScore.toFixed(1)} • Owned: ${p.selected_by_percent}%</small>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Hidden Gems
            if (analysis.hiddenGems.length > 0) {
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #28a745; margin-bottom: 15px;">💎 Hidden Gems</h4>
                        ${analysis.hiddenGems.slice(0, 5).map(p => `
                            <div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px;">
                                <strong>${p.first_name} ${p.second_name}</strong>
                                <span style="float: right; color: #666;">£${(p.now_cost / 10).toFixed(1)}m</span>
                                <br>
                                <small style="color: #999;">Value: ${p.valueRatio.toFixed(2)} pts/£m</small>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            resultsEl.innerHTML = html;
        }
        
        function generateTransferPlan() {
            if (!optimizer.squadManager.currentSquad) {
                alert('Please optimize a squad first');
                return;
            }
            
            const horizon = parseInt(document.getElementById('plan-horizon').value);
            const freeTransfers = parseInt(document.getElementById('free-transfers').value);
            const maxHits = parseInt(document.getElementById('max-hits').value);
            
            optimizer.gameweekPlanner.freeTransfers = freeTransfers;
            optimizer.gameweekPlanner.maxHits = maxHits;
            
            const plan = optimizer.gameweekPlanner.createTransferPlan(
                optimizer.squadManager.currentSquad,
                horizon,
                optimizer.optimizedSquad.remainingBudget
            );
            
            displayTransferPlan(plan);
        }
        
        function displayTransferPlan(plan) {
            const resultsEl = document.getElementById('transfer-plan-results');
            
            let html = `
                <h4 style="color: #17a2b8; margin-bottom: 15px;">📋 Transfer Plan</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p><strong>Total Transfers:</strong> ${plan.totalTransfers}</p>
                    <p><strong>Total Hits:</strong> ${plan.totalHits} points</p>
                    <p><strong>Projected Points:</strong> ${plan.projectedPoints}</p>
                </div>
            `;
            
            plan.gameweeks.forEach(gw => {
                if (gw.transfers.length > 0) {
                    html += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e9ecef;">
                            <h5 style="color: #333; margin-bottom: 10px;">Gameweek ${gw.gameweek}</h5>
                            ${gw.transfers.map(t => `
                                <p style="margin: 5px 0;">
                                    OUT: ${t.out.second_name} → IN: ${t.in.second_name} (${t.cost > 0 ? '+' : ''}£${(t.cost / 10).toFixed(1)}m)
                                </p>
                            `).join('')}
                            ${gw.hits > 0 ? `<p style="color: #dc3545;">-${gw.hits} point hit</p>` : ''}
                        </div>
                    `;
                }
            });
            
            resultsEl.innerHTML = html;
        }
        
        function compareSquads() {
            const checkboxes = document.querySelectorAll('.squad-compare-checkbox:checked');
            const squadIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (squadIds.length < 2) {
                alert('Please select at least 2 squads to compare');
                return;
            }
            
            const comparison = optimizer.squadManager.compareMultipleSquads(squadIds);
            displaySquadComparison(comparison);
        }
        
        function displaySquadComparison(comparison) {
            // This would display a detailed comparison modal or panel
            console.log('Squad comparison:', comparison);
            alert('Squad comparison feature - see console for details');
        }
        
        function shareSquad(squadId) {
            const link = optimizer.squadManager.generateShareableLink(squadId);
            navigator.clipboard.writeText(link).then(() => {
                alert('Squad link copied to clipboard!');
            });
        }
        
        function exportToFPL(squadId) {
            const fplData = optimizer.squadManager.exportToFPL(squadId);
            console.log('FPL Export Data:', fplData);
            alert('FPL export data logged to console');
        }
        
        function planTransfers(squadId) {
            const squad = optimizer.squadManager.loadSquad(squadId);
            if (squad) {
                showGameweekPlanner();
            }
        }
        
        function loadSquad(squadId) {
            const squad = optimizer.squadManager.loadSquad(squadId);
            if (squad) {
                alert(`Loaded squad: ${squad.name}`);
                // Update UI with loaded squad
            }
        }
        
        function deleteSquad(squadId) {
            if (confirm('Are you sure you want to delete this squad?')) {
                optimizer.squadManager.deleteSquad(squadId);
                loadSavedSquads();
            }
        }
        
        function clearAllSquads() {
            if (confirm('Are you sure you want to delete ALL saved squads?')) {
                optimizer.squadManager.clearAllData();
                loadSavedSquads();
            }
        }
        
        // Initialize the optimizer
        let optimizer;
        document.addEventListener('DOMContentLoaded', async function() {
            optimizer = new BudgetOptimizer();
            await optimizer.initialize();
            
            // Set up additional event listeners
            document.getElementById('algorithm-selector').addEventListener('change', (e) => {
                optimizer.selectedAlgorithm = e.target.value;
            });
            
            document.getElementById('mutation-rate').addEventListener('input', (e) => {
                document.getElementById('mutation-display').textContent = e.target.value + '%';
                optimizer.advancedOptimizer.mutationRate = e.target.value / 100;
            });
            
            // Check for shared squad in URL
            const urlParams = new URLSearchParams(window.location.search);
            const sharedSquad = urlParams.get('squad');
            if (sharedSquad) {
                const imported = optimizer.squadManager.importFromLink(sharedSquad);
                if (imported) {
                    console.log('Imported squad:', imported);
                }
            }
        });
        
        // Team of the Week functionality
        function getTeamOfTheWeek() {
            const totwSection = document.getElementById('team-of-week');
            const analysisSection = document.getElementById('totw-analysis');
            const totwButton = document.getElementById('totw-button');
            
            if (totwSection.style.display === 'none' || !totwSection.style.display) {
                // Show Team of the Week section
                totwSection.style.display = 'block';
                analysisSection.style.display = 'block';
                totwButton.innerHTML = '✅ TOTW Loaded';
                totwButton.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                
                // Update constraints to match TOTW formation (3-5-2)
                document.getElementById('def-play').value = 3;
                document.getElementById('mid-play').value = 5;
                document.getElementById('fwd-play').value = 2;
                
                // Scroll to TOTW section
                totwSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Show success message
                setTimeout(() => {
                    alert('🏆 Team of the Week loaded!\n\n✅ Formation set to 3-5-2\n✅ Expert picks displayed\n✅ Detailed analysis shown\n\nClick "Optimize My Squad" to find similar players in your budget!');
                }, 500);
                
                // Update budget optimizer with TOTW preferences if available
                if (optimizer) {
                    optimizer.selectedStrategy = 'best';
                    document.querySelectorAll('.strategy-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    document.querySelector('[data-strategy="best"]').classList.add('selected');
                }
                
            } else {
                // Hide Team of the Week section
                totwSection.style.display = 'none';
                analysisSection.style.display = 'none';
                totwButton.innerHTML = '🏆 Team of the Week';
                totwButton.style.background = 'linear-gradient(135deg, #ffd700, #ff6b6b, #ffd700)';
            }
        }
        
        function toggleTOTWDetails() {
            const analysis = document.getElementById('totw-analysis');
            if (analysis.style.display === 'none') {
                analysis.style.display = 'block';
            } else {
                analysis.style.display = 'none';
            }
        }
        
        // Auto-refresh data when tab becomes visible
        document.addEventListener('visibilitychange', async function() {
            if (!document.hidden && optimizer) {
                console.log('Tab became visible, refreshing budget optimizer data...');
                await optimizer.refreshData();
            }
        });
        
        // Also refresh when window gains focus
        window.addEventListener('focus', async function() {
            if (optimizer) {
                console.log('Window focused, refreshing budget optimizer data...');
                await optimizer.refreshData();
            }
        });
    </script>
    <script src="./auth-service.js"></script>
    <script src="./premium-access-control.js"></script>
    <script src="./membership-popup.js"></script>
<script src="/ai-assistant-sidebar.js" defer></script>
</body>
</html>