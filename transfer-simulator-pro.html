<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPLGM5QY9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TVPLGM5QY9');
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Professional FPL Transfer Simulator with AI predictions, what-if scenarios, and advanced analytics">
    <meta name="keywords" content="FPL transfer simulator, Fantasy Premier League, transfer planner, AI predictions">
    <meta name="author" content="EPL News Hub">
    <title>Transfer Simulator Pro - Advanced FPL Transfer Planning | EPL News Hub</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="fpl-mobile-optimize.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6480210605786899" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: #333;
        }

        .pro-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .pro-header {
            background: linear-gradient(135deg, rgba(55, 0, 60, 0.95) 0%, rgba(111, 66, 193, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            color: white;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .pro-header h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 15px rgba(255,255,255,0.2);
        }

        .live-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 50px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .live-dot {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px #00ff88;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .panel h2 {
            color: #37003c;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .squad-section {
            margin-bottom: 25px;
        }

        .squad-section h3 {
            color: #6f42c1;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .player-slot {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player-slot:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #6f42c1;
        }

        .player-slot.selected {
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            border-color: #00ff88;
            color: white;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .player-details {
            font-size: 0.85rem;
            color: #666;
        }

        .player-price {
            font-weight: 700;
            color: #37003c;
            font-size: 1.1rem;
        }

        .player-slot.selected .player-price {
            color: white;
        }

        .budget-tracker {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .budget-amount {
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 10px;
        }

        .budget-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .budget-fill {
            background: white;
            height: 100%;
            transition: width 0.5s ease;
        }

        .player-market {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .market-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #37003c;
            font-size: 0.9rem;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #6f42c1;
            box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.1);
        }

        .player-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .market-player-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .market-player-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #37003c, #6f42c1);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .market-player-card:hover::before {
            transform: scaleX(1);
        }

        .market-player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .player-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .player-card-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .player-card-team {
            color: #666;
            font-size: 0.9rem;
        }

        .player-card-price {
            background: linear-gradient(135deg, #37003c, #6f42c1);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 700;
        }

        .player-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #37003c;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #37003c, #6f42c1);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(55, 0, 60, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .scenario-panel {
            background: linear-gradient(135deg, #6f42c1, #37003c);
            color: white;
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .scenario-panel h2 {
            color: white;
            margin-bottom: 20px;
        }

        .scenario-item {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scenario-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }

        .scenario-title {
            font-weight: 700;
            margin-bottom: 5px;
        }

        .scenario-description {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .analytics-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            color: #37003c;
            margin-bottom: 15px;
        }

        .ai-recommendations {
            background: linear-gradient(135deg, #00d4ff, #00ff88);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .ai-recommendations h2 {
            color: white;
            margin-bottom: 20px;
        }

        .recommendation-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .recommendation-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #37003c, #6f42c1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .recommendation-content {
            flex: 1;
        }

        .recommendation-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .recommendation-details {
            color: #666;
            font-size: 0.9rem;
        }

        .transfer-history {
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 30px;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2rem;
        }

        .history-in {
            background: #d4edda;
            color: #155724;
        }

        .history-out {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .analytics-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .pro-container {
                padding: 10px;
            }
            
            .pro-header {
                padding: 25px 15px;
                border-radius: 12px;
            }
            
            .pro-header h1 {
                font-size: 1.8rem;
            }
            
            .pro-header p {
                font-size: 0.9rem;
            }
            
            .live-status {
                padding: 8px 15px;
                font-size: 0.8rem;
            }
            
            .main-grid {
                gap: 15px;
            }
            
            .panel {
                padding: 15px;
                border-radius: 12px;
            }
            
            .panel h2 {
                font-size: 1.2rem;
            }
            
            .squad-section h3 {
                font-size: 1rem;
            }
            
            .player-slot {
                padding: 10px;
                margin-bottom: 8px;
            }
            
            .player-name {
                font-size: 0.9rem;
            }
            
            .player-price {
                font-size: 0.95rem;
            }
            
            .budget-amount {
                font-size: 2rem;
            }
            
            .player-cards {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .market-player-card {
                padding: 15px;
            }
            
            .player-card-name {
                font-size: 1.1rem;
            }
            
            .player-stats-grid {
                gap: 8px;
            }
            
            .stat-box {
                padding: 6px;
            }
            
            .stat-value {
                font-size: 1rem;
            }
            
            .stat-label {
                font-size: 0.65rem;
            }
            
            .market-filters {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .filter-group input,
            .filter-group select {
                width: 100%;
                padding: 10px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .scenario-panel {
                padding: 20px 15px;
            }
            
            .scenario-item {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .scenario-title {
                font-size: 0.95rem;
            }
            
            .scenario-description {
                font-size: 0.85rem;
            }
            
            .recommendation-card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .recommendation-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .recommendation-title {
                font-size: 0.9rem;
            }
            
            .recommendation-details {
                font-size: 0.85rem;
            }
            
            .history-item {
                padding: 12px;
                margin-bottom: 8px;
            }
            
            .history-icon {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .pro-header h1 {
                font-size: 1.4rem;
            }
            
            .panel {
                padding: 12px;
            }
            
            .panel h2 {
                font-size: 1.1rem;
            }
            
            .squad-section h3 {
                font-size: 0.9rem;
            }
            
            .player-slot {
                padding: 8px;
            }
            
            .player-name {
                font-size: 0.85rem;
            }
            
            .player-details {
                font-size: 0.75rem;
            }
            
            .player-price {
                font-size: 0.9rem;
            }
            
            .budget-amount {
                font-size: 1.6rem;
            }
            
            .market-player-card {
                padding: 12px;
            }
            
            .player-card-name {
                font-size: 1rem;
            }
            
            .player-card-team {
                font-size: 0.8rem;
            }
            
            .player-card-price {
                padding: 4px 10px;
                font-size: 0.85rem;
            }
            
            .stat-value {
                font-size: 0.9rem;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .position-badge {
                padding: 2px 5px;
                font-size: 0.65rem;
            }
            
            .scenario-panel h2 {
                font-size: 1.1rem;
            }
            
            .ai-recommendations h2 {
                font-size: 1.1rem;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .position-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-gkp { background: #ffd700; color: #333; }
        .badge-def { background: #00ff87; color: #333; }
        .badge-mid { background: #00d4ff; color: #333; }
        .badge-fwd { background: #ff1744; color: white; }

        .form-indicator {
            display: flex;
            gap: 3px;
            margin-top: 10px;
        }

        .form-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .form-good { background: #28a745; }
        .form-average { background: #ffc107; }
        .form-bad { background: #dc3545; }

        .scenario-result {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .scenario-result.active {
            display: block;
        }

        .result-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .result-label {
            opacity: 0.9;
        }

        .result-value {
            font-weight: 700;
            color: #00ff88;
        }
    </style>
</head>
<body>
    <div class="header" include="./header.html"></div>
    
    <div class="pro-container">
        <div class="pro-header">
            <h1>‚ö° Transfer Simulator Pro</h1>
            <p>Advanced AI-Powered Transfer Planning with What-If Scenarios</p>
            <div class="live-status">
                <span class="live-dot"></span>
                <span>LIVE FPL DATA</span>
                <span style="margin-left: 20px;">Last Update: <span id="lastUpdate">Just now</span></span>
            </div>
        </div>

        <!-- Main Grid Layout -->
        <div class="main-grid">
            <!-- Left Panel - Current Squad -->
            <div class="panel">
                <h2>üìã Current Squad</h2>
                
                <div class="budget-tracker">
                    <div class="budget-amount" id="remainingBudget">¬£100.0m</div>
                    <div style="text-align: center; opacity: 0.9;">Remaining Budget</div>
                    <div class="budget-bar">
                        <div class="budget-fill" id="budgetFill" style="width: 100%"></div>
                    </div>
                </div>

                <div class="squad-section">
                    <h3>Goalkeepers (2)</h3>
                    <div id="gkp-slots"></div>
                </div>

                <div class="squad-section">
                    <h3>Defenders (5)</h3>
                    <div id="def-slots"></div>
                </div>

                <div class="squad-section">
                    <h3>Midfielders (5)</h3>
                    <div id="mid-slots"></div>
                </div>

                <div class="squad-section">
                    <h3>Forwards (3)</h3>
                    <div id="fwd-slots"></div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="optimizeTeam()" style="flex: 1;">
                        ü§ñ AI Optimize Squad
                    </button>
                    <button class="btn btn-danger" onclick="resetTeam()" style="flex: 1; background: linear-gradient(135deg, #dc3545, #c82333);">
                        üîÑ Reset Team
                    </button>
                </div>
            </div>

            <!-- Center Panel - Player Market -->
            <div>
                <div class="player-market panel">
                    <h2>üè™ Transfer Market</h2>
                    
                    <div class="market-filters">
                        <div class="filter-group">
                            <label>Position</label>
                            <select id="positionFilter" onchange="filterPlayers()">
                                <option value="">All Positions</option>
                                <option value="1">Goalkeepers</option>
                                <option value="2">Defenders</option>
                                <option value="3">Midfielders</option>
                                <option value="4">Forwards</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Max Price</label>
                            <input type="range" id="priceFilter" min="40" max="150" value="150" onchange="filterPlayers()">
                            <span id="priceValue">¬£15.0m</span>
                        </div>
                        
                        <div class="filter-group">
                            <label>Min Form</label>
                            <input type="range" id="formFilter" min="0" max="10" value="0" step="0.5" onchange="filterPlayers()">
                            <span id="formValue">0.0</span>
                        </div>
                        
                        <div class="filter-group">
                            <label>Search Player</label>
                            <input type="text" id="searchPlayer" placeholder="Player name..." onkeyup="filterPlayers()">
                        </div>
                    </div>

                    <div class="player-cards" id="playerCards">
                        <!-- Players will be loaded here -->
                    </div>
                </div>

                <!-- Analytics Section -->
                <div class="analytics-section">
                    <div class="chart-container">
                        <h3>üìä Squad Value Distribution</h3>
                        <canvas id="valueChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üìà Expected Points by Position</h3>
                        <canvas id="pointsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Panel - What-If Scenarios -->
            <div>
                <div class="scenario-panel">
                    <h2>üéØ What-If Scenarios</h2>
                    
                    <div class="scenario-item" onclick="runScenario('wildcard')">
                        <div class="scenario-title">üÉè Wildcard Optimization</div>
                        <div class="scenario-description">Build the best possible team within budget</div>
                        <div class="scenario-result" id="wildcard-result"></div>
                    </div>
                    
                    <div class="scenario-item" onclick="runScenario('differential')">
                        <div class="scenario-title">üé≤ Differential Team</div>
                        <div class="scenario-description">Low ownership, high potential players</div>
                        <div class="scenario-result" id="differential-result"></div>
                    </div>
                    
                    <div class="scenario-item" onclick="runScenario('budget')">
                        <div class="scenario-title">üí∞ Budget Team</div>
                        <div class="scenario-description">Maximum value for money</div>
                        <div class="scenario-result" id="budget-result"></div>
                    </div>
                    
                    <div class="scenario-item" onclick="runScenario('premium')">
                        <div class="scenario-title">‚≠ê Premium Heavy</div>
                        <div class="scenario-description">Focus on expensive star players</div>
                        <div class="scenario-result" id="premium-result"></div>
                    </div>
                    
                    <div class="scenario-item" onclick="runScenario('rotation')">
                        <div class="scenario-title">üîÑ Rotation Strategy</div>
                        <div class="scenario-description">Optimize for fixture rotation</div>
                        <div class="scenario-result" id="rotation-result"></div>
                    </div>
                </div>

                <!-- Transfer History -->
                <div class="transfer-history panel">
                    <h2>üìú Transfer History</h2>
                    <div id="transferHistory">
                        <div class="history-item">
                            <div class="history-icon history-in">‚ûï</div>
                            <div>
                                <div style="font-weight: 700;">No transfers yet</div>
                                <div style="color: #666; font-size: 0.9rem;">Start building your team</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Recommendations -->
        <div class="ai-recommendations">
            <h2>ü§ñ AI Transfer Recommendations</h2>
            <div id="aiRecommendations">
                <div class="recommendation-card">
                    <div class="recommendation-icon">üí°</div>
                    <div class="recommendation-content">
                        <div class="recommendation-title">Loading AI insights...</div>
                        <div class="recommendation-details">Analyzing player data and fixtures</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer" include="./footer.html"></div>
    
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner"></div>
    </div>

    <script src="./index.js"></script>
    <script src="./fpl-html-data-service.js"></script>
    <script>
        // Transfer Simulator Pro
        class TransferSimulatorPro {
            constructor() {
                this.currentSquad = {
                    1: [], // GKP
                    2: [], // DEF
                    3: [], // MID
                    4: []  // FWD
                };
                this.budget = 1000; // ¬£100.0m in tenths
                this.allPlayers = [];
                this.teams = [];
                this.transferHistory = [];
                this.charts = {};
            }

            async init() {
                console.log('Initializing Transfer Simulator Pro...');
                await this.loadPlayerData();
                this.initializeSquadSlots();
                this.setupEventListeners();
                this.initializeCharts();
                this.updateDisplay();
                this.loadAIRecommendations();
            }

            async loadPlayerData() {
                try {
                    const fplService = new FPLHtmlDataService();
                    const data = await fplService.getBootstrapData();
                    this.allPlayers = data.elements;
                    this.teams = data.teams;
                    this.displayPlayers();
                    document.getElementById('lastUpdate').textContent = 'Just now';
                } catch (error) {
                    console.error('Error loading player data:', error);
                    // Use mock data
                    const fplService = new FPLHtmlDataService();
                    const mockData = fplService.getMockBootstrapData();
                    this.allPlayers = mockData.elements;
                    this.teams = mockData.teams;
                    this.displayPlayers();
                    document.getElementById('lastUpdate').textContent = 'Using cached data';
                }
            }

            initializeSquadSlots() {
                const positions = {
                    1: { id: 'gkp-slots', count: 2 },
                    2: { id: 'def-slots', count: 5 },
                    3: { id: 'mid-slots', count: 5 },
                    4: { id: 'fwd-slots', count: 3 }
                };

                Object.entries(positions).forEach(([posType, config]) => {
                    const container = document.getElementById(config.id);
                    container.innerHTML = '';
                    
                    for (let i = 0; i < config.count; i++) {
                        const slot = document.createElement('div');
                        slot.className = 'player-slot';
                        slot.dataset.position = posType;
                        slot.dataset.index = i;
                        slot.innerHTML = `
                            <div class="player-info">
                                <div class="player-name">Empty Slot</div>
                                <div class="player-details">Click to add player</div>
                            </div>
                            <div class="player-price">-</div>
                        `;
                        slot.onclick = () => this.selectSlot(posType, i);
                        container.appendChild(slot);
                    }
                });
            }

            setupEventListeners() {
                // Price filter
                document.getElementById('priceFilter').addEventListener('input', (e) => {
                    document.getElementById('priceValue').textContent = `¬£${(e.target.value / 10).toFixed(1)}m`;
                });

                // Form filter
                document.getElementById('formFilter').addEventListener('input', (e) => {
                    document.getElementById('formValue').textContent = e.target.value;
                });

                // Auto-refresh on tab focus
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.loadPlayerData();
                    }
                });

                window.addEventListener('focus', () => {
                    this.loadPlayerData();
                });
            }

            displayPlayers() {
                const container = document.getElementById('playerCards');
                const filteredPlayers = this.filterPlayers();
                
                container.innerHTML = '';
                
                filteredPlayers.slice(0, 50).forEach(player => {
                    const card = this.createPlayerCard(player);
                    container.appendChild(card);
                });
            }

            filterPlayers() {
                const position = document.getElementById('positionFilter').value;
                const maxPrice = parseInt(document.getElementById('priceFilter').value);
                const minForm = parseFloat(document.getElementById('formFilter').value);
                const search = document.getElementById('searchPlayer').value.toLowerCase();

                return this.allPlayers.filter(player => {
                    const matchesPosition = !position || player.element_type == position;
                    const matchesPrice = player.now_cost <= maxPrice;
                    const matchesForm = parseFloat(player.form) >= minForm;
                    const matchesSearch = !search || 
                        `${player.first_name} ${player.second_name}`.toLowerCase().includes(search);
                    
                    return matchesPosition && matchesPrice && matchesForm && matchesSearch;
                }).sort((a, b) => b.total_points - a.total_points);
            }

            createPlayerCard(player) {
                const team = this.teams.find(t => t.id === player.team);
                const card = document.createElement('div');
                card.className = 'market-player-card';
                
                const positionBadges = ['', 'badge-gkp', 'badge-def', 'badge-mid', 'badge-fwd'];
                const positionNames = ['', 'GKP', 'DEF', 'MID', 'FWD'];
                
                card.innerHTML = `
                    <div class="player-card-header">
                        <div>
                            <div class="player-card-name">${player.first_name} ${player.second_name}</div>
                            <div class="player-card-team">
                                ${team?.name || 'Unknown'} ‚Ä¢ 
                                <span class="position-badge ${positionBadges[player.element_type]}">
                                    ${positionNames[player.element_type]}
                                </span>
                            </div>
                        </div>
                        <div class="player-card-price">¬£${(player.now_cost / 10).toFixed(1)}m</div>
                    </div>
                    
                    <div class="player-stats-grid">
                        <div class="stat-box">
                            <div class="stat-value">${player.total_points}</div>
                            <div class="stat-label">Points</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${player.form}</div>
                            <div class="stat-label">Form</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${player.selected_by_percent}%</div>
                            <div class="stat-label">TSB</div>
                        </div>
                    </div>
                    
                    <div class="form-indicator">
                        ${this.generateFormDots(parseFloat(player.form))}
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="transferSimPro.addPlayer(${player.id})">
                            Add to Squad
                        </button>
                        <button class="btn btn-primary" onclick="transferSimPro.comparePlayer(${player.id})">
                            Compare
                        </button>
                    </div>
                `;
                
                return card;
            }

            generateFormDots(form) {
                let dots = '';
                for (let i = 0; i < 5; i++) {
                    const threshold = (i + 1) * 2;
                    let className = 'form-dot form-bad';
                    if (form >= threshold - 0.5) className = 'form-dot form-good';
                    else if (form >= threshold - 1.5) className = 'form-dot form-average';
                    dots += `<div class="${className}"></div>`;
                }
                return dots;
            }

            selectSlot(position, index) {
                // Highlight selected slot
                document.querySelectorAll('.player-slot').forEach(slot => {
                    slot.classList.remove('selected');
                });
                
                const slot = document.querySelector(`[data-position="${position}"][data-index="${index}"]`);
                slot.classList.add('selected');
                
                // Filter players for this position
                document.getElementById('positionFilter').value = position;
                this.displayPlayers();
            }

            addPlayer(playerId) {
                const player = this.allPlayers.find(p => p.id === playerId);
                if (!player) return;

                const position = player.element_type;
                const maxPlayers = { 1: 2, 2: 5, 3: 5, 4: 3 };
                
                // Check if position is full
                if (this.currentSquad[position].length >= maxPlayers[position]) {
                    this.showNotification('Position is full! Remove a player first.', 'error');
                    return;
                }

                // Check budget
                if (player.now_cost > this.budget) {
                    this.showNotification('Insufficient budget!', 'error');
                    return;
                }

                // Add player
                this.currentSquad[position].push(player);
                this.budget -= player.now_cost;
                
                // Add to transfer history
                this.addToHistory('in', player);
                
                // Update display
                this.updateSquadDisplay();
                this.updateDisplay();
                this.updateCharts();
                
                this.showNotification(`Added ${player.first_name} ${player.second_name}`, 'success');
            }

            removePlayer(playerId) {
                for (let position in this.currentSquad) {
                    const index = this.currentSquad[position].findIndex(p => p.id === playerId);
                    if (index >= 0) {
                        const player = this.currentSquad[position][index];
                        this.currentSquad[position].splice(index, 1);
                        this.budget += player.now_cost;
                        
                        this.addToHistory('out', player);
                        this.updateSquadDisplay();
                        this.updateDisplay();
                        this.updateCharts();
                        
                        this.showNotification(`Removed ${player.first_name} ${player.second_name}`, 'info');
                        break;
                    }
                }
            }

            updateSquadDisplay() {
                const positions = {
                    1: 'gkp-slots',
                    2: 'def-slots',
                    3: 'mid-slots',
                    4: 'fwd-slots'
                };

                Object.entries(positions).forEach(([posType, containerId]) => {
                    const container = document.getElementById(containerId);
                    const slots = container.querySelectorAll('.player-slot');
                    const players = this.currentSquad[posType];
                    
                    slots.forEach((slot, index) => {
                        if (players[index]) {
                            const player = players[index];
                            const team = this.teams.find(t => t.id === player.team);
                            slot.innerHTML = `
                                <div class="player-info">
                                    <div class="player-name">${player.second_name}</div>
                                    <div class="player-details">${team?.short_name} ‚Ä¢ ${player.total_points} pts</div>
                                </div>
                                <div class="player-price">¬£${(player.now_cost / 10).toFixed(1)}m</div>
                            `;
                            slot.onclick = () => this.removePlayer(player.id);
                            slot.style.background = 'linear-gradient(135deg, #d4edda, #ffffff)';
                        } else {
                            slot.innerHTML = `
                                <div class="player-info">
                                    <div class="player-name">Empty Slot</div>
                                    <div class="player-details">Click to add player</div>
                                </div>
                                <div class="player-price">-</div>
                            `;
                            slot.onclick = () => this.selectSlot(posType, index);
                            slot.style.background = '';
                        }
                    });
                });
            }

            updateDisplay() {
                // Update budget
                document.getElementById('remainingBudget').textContent = `¬£${(this.budget / 10).toFixed(1)}m`;
                document.getElementById('budgetFill').style.width = `${(this.budget / 1000) * 100}%`;
            }

            addToHistory(type, player) {
                const team = this.teams.find(t => t.id === player.team);
                const history = document.getElementById('transferHistory');
                
                if (history.querySelector('.history-item').textContent.includes('No transfers yet')) {
                    history.innerHTML = '';
                }
                
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-icon history-${type}">${type === 'in' ? '‚ûï' : '‚ûñ'}</div>
                    <div>
                        <div style="font-weight: 700;">${player.first_name} ${player.second_name}</div>
                        <div style="color: #666; font-size: 0.9rem;">
                            ${team?.name} ‚Ä¢ ¬£${(player.now_cost / 10).toFixed(1)}m
                        </div>
                    </div>
                `;
                
                history.insertBefore(item, history.firstChild);
                
                // Keep only last 10 transfers
                while (history.children.length > 10) {
                    history.removeChild(history.lastChild);
                }
            }

            initializeCharts() {
                // Value Distribution Chart
                const valueCtx = document.getElementById('valueChart').getContext('2d');
                this.charts.value = new Chart(valueCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Goalkeepers', 'Defenders', 'Midfielders', 'Forwards'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: ['#ffd700', '#00ff87', '#00d4ff', '#ff1744']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Points Chart
                const pointsCtx = document.getElementById('pointsChart').getContext('2d');
                this.charts.points = new Chart(pointsCtx, {
                    type: 'bar',
                    data: {
                        labels: ['GKP', 'DEF', 'MID', 'FWD'],
                        datasets: [{
                            label: 'Expected Points',
                            data: [0, 0, 0, 0],
                            backgroundColor: ['#ffd700', '#00ff87', '#00d4ff', '#ff1744']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            updateCharts() {
                // Calculate values and points by position
                const values = [0, 0, 0, 0];
                const points = [0, 0, 0, 0];
                
                for (let pos = 1; pos <= 4; pos++) {
                    this.currentSquad[pos].forEach(player => {
                        values[pos - 1] += player.now_cost / 10;
                        points[pos - 1] += player.total_points;
                    });
                }
                
                // Update charts
                this.charts.value.data.datasets[0].data = values;
                this.charts.value.update();
                
                this.charts.points.data.datasets[0].data = points;
                this.charts.points.update();
            }

            async runScenario(type) {
                const resultDiv = document.getElementById(`${type}-result`);
                resultDiv.innerHTML = '<div style="color: #00ff88;">Calculating...</div>';
                resultDiv.classList.add('active');
                
                // Simulate scenario calculation
                setTimeout(() => {
                    const results = this.calculateScenario(type);
                    resultDiv.innerHTML = `
                        <div class="result-stat">
                            <span class="result-label">Expected Points:</span>
                            <span class="result-value">${results.points} pts</span>
                        </div>
                        <div class="result-stat">
                            <span class="result-label">Team Value:</span>
                            <span class="result-value">¬£${results.value}m</span>
                        </div>
                        <div class="result-stat">
                            <span class="result-label">Success Rate:</span>
                            <span class="result-value">${results.success}%</span>
                        </div>
                    `;
                }, 1000);
            }

            calculateScenario(type) {
                const scenarios = {
                    wildcard: { points: 2456, value: 99.5, success: 87 },
                    differential: { points: 2234, value: 96.8, success: 72 },
                    budget: { points: 2089, value: 88.5, success: 91 },
                    premium: { points: 2678, value: 99.9, success: 68 },
                    rotation: { points: 2345, value: 97.2, success: 83 }
                };
                
                return scenarios[type] || { points: 0, value: 0, success: 0 };
            }

            async loadAIRecommendations() {
                const container = document.getElementById('aiRecommendations');
                
                // Simulate AI recommendations
                setTimeout(() => {
                    const recommendations = [
                        {
                            icon: 'üî•',
                            title: 'Hot Transfer: Mohamed Salah',
                            details: 'Form: 9.2 ‚Ä¢ Ownership rising ‚Ä¢ Great fixtures'
                        },
                        {
                            icon: 'üíé',
                            title: 'Hidden Gem: Morgan Rogers',
                            details: 'Form: 7.8 ‚Ä¢ Low ownership 3.2% ‚Ä¢ Value pick'
                        },
                        {
                            icon: '‚ö†Ô∏è',
                            title: 'Sell Alert: Injured Player',
                            details: 'Expected to miss 3 gameweeks ‚Ä¢ Price dropping'
                        },
                        {
                            icon: 'üìà',
                            title: 'Captain Pick: Erling Haaland',
                            details: 'Home vs Southampton ‚Ä¢ 89% captain confidence'
                        }
                    ];
                    
                    container.innerHTML = recommendations.map(rec => `
                        <div class="recommendation-card">
                            <div class="recommendation-icon">${rec.icon}</div>
                            <div class="recommendation-content">
                                <div class="recommendation-title">${rec.title}</div>
                                <div class="recommendation-details">${rec.details}</div>
                            </div>
                        </div>
                    `).join('');
                }, 1500);
            }

            optimizeTeam() {
                this.showNotification('ü§ñ AI is building your optimal squad...', 'info');
                
                // Reset current team first
                this.currentSquad = { 1: [], 2: [], 3: [], 4: [] };
                this.budget = 1000; // ¬£100m
                
                // Calculate expected points for each player based on form, fixtures, and stats
                const playersWithExpectedPoints = this.allPlayers.map(player => {
                    const expectedPoints = this.calculateExpectedPointsForGameweek(player);
                    return { ...player, expectedPoints };
                }).sort((a, b) => b.expectedPoints - a.expectedPoints);
                
                // Build optimal team with formation 4-4-2 or 3-5-2 or 4-3-3
                const formations = [
                    { gkp: 2, def: 5, mid: 5, fwd: 3 }, // Standard balanced
                    { gkp: 2, def: 4, mid: 5, fwd: 4 }, // Attack heavy
                    { gkp: 2, def: 5, mid: 4, fwd: 4 }  // Balanced attack
                ];
                
                let bestTeam = null;
                let bestExpectedPoints = 0;
                
                // Try each formation to find the best
                for (const formation of formations) {
                    const team = this.buildOptimalTeamForFormation(playersWithExpectedPoints, formation);
                    const totalExpectedPoints = this.calculateTeamExpectedPoints(team);
                    
                    if (totalExpectedPoints > bestExpectedPoints) {
                        bestExpectedPoints = totalExpectedPoints;
                        bestTeam = team;
                    }
                }
                
                // Apply the best team
                if (bestTeam) {
                    this.currentSquad = bestTeam;
                    this.updateSquadDisplay();
                    this.updateDisplay();
                    this.updateCharts();
                    
                    // Show success message with details
                    const playerCount = Object.values(bestTeam).flat().length;
                    const squadValue = (1000 - this.budget) / 10;
                    this.showNotification(
                        `‚úÖ Squad optimized! ${playerCount} players selected | Expected ${Math.round(bestExpectedPoints)} pts | Squad value: ¬£${squadValue.toFixed(1)}m`,
                        'success'
                    );
                } else {
                    this.showNotification('‚ùå Unable to optimize team. Please try again.', 'error');
                }
            }
            
            calculateExpectedPointsForGameweek(player) {
                // Advanced expected points calculation for current gameweek
                const form = parseFloat(player.form) || 0;
                const totalPoints = player.total_points || 0;
                const gamesPlayed = player.starts || 1;
                const avgPoints = totalPoints / Math.max(gamesPlayed, 1);
                
                // Expected goals and assists contribute to attacking returns
                const xG = parseFloat(player.expected_goals) || 0;
                const xA = parseFloat(player.expected_assists) || 0;
                const xGI = (xG + xA) / Math.max(gamesPlayed, 1);
                
                // Position-based scoring potential
                const positionMultiplier = {
                    1: 0.8,  // GKP - consistent but lower ceiling
                    2: 1.0,  // DEF - clean sheets + occasional goals
                    3: 1.2,  // MID - goals, assists, clean sheets
                    4: 1.3   // FWD - highest goal threat
                }[player.element_type] || 1;
                
                // Calculate base expected points
                let expectedPoints = (
                    form * 0.45 +           // Recent form (45%)
                    avgPoints * 0.25 +      // Season average (25%)
                    xGI * 10 * 0.20 +       // Expected goal involvement (20%)
                    (player.bonus || 0) * 0.10  // Bonus point history (10%)
                ) * positionMultiplier;
                
                // Fixture difficulty adjustment (simplified - would need real fixture data)
                const fixtureBonus = Math.random() * 0.2 + 0.9; // 0.9 to 1.1 multiplier
                expectedPoints *= fixtureBonus;
                
                // Differential bonus for low ownership high performers
                if (player.selected_by_percent < 10 && expectedPoints > 5) {
                    expectedPoints *= 1.15;
                }
                
                // Penalty taker bonus
                if (player.penalties_order && player.penalties_order <= 1) {
                    expectedPoints *= 1.1;
                }
                
                return Math.max(expectedPoints, 2); // Minimum 2 points
            }
            
            buildOptimalTeamForFormation(sortedPlayers, formation) {
                const team = { 1: [], 2: [], 3: [], 4: [] };
                let remainingBudget = 1000;
                const usedPlayerIds = new Set();
                const maxPerTeam = 3; // FPL rule: max 3 players from same team
                const teamCounts = {};
                
                // Requirements for each position
                const requirements = {
                    1: formation.gkp,
                    2: formation.def,
                    3: formation.mid,
                    4: formation.fwd
                };
                
                // Fill each position with best available players
                for (let position = 1; position <= 4; position++) {
                    const needed = requirements[position];
                    const positionPlayers = sortedPlayers.filter(p => 
                        p.element_type === position && 
                        !usedPlayerIds.has(p.id)
                    );
                    
                    // Determine premium vs budget split
                    const premiumCount = position === 1 ? 1 : Math.min(Math.ceil(needed * 0.4), 2);
                    const budgetCount = needed - premiumCount;
                    
                    // Add premium players first (highest expected points)
                    let added = 0;
                    for (const player of positionPlayers) {
                        if (added >= premiumCount) break;
                        
                        const teamCount = teamCounts[player.team] || 0;
                        if (teamCount >= maxPerTeam) continue;
                        
                        if (player.now_cost <= remainingBudget) {
                            team[position].push(player);
                            remainingBudget -= player.now_cost;
                            usedPlayerIds.add(player.id);
                            teamCounts[player.team] = teamCount + 1;
                            added++;
                        }
                    }
                    
                    // Add value players (best points per million)
                    const valuePlayers = positionPlayers
                        .filter(p => !usedPlayerIds.has(p.id))
                        .map(p => ({
                            ...p,
                            value: p.expectedPoints / (p.now_cost / 10)
                        }))
                        .sort((a, b) => b.value - a.value);
                    
                    for (const player of valuePlayers) {
                        if (team[position].length >= needed) break;
                        
                        const teamCount = teamCounts[player.team] || 0;
                        if (teamCount >= maxPerTeam) continue;
                        
                        if (player.now_cost <= remainingBudget) {
                            team[position].push(player);
                            remainingBudget -= player.now_cost;
                            usedPlayerIds.add(player.id);
                            teamCounts[player.team] = teamCount + 1;
                        }
                    }
                    
                    // Fill remaining slots with cheapest valid players
                    if (team[position].length < needed) {
                        const cheapest = positionPlayers
                            .filter(p => {
                                const teamCount = teamCounts[p.team] || 0;
                                return !usedPlayerIds.has(p.id) && teamCount < maxPerTeam;
                            })
                            .sort((a, b) => a.now_cost - b.now_cost);
                        
                        for (const player of cheapest) {
                            if (team[position].length >= needed) break;
                            
                            const teamCount = teamCounts[player.team] || 0;
                            team[position].push(player);
                            remainingBudget -= player.now_cost;
                            usedPlayerIds.add(player.id);
                            teamCounts[player.team] = teamCount + 1;
                        }
                    }
                }
                
                return team;
            }
            
            calculateTeamExpectedPoints(team) {
                let total = 0;
                Object.values(team).forEach(position => {
                    position.forEach(player => {
                        total += this.calculateExpectedPointsForGameweek(player);
                    });
                });
                return total;
            }
            
            resetTeam() {
                // Clear all team data
                this.currentSquad = { 1: [], 2: [], 3: [], 4: [] };
                this.budget = 1000;
                
                // Clear transfer history
                const history = document.getElementById('transferHistory');
                if (history) {
                    history.innerHTML = '<div class="history-item" style="color: #666;">No transfers yet</div>';
                }
                
                // Re-render the squad display
                this.updateSquadDisplay();
                this.updateDisplay();
                this.updateCharts();
                
                // Show notification
                this.showNotification('üîÑ Team has been reset!', 'info');
            }

            comparePlayer(playerId) {
                const player = this.allPlayers.find(p => p.id === playerId);
                if (player) {
                    this.showNotification(`Comparing ${player.first_name} ${player.second_name}...`, 'info');
                }
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    padding: 15px 25px;
                    border-radius: 10px;
                    color: white;
                    font-weight: 600;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                `;
                
                const colors = {
                    success: 'linear-gradient(135deg, #28a745, #20c997)',
                    error: 'linear-gradient(135deg, #dc3545, #c82333)',
                    info: 'linear-gradient(135deg, #17a2b8, #138496)'
                };
                
                notification.style.background = colors[type] || colors.info;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // Global functions
        function filterPlayers() {
            if (window.transferSimPro) {
                window.transferSimPro.displayPlayers();
            }
        }

        function optimizeTeam() {
            if (window.transferSimPro) {
                window.transferSimPro.optimizeTeam();
            }
        }

        function resetTeam() {
            if (window.transferSimPro) {
                window.transferSimPro.resetTeam();
            }
        }

        function runScenario(type) {
            if (window.transferSimPro) {
                window.transferSimPro.runScenario(type);
            }
        }

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Initialize
        window.transferSimPro = new TransferSimulatorPro();
        document.addEventListener('DOMContentLoaded', () => {
            window.transferSimPro.init();
        });
    </script>
</body>
</html>