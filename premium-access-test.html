<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6480210605786899"
         crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Access Control Test</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
        }
        
        .test-section h3 {
            color: #37003c;
            margin-bottom: 15px;
        }
        
        .user-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #37003c, #6f42c1);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .status-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .premium-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .feature-link {
            display: block;
            padding: 15px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-decoration: none;
            color: #333;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .feature-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .feature-link.pro {
            border-color: #6f42c1;
            background: linear-gradient(135deg, #f3e8ff, #ffffff);
        }
        
        .feature-link.starter {
            border-color: #fd7e14;
            background: linear-gradient(135deg, #fff3e0, #ffffff);
        }
    </style>
</head>
<body>
    <div class="header" include="./header.html"></div>
    
    <div class="test-container">
        <h1>🧪 Premium Access Control Test</h1>
        <p>This page allows you to test the premium access control system by simulating different user membership levels.</p>
        
        <div class="test-section">
            <h3>Current User Status</h3>
            <div id="currentStatus" class="status-display">Loading...</div>
            <button class="btn btn-primary" onclick="refreshStatus()">🔄 Refresh Status</button>
        </div>
        
        <div class="test-section">
            <h3>Simulate User Types</h3>
            <p>Click the buttons below to simulate different user membership levels and get REAL access:</p>
            <div class="user-controls">
                <button class="btn btn-danger" onclick="simulateUser('free', false)">
                    Free User (Not Logged In)
                </button>
                <button class="btn btn-warning" onclick="simulateUser('free', true)">
                    Free User (Logged In)
                </button>
                <button class="btn btn-success" onclick="simulateUser('starter', true)">
                    ✨ Starter Member (Active)
                </button>
                <button class="btn btn-primary" onclick="simulateUser('pro', true)">
                    🚀 Pro Member (Active)
                </button>
                <button class="btn btn-danger" onclick="simulateUser('pro', false)">
                    Pro Member (Inactive)
                </button>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 6px; font-size: 0.9rem;">
                <strong>💡 Pro Tip:</strong> After clicking a button, you'll actually become that user type and can access the premium tools!
            </div>
        </div>
        
        <div class="test-section">
            <h3>Test Premium Features</h3>
            <p>Click on these premium features to test access control:</p>
            <div class="premium-links">
                <a href="player-predictor.html" class="feature-link pro" target="_blank">
                    🔮 Player Predictor<br>
                    <small>(Pro Only)</small>
                </a>
                <a href="budget-optimizer.html" class="feature-link pro" target="_blank">
                    💰 Budget Optimizer<br>
                    <small>(Pro Only)</small>
                </a>
                <a href="transfer-simulator-pro.html" class="feature-link starter" target="_blank">
                    ⚡ Transfer Simulator Pro<br>
                    <small>(Starter+)</small>
                </a>
                <a href="player-data-enhanced.html" class="feature-link starter" target="_blank">
                    📊 Player Analytics<br>
                    <small>(Starter+)</small>
                </a>
                <a href="fpl-ai-assistant.html" class="feature-link" target="_blank">
                    🤖 FPL AI Assistant<br>
                    <small>(Limited Free)</small>
                </a>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <strong>🧪 Test Instructions:</strong><br>
                1. Click a simulation button above to set your user type<br>
                2. Check the access indicators (✓/✗) on each feature<br>
                3. Click on a feature link to test actual access<br>
                4. Pro users should get access to all tools, Starter users to Starter+ tools
            </div>
        </div>
        
        <div class="test-section">
            <h3>Reset & Clear</h3>
            <button class="btn btn-danger" onclick="clearAllData()">
                🗑️ Clear All Test Data
            </button>
        </div>
    </div>
    
    <div class="footer" include="./footer.html"></div>
    <script src="./index.js"></script>
    <script src="./auth-service.js"></script>
    <script src="./subscription-manager.js"></script>
    <script src="./premium-access-control.js"></script>
    
    <script>
        function simulateUser(tier, isActive) {
            console.log(`Simulating user: ${tier} (${isActive ? 'active' : 'inactive'})`);
            
            // Set authentication data directly (most reliable method)
            localStorage.setItem('userLoggedIn', isActive ? 'true' : 'false');
            localStorage.setItem('membershipLevel', tier);
            
            // Set comprehensive subscription data
            const subscriptionData = {
                tier: tier,
                status: isActive ? 'active' : 'inactive',
                lastChecked: new Date().toISOString(),
                userId: `test-${tier}-user`,
                email: `test@${tier}.user`,
                subscriptionId: `sub_${Math.random().toString(36).substr(2, 9)}`,
                currentPeriodEnd: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days from now
            };
            localStorage.setItem('eplSubscription', JSON.stringify(subscriptionData));
            
            // Use auth service simulation if available
            if (window.authService && window.authService.simulateLogin) {
                window.authService.simulateLogin(tier, isActive);
            }
            
            // Update subscription manager
            if (window.subscriptionManager) {
                window.subscriptionManager.subscriptionData = subscriptionData;
                if (window.subscriptionManager.updateUIBasedOnSubscription) {
                    window.subscriptionManager.updateUIBasedOnSubscription();
                }
            }
            
            // Force refresh premium access control
            if (window.premiumAccessControl) {
                window.premiumAccessControl.refreshUserStatus();
                
                // Dispatch events to notify all systems
                window.dispatchEvent(new CustomEvent('authChanged', {
                    detail: {
                        user: {
                            email: subscriptionData.email,
                            subscription: subscriptionData
                        },
                        subscription: subscriptionData
                    }
                }));
                
                window.dispatchEvent(new CustomEvent('subscriptionUpdated', {
                    detail: {
                        tier: tier,
                        isActive: isActive,
                        subscription: subscriptionData
                    }
                }));
            }
            
            // Update status display and verify access
            setTimeout(() => {
                refreshStatus();
                verifyAccess(tier, isActive);
            }, 100);
            
            // Show notification with verification
            showNotification(`✅ ${tier.toUpperCase()} user activated! ${isActive ? 'Access granted to premium tools' : 'Subscription inactive'}`, isActive ? 'success' : 'warning');
        }
        
        function refreshStatus() {
            const statusEl = document.getElementById('currentStatus');
            
            if (window.premiumAccessControl) {
                const status = window.premiumAccessControl.userStatus;
                const subscriptionData = JSON.parse(localStorage.getItem('eplSubscription') || '{}');
                
                statusEl.innerHTML = `
                    <strong>Logged In:</strong> ${status.isLoggedIn ? '✅ Yes' : '❌ No'}<br>
                    <strong>Membership Level:</strong> ${status.membershipLevel.toUpperCase()}<br>
                    <strong>Active Subscription:</strong> ${status.isActive ? '✅ Active' : '❌ Inactive'}<br>
                    <strong>Daily AI Usage:</strong> ${status.dailyUsage.aiQueries} queries<br>
                    <strong>User Email:</strong> ${subscriptionData.email || 'Not set'}<br>
                    <strong>Subscription ID:</strong> ${subscriptionData.subscriptionId || 'None'}
                `;
            } else {
                statusEl.innerHTML = 'Premium access control not loaded';
            }
        }
        
        function verifyAccess(tier, isActive) {
            if (!window.premiumAccessControl) {
                console.error('Premium access control not available');
                return;
            }
            
            // Test access to different features
            const features = [
                'player-predictor.html',
                'budget-optimizer.html', 
                'transfer-simulator-pro.html',
                'player-data-enhanced.html',
                'fpl-ai-assistant.html'
            ];
            
            console.log(`\n🧪 VERIFYING ACCESS FOR ${tier.toUpperCase()} USER (${isActive ? 'ACTIVE' : 'INACTIVE'}):`);
            
            features.forEach(feature => {
                const access = window.premiumAccessControl.hasAccess(feature);
                const emoji = access.hasAccess ? '✅' : '❌';
                console.log(`${emoji} ${feature}: ${access.hasAccess ? 'GRANTED' : 'DENIED'}`);
                
                if (!access.hasAccess && access.requiredTier) {
                    console.log(`   Required tier: ${access.requiredTier}`);
                }
            });
            
            // Update feature links with real-time access status
            updateFeatureLinks();
        }
        
        function updateFeatureLinks() {
            const links = document.querySelectorAll('.feature-link');
            links.forEach(link => {
                const href = link.getAttribute('href');
                if (href && window.premiumAccessControl) {
                    const access = window.premiumAccessControl.hasAccess(href);
                    
                    // Update visual indicator
                    const existingIndicator = link.querySelector('.access-indicator');
                    if (existingIndicator) {
                        existingIndicator.remove();
                    }
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'access-indicator';
                    indicator.style.cssText = `
                        position: absolute;
                        top: 5px;
                        right: 5px;
                        background: ${access.hasAccess ? '#28a745' : '#dc3545'};
                        color: white;
                        border-radius: 50%;
                        width: 20px;
                        height: 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        font-weight: bold;
                    `;
                    indicator.textContent = access.hasAccess ? '✓' : '✗';
                    
                    link.style.position = 'relative';
                    link.appendChild(indicator);
                    
                    // Update border color
                    link.style.borderColor = access.hasAccess ? '#28a745' : '#dc3545';
                }
            });
        }
        
        function clearAllData() {
            // Clear all authentication data
            localStorage.removeItem('userLoggedIn');
            localStorage.removeItem('membershipLevel');
            localStorage.removeItem('eplSubscription');
            localStorage.removeItem('dailyUsage');
            
            // Reset subscription manager if it exists
            if (window.subscriptionManager) {
                window.subscriptionManager.subscriptionData = null;
                if (window.subscriptionManager.clearSubscription) {
                    window.subscriptionManager.clearSubscription();
                }
            }
            
            // Reset auth service if it exists
            if (window.authService && window.authService.simulateLogout) {
                window.authService.simulateLogout();
            }
            
            // Refresh premium access control
            if (window.premiumAccessControl) {
                window.premiumAccessControl.refreshUserStatus();
                
                // Dispatch logout events
                window.dispatchEvent(new CustomEvent('authChanged', {
                    detail: { user: null, subscription: null }
                }));
            }
            
            // Update displays
            setTimeout(() => {
                refreshStatus();
                updateFeatureLinks();
                verifyAccess('free', false);
            }, 100);
            
            showNotification('🔄 All test data cleared - back to free user', 'info');
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            const colors = {
                success: 'linear-gradient(135deg, #28a745, #20c997)',
                error: 'linear-gradient(135deg, #dc3545, #c82333)',
                info: 'linear-gradient(135deg, #17a2b8, #138496)'
            };
            
            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize status display
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                refreshStatus();
                updateFeatureLinks();
                
                // Show current status in console
                const currentData = localStorage.getItem('eplSubscription');
                if (currentData) {
                    try {
                        const subscription = JSON.parse(currentData);
                        console.log('🔍 Current subscription status:', subscription);
                        verifyAccess(subscription.tier, subscription.status === 'active');
                    } catch (error) {
                        console.log('🔍 No valid subscription data found');
                        verifyAccess('free', false);
                    }
                } else {
                    console.log('🔍 No subscription data found - showing as free user');
                    verifyAccess('free', false);
                }
            }, 500); // Delay to ensure scripts are loaded
        });
    </script>
</body>
</html>