<!DOCTYPE html>
<html lang="en-GB">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPLGM5QY9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TVPLGM5QY9');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Predict Premier League match scores and compete on the global leaderboard. Premium prediction game with accurate statistics and real-time rankings.">
    <meta name="keywords" content="EPL predictor, Premier League predictions, football prediction game, match predictions, score predictor, leaderboard">
    <title>EPL Score Predictor - Premier League Prediction Game | EPL News Hub</title>

    <link rel="icon" type="image/png" href="/eplnewshubnewlogo.png">
    <link rel="stylesheet" href="/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            color: #121212;
            line-height: 1.65;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .predictor-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 60px 24px;
        }

        /* Live Match Ticker */
        .live-ticker {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: #fff;
            padding: 12px 0;
            overflow: hidden;
            position: relative;
            margin-bottom: 40px;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .ticker-content {
            display: flex;
            animation: scroll-ticker 30s linear infinite;
            white-space: nowrap;
        }

        @keyframes scroll-ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .ticker-item {
            display: inline-flex;
            align-items: center;
            padding: 0 40px;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .ticker-live-dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .ticker-score {
            margin: 0 10px;
            font-size: 16px;
            font-weight: 800;
        }

        /* Header Section - Compact Athletic Style */
        .predictor-header {
            max-width: 1200px;
            margin: 0 auto 40px;
            background: linear-gradient(to bottom, #ffffff 0%, #fafafa 100%);
            border: 2px solid #dfdfdf;
            border-radius: 8px;
            padding: 32px 40px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 40px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e0e0e0;
        }

        .header-content {
            flex: 1;
        }

        .predictor-title {
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 42px;
            font-weight: 800;
            color: #121212;
            margin-bottom: 8px;
            line-height: 1.1;
            letter-spacing: -1.2px;
        }

        .predictor-subtitle {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 15px;
            color: #666;
            line-height: 1.5;
            font-weight: 400;
        }

        .welcome-box {
            background: linear-gradient(135deg, #121212 0%, #000 100%);
            color: #fff;
            padding: 20px 24px;
            border-radius: 6px;
            min-width: 240px;
            text-align: center;
        }

        .welcome-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: 0.3px;
        }

        .welcome-subtitle {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .user-section {
            display: none; /* Hidden when user is logged in */
        }

        .user-section.show {
            display: block;
        }

        .username-input-container {
            margin-bottom: 20px;
        }

        .username-input {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 17px;
            padding: 14px 18px;
            border: 2px solid #dfdfdf;
            border-radius: 4px;
            width: 100%;
            max-width: 320px;
            transition: all 0.2s ease;
            background: #fff;
        }

        .username-input:focus {
            outline: none;
            border-color: #121212;
            box-shadow: 0 0 0 3px rgba(18, 18, 18, 0.05);
        }

        .username-btn {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 15px;
            font-weight: 600;
            padding: 14px 32px;
            background: #121212;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 12px;
            transition: all 0.2s ease;
            letter-spacing: 0.3px;
        }

        .username-btn:hover {
            background: #000;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .username-btn:active {
            transform: translateY(0);
        }

        .user-stats {
            display: flex;
            gap: 32px;
            align-items: center;
            flex-wrap: wrap;
        }

        .stat-box {
            display: flex;
            align-items: baseline;
            gap: 10px;
            padding: 0;
        }

        .stat-box:hover .stat-value {
            color: #000;
        }

        .stat-label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #767676;
            font-weight: 600;
        }

        .stat-value {
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 28px;
            font-weight: 800;
            color: #121212;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .stat-separator {
            width: 1px;
            height: 32px;
            background: #dfdfdf;
        }

        /* Navigation Tabs - Athletic Style */
        .tabs-nav {
            border-bottom: 2px solid #dfdfdf;
            margin-bottom: 50px;
            display: flex;
            gap: 40px;
            background: #fff;
            padding: 0 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            overflow-x: auto;
        }

        .tab-link {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: #767676;
            padding: 20px 0;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.25s ease;
            background: none;
            border-left: none;
            border-right: none;
            border-top: none;
            white-space: nowrap;
            letter-spacing: 0.2px;
        }

        .tab-link:hover {
            color: #121212;
            border-bottom-color: #dfdfdf;
        }

        .tab-link.active {
            color: #121212;
            border-bottom-color: #121212;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 40px;
            padding-bottom: 24px;
            border-bottom: 2px solid #121212;
        }

        .section-title {
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 38px;
            font-weight: 800;
            color: #121212;
            margin-bottom: 12px;
            letter-spacing: -0.8px;
            line-height: 1.15;
        }

        .section-description {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 17px;
            color: #555;
            line-height: 1.7;
            letter-spacing: -0.01em;
        }

        /* Match Cards - Athletic Design */
        .matches-grid {
            display: grid;
            gap: 24px;
        }

        .match-card {
            border: 2px solid #dfdfdf;
            border-radius: 6px;
            padding: 32px;
            transition: all 0.3s ease;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .match-card:hover {
            border-color: #121212;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .match-card.predicted {
            background: linear-gradient(to bottom, #f8f9fa 0%, #fff 100%);
            border-color: #28a745;
            border-width: 2px;
        }

        .match-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
            color: #666;
        }

        .match-badge {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            background: #121212;
            color: #fff;
            font-weight: 600;
        }

        .difficulty-hard { background: #dc3545; }
        .difficulty-medium { background: #ffc107; color: #000; }
        .difficulty-easy { background: #28a745; }
        .live-badge { background: #dc3545; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .match-card {
            animation: fadeIn 0.4s ease forwards;
        }

        .match-card:nth-child(1) { animation-delay: 0.05s; }
        .match-card:nth-child(2) { animation-delay: 0.1s; }
        .match-card:nth-child(3) { animation-delay: 0.15s; }
        .match-card:nth-child(4) { animation-delay: 0.2s; }
        .match-card:nth-child(5) { animation-delay: 0.25s; }

        .live-match {
            border-color: #dc3545 !important;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.2);
        }

        .score-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .teams-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            align-items: center;
            margin-bottom: 25px;
        }

        .team-box {
            text-align: center;
        }

        .team-name {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #121212;
            margin-bottom: 15px;
        }

        .score-input {
            width: 75px;
            height: 65px;
            text-align: center;
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 32px;
            font-weight: 800;
            border: 2px solid #dfdfdf;
            border-radius: 6px;
            background: #fff;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .score-input:focus {
            outline: none;
            border-color: #121212;
            box-shadow: 0 0 0 3px rgba(18, 18, 18, 0.08);
            transform: scale(1.05);
        }

        .vs-text {
            font-size: 14px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .match-actions {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        /* Confidence Slider */
        .confidence-slider-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .confidence-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .confidence-value {
            font-size: 16px;
            font-weight: 800;
            color: #121212;
        }

        .confidence-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #ffc107 0%, #28a745 50%, #007bff 100%);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .confidence-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #121212;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .confidence-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #121212;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .confidence-description {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        /* Countdown Timer */
        .match-countdown {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 700;
            color: #856404;
            margin-bottom: 15px;
        }

        .countdown-timer {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            letter-spacing: 1px;
        }

        /* Form Guide */
        .form-guide {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: 10px;
        }

        .form-result {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #fff;
        }

        .form-result.W { background: #28a745; }
        .form-result.D { background: #6c757d; }
        .form-result.L { background: #dc3545; }

        /* Performance Chart */
        .performance-chart {
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }

        .sparkline {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 24px;
        }

        .sparkline-bar {
            width: 4px;
            background: linear-gradient(to top, #667eea, #764ba2);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .sparkline-bar:hover {
            background: linear-gradient(to top, #764ba2, #667eea);
        }

        /* Quick Predict Badge */
        .quick-predict-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* Enhanced Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #121212;
            color: #fff;
            padding: 16px 24px;
            font-size: 14px;
            z-index: 10000;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .toast.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .toast.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            height: 200px;
            margin-bottom: 24px;
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 16px;
        }

        .predict-btn {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 15px;
            font-weight: 700;
            padding: 14px 36px;
            background: linear-gradient(to bottom, #121212 0%, #000 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .predict-btn:hover {
            background: linear-gradient(to bottom, #000 0%, #121212 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        }

        .predict-btn:active {
            transform: translateY(0);
        }

        .points-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            font-size: 13px;
            color: #666;
            border-left: 3px solid #121212;
        }

        /* Leaderboard - Athletic Premium Table */
        .leaderboard-table {
            border: 2px solid #dfdfdf;
            border-radius: 6px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .leaderboard-header,
        .leaderboard-row {
            display: grid;
            grid-template-columns: 70px 1fr 110px 110px 110px;
            gap: 20px;
            padding: 18px 28px;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .leaderboard-header {
            background: linear-gradient(to bottom, #121212 0%, #000 100%);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #fff;
            font-weight: 700;
            border-bottom: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .leaderboard-row {
            transition: all 0.2s ease;
            background: #fff;
        }

        .leaderboard-row:hover {
            background: #fafafa;
            transform: translateX(4px);
        }

        .leaderboard-row:last-child {
            border-bottom: none;
        }

        .leaderboard-row.current-user {
            background: linear-gradient(to right, #fffbea 0%, #fff 100%);
            font-weight: 700;
            border-left: 4px solid #f4c430;
            box-shadow: 0 2px 8px rgba(244, 196, 48, 0.15);
        }

        .rank-number {
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 18px;
            font-weight: 700;
            color: #121212;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .player-name {
            font-size: 15px;
            color: #121212;
        }

        .stat-number {
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 16px;
            font-weight: 600;
            color: #121212;
        }

        /* Achievements Grid */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .achievement-card {
            border: 1px solid #e0e0e0;
            padding: 25px;
            text-align: center;
            transition: all 0.2s;
        }

        .achievement-card.unlocked {
            background: #f0fff4;
            border-color: #28a745;
        }

        .achievement-card.locked {
            opacity: 0.5;
        }

        .achievement-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .achievement-name {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #121212;
            margin-bottom: 8px;
        }

        .achievement-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        /* Power-ups Section */
        .powerups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .powerup-card {
            border: 2px solid #dfdfdf;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .powerup-card:hover {
            border-color: #121212;
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .powerup-card.active {
            background: linear-gradient(135deg, #fffbea 0%, #fff5d6 100%);
            border-color: #f4c430;
            border-width: 3px;
            box-shadow: 0 4px 16px rgba(244, 196, 48, 0.25);
        }

        .powerup-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .powerup-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .powerup-cost {
            font-size: 13px;
            color: #666;
        }

        /* Results Display */
        .result-card {
            background: #f8f9fa;
            padding: 20px;
            margin-top: 20px;
            border-left: 3px solid #007bff;
        }

        .result-correct { border-left-color: #28a745; background: #f0fff4; }
        .result-wrong { border-left-color: #dc3545; background: #fff5f5; }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f0f0f0;
            border-top: 3px solid #121212;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #121212;
            color: #fff;
            padding: 15px 25px;
            font-size: 14px;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .predictor-header {
                padding: 24px 20px;
            }

            .header-top {
                flex-direction: column;
                gap: 20px;
            }

            .welcome-box {
                min-width: auto;
                width: 100%;
            }

            .predictor-title {
                font-size: 32px;
                letter-spacing: -0.8px;
            }

            .predictor-subtitle {
                font-size: 14px;
            }

            .user-stats {
                gap: 20px;
                justify-content: space-between;
            }

            .stat-separator {
                display: none;
            }

            .stat-label {
                font-size: 11px;
            }

            .stat-value {
                font-size: 24px;
            }

            .username-input {
                max-width: 100%;
                margin-bottom: 12px;
            }

            .username-btn {
                margin-left: 0;
                width: 100%;
            }

            .teams-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .vs-text {
                display: none;
            }

            .leaderboard-header,
            .leaderboard-row {
                grid-template-columns: 50px 1fr 80px;
                font-size: 13px;
                padding: 14px 16px;
            }

            .leaderboard-row > :nth-child(4),
            .leaderboard-row > :nth-child(5) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header" include="./header.html"></div>

    <!-- Live Match Ticker -->
    <div id="liveTicker" class="live-ticker" style="display: none;">
        <div class="ticker-content" id="tickerContent"></div>
    </div>

    <div class="predictor-container">
        <!-- Main Header -->
        <div class="predictor-header">
            <div class="header-top">
                <div class="header-content">
                    <h1 class="predictor-title">Premier League Score Predictor</h1>
                    <p class="predictor-subtitle">Predict scores, compete globally, track your accuracy in real-time</p>
                </div>
                <div id="welcomeBox" class="welcome-box" style="display: none;">
                    <div class="welcome-name" id="welcomeName">—</div>
                    <div class="welcome-subtitle">On the Leaderboard</div>
                </div>
            </div>

            <div class="user-section" id="usernameSection">
                <div class="username-input-container">
                    <input
                        type="text"
                        class="username-input"
                        id="usernameInput"
                        placeholder="Choose your username"
                        maxlength="20"
                    >
                    <button class="username-btn" onclick="PredictorGame.setUsername()">Join Leaderboard</button>
                </div>
            </div>

            <div class="user-stats">
                <div class="stat-box">
                    <div class="stat-label">Points</div>
                    <div class="stat-value" id="userPoints">0</div>
                </div>
                <div class="stat-separator"></div>
                <div class="stat-box">
                    <div class="stat-label">Rank</div>
                    <div class="stat-value" id="userRank">—</div>
                </div>
                <div class="stat-separator"></div>
                <div class="stat-box">
                    <div class="stat-label">Accuracy</div>
                    <div class="stat-value" id="userAccuracy">0%</div>
                </div>
                <div class="stat-separator"></div>
                <div class="stat-box">
                    <div class="stat-label">Streak</div>
                    <div class="stat-value" id="userStreak">0</div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="tabs-nav">
            <button class="tab-link active" onclick="PredictorGame.switchTab('predict')">Predict</button>
            <button class="tab-link" onclick="PredictorGame.switchTab('leaderboard')">Leaderboard</button>
            <button class="tab-link" onclick="PredictorGame.switchTab('analytics')">📊 Analytics</button>
            <button class="tab-link" onclick="PredictorGame.switchTab('achievements')">Achievements</button>
            <button class="tab-link" onclick="PredictorGame.switchTab('results')">Results</button>
            <button class="tab-link" onclick="PredictorGame.switchTab('guide')">How to Play</button>
        </nav>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Loading Premier League fixtures...</p>
        </div>

        <!-- Predict Tab -->
        <div id="predict" class="content-section active" style="display:none;">
            <!-- Power-ups -->
            <div class="section-header">
                <h2 class="section-title">Power-ups</h2>
                <p class="section-description">Enhance your predictions with special abilities</p>
            </div>

            <div class="powerups-grid">
                <div class="powerup-card" onclick="PredictorGame.activatePowerup('double')">
                    <div class="powerup-icon">2×</div>
                    <div class="powerup-name">Double Points</div>
                    <div class="powerup-cost">Cost: 50 points</div>
                </div>
                <div class="powerup-card" onclick="PredictorGame.activatePowerup('streak')">
                    <div class="powerup-icon">🛡️</div>
                    <div class="powerup-name">Streak Saver</div>
                    <div class="powerup-cost">Cost: 100 points</div>
                </div>
                <div class="powerup-card" onclick="PredictorGame.activatePowerup('hint')">
                    <div class="powerup-icon">💡</div>
                    <div class="powerup-name">Hint</div>
                    <div class="powerup-cost">Cost: 30 points</div>
                </div>
            </div>

            <div class="section-header">
                <h2 class="section-title">Upcoming Matches</h2>
                <p class="section-description">Make your predictions before kickoff</p>
            </div>

            <div class="matches-grid" id="upcomingMatches"></div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboard" class="content-section">
            <div class="section-header">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                    <h2 class="section-title" style="margin-bottom: 0;">Global Leaderboard</h2>
                    <button onclick="PredictorGame.refreshLeaderboard()" style="
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        font-size: 14px;
                        font-weight: 600;
                        padding: 10px 20px;
                        background: #121212;
                        color: #fff;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    ">🔄 Refresh</button>
                </div>
                <p class="section-description">Real-time rankings based on actual user predictions</p>
            </div>

            <div class="leaderboard-table">
                <div class="leaderboard-header">
                    <div>Rank</div>
                    <div>Player</div>
                    <div>Points</div>
                    <div>Streak</div>
                    <div>Accuracy</div>
                </div>
                <div id="leaderboardBody"></div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div id="achievements" class="content-section">
            <div class="section-header">
                <h2 class="section-title">Achievements</h2>
                <p class="section-description">Unlock badges by reaching milestones</p>
            </div>

            <div class="achievements-grid" id="achievementsGrid"></div>
        </div>

        <!-- Results Tab -->
        <div id="results" class="content-section">
            <div class="section-header">
                <h2 class="section-title">Recent Results</h2>
                <p class="section-description">See how your predictions scored</p>
            </div>

            <div class="matches-grid" id="resultsMatches"></div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="content-section">
            <div class="section-header">
                <h2 class="section-title">Performance Analytics</h2>
                <p class="section-description">Deep insights into your prediction performance</p>
            </div>

            <div style="max-width: 1000px; margin: 0 auto;">
                <!-- Quick Stats Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 8px; color: #fff; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Predictions</div>
                        <div style="font-size: 32px; font-weight: 800;" id="analyticsTotalPredictions">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 24px; border-radius: 8px; color: #fff; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Success Rate</div>
                        <div style="font-size: 32px; font-weight: 800;" id="analyticsSuccessRate">0%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); padding: 24px; border-radius: 8px; color: #fff; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Exact Scores</div>
                        <div style="font-size: 32px; font-weight: 800;" id="analyticsExactScores">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); padding: 24px; border-radius: 8px; color: #fff; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Best Streak</div>
                        <div style="font-size: 32px; font-weight: 800;" id="analyticsBestStreak">0 🔥</div>
                    </div>
                </div>

                <!-- Performance Over Time -->
                <div style="background: #fff; border: 2px solid #dfdfdf; border-radius: 8px; padding: 30px; margin-bottom: 24px;">
                    <h3 style="font-size: 18px; margin-bottom: 20px; font-weight: 600;">📈 Points History</h3>
                    <div id="analyticsPointsChart" style="height: 200px; display: flex; align-items: flex-end; justify-content: space-around; gap: 8px; padding: 20px; background: #f8f9fa; border-radius: 6px;">
                        <!-- Chart bars will be generated here -->
                    </div>
                    <div style="text-align: center; margin-top: 15px; font-size: 13px; color: #666;">Last 20 predictions</div>
                </div>

                <!-- Breakdown by Result Type -->
                <div style="background: #fff; border: 2px solid #dfdfdf; border-radius: 8px; padding: 30px; margin-bottom: 24px;">
                    <h3 style="font-size: 18px; margin-bottom: 20px; font-weight: 600;">🎯 Prediction Breakdown</h3>
                    <div style="display: grid; gap: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <span>🎯 Exact Score (10pts)</span>
                            <span style="font-weight: 700; font-size: 18px;" id="breakdownExact">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <span>✓ Correct Result + GD (7pts)</span>
                            <span style="font-weight: 700; font-size: 18px;" id="breakdownResultGD">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <span>✓ Correct Result (5pts)</span>
                            <span style="font-weight: 700; font-size: 18px;" id="breakdownResult">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                            <span>✗ Incorrect</span>
                            <span style="font-weight: 700; font-size: 18px;" id="breakdownIncorrect">0</span>
                        </div>
                    </div>
                </div>

                <!-- Top Performances -->
                <div style="background: #fff; border: 2px solid #dfdfdf; border-radius: 8px; padding: 30px;">
                    <h3 style="font-size: 18px; margin-bottom: 20px; font-weight: 600;">⭐ Top Predictions</h3>
                    <div id="topPredictions" style="display: grid; gap: 12px;">
                        <!-- Top predictions will be listed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Tab -->
        <div id="debug" class="content-section">
            <div class="section-header">
                <h2 class="section-title">Debug Panel</h2>
                <p class="section-description">Troubleshoot leaderboard and sync issues</p>
            </div>

            <div style="max-width: 900px; margin: 0 auto;">
                <div style="background: #fff; border: 2px solid #dfdfdf; border-radius: 8px; padding: 30px; margin-bottom: 24px;">
                    <h3 style="font-size: 18px; margin-bottom: 20px; font-weight: 600;">🔍 Your Data</h3>
                    <div id="debugUserData" style="font-family: monospace; font-size: 13px; background: #f8f9fa; padding: 20px; border-radius: 4px; overflow-x: auto;"></div>
                </div>

                <div style="background: #fff; border: 2px solid #dfdfdf; border-radius: 8px; padding: 30px; margin-bottom: 24px;">
                    <h3 style="font-size: 18px; margin-bottom: 20px; font-weight: 600;">🔥 Firebase Connection & Sync</h3>
                    <div id="debugFirebase" style="font-family: monospace; font-size: 13px; background: #f8f9fa; padding: 20px; border-radius: 4px; margin-bottom: 15px;"></div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="PredictorGame.testFirebaseConnection()" style="padding: 10px 20px; background: #121212; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Test Connection</button>
                        <button onclick="PredictorGame.forceRecalcAndSync()" style="padding: 10px 20px; background: #28a745; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Recalculate Points & Sync</button>
                        <button onclick="PredictorGame.forceSync()" style="padding: 10px 20px; background: #dc3545; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Force Sync Current Data</button>
                    </div>
                </div>

                <div style="background: #fff; border: 2px solid #dfdfdf; border-radius: 8px; padding: 30px;">
                    <h3 style="font-size: 18px; margin-bottom: 20px; font-weight: 600;">📊 Leaderboard Raw Data</h3>
                    <div id="debugLeaderboard" style="font-family: monospace; font-size: 13px; background: #f8f9fa; padding: 20px; border-radius: 4px; max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- Guide Tab -->
        <div id="guide" class="content-section">
            <div class="section-header">
                <h2 class="section-title">How to Play</h2>
            </div>

            <div style="max-width: 700px; margin: 0 auto;">
                <h3 style="font-size: 20px; margin: 30px 0 15px; font-weight: 600;">Scoring System</h3>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>10 points</strong> — Exact score prediction
                    </li>
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>7 points</strong> — Correct result + goal difference
                    </li>
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>5 points</strong> — Correct result only
                    </li>
                </ul>

                <h3 style="font-size: 20px; margin: 30px 0 15px; font-weight: 600;">Difficulty Multipliers</h3>
                <p style="color: #666; line-height: 1.6; margin-bottom: 10px;">
                    Match difficulty affects points earned:
                </p>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>Hard</strong> — 1.5× points (top team clashes)
                    </li>
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>Medium</strong> — 1.2× points (mixed matchups)
                    </li>
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>Easy</strong> — 1× points (standard matches)
                    </li>
                </ul>

                <h3 style="font-size: 20px; margin: 30px 0 15px; font-weight: 600;">Streaks & Bonuses</h3>
                <p style="color: #666; line-height: 1.6;">
                    Build a streak by making consecutive correct predictions. Earn bonus points:
                    3+ streak (+2 pts), 5+ streak (+5 pts), 10+ streak (+10 pts).
                </p>

                <h3 style="font-size: 20px; margin: 30px 0 15px; font-weight: 600;">Power-ups</h3>
                <p style="color: #666; line-height: 1.6;">
                    Purchase power-ups with your earned points to boost your predictions.
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer" include="./footer.html"></div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="/index.js"></script>

    <script>
        // GLOBAL LEADERBOARD using Supabase (truly global across all users and devices!)
        // TODO: Replace these with YOUR Supabase credentials from https://supabase.com
        const SUPABASE_URL = 'YOUR_SUPABASE_PROJECT_URL'; // Replace with your project URL
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Replace with your anon/public key

        const LeaderboardStorage = {
            async getAllUsers() {
                try {
                    console.log('🌐 Fetching GLOBAL leaderboard from Supabase...');

                    const response = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=*`, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    });

                    if (!response.ok) {
                        console.error('❌ Supabase fetch failed:', response.status);
                        return {};
                    }

                    const data = await response.json();
                    console.log('✅ Global leaderboard loaded:', data.length, 'players worldwide');

                    // Convert array to object keyed by user_id
                    const users = {};
                    data.forEach(user => {
                        users[user.user_id] = {
                            username: user.username,
                            totalPoints: user.total_points,
                            streak: user.streak,
                            totalPredictions: user.total_predictions,
                            correctPredictions: user.correct_predictions,
                            accuracy: user.accuracy,
                            lastUpdated: user.last_updated
                        };
                    });

                    return users;
                } catch (error) {
                    console.error('❌ Error fetching global leaderboard:', error);
                    return {};
                }
            },

            async saveUser(userId, userData) {
                try {
                    console.log('💾 Saving to GLOBAL leaderboard...', { userId, userData });

                    const payload = {
                        user_id: userId,
                        username: userData.username,
                        total_points: userData.totalPoints || 0,
                        streak: userData.streak || 0,
                        total_predictions: userData.totalPredictions || 0,
                        correct_predictions: userData.correctPredictions || 0,
                        accuracy: userData.accuracy || 0
                    };

                    // Upsert (insert or update if exists)
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'resolution=merge-duplicates'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok || response.status === 201) {
                        console.log('✅ Saved to GLOBAL leaderboard - visible to ALL users!');
                        console.log('👤 Your data:', userData);
                        return true;
                    } else {
                        console.error('❌ Failed to save:', response.status, await response.text());
                        return false;
                    }
                } catch (error) {
                    console.error('❌ Error saving to global leaderboard:', error);
                    return false;
                }
            },

            async getLeaderboard() {
                const users = await this.getAllUsers();
                console.log('🏆 Processing GLOBAL leaderboard:', Object.keys(users).length, 'players');

                const leaderboard = Object.entries(users)
                    .map(([userId, data]) => ({
                        userId,
                        ...data
                    }))
                    .filter(user => user.username) // Include ALL users with usernames
                    .sort((a, b) => {
                        // Sort by total points (descending)
                        if (b.totalPoints !== a.totalPoints) {
                            return b.totalPoints - a.totalPoints;
                        }
                        // If same points, sort by accuracy
                        if (b.accuracy !== a.accuracy) {
                            return b.accuracy - a.accuracy;
                        }
                        // If same accuracy, sort by streak
                        if (b.streak !== a.streak) {
                            return b.streak - a.streak;
                        }
                        // Alphabetical tiebreaker
                        return a.username.localeCompare(b.username);
                    });

                console.log('📊 Final GLOBAL leaderboard:', leaderboard.length, 'players ranked');
                return leaderboard;
            },

            async checkUsernameExists(username, currentUserId) {
                try {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/leaderboard?username=eq.${encodeURIComponent(username)}&select=user_id`,
                        {
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            }
                        }
                    );

                    if (!response.ok) return false;

                    const data = await response.json();
                    // Username exists if we find a different user with same name
                    return data.some(user => user.user_id !== currentUserId);
                } catch (error) {
                    console.error('❌ Error checking username:', error);
                    return false;
                }
            }
        };

        const PredictorGame = {
            fixtures: [],
            predictions: {},
            teamFormCache: {},
            userStats: {
                username: '',
                userId: '',
                totalPoints: 0,
                level: 1,
                streak: 0,
                longestStreak: 0,
                totalPredictions: 0,
                correctPredictions: 0,
                exactScores: 0,
                achievements: [],
                activePowerup: null,
                streakSaverActive: false
            },
            leaderboardData: [],
            currentSeason: '2025-2026',
            leagueId: 4328,
            achievements: [
                { id: 'first_prediction', name: 'First Steps', desc: 'Make your first prediction', icon: '🎯' },
                { id: 'exact_score_1', name: 'Sharpshooter', desc: 'Get 1 exact score', icon: '🎯' },
                { id: 'exact_score_5', name: 'Marksman', desc: 'Get 5 exact scores', icon: '🏹' },
                { id: 'exact_score_10', name: 'Sniper Elite', desc: 'Get 10 exact scores', icon: '🎖️' },
                { id: 'streak_3', name: 'Hot Streak', desc: 'Reach a 3-prediction streak', icon: '🔥' },
                { id: 'streak_5', name: 'On Fire', desc: 'Reach a 5-prediction streak', icon: '🔥🔥' },
                { id: 'streak_10', name: 'Unstoppable', desc: 'Reach a 10-prediction streak', icon: '🔥🔥🔥' },
                { id: 'points_100', name: 'Century', desc: 'Earn 100 total points', icon: '💯' },
                { id: 'points_500', name: 'High Roller', desc: 'Earn 500 total points', icon: '💎' },
                { id: 'points_1000', name: 'Legend', desc: 'Earn 1000 total points', icon: '👑' },
                { id: 'level_5', name: 'Rising Star', desc: 'Reach level 5', icon: '🌟' },
                { id: 'level_10', name: 'Veteran', desc: 'Reach level 10', icon: '⚡' }
            ],

            async init() {
                await this.loadUserData();
                await this.fetchFixtures();
                this.updateStatsDisplay();
                this.renderAchievements();
                await this.loadLeaderboard();
                this.showSection('predict');

                // Auto-refresh fixtures every 60 seconds to get live updates
                setInterval(() => {
                    this.fetchFixtures();
                }, 60000);
            },

            async loadUserData() {
                const saved = localStorage.getItem('eplPredictorUserData');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.predictions = data.predictions || {};
                    this.userStats = { ...this.userStats, ...data.stats };

                    if (this.userStats.username) {
                        document.getElementById('usernameSection').style.display = 'none';
                        document.getElementById('welcomeBox').style.display = 'block';
                        document.getElementById('welcomeName').textContent = this.userStats.username;

                        // Sync existing user to leaderboard
                        await this.syncToLeaderboard();
                    }
                }

                if (!this.userStats.userId) {
                    this.userStats.userId = 'user_' + Math.random().toString(36).substr(2, 9);
                }
            },

            saveUserData() {
                const data = {
                    predictions: this.predictions,
                    stats: this.userStats,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('eplPredictorUserData', JSON.stringify(data));
            },

            async setUsername() {
                const username = document.getElementById('usernameInput').value.trim();
                const btn = document.querySelector('.username-btn');

                if (!username) {
                    this.showToast('Please enter a username', 'error');
                    return;
                }

                if (username.length < 3) {
                    this.showToast('Username must be at least 3 characters', 'error');
                    return;
                }

                if (username.length > 20) {
                    this.showToast('Username must be 20 characters or less', 'error');
                    return;
                }

                // Check for valid characters (alphanumeric, underscores, hyphens)
                if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                    this.showToast('Username can only contain letters, numbers, underscores, and hyphens', 'error');
                    return;
                }

                // Show loading state
                const originalText = btn.textContent;
                btn.textContent = 'Checking...';
                btn.disabled = true;

                try {
                    // Check if username is already taken
                    const isAvailable = await this.checkUsernameAvailability(username);
                    if (!isAvailable) {
                        this.showToast('Username already taken. Please choose another.', 'error');
                        btn.textContent = originalText;
                        btn.disabled = false;
                        return;
                    }

                    btn.textContent = 'Saving...';

                    // If user already has a username, remove old username mapping
                    if (this.userStats.username && this.userStats.username !== username) {
                        await database.ref('usernames/' + this.userStats.username.toLowerCase()).remove();
                    }

                    this.userStats.username = username;
                    this.saveUserData();

                    // Save username mapping and user data
                    await this.syncUsernameAndData(username);

                    document.getElementById('usernameSection').style.display = 'none';
                    document.getElementById('welcomeBox').style.display = 'block';
                    document.getElementById('welcomeName').textContent = username;

                    this.showToast('Username saved successfully!', 'success');
                } catch (error) {
                    console.error('Error setting username:', error);
                    this.showToast('Error saving username. Please try again.', 'error');
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            },

            async checkUsernameAvailability(username) {
                const exists = await LeaderboardStorage.checkUsernameExists(username, this.userStats.userId);
                return !exists; // Return true if available (doesn't exist for other users)
            },

            async syncUsernameAndData(username) {
                // Save user data to leaderboard
                await this.syncToLeaderboard();
            },

            async syncToLeaderboard() {
                if (!this.userStats.username) {
                    console.log('⚠️ Cannot sync to leaderboard: No username set');
                    return;
                }

                const userData = {
                    username: this.userStats.username,
                    totalPoints: this.userStats.totalPoints || 0,
                    streak: this.userStats.streak || 0,
                    totalPredictions: this.userStats.totalPredictions || 0,
                    correctPredictions: this.userStats.correctPredictions || 0,
                    accuracy: this.userStats.totalPredictions > 0 ?
                        Math.round((this.userStats.correctPredictions / this.userStats.totalPredictions) * 100) : 0
                };

                await LeaderboardStorage.saveUser(this.userStats.userId, userData);

                console.log('✅ Synced to GLOBAL leaderboard (visible to all users!):', {
                    userId: this.userStats.userId,
                    username: userData.username,
                    totalPoints: userData.totalPoints,
                    accuracy: userData.accuracy
                });

                // Refresh leaderboard display
                await this.loadLeaderboard();
            },

            async loadLeaderboard() {
                console.log('📊 Loading GLOBAL leaderboard from cloud...');

                const users = await LeaderboardStorage.getLeaderboard();

                console.log(`✅ Global leaderboard loaded: ${users.length} players worldwide`, {
                    topPlayer: users[0]?.username,
                    topPoints: users[0]?.totalPoints
                });

                // Show visual feedback if leaderboard data changed
                const hasChanged = JSON.stringify(this.leaderboardData) !== JSON.stringify(users);
                if (hasChanged && this.leaderboardData.length > 0) {
                    this.showLeaderboardUpdate();
                }

                this.leaderboardData = users;
                this.renderLeaderboard();
                this.updateUserRank();
            },

            async refreshLeaderboard() {
                console.log('🔄 Manually refreshing leaderboard...');
                await this.loadLeaderboard();
                this.showToast('Leaderboard refreshed', 'success');
            },

            async forceSync() {
                console.log('🚀 Force syncing current data to leaderboard...');
                if (!this.userStats.username) {
                    this.showToast('Please set a username first', 'error');
                    return;
                }

                await this.syncToLeaderboard();
                this.showToast('✅ Synced successfully!', 'success');
                this.updateDebugPanel();
            },

            async forceRecalcAndSync() {
                console.log('🔄 Recalculating all points and syncing...');
                if (!this.userStats.username) {
                    this.showToast('Please set a username first', 'error');
                    return;
                }

                // Recalculate points from all finished matches
                await this.calculateAllPoints();

                // Update displays
                this.updateStatsDisplay();
                this.renderResults();

                this.showToast('✅ Recalculated and synced!', 'success');
                this.updateDebugPanel();
            },

            testFirebaseConnection() {
                console.log('🧪 Testing localStorage leaderboard...');
                const debugDiv = document.getElementById('debugFirebase');

                try {
                    // Test write
                    const testData = {
                        username: 'test_user',
                        totalPoints: 100,
                        streak: 5,
                        accuracy: 80,
                        totalPredictions: 10,
                        correctPredictions: 8
                    };

                    LeaderboardStorage.saveUser('test_' + Date.now(), testData);

                    // Test read
                    const leaderboard = LeaderboardStorage.getLeaderboard();

                    debugDiv.innerHTML = `
                        <div style="color: #28a745; margin-bottom: 10px;">✅ localStorage Leaderboard Working!</div>
                        <div>• Write test: PASSED</div>
                        <div>• Read test: PASSED</div>
                        <div>• Storage: localStorage (browser-based)</div>
                        <div>• Total players: ${leaderboard.length}</div>
                    `;
                    this.showToast('Leaderboard storage working', 'success');
                } catch (error) {
                    debugDiv.innerHTML = `
                        <div style="color: #dc3545; margin-bottom: 10px;">❌ localStorage Test Failed</div>
                        <div>Error: ${error.message}</div>
                        <div style="margin-top: 10px;">Check browser console for details</div>
                    `;
                    console.error('localStorage test failed:', error);
                    this.showToast('Storage test failed', 'error');
                }
            },

            updateDebugPanel() {
                // Update user data
                const userData = document.getElementById('debugUserData');
                if (userData) {
                    userData.innerHTML = `<pre>${JSON.stringify({
                        userId: this.userStats.userId,
                        username: this.userStats.username,
                        totalPoints: this.userStats.totalPoints,
                        totalPredictions: this.userStats.totalPredictions,
                        correctPredictions: this.userStats.correctPredictions,
                        accuracy: this.userStats.totalPredictions > 0
                            ? Math.round((this.userStats.correctPredictions / this.userStats.totalPredictions) * 100)
                            : 0,
                        streak: this.userStats.streak,
                        level: this.userStats.level,
                        predictionCount: Object.keys(this.predictions).length,
                        finishedMatches: this.fixtures.filter(m => this.isFinished(m)).length
                    }, null, 2)}</pre>`;
                }

                // Update leaderboard data
                const leaderboardDebug = document.getElementById('debugLeaderboard');
                if (leaderboardDebug) {
                    leaderboardDebug.innerHTML = `
                        <div style="margin-bottom: 10px;"><strong>Total Players:</strong> ${this.leaderboardData.length}</div>
                        <div style="margin-bottom: 10px;"><strong>Players with Points:</strong> ${this.leaderboardData.filter(p => p.totalPoints > 0).length}</div>
                        <div style="margin-bottom: 15px;"><strong>Your Rank:</strong> ${this.leaderboardData.findIndex(u => u.userId === this.userStats.userId) + 1 || 'Not ranked'}</div>
                        <pre>${JSON.stringify(this.leaderboardData.slice(0, 10), null, 2)}</pre>
                    `;
                }
            },

            showLeaderboardUpdate() {
                const leaderboardTab = document.querySelector('[onclick*="leaderboard"]');
                if (leaderboardTab && !leaderboardTab.classList.contains('active')) {
                    // Add a subtle pulse animation to the leaderboard tab
                    leaderboardTab.style.position = 'relative';
                    const badge = document.createElement('span');
                    badge.style.cssText = `
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        width: 8px;
                        height: 8px;
                        background: #e74c3c;
                        border-radius: 50%;
                        animation: pulse 2s infinite;
                    `;
                    badge.className = 'update-badge';

                    // Remove existing badge if any
                    const existingBadge = leaderboardTab.querySelector('.update-badge');
                    if (existingBadge) existingBadge.remove();

                    leaderboardTab.appendChild(badge);
                }
            },

            updateUserRank() {
                const userRank = this.leaderboardData.findIndex(u => u.userId === this.userStats.userId) + 1;
                document.getElementById('userRank').textContent = userRank > 0 ? `#${userRank}` : '—';
            },

            renderLeaderboard() {
                const container = document.getElementById('leaderboardBody');

                if (this.leaderboardData.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #666;">
                            <div style="font-size: 48px; margin-bottom: 16px;">🏆</div>
                            <div style="font-size: 18px; font-weight: 600; color: #121212; margin-bottom: 8px;">No players yet</div>
                            <div style="font-size: 14px;">Be the first to join the leaderboard!</div>
                        </div>
                    `;
                    return;
                }

                const totalPlayers = this.leaderboardData.length;
                const playersWithPoints = this.leaderboardData.filter(p => p.totalPoints > 0).length;

                // Show top 100 players
                container.innerHTML = this.leaderboardData.slice(0, 100).map((player, index) => {
                    const rank = index + 1;
                    const isCurrentUser = player.userId === this.userStats.userId;

                    // Medal icons for top 3
                    let rankDisplay = rank;
                    if (rank === 1) rankDisplay = '🥇';
                    else if (rank === 2) rankDisplay = '🥈';
                    else if (rank === 3) rankDisplay = '🥉';

                    return `
                        <div class="leaderboard-row ${isCurrentUser ? 'current-user' : ''}">
                            <div class="rank-number rank-${rank}">${rankDisplay}</div>
                            <div class="player-name">${this.escapeHtml(player.username)}${isCurrentUser ? ' <strong style="color: #f4c430;">(You)</strong>' : ''}</div>
                            <div class="stat-number"><strong>${player.totalPoints}</strong></div>
                            <div class="stat-number">${player.streak > 0 ? '🔥 ' + player.streak : '—'}</div>
                            <div class="stat-number">${player.accuracy}%</div>
                        </div>
                    `;
                }).join('');

                // Add footer with stats
                const lastUpdate = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const playersWithZero = totalPlayers - playersWithPoints;

                let statsMessage = `<strong>${totalPlayers}</strong> total player${totalPlayers !== 1 ? 's' : ''}`;

                if (playersWithPoints > 0) {
                    statsMessage += ` · <strong>${playersWithPoints}</strong> with points`;
                    if (playersWithZero > 0) {
                        statsMessage += ` · <strong>${playersWithZero}</strong> awaiting points`;
                    }
                } else {
                    statsMessage += ` · All players awaiting points (make predictions on matches!)`;
                }

                if (totalPlayers > 100) {
                    statsMessage += ` · Showing top 100`;
                }

                container.innerHTML += `
                    <div style="padding: 20px 28px; background: #f8f9fa; border-top: 2px solid #dfdfdf; text-align: center; font-size: 13px; color: #666;">
                        <div style="margin-bottom: 8px;">
                            ${statsMessage}
                        </div>
                        <div style="font-size: 11px; color: #999;">
                            Last updated: ${lastUpdate} · Shows all players with usernames
                        </div>
                    </div>
                `;
            },

            escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            },

            async fetchFixtures() {
                try {
                    document.getElementById('loadingState').style.display = 'block';

                    const response = await fetch(
                        `https://api.allorigins.win/raw?url=https://www.thesportsdb.com/api/v1/json/3/eventsseason.php?id=${this.leagueId}&s=${this.currentSeason}`
                    );

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data.events) {
                        this.fixtures = data.events
                            .map(event => this.parseEvent(event))
                            .sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

                        await this.calculateAllPoints();
                        this.renderUpcoming();
                        this.renderResults();
                        this.renderLiveTicker();

                        document.getElementById('loadingState').style.display = 'none';
                    } else {
                        throw new Error('No events data returned from API');
                    }
                } catch (error) {
                    console.error('Error loading fixtures:', error);
                    document.getElementById('loadingState').style.display = 'none';
                    this.showToast('Error loading fixtures: ' + error.message, 'error');
                }
            },

            parseEvent(event) {
                return {
                    id: event.idEvent,
                    homeTeam: event.strHomeTeam,
                    awayTeam: event.strAwayTeam,
                    homeTeamId: event.idHomeTeam,
                    awayTeamId: event.idAwayTeam,
                    homeScore: event.intHomeScore ? parseInt(event.intHomeScore) : null,
                    awayScore: event.intAwayScore ? parseInt(event.intAwayScore) : null,
                    dateTime: event.strTimestamp || `${event.dateEvent} ${event.strTime}`,
                    status: event.strStatus,
                    round: event.intRound,
                    difficulty: this.calculateDifficulty(event.strHomeTeam, event.strAwayTeam)
                };
            },

            calculateDifficulty(homeTeam, awayTeam) {
                const topTeams = ['Arsenal', 'Manchester City', 'Liverpool', 'Chelsea', 'Manchester United', 'Tottenham'];
                const isHomeTop = topTeams.includes(homeTeam);
                const isAwayTop = topTeams.includes(awayTeam);

                if (isHomeTop && isAwayTop) return 'hard';
                if (isHomeTop || isAwayTop) return 'medium';
                return 'easy';
            },

            getDifficultyMultiplier(difficulty) {
                return difficulty === 'hard' ? 1.5 : difficulty === 'medium' ? 1.2 : 1;
            },

            isUpcoming(match) {
                const matchDate = new Date(match.dateTime);
                const now = new Date();
                return matchDate > now && match.homeScore === null;
            },

            isLive(match) {
                const matchDate = new Date(match.dateTime);
                const now = new Date();
                const matchEndTime = new Date(matchDate.getTime() + 120 * 60000); // 2 hours after kickoff
                return now >= matchDate && now <= matchEndTime && match.homeScore === null;
            },

            hasMatchStarted(match) {
                const matchDate = new Date(match.dateTime);
                const now = new Date();
                return now >= matchDate;
            },

            isFinished(match) {
                return match.homeScore !== null && match.awayScore !== null;
            },

            renderUpcoming() {
                try {
                    const container = document.getElementById('upcomingMatches');
                    const upcoming = this.fixtures.filter(m => this.isUpcoming(m) || this.isLive(m)).slice(0, 20);

                    if (upcoming.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">No upcoming matches</p>';
                        return;
                    }

                    container.innerHTML = upcoming.map(match => {
                        const prediction = this.predictions[match.id];
                        const hasPrediction = prediction && prediction.homeScore !== undefined;
                        const multiplier = this.getDifficultyMultiplier(match.difficulty);
                        const matchStarted = this.hasMatchStarted(match);
                        const isLive = this.isLive(match);
                        const isLocked = matchStarted || hasPrediction;
                        const countdown = this.getCountdown(match.dateTime);
                        const homeForm = this.getTeamForm(match.homeTeam, match.homeTeamId);
                        const awayForm = this.getTeamForm(match.awayTeam, match.awayTeamId);

                    return `
                        <div class="match-card ${hasPrediction ? 'predicted' : ''} ${isLive ? 'live-match' : ''}" style="position: relative;">
                            ${hasPrediction && !matchStarted ? '<div class="quick-predict-badge">LOCKED ✓</div>' : ''}

                            <div class="match-info">
                                <span>${new Date(match.dateTime).toLocaleDateString('en-GB', {
                                    weekday: 'short',
                                    day: 'numeric',
                                    month: 'short',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}</span>
                                <span class="match-badge ${isLive ? 'live-badge' : `difficulty-${match.difficulty}`}">
                                    ${isLive ? '🔴 LIVE' : `${match.difficulty} ${multiplier}×`}
                                </span>
                            </div>

                            ${!matchStarted && countdown ? `
                                <div class="match-countdown">
                                    ⏱️ Kickoff in <span class="countdown-timer">${countdown}</span>
                                </div>
                            ` : ''}

                            ${isLive ? `
                                <div style="background: #fff3cd; padding: 10px; margin-bottom: 15px; border-left: 3px solid #ffc107; font-size: 14px; color: #856404;">
                                    <strong>Match in Progress</strong> — Predictions are locked
                                </div>
                            ` : ''}

                            ${matchStarted && !hasPrediction ? `
                                <div style="background: #f8d7da; padding: 10px; margin-bottom: 15px; border-left: 3px solid #dc3545; font-size: 14px; color: #721c24;">
                                    <strong>Match Started</strong> — Cannot make prediction
                                </div>
                            ` : ''}

                            <div class="teams-row">
                                <div class="team-box">
                                    <div class="team-name">${match.homeTeam}</div>
                                    ${homeForm ? `<div class="form-guide">${homeForm}</div>` : ''}
                                    <input
                                        type="number"
                                        class="score-input"
                                        id="home_${match.id}"
                                        min="0"
                                        max="10"
                                        value="${prediction?.homeScore ?? ''}"
                                        placeholder="—"
                                        ${isLocked ? 'disabled' : ''}
                                        onchange="PredictorGame.autoSavePrediction('${match.id}', '${match.difficulty}')"
                                    >
                                </div>

                                <div class="vs-text">vs</div>

                                <div class="team-box">
                                    <div class="team-name">${match.awayTeam}</div>
                                    ${awayForm ? `<div class="form-guide">${awayForm}</div>` : ''}
                                    <input
                                        type="number"
                                        class="score-input"
                                        id="away_${match.id}"
                                        min="0"
                                        max="10"
                                        value="${prediction?.awayScore ?? ''}"
                                        placeholder="—"
                                        ${isLocked ? 'disabled' : ''}
                                        onchange="PredictorGame.autoSavePrediction('${match.id}', '${match.difficulty}')"
                                    >
                                </div>
                            </div>

                            <div class="match-actions">
                                ${!matchStarted && !hasPrediction ? `
                                    <div class="points-info" style="background: #fff8e1; border-left-color: #ffc107;">
                                        <strong>💡 Enter both scores</strong> — Auto-saves when complete
                                    </div>
                                    <div class="points-info">
                                        <strong>Potential:</strong>
                                        Exact ${Math.round(10 * multiplier)}pts,
                                        Result+GD ${Math.round(7 * multiplier)}pts,
                                        Result ${Math.round(5 * multiplier)}pts
                                        ${this.userStats.streak >= 3 ? ` + ${this.getStreakBonus()} streak bonus` : ''}
                                    </div>
                                ` : hasPrediction ? `
                                    <div class="points-info" style="background: #e7f3ff; border-left-color: #007bff;">
                                        <strong>Your Prediction:</strong> ${prediction.homeScore}–${prediction.awayScore}
                                        ${isLive ? ' — Waiting for final result...' : ''}
                                    </div>
                                ` : `
                                    <div class="points-info" style="background: #f8d7da; border-left-color: #dc3545; color: #721c24;">
                                        <strong>Missed Opportunity</strong> — Match has already started
                                    </div>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
                } catch (error) {
                    console.error('Error rendering upcoming matches:', error);
                    const container = document.getElementById('upcomingMatches');
                    container.innerHTML = '<p style="text-align: center; color: #dc3545;">Error displaying matches. Please refresh the page.</p>';
                }
            },

            getStreakBonus() {
                const streak = this.userStats.streak;
                if (streak >= 10) return 10;
                if (streak >= 5) return 5;
                if (streak >= 3) return 2;
                return 0;
            },

            autoSavePrediction(matchId, difficulty) {
                // Check if both inputs have values
                const homeInput = document.getElementById(`home_${matchId}`);
                const awayInput = document.getElementById(`away_${matchId}`);

                if (!homeInput || !awayInput) return;

                const homeScore = parseInt(homeInput.value);
                const awayScore = parseInt(awayInput.value);

                // Only auto-save if both scores are valid numbers
                if (!isNaN(homeScore) && !isNaN(awayScore) && homeScore >= 0 && awayScore >= 0) {
                    console.log('⚡ Auto-saving prediction:', { matchId, homeScore, awayScore });
                    this.savePrediction(matchId, difficulty);
                }
            },

            savePrediction(matchId, difficulty) {
                if (!this.userStats.username) {
                    this.showToast('Please set a username first', 'error');
                    return;
                }

                // Check if match has started
                const match = this.fixtures.find(m => m.id === matchId);
                if (match && this.hasMatchStarted(match)) {
                    this.showToast('Cannot predict - match has already started', 'error');
                    return;
                }

                // Check if prediction already exists
                const existingPrediction = this.predictions[matchId];
                if (existingPrediction && existingPrediction.homeScore !== undefined) {
                    this.showToast('Cannot change prediction - already submitted', 'error');
                    return;
                }

                const homeInput = document.getElementById(`home_${matchId}`);
                const awayInput = document.getElementById(`away_${matchId}`);

                const homeScore = parseInt(homeInput.value);
                const awayScore = parseInt(awayInput.value);

                if (isNaN(homeScore) || isNaN(awayScore) || homeScore < 0 || awayScore < 0) {
                    this.showToast('Please enter valid scores', 'error');
                    return;
                }

                this.predictions[matchId] = {
                    homeScore,
                    awayScore,
                    difficulty,
                    timestamp: new Date().toISOString(),
                    doublePowerup: this.userStats.activePowerup === 'double',
                    locked: true
                };

                if (this.userStats.activePowerup === 'double') {
                    this.userStats.activePowerup = null;
                }

                this.userStats.totalPredictions++;
                this.saveUserData();
                this.syncToFirebase();
                this.renderUpcoming();
                this.checkAchievements();

                this.showToast('Prediction saved!', 'success');
            },

            calculatePoints(prediction, actual) {
                if (!prediction || actual.homeScore === null) return 0;

                let basePoints = 0;
                const predHome = prediction.homeScore;
                const predAway = prediction.awayScore;
                const actHome = actual.homeScore;
                const actAway = actual.awayScore;

                if (predHome === actHome && predAway === actAway) {
                    basePoints = 10;
                } else {
                    const predGD = predHome - predAway;
                    const actGD = actHome - actAway;
                    const predResult = predGD > 0 ? 'H' : predGD < 0 ? 'A' : 'D';
                    const actResult = actGD > 0 ? 'H' : actGD < 0 ? 'A' : 'D';

                    if (predResult === actResult && predGD === actGD) {
                        basePoints = 7;
                    } else if (predResult === actResult) {
                        basePoints = 5;
                    }
                }

                const multiplier = this.getDifficultyMultiplier(prediction.difficulty || 'easy');
                let finalPoints = Math.round(basePoints * multiplier);

                if (basePoints > 0) {
                    finalPoints += this.getStreakBonus();
                }

                if (prediction.doublePowerup) {
                    finalPoints *= 2;
                }

                return finalPoints;
            },

            async calculateAllPoints() {
                let totalPoints = 0;
                let exactScores = 0;
                let correctPredictions = 0;
                let currentStreak = 0;
                let incorrectHappened = false;
                let pointsChanged = false;

                const previousPoints = this.userStats.totalPoints;
                const previousCorrect = this.userStats.correctPredictions;

                console.log('📊 Calculating points from finished matches...');

                this.fixtures.forEach(match => {
                    if (this.isFinished(match) && this.predictions[match.id]) {
                        const points = this.calculatePoints(this.predictions[match.id], match);

                        // Check if points were just calculated for this match
                        if (!this.predictions[match.id].points || this.predictions[match.id].points !== points) {
                            pointsChanged = true;
                            console.log(`  ✨ New points for ${match.homeTeam} vs ${match.awayTeam}: ${points}pts`);
                        }

                        this.predictions[match.id].points = points;

                        totalPoints += points;
                        if (points >= 10) exactScores++;
                        if (points > 0) {
                            correctPredictions++;
                            if (!incorrectHappened) currentStreak++;
                        } else {
                            incorrectHappened = true;
                        }
                    }
                });

                console.log(`📈 Total Points: ${totalPoints} (was ${previousPoints})`);
                console.log(`✅ Correct: ${correctPredictions} (was ${previousCorrect})`);
                console.log(`🔥 Streak: ${currentStreak}`);

                this.userStats.totalPoints = totalPoints;
                this.userStats.exactScores = exactScores;
                this.userStats.correctPredictions = correctPredictions;
                this.userStats.streak = currentStreak;
                if (currentStreak > this.userStats.longestStreak) {
                    this.userStats.longestStreak = currentStreak;
                }

                this.userStats.level = Math.floor(totalPoints / 100) + 1;

                this.saveUserData();
                this.updateStatsDisplay(); // Force update display

                // ALWAYS sync to leaderboard if user has username
                if (this.userStats.username) {
                    if (pointsChanged || previousPoints !== totalPoints || previousCorrect !== correctPredictions) {
                        console.log('🔥 Points/stats changed! Syncing to leaderboard...');
                        await this.syncToLeaderboard();
                    } else {
                        console.log('📊 No point changes, but ensuring leaderboard is up to date...');
                        await this.syncToLeaderboard(); // Sync anyway to ensure data is current
                    }
                } else {
                    console.warn('⚠️ No username set - cannot sync to leaderboard!');
                }
            },

            renderResults() {
                const container = document.getElementById('resultsMatches');
                const finished = this.fixtures
                    .filter(m => this.isFinished(m))
                    .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime))
                    .slice(0, 30);

                if (finished.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No results yet</p>';
                    return;
                }

                container.innerHTML = finished.map(match => {
                    const prediction = this.predictions[match.id];
                    const points = prediction?.points || 0;

                    return `
                        <div class="match-card">
                            <div class="match-info">
                                <span>${new Date(match.dateTime).toLocaleDateString('en-GB', {
                                    weekday: 'short',
                                    day: 'numeric',
                                    month: 'short'
                                })}</span>
                                <span class="match-badge">Final</span>
                            </div>

                            <div style="text-align: center; margin: 20px 0;">
                                <div style="font-size: 20px; font-weight: 600; margin-bottom: 10px;">
                                    ${match.homeTeam} ${match.homeScore}–${match.awayScore} ${match.awayTeam}
                                </div>
                            </div>

                            ${prediction ? `
                                <div class="result-card ${points > 0 ? 'result-correct' : 'result-wrong'}">
                                    <strong>Your Prediction:</strong> ${prediction.homeScore}–${prediction.awayScore}<br>
                                    <strong>Points Earned:</strong> ${points}
                                    ${points >= 10 ? ' (Exact Score!)' : points >= 7 ? ' (Result + GD)' : points >= 5 ? ' (Correct Result)' : ''}
                                </div>
                            ` : `
                                <div class="result-card">No prediction made</div>
                            `}
                        </div>
                    `;
                }).join('');
            },

            renderAchievements() {
                const container = document.getElementById('achievementsGrid');

                container.innerHTML = this.achievements.map(ach => {
                    const unlocked = this.userStats.achievements.includes(ach.id);

                    return `
                        <div class="achievement-card ${unlocked ? 'unlocked' : 'locked'}">
                            <div class="achievement-icon">${ach.icon}</div>
                            <div class="achievement-name">${ach.name}</div>
                            <div class="achievement-desc">${ach.desc}</div>
                            ${unlocked ? '<div style="margin-top: 10px; color: #28a745; font-weight: 600;">✓ Unlocked</div>' : ''}
                        </div>
                    `;
                }).join('');
            },

            checkAchievements() {
                const newAchievements = [];

                this.achievements.forEach(ach => {
                    if (!this.userStats.achievements.includes(ach.id)) {
                        let unlocked = false;

                        switch(ach.id) {
                            case 'first_prediction':
                                unlocked = this.userStats.totalPredictions >= 1;
                                break;
                            case 'exact_score_1':
                                unlocked = this.userStats.exactScores >= 1;
                                break;
                            case 'exact_score_5':
                                unlocked = this.userStats.exactScores >= 5;
                                break;
                            case 'exact_score_10':
                                unlocked = this.userStats.exactScores >= 10;
                                break;
                            case 'streak_3':
                                unlocked = this.userStats.longestStreak >= 3;
                                break;
                            case 'streak_5':
                                unlocked = this.userStats.longestStreak >= 5;
                                break;
                            case 'streak_10':
                                unlocked = this.userStats.longestStreak >= 10;
                                break;
                            case 'points_100':
                                unlocked = this.userStats.totalPoints >= 100;
                                break;
                            case 'points_500':
                                unlocked = this.userStats.totalPoints >= 500;
                                break;
                            case 'points_1000':
                                unlocked = this.userStats.totalPoints >= 1000;
                                break;
                            case 'level_5':
                                unlocked = this.userStats.level >= 5;
                                break;
                            case 'level_10':
                                unlocked = this.userStats.level >= 10;
                                break;
                        }

                        if (unlocked) {
                            this.userStats.achievements.push(ach.id);
                            newAchievements.push(ach);
                        }
                    }
                });

                if (newAchievements.length > 0) {
                    newAchievements.forEach(ach => {
                        this.showToast(`Achievement Unlocked: ${ach.name}!`, 'success');
                    });
                    this.saveUserData();
                    this.renderAchievements();
                }
            },

            activatePowerup(type) {
                const costs = { double: 50, streak: 100, hint: 30 };
                const cost = costs[type];

                if (this.userStats.totalPoints < cost) {
                    this.showToast(`Need ${cost} points`, 'error');
                    return;
                }

                if (type === 'double') {
                    this.userStats.totalPoints -= cost;
                    this.userStats.activePowerup = 'double';
                    this.showToast('Double Points activated!', 'success');
                } else if (type === 'streak') {
                    this.userStats.totalPoints -= cost;
                    this.userStats.streakSaverActive = true;
                    this.showToast('Streak Saver activated!', 'success');
                } else if (type === 'hint') {
                    this.showToast('Check recent form and head-to-head records', 'success');
                }

                this.saveUserData();
                this.syncToFirebase();
                this.updateStatsDisplay();
            },

            updateStatsDisplay() {
                document.getElementById('userPoints').textContent = this.userStats.totalPoints;
                document.getElementById('userStreak').textContent = this.userStats.streak;

                const totalFinished = Object.keys(this.predictions).filter(id =>
                    this.predictions[id].points !== undefined
                ).length;
                const accuracy = totalFinished > 0 ?
                    Math.round((this.userStats.correctPredictions / totalFinished) * 100) : 0;
                document.getElementById('userAccuracy').textContent = accuracy + '%';
            },

            switchTab(tabName) {
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });

                document.querySelectorAll('.tab-link').forEach(btn => {
                    btn.classList.remove('active');
                });

                document.getElementById(tabName).classList.add('active');
                document.getElementById(tabName).style.display = 'block';
                event.target.classList.add('active');

                // Remove update badge when switching to leaderboard
                if (tabName === 'leaderboard') {
                    const badge = event.target.querySelector('.update-badge');
                    if (badge) badge.remove();
                }

                // Update debug panel when switching to debug tab
                if (tabName === 'debug') {
                    this.updateDebugPanel();
                }

                // Update analytics when switching to analytics tab
                if (tabName === 'analytics') {
                    this.renderAnalytics();
                }
            },

            showSection(section) {
                document.getElementById(section).style.display = 'block';
            },

            getCountdown(matchDateTime) {
                const now = new Date();
                const matchDate = new Date(matchDateTime);
                const diff = matchDate - now;

                if (diff < 0) return null;

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                if (hours > 24) {
                    const days = Math.floor(hours / 24);
                    return `${days}d ${hours % 24}h`;
                }
                return `${hours}h ${minutes}m`;
            },

            async fetchTeamForm(teamId, teamName) {
                try {
                    // Fetch last 5 events for this team
                    const response = await fetch(`https://api.allorigins.win/raw?url=https://www.thesportsdb.com/api/v1/json/3/eventslast.php?id=${teamId}`);
                    const data = await response.json();

                    if (!data.results || data.results.length === 0) {
                        return null;
                    }

                    // Filter to only Premier League matches that are finished
                    const eplMatches = data.results
                        .filter(match =>
                            match.idLeague === '4328' &&
                            match.intHomeScore !== null &&
                            match.intAwayScore !== null
                        )
                        .slice(0, 5);

                    const formResults = [];
                    for (const match of eplMatches) {
                        const homeScore = parseInt(match.intHomeScore);
                        const awayScore = parseInt(match.intAwayScore);
                        const isHome = match.strHomeTeam === teamName;

                        let result;
                        if (homeScore === awayScore) {
                            result = 'D';
                        } else if ((isHome && homeScore > awayScore) || (!isHome && awayScore > homeScore)) {
                            result = 'W';
                        } else {
                            result = 'L';
                        }

                        formResults.push(`<div class="form-result ${result}">${result}</div>`);
                    }

                    return formResults.join('');
                } catch (error) {
                    console.error('Error fetching team form:', error);
                    return null;
                }
            },

            getTeamForm(teamName, teamId) {
                try {
                    // Return empty if no team ID
                    if (!teamId) return '';

                    // Return cached form if available and less than 1 hour old
                    const cached = this.teamFormCache[teamId];
                    if (cached && Date.now() - cached.timestamp < 3600000) {
                        return cached.form;
                    }

                    // Fetch form asynchronously and cache it
                    this.fetchTeamForm(teamId, teamName).then(form => {
                        if (form) {
                            this.teamFormCache[teamId] = {
                                form: form,
                                timestamp: Date.now()
                            };
                            // Re-render to show the updated form
                            this.renderUpcoming();
                        }
                    }).catch(error => {
                        console.error('Error in getTeamForm async fetch:', error);
                    });

                    // Return cached form or empty string while loading
                    return cached?.form || '';
                } catch (error) {
                    console.error('Error in getTeamForm:', error);
                    return '';
                }
            },

            renderLiveTicker() {
                const liveMatches = this.fixtures.filter(m => this.isLive(m));
                const ticker = document.getElementById('liveTicker');
                const tickerContent = document.getElementById('tickerContent');

                if (liveMatches.length === 0) {
                    ticker.style.display = 'none';
                    return;
                }

                ticker.style.display = 'block';

                // Duplicate content for seamless scroll
                const items = liveMatches.map(m => `
                    <div class="ticker-item">
                        <div class="ticker-live-dot"></div>
                        ${m.homeTeam} <span class="ticker-score">${m.homeScore ?? 0} - ${m.awayScore ?? 0}</span> ${m.awayTeam}
                    </div>
                `).join('');

                tickerContent.innerHTML = items + items; // Duplicate for seamless loop
            },

            renderAnalytics() {
                const finishedMatches = this.fixtures.filter(m => this.isFinished(m) && this.predictions[m.id]);

                // Update quick stats
                document.getElementById('analyticsTotalPredictions').textContent = this.userStats.totalPredictions;
                const successRate = this.userStats.totalPredictions > 0
                    ? Math.round((this.userStats.correctPredictions / this.userStats.totalPredictions) * 100)
                    : 0;
                document.getElementById('analyticsSuccessRate').textContent = successRate + '%';
                document.getElementById('analyticsExactScores').textContent = this.userStats.exactScores;
                document.getElementById('analyticsBestStreak').textContent = this.userStats.longestStreak + ' 🔥';

                // Render points chart (last 20 predictions)
                const chartContainer = document.getElementById('analyticsPointsChart');
                const last20 = finishedMatches.slice(-20);
                const maxPoints = Math.max(...last20.map(m => this.predictions[m.id]?.points || 0), 10);

                chartContainer.innerHTML = last20.map(m => {
                    const points = this.predictions[m.id]?.points || 0;
                    const height = (points / maxPoints) * 100;
                    const color = points >= 10 ? '#28a745' : points >= 7 ? '#ffc107' : points >= 5 ? '#007bff' : '#dc3545';
                    return `<div style="flex: 1; height: ${height}%; background: ${color}; border-radius: 4px 4px 0 0; min-width: 8px;" title="${points}pts"></div>`;
                }).join('') || '<div style="text-align: center; color: #999;">No data yet</div>';

                // Calculate breakdown
                let exact = 0, resultGD = 0, result = 0, incorrect = 0;
                finishedMatches.forEach(m => {
                    const points = this.predictions[m.id]?.points || 0;
                    if (points >= 10) exact++;
                    else if (points >= 7) resultGD++;
                    else if (points >= 5) result++;
                    else incorrect++;
                });

                document.getElementById('breakdownExact').textContent = exact;
                document.getElementById('breakdownResultGD').textContent = resultGD;
                document.getElementById('breakdownResult').textContent = result;
                document.getElementById('breakdownIncorrect').textContent = incorrect;

                // Top predictions
                const topContainer = document.getElementById('topPredictions');
                const sortedPredictions = finishedMatches
                    .filter(m => this.predictions[m.id]?.points > 0)
                    .sort((a, b) => (this.predictions[b.id]?.points || 0) - (this.predictions[a.id]?.points || 0))
                    .slice(0, 5);

                topContainer.innerHTML = sortedPredictions.map(m => {
                    const pred = this.predictions[m.id];
                    return `
                        <div style="padding: 15px; background: #f8f9fa; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${m.homeTeam} ${pred.homeScore}-${pred.awayScore} ${m.awayTeam}</strong>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">Actual: ${m.homeScore}-${m.awayScore}</div>
                            </div>
                            <div style="font-size: 24px; font-weight: 800; color: ${pred.points >= 10 ? '#28a745' : '#667eea'};">${pred.points}pts</div>
                        </div>
                    `;
                }).join('') || '<div style="text-align: center; color: #999; padding: 20px;">No predictions with points yet</div>';
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const icons = {
                    success: '✓',
                    error: '✗',
                    info: 'ℹ'
                };
                toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span><span>${message}</span>`;
                toast.className = `toast ${type}`;
                toast.style.display = 'flex';

                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            PredictorGame.init();
        });
    </script>
</body>
</html>
