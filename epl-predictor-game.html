<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPLGM5QY9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TVPLGM5QY9');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPL Betting Game - EPL News Hub</title>
    <meta name="description" content="Bet coins on Premier League matches. Predict match outcomes, build your streak, and climb the leaderboard!">
    <link rel="icon" type="image/png" href="/eplnewshubnewlogo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/supabase-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
            color: #f5f5f5;
            min-height: 100vh;
        }

        /* Header Styles */
        .betting-header {
            background: rgba(20, 20, 20, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: inherit;
        }

        .logo-section img {
            height: 40px;
            width: auto;
        }

        .logo-text h1 {
            font-size: 20px;
            font-weight: 700;
            color: #00ff87;
        }

        .logo-text span {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .wallet-display {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .coin-balance {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(0, 255, 135, 0.15), rgba(0, 255, 135, 0.05));
            padding: 10px 20px;
            border-radius: 50px;
            border: 1px solid rgba(0, 255, 135, 0.3);
        }

        .coin-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
            color: #000;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
        }

        .coin-amount {
            font-size: 18px;
            font-weight: 700;
            color: #00ff87;
        }

        .streak-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 100, 50, 0.15);
            padding: 8px 14px;
            border-radius: 50px;
            border: 1px solid rgba(255, 100, 50, 0.3);
        }

        .streak-badge.active {
            background: rgba(255, 100, 50, 0.25);
            border-color: rgba(255, 100, 50, 0.5);
        }

        .streak-icon {
            font-size: 16px;
        }

        .streak-count {
            font-size: 14px;
            font-weight: 600;
            color: #ff6432;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            border: none;
        }

        .nav-btn.primary {
            background: #00ff87;
            color: #000;
        }

        .nav-btn.primary:hover {
            background: #00dd75;
            transform: translateY(-2px);
        }

        .nav-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Tab Navigation */
        .tab-nav {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 24px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: #888;
            border: none;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            background: rgba(0, 255, 135, 0.15);
            color: #00ff87;
            border: 1px solid rgba(0, 255, 135, 0.3);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 24px;
            background: transparent !important;
            min-height: auto !important;
        }

        /* Match Grid */
        .matches-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
        }

        .match-count {
            font-size: 14px;
            color: #888;
        }

        .section-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .refresh-odds-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 255, 135, 0.1);
            border: 1px solid rgba(0, 255, 135, 0.3);
            color: #00ff87;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .refresh-odds-btn:hover {
            background: rgba(0, 255, 135, 0.2);
            border-color: rgba(0, 255, 135, 0.5);
        }

        .refresh-odds-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .refresh-odds-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .odds-updated {
            font-size: 11px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .odds-updated.live {
            color: #00ff87;
        }

        .odds-updated::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #666;
        }

        .odds-updated.live::before {
            background: #00ff87;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .matches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 16px;
        }

        /* Match Card */
        .match-card {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s;
        }

        .match-card:hover {
            border-color: rgba(0, 255, 135, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .match-card.has-bet {
            border-color: rgba(0, 255, 135, 0.5);
            background: rgba(0, 255, 135, 0.05);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .live-odds-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #00ff87 0%, #00d4ff 100%);
            color: #000;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            border-radius: 4px;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .live-odds-badge svg {
            color: #000;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(0, 255, 135, 0.3); }
            50% { box-shadow: 0 0 15px rgba(0, 255, 135, 0.6); }
        }

        .match-date {
            font-size: 12px;
            color: #888;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .match-date svg {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }

        .match-teams {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .team-badge {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .team-badge img {
            width: 36px;
            height: 36px;
            object-fit: contain;
        }

        .team-name {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
            text-align: center;
            max-width: 100px;
        }

        .team-position {
            font-size: 11px;
            color: #666;
        }

        .vs-badge {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        /* Betting Options */
        .betting-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .bet-option {
            padding: 14px 8px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
        }

        .bet-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .bet-option.home {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .bet-option.home:hover, .bet-option.home.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .bet-option.draw {
            border-color: rgba(107, 114, 128, 0.3);
        }

        .bet-option.draw:hover, .bet-option.draw.selected {
            background: rgba(107, 114, 128, 0.2);
            border-color: #6b7280;
        }

        .bet-option.away {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .bet-option.away:hover, .bet-option.away.selected {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        .bet-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .bet-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .bet-odds {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .bet-option.home .bet-odds { color: #3b82f6; }
        .bet-option.draw .bet-odds { color: #9ca3af; }
        .bet-option.away .bet-odds { color: #ef4444; }

        .bet-placed-badge {
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(0, 255, 135, 0.15);
            border-radius: 8px;
            font-size: 12px;
            color: #00ff87;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        /* Bet Slip Sidebar */
        .bet-slip-container {
            position: sticky;
            top: 100px;
        }

        .bet-slip {
            background: rgba(30, 30, 30, 0.95);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .bet-slip-header {
            padding: 16px 20px;
            background: rgba(0, 255, 135, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bet-slip-title {
            font-size: 16px;
            font-weight: 700;
            color: #00ff87;
        }

        .clear-slip-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .clear-slip-btn:hover {
            color: #ef4444;
        }

        .bet-slip-empty {
            padding: 40px 20px;
            text-align: center;
            color: #666;
        }

        .bet-slip-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .bet-slip-content {
            padding: 16px;
        }

        .slip-match {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }

        .slip-match-teams {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .slip-selection {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slip-bet-type {
            font-size: 13px;
            color: #888;
        }

        .slip-odds {
            font-size: 16px;
            font-weight: 700;
            color: #00ff87;
        }

        .stake-input-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stake-label {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
        }

        .stake-input-wrapper {
            position: relative;
            margin-bottom: 12px;
        }

        .stake-input {
            width: 100%;
            padding: 14px 16px;
            padding-left: 40px;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            transition: border-color 0.2s;
        }

        .stake-input:focus {
            outline: none;
            border-color: #00ff87;
        }

        .stake-coin-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 11px;
            color: #000;
        }

        .quick-stakes {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .quick-stake-btn {
            padding: 10px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-stake-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .quick-stake-btn.all-in {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .quick-stake-btn.all-in:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .potential-return {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: rgba(0, 255, 135, 0.1);
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .return-label {
            font-size: 13px;
            color: #888;
        }

        .return-amount {
            font-size: 20px;
            font-weight: 700;
            color: #00ff87;
        }

        .place-bet-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #00ff87, #00dd75);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .place-bet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 255, 135, 0.3);
        }

        .place-bet-btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* My Bets Tab */
        .bets-section {
            display: none;
        }

        .bets-section.active {
            display: block;
        }

        .bets-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .bets-tab {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            color: #888;
            border: none;
            transition: all 0.2s;
        }

        .bets-tab.active {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .bet-history-card {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .bet-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .bet-history-match {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
        }

        .bet-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .bet-status.pending {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .bet-status.won {
            background: rgba(0, 255, 135, 0.2);
            color: #00ff87;
        }

        .bet-status.lost {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .bet-history-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bet-history-selection {
            font-size: 13px;
            color: #888;
        }

        .bet-history-stake {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .bet-history-stake span {
            font-size: 14px;
            color: #666;
        }

        .bet-history-return {
            font-size: 16px;
            font-weight: 700;
            color: #00ff87;
        }

        .bet-history-return.lost {
            color: #ef4444;
            text-decoration: line-through;
        }

        /* Leaderboard */
        .leaderboard-section {
            display: none;
        }

        .leaderboard-section.active {
            display: block;
        }

        .leaderboard-card {
            background: rgba(30, 30, 30, 0.8);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .leaderboard-header-row {
            display: grid;
            grid-template-columns: 60px 1fr 100px 100px 80px;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.05);
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .leaderboard-row {
            display: grid;
            grid-template-columns: 60px 1fr 100px 100px 80px;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            align-items: center;
            transition: background 0.2s;
        }

        .leaderboard-row:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .leaderboard-row:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            font-size: 18px;
            font-weight: 700;
            color: #888;
        }

        .leaderboard-row:nth-child(2) .leaderboard-rank { color: #ffd700; }
        .leaderboard-row:nth-child(3) .leaderboard-rank { color: #c0c0c0; }
        .leaderboard-row:nth-child(4) .leaderboard-rank { color: #cd7f32; }

        .leaderboard-user {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
        }

        .leaderboard-profit {
            font-size: 15px;
            font-weight: 700;
            color: #00ff87;
        }

        .leaderboard-profit.negative {
            color: #ef4444;
        }

        .leaderboard-bets {
            font-size: 14px;
            color: #888;
        }

        .leaderboard-winrate {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        /* Daily Bonus Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a1a, #252525);
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.4);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: #888;
            margin-bottom: 24px;
        }

        .bonus-amount {
            font-size: 48px;
            font-weight: 800;
            color: #00ff87;
            margin-bottom: 8px;
        }

        .bonus-day {
            font-size: 14px;
            color: #888;
            margin-bottom: 24px;
        }

        .claim-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #00ff87, #00dd75);
            border: none;
            border-radius: 10px;
            color: #000;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .claim-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 255, 135, 0.3);
        }

        /* Auth Required State */
        .auth-required {
            padding: 80px 24px;
            text-align: center;
        }

        .auth-required svg {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            opacity: 0.3;
        }

        .auth-required h2 {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 12px;
        }

        .auth-required p {
            font-size: 16px;
            color: #888;
            margin-bottom: 24px;
        }

        .auth-required .nav-btn {
            display: inline-block;
        }

        /* Loading State */
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00ff87;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 14px 20px;
            background: rgba(30, 30, 30, 0.95);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success { border-color: rgba(0, 255, 135, 0.3); }
        .toast.error { border-color: rgba(239, 68, 68, 0.3); }
        .toast.info { border-color: rgba(59, 130, 246, 0.3); }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            font-size: 14px;
            color: #fff;
        }

        /* No Matches State */
        .no-matches {
            padding: 60px 24px;
            text-align: center;
            background: rgba(30, 30, 30, 0.5);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .no-matches svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .no-matches h3 {
            font-size: 18px;
            color: #fff;
            margin-bottom: 8px;
        }

        .no-matches p {
            font-size: 14px;
            color: #888;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .bet-slip-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 99;
                padding: 0;
            }

            .bet-slip {
                border-radius: 20px 20px 0 0;
                max-height: 60vh;
                overflow-y: auto;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 12px;
            }

            .header-left {
                width: 100%;
                justify-content: space-between;
            }

            .wallet-display {
                gap: 12px;
            }

            .coin-balance {
                padding: 8px 14px;
            }

            .coin-amount {
                font-size: 16px;
            }

            .matches-grid {
                grid-template-columns: 1fr;
            }

            .leaderboard-header-row,
            .leaderboard-row {
                grid-template-columns: 40px 1fr 80px;
            }

            .leaderboard-bets,
            .leaderboard-winrate {
                display: none;
            }
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }
    </style>
    <script src="/index.js" defer></script>
</head>
<body>
    <!-- Site Header -->
    <div class="header" include="./header.html"></div>

    <!-- Game Header with Wallet -->
    <div class="betting-header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo-text">
                    <h1>Predictor Game</h1>
                    <span>Premier League</span>
                </div>
                <div class="wallet-display" id="walletDisplay">
                    <div class="coin-balance">
                        <div class="coin-icon">C</div>
                        <span class="coin-amount" id="coinBalance">0</span>
                    </div>
                    <div class="streak-badge" id="streakBadge">
                        <span class="streak-icon">&#128293;</span>
                        <span class="streak-count" id="streakCount">0</span>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <a href="/signin.html" class="nav-btn primary" id="authBtn">Sign In</a>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
        <button class="tab-btn active" data-tab="matches">Upcoming Matches</button>
        <button class="tab-btn" data-tab="mybets">My Bets</button>
        <button class="tab-btn" data-tab="leaderboard">Leaderboard</button>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Auth Required State -->
        <div class="auth-required hidden" id="authRequired">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            <h2>Sign In to Play</h2>
            <p>Create an account to start betting with coins and compete on the leaderboard!</p>
            <a href="/signin.html" class="nav-btn primary">Sign In</a>
            <a href="/create-account.html" class="nav-btn secondary" style="margin-left: 12px;">Create Account</a>
        </div>

        <!-- Matches Section -->
        <section class="matches-section" id="matchesSection">
            <div class="section-header">
                <h2 class="section-title">Upcoming Matches</h2>
                <div class="section-header-right">
                    <span class="odds-updated" id="oddsUpdated"></span>
                    <button class="refresh-odds-btn" id="refreshOddsBtn" title="Refresh odds">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                        <span>Refresh</span>
                    </button>
                    <span class="match-count" id="matchCount">Loading...</span>
                </div>
            </div>
            <div class="matches-grid" id="matchesGrid">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>

        <!-- My Bets Section -->
        <section class="bets-section" id="myBetsSection">
            <div class="bets-tabs">
                <button class="bets-tab active" data-filter="pending">Pending</button>
                <button class="bets-tab" data-filter="settled">Settled</button>
                <button class="bets-tab" data-filter="all">All Bets</button>
            </div>
            <div id="betsContainer">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section class="leaderboard-section" id="leaderboardSection">
            <div class="leaderboard-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                <div style="background: rgba(30,30,30,0.8); border-radius: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.08); text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #00ff87;" id="statTotalPlayers">-</div>
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">Total Players</div>
                </div>
                <div style="background: rgba(30,30,30,0.8); border-radius: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.08); text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #ffd700;" id="statTotalBets">-</div>
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">Total Bets Placed</div>
                </div>
                <div style="background: rgba(30,30,30,0.8); border-radius: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.08); text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #ff6432;" id="statTopStreak">-</div>
                    <div style="font-size: 12px; color: #888; margin-top: 4px;">Best Win Streak</div>
                </div>
            </div>
            <div class="leaderboard-card">
                <div class="leaderboard-header-row">
                    <span>Rank</span>
                    <span>Player</span>
                    <span>Profit</span>
                    <span>Wins</span>
                    <span>Win %</span>
                </div>
                <div id="leaderboardRows">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bet Slip -->
        <aside class="bet-slip-container" id="betSlipContainer">
            <div class="bet-slip">
                <div class="bet-slip-header">
                    <span class="bet-slip-title">Bet Slip</span>
                    <button class="clear-slip-btn" id="clearSlip">Clear</button>
                </div>
                <div class="bet-slip-empty" id="betSlipEmpty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    <p>Select a match outcome to place a bet</p>
                </div>
                <div class="bet-slip-content hidden" id="betSlipContent">
                    <div class="slip-match">
                        <div class="slip-match-teams" id="slipTeams">-</div>
                        <div class="slip-selection">
                            <span class="slip-bet-type" id="slipBetType">-</span>
                            <span class="slip-odds" id="slipOdds">-</span>
                        </div>
                    </div>
                    <div class="stake-input-section">
                        <div class="stake-label">Stake Amount</div>
                        <div class="stake-input-wrapper">
                            <div class="stake-coin-icon">C</div>
                            <input type="number" class="stake-input" id="stakeInput" placeholder="0" min="1">
                        </div>
                        <div class="quick-stakes">
                            <button class="quick-stake-btn" data-amount="100">100</button>
                            <button class="quick-stake-btn" data-amount="500">500</button>
                            <button class="quick-stake-btn" data-amount="1000">1K</button>
                            <button class="quick-stake-btn all-in" data-amount="all">ALL</button>
                        </div>
                        <div class="potential-return">
                            <span class="return-label">Potential Return</span>
                            <span class="return-amount" id="potentialReturn">0</span>
                        </div>
                        <button class="place-bet-btn" id="placeBetBtn" disabled>Place Bet</button>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- Daily Bonus Modal -->
    <div class="modal-overlay" id="bonusModal">
        <div class="modal">
            <div class="modal-icon">&#127873;</div>
            <h2 class="modal-title">Daily Bonus!</h2>
            <p class="modal-subtitle">Welcome back! Here's your daily reward.</p>
            <div class="bonus-amount" id="bonusAmount">+100</div>
            <div class="bonus-day" id="bonusDay">Day 1 of 7</div>
            <button class="claim-btn" id="claimBonus">Claim Bonus</button>
        </div>
    </div>

    <!-- Username Setup Modal -->
    <div class="modal-overlay" id="usernameModal">
        <div class="modal">
            <div class="modal-icon" style="background: linear-gradient(135deg, #00ff87, #00dd75);">&#128100;</div>
            <h2 class="modal-title">Set Your Username</h2>
            <p class="modal-subtitle">Choose a display name for the leaderboard</p>
            <div style="margin: 20px 0;">
                <input type="text" id="usernameInput" placeholder="Enter username" maxlength="20"
                    style="width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; font-size: 16px; text-align: center;">
                <p id="usernameError" style="color: #ef4444; font-size: 12px; margin-top: 8px; display: none;"></p>
            </div>
            <button class="claim-btn" id="saveUsername">Save Username</button>
            <button class="nav-btn secondary" id="skipUsername" style="width: 100%; margin-top: 10px;">Skip for Now</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Initialize Supabase (use supabaseClient to avoid conflict with CDN global)
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // The Odds API Configuration (Free tier: 500 requests/month)
        // Get your free API key at: https://the-odds-api.com/
        const ODDS_API_KEY = 'd0c1a96c192e6a221fd9960de8f33d89';
        const ODDS_API_BASE = 'https://api.the-odds-api.com/v4/sports/soccer_epl/odds';

        // Odds Cache (to minimize API calls)
        let oddsCache = {
            data: {},
            lastFetched: null,
            expiresIn: 15 * 60 * 1000 // Cache for 15 minutes (reduced for fresher odds)
        };

        // Match Results Cache (for settling bets with real results)
        let resultsCache = {
            data: {},
            lastFetched: null,
            expiresIn: 5 * 60 * 1000 // Cache for 5 minutes (check frequently for results)
        };

        // App State
        let currentUser = null;
        let userWallet = null;
        let userProfile = null;
        let selectedBet = null;
        let matches = [];
        let standings = [];
        let userBets = [];
        let leaderboardData = [];

        // Daily Bonus Amounts
        const DAILY_BONUSES = [100, 150, 200, 300, 400, 500, 750];

        // Team name normalization map (API names -> our names)
        const TEAM_NAME_MAP = {
            'Arsenal': ['Arsenal', 'Arsenal FC'],
            'Aston Villa': ['Aston Villa', 'Aston Villa FC'],
            'Bournemouth': ['Bournemouth', 'AFC Bournemouth'],
            'Brentford': ['Brentford', 'Brentford FC'],
            'Brighton': ['Brighton', 'Brighton and Hove Albion', 'Brighton & Hove Albion'],
            'Chelsea': ['Chelsea', 'Chelsea FC'],
            'Crystal Palace': ['Crystal Palace', 'Crystal Palace FC'],
            'Everton': ['Everton', 'Everton FC'],
            'Fulham': ['Fulham', 'Fulham FC'],
            'Ipswich': ['Ipswich', 'Ipswich Town'],
            'Leicester': ['Leicester', 'Leicester City'],
            'Liverpool': ['Liverpool', 'Liverpool FC'],
            'Manchester City': ['Manchester City', 'Man City'],
            'Manchester United': ['Manchester United', 'Man United', 'Man Utd'],
            'Newcastle': ['Newcastle', 'Newcastle United'],
            'Nottingham Forest': ['Nottingham Forest', "Nott'm Forest"],
            'Southampton': ['Southampton', 'Southampton FC'],
            'Tottenham': ['Tottenham', 'Tottenham Hotspur', 'Spurs'],
            'West Ham': ['West Ham', 'West Ham United'],
            'Wolves': ['Wolves', 'Wolverhampton Wanderers', 'Wolverhampton']
        };

        // Fetch real odds from The Odds API
        async function fetchRealOdds() {
            // Check if cache is still valid
            if (oddsCache.lastFetched && (Date.now() - oddsCache.lastFetched) < oddsCache.expiresIn) {
                console.log('Using cached odds data');
                return oddsCache.data;
            }

            // Skip if no API key configured
            if (ODDS_API_KEY === 'YOUR_ODDS_API_KEY' || !ODDS_API_KEY) {
                console.log('No Odds API key configured, using calculated odds');
                return {};
            }

            try {
                console.log('Fetching real odds from The Odds API...');
                const response = await fetch(
                    `${ODDS_API_BASE}?apiKey=${ODDS_API_KEY}&regions=uk,eu&markets=h2h&oddsFormat=decimal`
                );

                if (!response.ok) {
                    const remaining = response.headers.get('x-requests-remaining');
                    console.log(`API requests remaining: ${remaining}`);
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('Fetched odds for', data.length, 'matches');

                // Process and cache the odds
                const processedOdds = {};
                data.forEach(match => {
                    // Find best odds from bookmakers
                    let bestHomeOdds = 1.01, bestDrawOdds = 1.01, bestAwayOdds = 1.01;

                    match.bookmakers.forEach(bookmaker => {
                        const h2hMarket = bookmaker.markets.find(m => m.key === 'h2h');
                        if (h2hMarket) {
                            h2hMarket.outcomes.forEach(outcome => {
                                if (outcome.name === match.home_team) {
                                    bestHomeOdds = Math.max(bestHomeOdds, outcome.price);
                                } else if (outcome.name === match.away_team) {
                                    bestAwayOdds = Math.max(bestAwayOdds, outcome.price);
                                } else if (outcome.name === 'Draw') {
                                    bestDrawOdds = Math.max(bestDrawOdds, outcome.price);
                                }
                            });
                        }
                    });

                    // Normalize team names and store
                    const homeKey = normalizeTeamName(match.home_team);
                    const awayKey = normalizeTeamName(match.away_team);
                    const matchKey = `${homeKey}_vs_${awayKey}`;

                    processedOdds[matchKey] = {
                        home: parseFloat(bestHomeOdds.toFixed(2)),
                        draw: parseFloat(bestDrawOdds.toFixed(2)),
                        away: parseFloat(bestAwayOdds.toFixed(2)),
                        homeTeam: match.home_team,
                        awayTeam: match.away_team,
                        commenceTime: match.commence_time,
                        bookmakerCount: match.bookmakers.length
                    };
                });

                // Update cache
                oddsCache.data = processedOdds;
                oddsCache.lastFetched = Date.now();

                // Show remaining API calls
                const remaining = data.headers?.get('x-requests-remaining') || 'unknown';
                console.log('Odds cached. API calls remaining:', remaining);

                return processedOdds;
            } catch (error) {
                console.error('Error fetching real odds:', error);
                return oddsCache.data || {}; // Return cached data or empty
            }
        }

        // Normalize team names for matching
        function normalizeTeamName(name) {
            for (const [normalized, variations] of Object.entries(TEAM_NAME_MAP)) {
                if (variations.some(v => name.toLowerCase().includes(v.toLowerCase()) ||
                    v.toLowerCase().includes(name.toLowerCase()))) {
                    return normalized;
                }
            }
            return name;
        }

        // Get real odds for a specific match
        function getRealOdds(homeTeam, awayTeam) {
            const homeKey = normalizeTeamName(homeTeam);
            const awayKey = normalizeTeamName(awayTeam);
            const matchKey = `${homeKey}_vs_${awayKey}`;
            return oddsCache.data[matchKey] || null;
        }

        // Fetch real match results from The Odds API
        async function fetchMatchResults() {
            // Check if cache is still valid
            if (resultsCache.lastFetched && (Date.now() - resultsCache.lastFetched) < resultsCache.expiresIn) {
                console.log('Using cached match results');
                return resultsCache.data;
            }

            // Skip if no API key configured
            if (ODDS_API_KEY === 'YOUR_ODDS_API_KEY' || !ODDS_API_KEY) {
                console.log('No Odds API key configured, cannot fetch results');
                return {};
            }

            try {
                console.log('Fetching real match results from The Odds API...');
                // daysFrom=3 gets completed games from the past 3 days (costs 2 credits)
                const response = await fetch(
                    `https://api.the-odds-api.com/v4/sports/soccer_epl/scores?apiKey=${ODDS_API_KEY}&daysFrom=3`
                );

                if (!response.ok) {
                    const remaining = response.headers.get('x-requests-remaining');
                    console.log(`API requests remaining: ${remaining}`);
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                console.log('Fetched scores for', data.length, 'matches');

                // Process and cache the results
                const processedResults = {};
                data.forEach(match => {
                    if (match.completed && match.scores && match.scores.length === 2) {
                        const homeKey = normalizeTeamName(match.home_team);
                        const awayKey = normalizeTeamName(match.away_team);
                        const matchKey = `${homeKey}_vs_${awayKey}`;

                        // Extract scores
                        const homeScore = match.scores.find(s => s.name === match.home_team);
                        const awayScore = match.scores.find(s => s.name === match.away_team);

                        if (homeScore && awayScore) {
                            const homeGoals = parseInt(homeScore.score);
                            const awayGoals = parseInt(awayScore.score);

                            // Determine result
                            let result;
                            if (homeGoals > awayGoals) {
                                result = 'home';
                            } else if (awayGoals > homeGoals) {
                                result = 'away';
                            } else {
                                result = 'draw';
                            }

                            processedResults[matchKey] = {
                                homeTeam: match.home_team,
                                awayTeam: match.away_team,
                                homeScore: homeGoals,
                                awayScore: awayGoals,
                                result: result,
                                completed: true,
                                commenceTime: match.commence_time,
                                lastUpdate: match.last_update
                            };

                            console.log(`Match result: ${homeKey} ${homeGoals} - ${awayGoals} ${awayKey} (${result})`);
                        }
                    }
                });

                // Update cache
                resultsCache.data = processedResults;
                resultsCache.lastFetched = Date.now();

                // Show remaining API calls
                const remaining = response.headers.get('x-requests-remaining');
                console.log('Results cached. API calls remaining:', remaining);

                return processedResults;
            } catch (error) {
                console.error('Error fetching match results:', error);
                return resultsCache.data || {}; // Return cached data or empty
            }
        }

        // Get match result for a specific game
        function getMatchResult(homeTeam, awayTeam) {
            const homeKey = normalizeTeamName(homeTeam);
            const awayKey = normalizeTeamName(awayTeam);
            const matchKey = `${homeKey}_vs_${awayKey}`;
            return resultsCache.data[matchKey] || null;
        }

        // Force refresh odds (can be called manually or on a timer)
        async function refreshOdds() {
            oddsCache.lastFetched = null; // Invalidate cache
            await fetchRealOdds();
            await loadMatches(); // Re-render matches with new odds
            updateOddsStatus();
            showToast('Odds updated!', 'info');
        }

        // Update the odds status indicator
        function updateOddsStatus() {
            const oddsUpdatedEl = document.getElementById('oddsUpdated');
            if (!oddsUpdatedEl) return;

            const hasRealOdds = oddsCache.lastFetched && Object.keys(oddsCache.data).length > 0;

            if (hasRealOdds) {
                const now = new Date();
                const lastUpdate = new Date(oddsCache.lastFetched);
                const diffMins = Math.round((now - lastUpdate) / 60000);

                let timeText;
                if (diffMins < 1) {
                    timeText = 'Just now';
                } else if (diffMins === 1) {
                    timeText = '1 min ago';
                } else if (diffMins < 60) {
                    timeText = diffMins + ' mins ago';
                } else {
                    timeText = Math.round(diffMins / 60) + ' hours ago';
                }

                oddsUpdatedEl.textContent = 'Live odds: ' + timeText;
                oddsUpdatedEl.classList.add('live');
            } else {
                oddsUpdatedEl.textContent = 'Using calculated odds';
                oddsUpdatedEl.classList.remove('live');
            }
        }

        // DOM Elements
        const coinBalanceEl = document.getElementById('coinBalance');
        const streakCountEl = document.getElementById('streakCount');
        const streakBadgeEl = document.getElementById('streakBadge');
        const matchesGridEl = document.getElementById('matchesGrid');
        const matchCountEl = document.getElementById('matchCount');
        const betSlipEmpty = document.getElementById('betSlipEmpty');
        const betSlipContent = document.getElementById('betSlipContent');
        const stakeInput = document.getElementById('stakeInput');
        const potentialReturnEl = document.getElementById('potentialReturn');
        const placeBetBtn = document.getElementById('placeBetBtn');
        const authBtn = document.getElementById('authBtn');
        const authRequired = document.getElementById('authRequired');
        const matchesSection = document.getElementById('matchesSection');
        const betSlipContainer = document.getElementById('betSlipContainer');
        const bonusModal = document.getElementById('bonusModal');
        const toastContainer = document.getElementById('toastContainer');

        // Initialize App
        async function init() {
            await checkAuth();
            setupEventListeners();

            // Fetch real odds, standings, and match results in parallel for faster loading
            await Promise.all([
                fetchRealOdds(),
                loadStandings(),
                fetchMatchResults()
            ]);

            await loadMatches();
            updateOddsStatus(); // Show initial odds status

            if (currentUser) {
                await loadUserBets();
                await checkOrCreateProfile();
                await checkDailyBonus();
                startSettlementPolling();
            }

            // Start automatic odds refresh (every 15 minutes)
            startOddsRefreshPolling();
        }

        // Automatically refresh odds periodically
        function startOddsRefreshPolling() {
            // Refresh odds every 15 minutes to keep them current
            setInterval(async () => {
                console.log('Auto-refreshing odds...');
                oddsCache.lastFetched = null; // Invalidate cache
                await fetchRealOdds();
                await loadMatches(); // Re-render with new odds
                updateOddsStatus();
            }, 15 * 60 * 1000);

            // Also update the status display every minute (to show "2 mins ago", "3 mins ago", etc.)
            setInterval(updateOddsStatus, 60 * 1000);
        }

        // Check or Create User Profile
        async function checkOrCreateProfile() {
            if (!currentUser) return;

            try {
                // Try to get existing profile
                const { data: profile, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code === 'PGRST116') {
                    // No profile exists, show username modal
                    showUsernameModal();
                } else if (profile) {
                    userProfile = profile;
                }
            } catch (e) {
                console.error('Error checking profile:', e);
            }
        }

        // Show Username Modal
        function showUsernameModal() {
            const modal = document.getElementById('usernameModal');
            const input = document.getElementById('usernameInput');
            const error = document.getElementById('usernameError');
            const saveBtn = document.getElementById('saveUsername');
            const skipBtn = document.getElementById('skipUsername');

            modal.classList.add('active');

            saveBtn.onclick = async () => {
                const username = input.value.trim();

                if (username.length < 3) {
                    error.textContent = 'Username must be at least 3 characters';
                    error.style.display = 'block';
                    return;
                }

                if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                    error.textContent = 'Only letters, numbers, and underscores allowed';
                    error.style.display = 'block';
                    return;
                }

                // Check if username is taken
                const { data: existing } = await supabaseClient
                    .from('user_profiles')
                    .select('id')
                    .eq('username', username)
                    .single();

                if (existing) {
                    error.textContent = 'Username is already taken';
                    error.style.display = 'block';
                    return;
                }

                // Create profile
                const { data: newProfile, error: createError } = await supabaseClient
                    .from('user_profiles')
                    .insert({
                        user_id: currentUser.id,
                        username: username
                    })
                    .select()
                    .single();

                if (createError) {
                    error.textContent = 'Error saving username. Try again.';
                    error.style.display = 'block';
                    return;
                }

                userProfile = newProfile;
                modal.classList.remove('active');
                showToast('Username set to ' + username + '!', 'success');
            };

            skipBtn.onclick = async () => {
                // Create profile with default username
                const defaultUsername = 'Player_' + currentUser.id.substring(0, 8);
                const { data: newProfile } = await supabaseClient
                    .from('user_profiles')
                    .insert({
                        user_id: currentUser.id,
                        username: defaultUsername
                    })
                    .select()
                    .single();

                if (newProfile) {
                    userProfile = newProfile;
                }
                modal.classList.remove('active');
            };

            // Enter key to save
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveBtn.click();
                }
            });
        }

        // Check Authentication
        async function checkAuth() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            currentUser = user;

            if (user) {
                authBtn.textContent = 'Account';
                authBtn.href = '/account.html';
                authRequired.classList.add('hidden');
                matchesSection.classList.remove('hidden');
                betSlipContainer.classList.remove('hidden');
                await loadOrCreateWallet();
            } else {
                authRequired.classList.remove('hidden');
                matchesSection.classList.add('hidden');
                betSlipContainer.classList.add('hidden');
            }
        }

        // Load or Create User Wallet (with localStorage fallback)
        async function loadOrCreateWallet() {
            try {
                const { data: wallet, error } = await supabaseClient
                    .from('user_wallets')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code === 'PGRST116') {
                    // Wallet doesn't exist, create one
                    const { data: newWallet, error: createError } = await supabaseClient
                        .from('user_wallets')
                        .insert({ user_id: currentUser.id, coins: 10000 })
                        .select()
                        .single();

                    if (createError) {
                        console.error('Error creating wallet:', createError);
                        // Fall back to localStorage
                        loadLocalWallet();
                        return;
                    }
                    userWallet = newWallet;
                    showToast('Welcome! You received 10,000 coins!', 'success');
                } else if (error) {
                    console.error('Error loading wallet:', error);
                    // Fall back to localStorage
                    loadLocalWallet();
                    return;
                } else {
                    userWallet = wallet;
                }
            } catch (e) {
                console.error('Supabase error, using localStorage:', e);
                loadLocalWallet();
            }

            updateWalletDisplay();
        }

        // LocalStorage fallback for wallet
        function loadLocalWallet() {
            const savedWallet = localStorage.getItem('epl_betting_wallet_' + currentUser.id);
            if (savedWallet) {
                userWallet = JSON.parse(savedWallet);
            } else {
                userWallet = {
                    user_id: currentUser.id,
                    coins: 10000,
                    lifetime_winnings: 0,
                    total_bets: 0,
                    won_bets: 0,
                    current_streak: 0,
                    best_streak: 0,
                    last_daily_bonus: null,
                    daily_bonus_day: 0
                };
                saveLocalWallet();
                showToast('Welcome! You received 10,000 coins!', 'success');
            }
        }

        function saveLocalWallet() {
            if (userWallet && currentUser) {
                localStorage.setItem('epl_betting_wallet_' + currentUser.id, JSON.stringify(userWallet));
            }
        }

        // Update Wallet Display
        function updateWalletDisplay() {
            if (userWallet) {
                coinBalanceEl.textContent = userWallet.coins.toLocaleString();
                streakCountEl.textContent = userWallet.current_streak;

                if (userWallet.current_streak >= 3) {
                    streakBadgeEl.classList.add('active');
                } else {
                    streakBadgeEl.classList.remove('active');
                }
            }
        }

        // Load League Standings for Odds Calculation (using free TheSportsDB)
        async function loadStandings() {
            try {
                const response = await fetch('https://www.thesportsdb.com/api/v1/json/3/lookuptable.php?l=4328&s=2024-2025');
                const data = await response.json();
                if (data.table && data.table.length > 0) {
                    standings = data.table;
                }
            } catch (error) {
                console.error('Error loading standings:', error);
                // Use default standings order
                standings = [];
            }
        }

        // Load Upcoming Matches (using real fixtures from The Odds API)
        async function loadMatches() {
            try {
                // Try to use real fixtures from The Odds API (already fetched in oddsCache)
                const realMatches = generateMatchesFromOddsAPI();

                if (realMatches.length > 0) {
                    console.log('Using real fixtures from The Odds API');
                    matches = realMatches;
                } else {
                    console.log('No real fixtures available, using sample matches');
                    matches = generateSampleMatches();
                }

                // Check for existing bets from Supabase
                if (currentUser) {
                    const { data: bets } = await supabaseClient
                        .from('user_bets')
                        .select('match_id, home_team, away_team')
                        .eq('user_id', currentUser.id)
                        .eq('status', 'pending');

                    if (bets && bets.length > 0) {
                        // Match by team names since IDs can vary
                        const betKeys = new Set(bets.map(b =>
                            `${normalizeTeamName(b.home_team)}_vs_${normalizeTeamName(b.away_team)}`
                        ));
                        matches = matches.map(m => ({
                            ...m,
                            hasBet: betKeys.has(`${normalizeTeamName(m.strHomeTeam)}_vs_${normalizeTeamName(m.strAwayTeam)}`)
                        }));
                    }
                }

                renderMatches();
            } catch (error) {
                console.error('Error loading matches:', error);
                matches = generateSampleMatches();
                renderMatches();
            }
        }

        // Generate matches from The Odds API data (uses cached odds data)
        function generateMatchesFromOddsAPI() {
            const oddsData = oddsCache.data;
            if (!oddsData || Object.keys(oddsData).length === 0) {
                return [];
            }

            // Team badge URLs
            const teamBadges = {
                'Arsenal': 'https://r2.thesportsdb.com/images/media/team/badge/uyhbfe1612467038.png',
                'Liverpool': 'https://r2.thesportsdb.com/images/media/team/badge/kfaher1737969724.png',
                'Manchester City': 'https://r2.thesportsdb.com/images/media/team/badge/vwpvry1467462651.png',
                'Chelsea': 'https://r2.thesportsdb.com/images/media/team/badge/yvwvtu1448813215.png',
                'Manchester United': 'https://r2.thesportsdb.com/images/media/team/badge/xzqdr11517660252.png',
                'Tottenham': 'https://r2.thesportsdb.com/images/media/team/badge/dfyfhl1604094109.png',
                'Newcastle': 'https://r2.thesportsdb.com/images/media/team/badge/lhwuiz1621593302.png',
                'Aston Villa': 'https://r2.thesportsdb.com/images/media/team/badge/jykrpv1717309891.png',
                'Brighton': 'https://r2.thesportsdb.com/images/media/team/badge/ywypts1448810904.png',
                'West Ham': 'https://r2.thesportsdb.com/images/media/team/badge/yutyxs1467459956.png',
                'Nottingham Forest': 'https://r2.thesportsdb.com/images/media/team/badge/bk4qjs1546440351.png',
                'Bournemouth': 'https://r2.thesportsdb.com/images/media/team/badge/y08nak1534071116.png',
                'Fulham': 'https://r2.thesportsdb.com/images/media/team/badge/xwwvyt1448811086.png',
                'Crystal Palace': 'https://r2.thesportsdb.com/images/media/team/badge/ia6i3m1656014992.png',
                'Brentford': 'https://r2.thesportsdb.com/images/media/team/badge/grv1aw1546453779.png',
                'Wolves': 'https://r2.thesportsdb.com/images/media/team/badge/u9qr031621593327.png',
                'Everton': 'https://r2.thesportsdb.com/images/media/team/badge/eqayrf1523184794.png',
                'Leicester': 'https://r2.thesportsdb.com/images/media/team/badge/xtxwtu1448813356.png',
                'Ipswich': 'https://r2.thesportsdb.com/images/media/team/badge/mdj1ey1634670785.png',
                'Southampton': 'https://r2.thesportsdb.com/images/media/team/badge/ggqtd01621593274.png'
            };

            const defaultBadge = 'https://r2.thesportsdb.com/images/media/team/badge/placeholder.png';

            const realMatches = [];
            for (const [matchKey, odds] of Object.entries(oddsData)) {
                const [homeNorm, , awayNorm] = matchKey.split('_');
                const commenceTime = new Date(odds.commenceTime);

                // Only include future matches (not already started)
                if (commenceTime > new Date()) {
                    realMatches.push({
                        idEvent: matchKey, // Use matchKey as unique ID
                        strHomeTeam: homeNorm,
                        strAwayTeam: awayNorm,
                        strHomeTeamBadge: teamBadges[homeNorm] || defaultBadge,
                        strAwayTeamBadge: teamBadges[awayNorm] || defaultBadge,
                        strTimestamp: odds.commenceTime,
                        dateEvent: commenceTime.toISOString().split('T')[0],
                        intHomeScore: null,
                        intAwayScore: null,
                        isRealFixture: true
                    });
                }
            }

            // Sort by kick-off time
            realMatches.sort((a, b) => new Date(a.strTimestamp) - new Date(b.strTimestamp));

            return realMatches;
        }

        // Generate sample EPL matches for demo/fallback
        function generateSampleMatches() {
            const teams = [
                { name: 'Arsenal', badge: 'https://r2.thesportsdb.com/images/media/team/badge/uyhbfe1612467038.png' },
                { name: 'Liverpool', badge: 'https://r2.thesportsdb.com/images/media/team/badge/kfaher1737969724.png' },
                { name: 'Manchester City', badge: 'https://r2.thesportsdb.com/images/media/team/badge/vwpvry1467462651.png' },
                { name: 'Chelsea', badge: 'https://r2.thesportsdb.com/images/media/team/badge/yvwvtu1448813215.png' },
                { name: 'Manchester United', badge: 'https://r2.thesportsdb.com/images/media/team/badge/xzqdr11517660252.png' },
                { name: 'Tottenham', badge: 'https://r2.thesportsdb.com/images/media/team/badge/dfyfhl1604094109.png' },
                { name: 'Newcastle', badge: 'https://r2.thesportsdb.com/images/media/team/badge/lhwuiz1621593302.png' },
                { name: 'Aston Villa', badge: 'https://r2.thesportsdb.com/images/media/team/badge/jykrpv1717309891.png' },
                { name: 'Brighton', badge: 'https://r2.thesportsdb.com/images/media/team/badge/ywypts1448810904.png' },
                { name: 'West Ham', badge: 'https://r2.thesportsdb.com/images/media/team/badge/yutyxs1467459956.png' },
                { name: 'Nottingham Forest', badge: 'https://r2.thesportsdb.com/images/media/team/badge/bk4qjs1546440351.png' },
                { name: 'Bournemouth', badge: 'https://r2.thesportsdb.com/images/media/team/badge/y08nak1534071116.png' },
                { name: 'Fulham', badge: 'https://r2.thesportsdb.com/images/media/team/badge/xwwvyt1448811086.png' },
                { name: 'Crystal Palace', badge: 'https://r2.thesportsdb.com/images/media/team/badge/ia6i3m1656014992.png' },
                { name: 'Brentford', badge: 'https://r2.thesportsdb.com/images/media/team/badge/grv1aw1546453779.png' },
                { name: 'Wolves', badge: 'https://r2.thesportsdb.com/images/media/team/badge/u9qr031621593327.png' },
                { name: 'Everton', badge: 'https://r2.thesportsdb.com/images/media/team/badge/eqayrf1523184794.png' },
                { name: 'Leicester', badge: 'https://r2.thesportsdb.com/images/media/team/badge/xtxwtu1448813356.png' },
                { name: 'Ipswich', badge: 'https://r2.thesportsdb.com/images/media/team/badge/mdj1ey1634670785.png' },
                { name: 'Southampton', badge: 'https://r2.thesportsdb.com/images/media/team/badge/ggqtd01621593274.png' }
            ];

            const sampleMatches = [];
            const baseDate = new Date();
            baseDate.setHours(15, 0, 0, 0);

            // Generate 10 sample matches over the next few days
            const matchups = [
                [0, 5],   // Arsenal vs Tottenham
                [1, 2],   // Liverpool vs Man City
                [3, 4],   // Chelsea vs Man United
                [6, 7],   // Newcastle vs Aston Villa
                [8, 9],   // Brighton vs West Ham
                [10, 11], // Forest vs Bournemouth
                [12, 13], // Fulham vs Crystal Palace
                [14, 15], // Brentford vs Wolves
                [16, 17], // Everton vs Leicester
                [18, 19]  // Ipswich vs Southampton
            ];

            matchups.forEach((pair, index) => {
                const matchDate = new Date(baseDate);
                matchDate.setDate(matchDate.getDate() + Math.floor(index / 3) + 1);
                matchDate.setHours(15 + (index % 3) * 2, 0, 0, 0);

                sampleMatches.push({
                    idEvent: 'sample_' + (index + 1),
                    strHomeTeam: teams[pair[0]].name,
                    strAwayTeam: teams[pair[1]].name,
                    strHomeTeamBadge: teams[pair[0]].badge,
                    strAwayTeamBadge: teams[pair[1]].badge,
                    strTimestamp: matchDate.toISOString(),
                    dateEvent: matchDate.toISOString().split('T')[0],
                    intHomeScore: null,
                    intAwayScore: null
                });
            });

            return sampleMatches;
        }

        // Calculate Odds Based on Standings
        function calculateOdds(homeTeam, awayTeam) {
            // First, check for real odds from The Odds API
            const realOdds = getRealOdds(homeTeam, awayTeam);
            if (realOdds) {
                console.log(`Using real bookmaker odds for ${homeTeam} vs ${awayTeam}`);
                return {
                    home: realOdds.home,
                    draw: realOdds.draw,
                    away: realOdds.away,
                    isRealOdds: true,
                    bookmakerCount: realOdds.bookmakerCount
                };
            }

            // Fallback: Calculate odds based on league standings
            console.log(`Calculating odds for ${homeTeam} vs ${awayTeam} (no API odds available)`);
            let homePos = 10, awayPos = 10;

            if (standings.length > 0) {
                // Check TheSportsDB format
                const homeTeamData = standings.find(t => {
                    const teamName = t.strTeam || (t.team && t.team.name);
                    return normalizeTeamName(teamName) === normalizeTeamName(homeTeam);
                });
                const awayTeamData = standings.find(t => {
                    const teamName = t.strTeam || (t.team && t.team.name);
                    return normalizeTeamName(teamName) === normalizeTeamName(awayTeam);
                });

                if (homeTeamData) {
                    homePos = homeTeamData.intRank || homeTeamData.rank || standings.indexOf(homeTeamData) + 1;
                }
                if (awayTeamData) {
                    awayPos = awayTeamData.intRank || awayTeamData.rank || standings.indexOf(awayTeamData) + 1;
                }
            }

            // Base odds calculation with home advantage
            const homeStrength = (21 - homePos) / 20;
            const awayStrength = (21 - awayPos) / 20;
            const homeAdvantage = 0.12;

            const totalStrength = homeStrength + homeAdvantage + awayStrength;
            const homeWinProb = (homeStrength + homeAdvantage) / totalStrength;
            const awayWinProb = awayStrength / totalStrength;
            const drawProb = 1 - homeWinProb - awayWinProb + 0.25;

            // Convert to decimal odds (with bookmaker margin)
            const margin = 1.08;
            let homeOdds = (1 / homeWinProb) * margin;
            let drawOdds = (1 / drawProb) * margin;
            let awayOdds = (1 / awayWinProb) * margin;

            // Clamp odds to reasonable ranges
            homeOdds = Math.max(1.10, Math.min(15, homeOdds));
            drawOdds = Math.max(2.50, Math.min(8, drawOdds));
            awayOdds = Math.max(1.10, Math.min(15, awayOdds));

            return {
                home: parseFloat(homeOdds.toFixed(2)),
                draw: parseFloat(drawOdds.toFixed(2)),
                away: parseFloat(awayOdds.toFixed(2)),
                isRealOdds: false
            };
        }

        // Render Matches
        function renderMatches() {
            if (matches.length === 0) {
                matchesGridEl.innerHTML = '<div class="no-matches"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><h3>No Upcoming Matches</h3><p>Check back soon for new fixtures</p></div>';
                matchCountEl.textContent = '0 matches';
                return;
            }

            // Count how many matches have real odds
            const realOddsCount = matches.filter(m => getRealOdds(m.strHomeTeam, m.strAwayTeam)).length;
            matchCountEl.textContent = matches.length + ' matches' + (realOddsCount > 0 ? ' (' + realOddsCount + ' with live odds)' : '');

            matchesGridEl.innerHTML = matches.map(match => {
                const matchDate = new Date(match.strTimestamp || match.dateEvent);
                const odds = calculateOdds(match.strHomeTeam, match.strAwayTeam);
                const isLocked = matchDate < new Date(Date.now() + 5 * 60 * 1000);
                const matchData = JSON.stringify({id: match.idEvent, home: match.strHomeTeam, away: match.strAwayTeam, date: match.strTimestamp || match.dateEvent}).replace(/"/g, '&quot;');
                const hasRealOdds = odds.isRealOdds === true;

                return '<div class="match-card ' + (match.hasBet ? 'has-bet' : '') + '" data-match-id="' + match.idEvent + '">' +
                    '<div class="match-header">' +
                        '<div class="match-date">' +
                            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' +
                            matchDate.toLocaleDateString('en-GB', { weekday: 'short', month: 'short', day: 'numeric' }) + ' at ' + matchDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) +
                        '</div>' +
                        (hasRealOdds ? '<div class="live-odds-badge" title="Real-time odds from ' + odds.bookmakerCount + ' bookmakers"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="3" fill="currentColor"/><circle cx="12" cy="12" r="8"/></svg> LIVE ODDS</div>' : '') +
                    '</div>' +
                    '<div class="match-teams">' +
                        '<div class="team">' +
                            '<div class="team-badge"><img src="' + (match.strHomeTeamBadge || '/placeholder.png') + '" alt="' + match.strHomeTeam + '" onerror="this.style.display=\'none\'"></div>' +
                            '<span class="team-name">' + match.strHomeTeam + '</span>' +
                        '</div>' +
                        '<div class="vs-badge">VS</div>' +
                        '<div class="team">' +
                            '<div class="team-badge"><img src="' + (match.strAwayTeamBadge || '/placeholder.png') + '" alt="' + match.strAwayTeam + '" onerror="this.style.display=\'none\'"></div>' +
                            '<span class="team-name">' + match.strAwayTeam + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="betting-options">' +
                        '<div class="bet-option home ' + (isLocked || match.hasBet ? 'disabled' : '') + '" data-match="' + matchData + '" data-bet-type="home" data-odds="' + odds.home + '">' +
                            '<div class="bet-label">' + match.strHomeTeam.split(' ')[0] + '</div>' +
                            '<div class="bet-odds">' + odds.home + '</div>' +
                        '</div>' +
                        '<div class="bet-option draw ' + (isLocked || match.hasBet ? 'disabled' : '') + '" data-match="' + matchData + '" data-bet-type="draw" data-odds="' + odds.draw + '">' +
                            '<div class="bet-label">Draw</div>' +
                            '<div class="bet-odds">' + odds.draw + '</div>' +
                        '</div>' +
                        '<div class="bet-option away ' + (isLocked || match.hasBet ? 'disabled' : '') + '" data-match="' + matchData + '" data-bet-type="away" data-odds="' + odds.away + '">' +
                            '<div class="bet-label">' + match.strAwayTeam.split(' ')[0] + '</div>' +
                            '<div class="bet-odds">' + odds.away + '</div>' +
                        '</div>' +
                    '</div>' +
                    (match.hasBet ? '<div class="bet-placed-badge">&#10003; Bet Placed</div>' : '') +
                '</div>';
            }).join('');

            // Add click handlers for betting options
            document.querySelectorAll('.bet-option:not(.disabled)').forEach(option => {
                option.addEventListener('click', handleBetSelection);
            });
        }

        // Handle Bet Selection
        function handleBetSelection(e) {
            if (!currentUser) {
                showToast('Please sign in to place bets', 'error');
                return;
            }

            const option = e.currentTarget;
            const matchDataStr = option.getAttribute('data-match').replace(/&quot;/g, '"');
            const match = JSON.parse(matchDataStr);
            const betType = option.dataset.betType;
            const odds = parseFloat(option.dataset.odds);

            // Remove previous selection
            document.querySelectorAll('.bet-option.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Add selection to clicked option
            option.classList.add('selected');

            // Update bet slip
            selectedBet = {
                matchId: match.id,
                homeTeam: match.home,
                awayTeam: match.away,
                matchDate: match.date,
                betType,
                odds
            };

            updateBetSlip();
        }

        // Update Bet Slip
        function updateBetSlip() {
            if (!selectedBet) {
                betSlipEmpty.classList.remove('hidden');
                betSlipContent.classList.add('hidden');
                return;
            }

            betSlipEmpty.classList.add('hidden');
            betSlipContent.classList.remove('hidden');

            document.getElementById('slipTeams').textContent = selectedBet.homeTeam + ' vs ' + selectedBet.awayTeam;

            const betTypeLabels = { home: 'Home Win', draw: 'Draw', away: 'Away Win' };
            document.getElementById('slipBetType').textContent = betTypeLabels[selectedBet.betType];
            document.getElementById('slipOdds').textContent = selectedBet.odds.toFixed(2);

            updatePotentialReturn();
        }

        // Update Potential Return
        function updatePotentialReturn() {
            const stake = parseInt(stakeInput.value) || 0;

            if (stake > 0 && selectedBet) {
                const potentialReturn = Math.floor(stake * selectedBet.odds);
                potentialReturnEl.textContent = potentialReturn.toLocaleString();
                placeBetBtn.disabled = stake > userWallet.coins;

                if (stake > userWallet.coins) {
                    placeBetBtn.textContent = 'Insufficient Coins';
                } else {
                    placeBetBtn.textContent = 'Place Bet';
                }
            } else {
                potentialReturnEl.textContent = '0';
                placeBetBtn.disabled = true;
            }
        }

        // Place Bet (saves to Supabase)
        async function placeBet() {
            if (!selectedBet || !currentUser || !userWallet) return;

            const stake = parseInt(stakeInput.value);

            if (stake <= 0) {
                showToast('Please enter a valid stake amount', 'error');
                return;
            }

            if (stake > userWallet.coins) {
                showToast('Insufficient coins', 'error');
                return;
            }

            const potentialWin = Math.floor(stake * selectedBet.odds);
            const betHomeTeam = selectedBet.homeTeam;
            const betAwayTeam = selectedBet.awayTeam;

            // Check if already bet on this match (from Supabase)
            const { data: existingBet } = await supabaseClient
                .from('user_bets')
                .select('id')
                .eq('user_id', currentUser.id)
                .eq('match_id', selectedBet.matchId)
                .eq('status', 'pending')
                .single();

            if (existingBet) {
                showToast('You already have a bet on this match', 'error');
                return;
            }

            // Create bet record in Supabase
            const { data: newBet, error: betError } = await supabaseClient
                .from('user_bets')
                .insert({
                    user_id: currentUser.id,
                    match_id: selectedBet.matchId,
                    match_date: selectedBet.matchDate,
                    home_team: selectedBet.homeTeam,
                    away_team: selectedBet.awayTeam,
                    bet_type: selectedBet.betType,
                    stake: stake,
                    odds: selectedBet.odds,
                    potential_win: potentialWin,
                    status: 'pending'
                })
                .select()
                .single();

            if (betError) {
                console.error('Error saving bet:', betError);
                showToast('Error placing bet. Please try again.', 'error');
                return;
            }

            // Update wallet in Supabase
            const { error: walletError } = await supabaseClient
                .from('user_wallets')
                .update({
                    coins: userWallet.coins - stake,
                    total_bets: (userWallet.total_bets || 0) + 1
                })
                .eq('user_id', currentUser.id);

            if (walletError) {
                console.error('Error updating wallet:', walletError);
            }

            // Update local wallet state
            userWallet.coins -= stake;
            userWallet.total_bets = (userWallet.total_bets || 0) + 1;
            updateWalletDisplay();

            // Update leaderboard entry
            await updateLeaderboardEntry();

            showToast('Bet placed! ' + stake + ' coins on ' + betHomeTeam + ' vs ' + betAwayTeam, 'success');

            // Clear bet slip
            selectedBet = null;
            stakeInput.value = '';
            updateBetSlip();
            document.querySelectorAll('.bet-option.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // Reload matches to show bet placed
            await loadMatches();
        }

        // Load User Bets (from Supabase)
        async function loadUserBets() {
            if (!currentUser) return;

            const { data: bets, error } = await supabaseClient
                .from('user_bets')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading bets:', error);
                userBets = [];
            } else {
                userBets = bets || [];
            }

            renderUserBets('pending');
        }

        // Render User Bets
        function renderUserBets(filter) {
            const container = document.getElementById('betsContainer');

            let filteredBets = userBets;
            if (filter === 'pending') {
                filteredBets = userBets.filter(b => b.status === 'pending');
            } else if (filter === 'settled') {
                filteredBets = userBets.filter(b => b.status !== 'pending');
            }

            if (filteredBets.length === 0) {
                container.innerHTML = '<div class="no-matches"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><h3>No Bets Yet</h3><p>' + (filter === 'pending' ? 'Place your first bet on an upcoming match!' : 'Your settled bets will appear here') + '</p></div>';
                return;
            }

            const betTypeLabels = { home: 'Home Win', draw: 'Draw', away: 'Away Win' };

            container.innerHTML = filteredBets.map(bet => {
                return '<div class="bet-history-card">' +
                    '<div class="bet-history-header">' +
                        '<span class="bet-history-match">' + bet.home_team + ' vs ' + bet.away_team + '</span>' +
                        '<span class="bet-status ' + bet.status + '">' + bet.status + '</span>' +
                    '</div>' +
                    '<div class="bet-history-details">' +
                        '<span class="bet-history-selection">' + betTypeLabels[bet.bet_type] + ' @ ' + bet.odds + '</span>' +
                        '<div class="bet-history-stake">' +
                            '<span>Stake: ' + bet.stake + '</span>' +
                            '<span class="bet-history-return ' + (bet.status === 'lost' ? 'lost' : '') + '">' + (bet.status === 'won' ? '+' + bet.payout : bet.potential_win) + '</span>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // Update leaderboard entry for current user
        async function updateLeaderboardEntry() {
            if (!currentUser || !userWallet) return;

            try {
                // Get user's display name from profiles
                const { data: profile } = await supabaseClient
                    .from('profiles')
                    .select('full_name')
                    .eq('id', currentUser.id)
                    .single();

                const username = profile?.full_name || 'Player_' + currentUser.id.substring(0, 8);

                // Upsert leaderboard entry
                await supabaseClient
                    .from('betting_leaderboard')
                    .upsert({
                        user_id: currentUser.id,
                        username: username,
                        profit: userWallet.lifetime_winnings || 0,
                        total_bets: userWallet.total_bets || 0,
                        won_bets: userWallet.won_bets || 0,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });
            } catch (e) {
                console.error('Error updating leaderboard:', e);
            }
        }

        // Load Leaderboard
        async function loadLeaderboard() {
            const container = document.getElementById('leaderboardRows');
            container.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

            try {
                const { data: leaders, error } = await supabaseClient
                    .from('betting_leaderboard')
                    .select('*')
                    .order('profit', { ascending: false })
                    .limit(50);

                if (error) {
                    console.error('Error loading leaderboard:', error);
                    // Try fallback to direct wallet query
                    await loadLeaderboardFallback();
                    return;
                }

                leaderboardData = leaders || [];
                renderLeaderboard();
            } catch (e) {
                console.error('Leaderboard error:', e);
                await loadLeaderboardFallback();
            }
        }

        // Fallback leaderboard loading (if view doesn't exist yet)
        async function loadLeaderboardFallback() {
            try {
                const { data: wallets, error } = await supabaseClient
                    .from('user_wallets')
                    .select('user_id, coins, lifetime_winnings, total_bets, won_bets, current_streak, best_streak')
                    .gt('total_bets', 0)
                    .order('lifetime_winnings', { ascending: false })
                    .limit(50);

                if (error || !wallets) {
                    renderLeaderboard();
                    return;
                }

                // Get profiles for these users
                const userIds = wallets.map(w => w.user_id);
                const { data: profiles } = await supabaseClient
                    .from('profiles')
                    .select('id, full_name')
                    .in('id', userIds);

                const profileMap = {};
                if (profiles) {
                    profiles.forEach(p => { profileMap[p.id] = p.full_name; });
                }

                leaderboardData = wallets.map(w => ({
                    user_id: w.user_id,
                    username: profileMap[w.user_id] || 'Player_' + w.user_id.substring(0, 8),
                    coins: w.coins,
                    profit: w.lifetime_winnings || 0,
                    total_bets: w.total_bets || 0,
                    won_bets: w.won_bets || 0,
                    current_streak: w.current_streak || 0,
                    best_streak: w.best_streak || 0,
                    win_rate: w.total_bets > 0 ? Math.round((w.won_bets / w.total_bets) * 100) : 0
                }));

                renderLeaderboard();
            } catch (e) {
                console.error('Fallback leaderboard error:', e);
                renderLeaderboard();
            }
        }

        // Render Leaderboard
        function renderLeaderboard() {
            const container = document.getElementById('leaderboardRows');

            // Update stats
            const totalPlayers = leaderboardData.length;
            const totalBets = leaderboardData.reduce((sum, l) => sum + (l.total_bets || 0), 0);
            const topStreak = Math.max(...leaderboardData.map(l => l.best_streak || l.current_streak || 0), 0);

            document.getElementById('statTotalPlayers').textContent = totalPlayers.toLocaleString();
            document.getElementById('statTotalBets').textContent = totalBets.toLocaleString();
            document.getElementById('statTopStreak').textContent = topStreak;

            if (!leaderboardData || leaderboardData.length === 0) {
                container.innerHTML = '<div class="no-matches" style="border-radius: 0;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 21h8m-4-4v4M3 11h18M5 11V7a2 2 0 012-2h10a2 2 0 012 2v4M7 21a2 2 0 01-2-2v-4h14v4a2 2 0 01-2 2H7z"/></svg><h3>No Rankings Yet</h3><p>Place bets to appear on the leaderboard!</p></div>';
                return;
            }

            // Find current user's rank
            let userRank = -1;
            if (currentUser) {
                userRank = leaderboardData.findIndex(l => l.user_id === currentUser.id);
            }

            let html = '';

            // Show user's rank banner if they're on the leaderboard
            if (userRank >= 0) {
                const userData = leaderboardData[userRank];
                html += '<div class="user-rank-banner" style="background: linear-gradient(135deg, rgba(0,255,135,0.15), rgba(0,255,135,0.05)); padding: 16px 20px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,255,135,0.2);">' +
                    '<div style="display: flex; align-items: center; gap: 12px;">' +
                        '<span style="font-size: 24px; font-weight: 700; color: #00ff87;">#' + (userRank + 1) + '</span>' +
                        '<div>' +
                            '<div style="font-size: 14px; color: #888;">Your Rank</div>' +
                            '<div style="font-size: 16px; font-weight: 600; color: #fff;">' + userData.username + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div style="text-align: right;">' +
                        '<div style="font-size: 20px; font-weight: 700; color: ' + (userData.profit >= 0 ? '#00ff87' : '#ef4444') + ';">' + (userData.profit >= 0 ? '+' : '') + (userData.profit || 0).toLocaleString() + '</div>' +
                        '<div style="font-size: 12px; color: #888;">' + userData.won_bets + ' wins / ' + userData.total_bets + ' bets</div>' +
                    '</div>' +
                '</div>';
            }

            // Render all leaderboard rows
            html += leaderboardData.map((leader, index) => {
                const winRate = leader.win_rate || (leader.total_bets > 0 ? Math.round((leader.won_bets / leader.total_bets) * 100) : 0);
                const isCurrentUser = currentUser && leader.user_id === currentUser.id;
                const rankEmoji = index === 0 ? '&#129351;' : index === 1 ? '&#129352;' : index === 2 ? '&#129353;' : '';

                return '<div class="leaderboard-row' + (isCurrentUser ? ' current-user' : '') + '" style="' + (isCurrentUser ? 'background: rgba(0,255,135,0.08);' : '') + '">' +
                    '<span class="leaderboard-rank">' + (rankEmoji || '#' + (index + 1)) + '</span>' +
                    '<span class="leaderboard-user">' +
                        '<span style="' + (isCurrentUser ? 'color: #00ff87;' : '') + '">' + leader.username + '</span>' +
                        (leader.current_streak >= 3 ? ' <span style="font-size: 12px;" title="Win streak: ' + leader.current_streak + '">&#128293;' + leader.current_streak + '</span>' : '') +
                    '</span>' +
                    '<span class="leaderboard-profit ' + ((leader.profit || 0) < 0 ? 'negative' : '') + '">' + ((leader.profit || 0) >= 0 ? '+' : '') + (leader.profit || 0).toLocaleString() + '</span>' +
                    '<span class="leaderboard-bets">' + (leader.won_bets || 0) + '/' + (leader.total_bets || 0) + '</span>' +
                    '<span class="leaderboard-winrate">' + winRate + '%</span>' +
                '</div>';
            }).join('');

            container.innerHTML = html;
        }

        // Check Daily Bonus (using Supabase)
        async function checkDailyBonus() {
            if (!userWallet) return;

            const today = new Date().toISOString().split('T')[0];
            const lastBonus = userWallet.last_daily_bonus;

            if (lastBonus === today) return;

            // Calculate bonus day (reset after 7 days or if missed a day)
            let bonusDay = userWallet.daily_bonus_day || 0;
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

            if (lastBonus !== yesterday) {
                bonusDay = 0; // Reset if missed a day
            }

            bonusDay = (bonusDay % 7) + 1;
            const bonusAmount = DAILY_BONUSES[bonusDay - 1];

            document.getElementById('bonusAmount').textContent = '+' + bonusAmount;
            document.getElementById('bonusDay').textContent = 'Day ' + bonusDay + ' of 7';

            bonusModal.classList.add('active');

            document.getElementById('claimBonus').onclick = async () => {
                userWallet.coins += bonusAmount;
                userWallet.last_daily_bonus = today;
                userWallet.daily_bonus_day = bonusDay;

                // Save to Supabase
                await supabaseClient
                    .from('user_wallets')
                    .update({
                        coins: userWallet.coins,
                        last_daily_bonus: today,
                        daily_bonus_day: bonusDay
                    })
                    .eq('user_id', currentUser.id);

                updateWalletDisplay();
                showToast('Claimed ' + bonusAmount + ' coins!', 'success');
                bonusModal.classList.remove('active');
            };
        }

        // Settlement Polling (using real match results from The Odds API)
        async function settleBets() {
            if (!currentUser || !userWallet) return;

            // Fetch latest match results
            await fetchMatchResults();

            // Get pending bets from Supabase
            const { data: pendingBets, error } = await supabaseClient
                .from('user_bets')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('status', 'pending');

            if (error || !pendingBets || pendingBets.length === 0) return;

            let updated = false;
            for (const bet of pendingBets) {
                const matchDate = new Date(bet.match_date);
                // Only try to settle bets that are at least 2 hours past match time
                if (matchDate < new Date(Date.now() - 2 * 60 * 60 * 1000)) {
                    // Try to get real match result
                    const matchResult = getMatchResult(bet.home_team, bet.away_team);

                    if (matchResult && matchResult.completed) {
                        // We have a real result! Compare with bet
                        const won = bet.bet_type === matchResult.result;
                        const scoreDisplay = `${matchResult.homeScore}-${matchResult.awayScore}`;

                        console.log(`Settling bet: ${bet.home_team} vs ${bet.away_team}`);
                        console.log(`  Result: ${scoreDisplay} (${matchResult.result})`);
                        console.log(`  Bet on: ${bet.bet_type}, Won: ${won}`);

                        // Calculate payout
                        const payout = won ? bet.potential_win : 0;

                        // Update bet status in Supabase with the actual score
                        await supabaseClient
                            .from('user_bets')
                            .update({
                                status: won ? 'won' : 'lost',
                                settled_at: new Date().toISOString(),
                                payout: payout
                            })
                            .eq('id', bet.id);

                        if (won) {
                            const streakBonus = userWallet.current_streak >= 5 ? 0.25 :
                                               userWallet.current_streak >= 3 ? 0.10 : 0;
                            const totalPayout = Math.floor(bet.potential_win * (1 + streakBonus));

                            userWallet.coins += totalPayout;
                            userWallet.lifetime_winnings = (userWallet.lifetime_winnings || 0) + totalPayout - bet.stake;
                            userWallet.won_bets = (userWallet.won_bets || 0) + 1;
                            userWallet.current_streak = (userWallet.current_streak || 0) + 1;
                            userWallet.best_streak = Math.max(userWallet.best_streak || 0, userWallet.current_streak);

                            showToast(`Won ${totalPayout} coins! ${bet.home_team} ${scoreDisplay} ${bet.away_team}` + (streakBonus > 0 ? ' (Streak bonus!)' : ''), 'success');
                        } else {
                            userWallet.current_streak = 0;
                            userWallet.lost_bets = (userWallet.lost_bets || 0) + 1;
                            userWallet.lifetime_winnings = (userWallet.lifetime_winnings || 0) - bet.stake;
                            showToast(`Bet lost: ${bet.home_team} ${scoreDisplay} ${bet.away_team}`, 'error');
                        }

                        updated = true;
                    } else {
                        // No real result available yet - match might not be finished
                        // or not in the API's 3-day window
                        console.log(`Waiting for result: ${bet.home_team} vs ${bet.away_team}`);
                    }
                }
            }

            if (updated) {
                // Update wallet in Supabase
                await supabaseClient
                    .from('user_wallets')
                    .update({
                        coins: userWallet.coins,
                        lifetime_winnings: userWallet.lifetime_winnings,
                        won_bets: userWallet.won_bets,
                        lost_bets: userWallet.lost_bets,
                        current_streak: userWallet.current_streak,
                        best_streak: userWallet.best_streak
                    })
                    .eq('user_id', currentUser.id);

                // Update leaderboard table
                await updateLeaderboardEntry();

                updateWalletDisplay();
                loadUserBets();
            }
        }

        function startSettlementPolling() {
            settleBets();
            // Check every 2 minutes for new results (reduced frequency to save API calls)
            setInterval(settleBets, 2 * 60 * 1000);
        }

        // Show Toast Notification
        function showToast(message, type) {
            type = type || 'info';
            const icons = {
                success: '&#10003;',
                error: '&#10005;',
                info: 'i'
            };

            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = '<span class="toast-icon">' + icons[type] + '</span><span class="toast-message">' + message + '</span>';

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Event Listeners
        function setupEventListeners() {
            // Tab Navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const tab = btn.dataset.tab;
                    matchesSection.classList.toggle('hidden', tab !== 'matches');
                    document.getElementById('myBetsSection').classList.toggle('active', tab === 'mybets');
                    document.getElementById('leaderboardSection').classList.toggle('active', tab === 'leaderboard');
                    betSlipContainer.classList.toggle('hidden', tab !== 'matches');

                    if (tab === 'mybets') loadUserBets();
                    if (tab === 'leaderboard') loadLeaderboard();
                });
            });

            // Refresh Odds Button
            const refreshOddsBtn = document.getElementById('refreshOddsBtn');
            if (refreshOddsBtn) {
                refreshOddsBtn.addEventListener('click', async () => {
                    refreshOddsBtn.disabled = true;
                    refreshOddsBtn.classList.add('loading');
                    try {
                        await refreshOdds();
                    } finally {
                        refreshOddsBtn.disabled = false;
                        refreshOddsBtn.classList.remove('loading');
                    }
                });
            }

            // Bets Filter Tabs
            document.querySelectorAll('.bets-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.bets-tab').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderUserBets(btn.dataset.filter);
                });
            });

            // Stake Input
            stakeInput.addEventListener('input', updatePotentialReturn);

            // Quick Stake Buttons
            document.querySelectorAll('.quick-stake-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const amount = btn.dataset.amount;
                    if (amount === 'all') {
                        stakeInput.value = userWallet ? userWallet.coins : 0;
                    } else {
                        stakeInput.value = amount;
                    }
                    updatePotentialReturn();
                });
            });

            // Place Bet Button
            placeBetBtn.addEventListener('click', placeBet);

            // Clear Slip
            document.getElementById('clearSlip').addEventListener('click', () => {
                selectedBet = null;
                stakeInput.value = '';
                updateBetSlip();
                document.querySelectorAll('.bet-option.selected').forEach(el => {
                    el.classList.remove('selected');
                });
            });
        }

        // Initialize
        init();
    </script>

    <!-- Site Footer -->
    <div class="footer" include="./footer.html"></div>
</body>
</html>
