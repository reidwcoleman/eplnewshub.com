<!DOCTYPE html>
<html lang="en-GB">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TVPLGM5QY9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TVPLGM5QY9');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Predict Premier League match scores and compete on the global leaderboard. Premium prediction game with accurate statistics and real-time rankings.">
    <meta name="keywords" content="EPL predictor, Premier League predictions, football prediction game, match predictions, score predictor, leaderboard">
    <title>EPL Score Predictor - Premier League Prediction Game | EPL News Hub</title>

    <link rel="icon" type="image/png" href="/eplnewshubnewlogo.png">
    <link rel="stylesheet" href="/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            color: #121212;
            line-height: 1.6;
        }

        .predictor-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header Section - NYT Style */
        .predictor-header {
            max-width: 700px;
            margin: 0 auto 50px;
            padding: 40px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .predictor-title {
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 42px;
            font-weight: 700;
            color: #121212;
            margin-bottom: 15px;
            line-height: 1.2;
            letter-spacing: -0.5px;
        }

        .predictor-subtitle {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 18px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .user-section {
            border-top: 1px solid #e0e0e0;
            padding-top: 25px;
            margin-top: 25px;
        }

        .username-input-container {
            margin-bottom: 20px;
        }

        .username-input {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            padding: 12px 16px;
            border: 1px solid #d0d0d0;
            width: 100%;
            max-width: 300px;
            transition: border-color 0.2s;
        }

        .username-input:focus {
            outline: none;
            border-color: #121212;
        }

        .username-btn {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            font-weight: 600;
            padding: 12px 24px;
            background: #121212;
            color: #fff;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            transition: background 0.2s;
        }

        .username-btn:hover {
            background: #000;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .stat-box {
            border-left: 3px solid #121212;
            padding-left: 15px;
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 32px;
            font-weight: 700;
            color: #121212;
        }

        /* Navigation Tabs - Clean Style */
        .tabs-nav {
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 40px;
            display: flex;
            gap: 30px;
        }

        .tab-link {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            padding: 15px 0;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            background: none;
            border-left: none;
            border-right: none;
            border-top: none;
        }

        .tab-link:hover {
            color: #121212;
        }

        .tab-link.active {
            color: #121212;
            border-bottom-color: #121212;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .section-title {
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 32px;
            font-weight: 700;
            color: #121212;
            margin-bottom: 10px;
        }

        .section-description {
            font-size: 16px;
            color: #666;
            line-height: 1.6;
        }

        /* Match Cards - Clean Design */
        .matches-grid {
            display: grid;
            gap: 30px;
        }

        .match-card {
            border: 1px solid #e0e0e0;
            padding: 30px;
            transition: all 0.2s;
            background: #fff;
        }

        .match-card:hover {
            border-color: #121212;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .match-card.predicted {
            background: #f8f9fa;
            border-color: #28a745;
        }

        .match-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
            color: #666;
        }

        .match-badge {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            background: #121212;
            color: #fff;
            font-weight: 600;
        }

        .difficulty-hard { background: #dc3545; }
        .difficulty-medium { background: #ffc107; color: #000; }
        .difficulty-easy { background: #28a745; }

        .teams-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            align-items: center;
            margin-bottom: 25px;
        }

        .team-box {
            text-align: center;
        }

        .team-name {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #121212;
            margin-bottom: 15px;
        }

        .score-input {
            width: 70px;
            height: 60px;
            text-align: center;
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 28px;
            font-weight: 700;
            border: 2px solid #d0d0d0;
            background: #fff;
            transition: border-color 0.2s;
        }

        .score-input:focus {
            outline: none;
            border-color: #121212;
        }

        .vs-text {
            font-size: 14px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .match-actions {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .predict-btn {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            font-weight: 600;
            padding: 12px 30px;
            background: #121212;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .predict-btn:hover {
            background: #000;
        }

        .points-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            font-size: 13px;
            color: #666;
            border-left: 3px solid #121212;
        }

        /* Leaderboard - Professional Table */
        .leaderboard-table {
            border: 1px solid #e0e0e0;
        }

        .leaderboard-header,
        .leaderboard-row {
            display: grid;
            grid-template-columns: 60px 1fr 100px 100px 100px;
            gap: 15px;
            padding: 15px 20px;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .leaderboard-header {
            background: #f8f9fa;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            font-weight: 600;
        }

        .leaderboard-row:hover {
            background: #f8f9fa;
        }

        .leaderboard-row.current-user {
            background: #fffbea;
            font-weight: 600;
        }

        .rank-number {
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 18px;
            font-weight: 700;
            color: #121212;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        .player-name {
            font-size: 15px;
            color: #121212;
        }

        .stat-number {
            font-family: 'Noto Serif', Georgia, serif;
            font-size: 16px;
            font-weight: 600;
            color: #121212;
        }

        /* Achievements Grid */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .achievement-card {
            border: 1px solid #e0e0e0;
            padding: 25px;
            text-align: center;
            transition: all 0.2s;
        }

        .achievement-card.unlocked {
            background: #f0fff4;
            border-color: #28a745;
        }

        .achievement-card.locked {
            opacity: 0.5;
        }

        .achievement-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .achievement-name {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #121212;
            margin-bottom: 8px;
        }

        .achievement-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        /* Power-ups Section */
        .powerups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .powerup-card {
            border: 1px solid #e0e0e0;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .powerup-card:hover {
            border-color: #121212;
        }

        .powerup-card.active {
            background: #fffbea;
            border-color: #ffc107;
        }

        .powerup-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .powerup-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .powerup-cost {
            font-size: 13px;
            color: #666;
        }

        /* Results Display */
        .result-card {
            background: #f8f9fa;
            padding: 20px;
            margin-top: 20px;
            border-left: 3px solid #007bff;
        }

        .result-correct { border-left-color: #28a745; background: #f0fff4; }
        .result-wrong { border-left-color: #dc3545; background: #fff5f5; }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f0f0f0;
            border-top: 3px solid #121212;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #121212;
            color: #fff;
            padding: 15px 25px;
            font-size: 14px;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .predictor-title {
                font-size: 32px;
            }

            .teams-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .vs-text {
                display: none;
            }

            .leaderboard-header,
            .leaderboard-row {
                grid-template-columns: 50px 1fr 80px;
                font-size: 13px;
            }

            .leaderboard-row > :nth-child(4),
            .leaderboard-row > :nth-child(5) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header" include="./header.html"></div>

    <div class="predictor-container">
        <!-- Main Header -->
        <div class="predictor-header">
            <h1 class="predictor-title">Premier League Score Predictor</h1>
            <p class="predictor-subtitle">
                Predict match scores, compete on the global leaderboard, and track your accuracy.
                All statistics are calculated in real-time from actual user predictions.
            </p>

            <div class="user-section">
                <div class="username-input-container" id="usernameSection">
                    <input
                        type="text"
                        class="username-input"
                        id="usernameInput"
                        placeholder="Choose your username"
                        maxlength="20"
                    >
                    <button class="username-btn" onclick="PredictorGame.setUsername()">Save Username</button>
                    <p style="font-size: 13px; color: #999; margin-top: 8px;">Your username will appear on the leaderboard</p>
                </div>

                <div class="user-stats">
                    <div class="stat-box">
                        <div class="stat-label">Points</div>
                        <div class="stat-value" id="userPoints">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Rank</div>
                        <div class="stat-value" id="userRank">‚Äî</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Accuracy</div>
                        <div class="stat-value" id="userAccuracy">0%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Streak</div>
                        <div class="stat-value" id="userStreak">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="tabs-nav">
            <button class="tab-link active" onclick="PredictorGame.switchTab('predict')">Predict</button>
            <button class="tab-link" onclick="PredictorGame.switchTab('leaderboard')">Leaderboard</button>
            <button class="tab-link" onclick="PredictorGame.switchTab('achievements')">Achievements</button>
            <button class="tab-link" onclick="PredictorGame.switchTab('results')">Results</button>
            <button class="tab-link" onclick="PredictorGame.switchTab('guide')">How to Play</button>
        </nav>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>Loading Premier League fixtures...</p>
        </div>

        <!-- Predict Tab -->
        <div id="predict" class="content-section active" style="display:none;">
            <!-- Power-ups -->
            <div class="section-header">
                <h2 class="section-title">Power-ups</h2>
                <p class="section-description">Enhance your predictions with special abilities</p>
            </div>

            <div class="powerups-grid">
                <div class="powerup-card" onclick="PredictorGame.activatePowerup('double')">
                    <div class="powerup-icon">2√ó</div>
                    <div class="powerup-name">Double Points</div>
                    <div class="powerup-cost">Cost: 50 points</div>
                </div>
                <div class="powerup-card" onclick="PredictorGame.activatePowerup('streak')">
                    <div class="powerup-icon">üõ°Ô∏è</div>
                    <div class="powerup-name">Streak Saver</div>
                    <div class="powerup-cost">Cost: 100 points</div>
                </div>
                <div class="powerup-card" onclick="PredictorGame.activatePowerup('hint')">
                    <div class="powerup-icon">üí°</div>
                    <div class="powerup-name">Hint</div>
                    <div class="powerup-cost">Cost: 30 points</div>
                </div>
            </div>

            <div class="section-header">
                <h2 class="section-title">Upcoming Matches</h2>
                <p class="section-description">Make your predictions before kickoff</p>
            </div>

            <div class="matches-grid" id="upcomingMatches"></div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboard" class="content-section">
            <div class="section-header">
                <h2 class="section-title">Global Leaderboard</h2>
                <p class="section-description">Real-time rankings based on actual user predictions</p>
            </div>

            <div class="leaderboard-table">
                <div class="leaderboard-header">
                    <div>Rank</div>
                    <div>Player</div>
                    <div>Points</div>
                    <div>Streak</div>
                    <div>Accuracy</div>
                </div>
                <div id="leaderboardBody"></div>
            </div>
        </div>

        <!-- Achievements Tab -->
        <div id="achievements" class="content-section">
            <div class="section-header">
                <h2 class="section-title">Achievements</h2>
                <p class="section-description">Unlock badges by reaching milestones</p>
            </div>

            <div class="achievements-grid" id="achievementsGrid"></div>
        </div>

        <!-- Results Tab -->
        <div id="results" class="content-section">
            <div class="section-header">
                <h2 class="section-title">Recent Results</h2>
                <p class="section-description">See how your predictions scored</p>
            </div>

            <div class="matches-grid" id="resultsMatches"></div>
        </div>

        <!-- Guide Tab -->
        <div id="guide" class="content-section">
            <div class="section-header">
                <h2 class="section-title">How to Play</h2>
            </div>

            <div style="max-width: 700px; margin: 0 auto;">
                <h3 style="font-size: 20px; margin: 30px 0 15px; font-weight: 600;">Scoring System</h3>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>10 points</strong> ‚Äî Exact score prediction
                    </li>
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>7 points</strong> ‚Äî Correct result + goal difference
                    </li>
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>5 points</strong> ‚Äî Correct result only
                    </li>
                </ul>

                <h3 style="font-size: 20px; margin: 30px 0 15px; font-weight: 600;">Difficulty Multipliers</h3>
                <p style="color: #666; line-height: 1.6; margin-bottom: 10px;">
                    Match difficulty affects points earned:
                </p>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>Hard</strong> ‚Äî 1.5√ó points (top team clashes)
                    </li>
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>Medium</strong> ‚Äî 1.2√ó points (mixed matchups)
                    </li>
                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                        <strong>Easy</strong> ‚Äî 1√ó points (standard matches)
                    </li>
                </ul>

                <h3 style="font-size: 20px; margin: 30px 0 15px; font-weight: 600;">Streaks & Bonuses</h3>
                <p style="color: #666; line-height: 1.6;">
                    Build a streak by making consecutive correct predictions. Earn bonus points:
                    3+ streak (+2 pts), 5+ streak (+5 pts), 10+ streak (+10 pts).
                </p>

                <h3 style="font-size: 20px; margin: 30px 0 15px; font-weight: 600;">Power-ups</h3>
                <p style="color: #666; line-height: 1.6;">
                    Purchase power-ups with your earned points to boost your predictions.
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer" include="./footer.html"></div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Scripts -->
    <script src="/index.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBXOcs8TGk_vZ8uQmYxJ7P5RZxTJ5tKxRg",
            authDomain: "epl-predictor-9cf44.firebaseapp.com",
            databaseURL: "https://epl-predictor-9cf44-default-rtdb.firebaseio.com",
            projectId: "epl-predictor-9cf44",
            storageBucket: "epl-predictor-9cf44.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const PredictorGame = {
            fixtures: [],
            predictions: {},
            userStats: {
                username: '',
                userId: '',
                totalPoints: 0,
                level: 1,
                streak: 0,
                longestStreak: 0,
                totalPredictions: 0,
                correctPredictions: 0,
                exactScores: 0,
                achievements: [],
                activePowerup: null,
                streakSaverActive: false
            },
            leaderboardData: [],
            currentSeason: '2025-2026',
            leagueId: 4328,
            achievements: [
                { id: 'first_prediction', name: 'First Steps', desc: 'Make your first prediction', icon: 'üéØ' },
                { id: 'exact_score_1', name: 'Sharpshooter', desc: 'Get 1 exact score', icon: 'üéØ' },
                { id: 'exact_score_5', name: 'Marksman', desc: 'Get 5 exact scores', icon: 'üèπ' },
                { id: 'exact_score_10', name: 'Sniper Elite', desc: 'Get 10 exact scores', icon: 'üéñÔ∏è' },
                { id: 'streak_3', name: 'Hot Streak', desc: 'Reach a 3-prediction streak', icon: 'üî•' },
                { id: 'streak_5', name: 'On Fire', desc: 'Reach a 5-prediction streak', icon: 'üî•üî•' },
                { id: 'streak_10', name: 'Unstoppable', desc: 'Reach a 10-prediction streak', icon: 'üî•üî•üî•' },
                { id: 'points_100', name: 'Century', desc: 'Earn 100 total points', icon: 'üíØ' },
                { id: 'points_500', name: 'High Roller', desc: 'Earn 500 total points', icon: 'üíé' },
                { id: 'points_1000', name: 'Legend', desc: 'Earn 1000 total points', icon: 'üëë' },
                { id: 'level_5', name: 'Rising Star', desc: 'Reach level 5', icon: 'üåü' },
                { id: 'level_10', name: 'Veteran', desc: 'Reach level 10', icon: '‚ö°' }
            ],

            async init() {
                this.loadUserData();
                await this.fetchFixtures();
                this.updateStatsDisplay();
                this.renderAchievements();
                this.loadLeaderboard();
                this.showSection('predict');
            },

            loadUserData() {
                const saved = localStorage.getItem('eplPredictorUserData');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.predictions = data.predictions || {};
                    this.userStats = { ...this.userStats, ...data.stats };

                    if (this.userStats.username) {
                        document.getElementById('usernameInput').value = this.userStats.username;
                        document.getElementById('usernameSection').innerHTML = `
                            <p style="font-size: 16px; color: #121212; font-weight: 600;">Welcome back, ${this.userStats.username}!</p>
                        `;
                    }
                }

                if (!this.userStats.userId) {
                    this.userStats.userId = 'user_' + Math.random().toString(36).substr(2, 9);
                }
            },

            saveUserData() {
                const data = {
                    predictions: this.predictions,
                    stats: this.userStats,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('eplPredictorUserData', JSON.stringify(data));
            },

            setUsername() {
                const username = document.getElementById('usernameInput').value.trim();
                if (!username) {
                    this.showToast('Please enter a username', 'error');
                    return;
                }

                if (username.length < 3) {
                    this.showToast('Username must be at least 3 characters', 'error');
                    return;
                }

                this.userStats.username = username;
                this.saveUserData();
                this.syncToFirebase();

                document.getElementById('usernameSection').innerHTML = `
                    <p style="font-size: 16px; color: #121212; font-weight: 600;">Welcome, ${username}!</p>
                `;

                this.showToast('Username saved successfully!', 'success');
            },

            async syncToFirebase() {
                if (!this.userStats.username) return;

                const userRef = database.ref('users/' + this.userStats.userId);
                await userRef.set({
                    username: this.userStats.username,
                    totalPoints: this.userStats.totalPoints,
                    streak: this.userStats.streak,
                    totalPredictions: this.userStats.totalPredictions,
                    correctPredictions: this.userStats.correctPredictions,
                    accuracy: this.userStats.totalPredictions > 0 ?
                        Math.round((this.userStats.correctPredictions / this.userStats.totalPredictions) * 100) : 0,
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
            },

            async loadLeaderboard() {
                const usersRef = database.ref('users').orderByChild('totalPoints').limitToLast(100);

                usersRef.on('value', (snapshot) => {
                    const users = [];
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        users.push({
                            userId: childSnapshot.key,
                            username: userData.username,
                            totalPoints: userData.totalPoints || 0,
                            streak: userData.streak || 0,
                            accuracy: userData.accuracy || 0,
                            predictions: userData.totalPredictions || 0
                        });
                    });

                    users.sort((a, b) => b.totalPoints - a.totalPoints);
                    this.leaderboardData = users;
                    this.renderLeaderboard();
                    this.updateUserRank();
                });
            },

            updateUserRank() {
                const userRank = this.leaderboardData.findIndex(u => u.userId === this.userStats.userId) + 1;
                document.getElementById('userRank').textContent = userRank > 0 ? `#${userRank}` : '‚Äî';
            },

            renderLeaderboard() {
                const container = document.getElementById('leaderboardBody');

                if (this.leaderboardData.length === 0) {
                    container.innerHTML = '<div style="padding: 40px; text-align: center; color: #666;">No players yet. Be the first!</div>';
                    return;
                }

                container.innerHTML = this.leaderboardData.slice(0, 50).map((player, index) => {
                    const rank = index + 1;
                    const isCurrentUser = player.userId === this.userStats.userId;

                    return `
                        <div class="leaderboard-row ${isCurrentUser ? 'current-user' : ''}">
                            <div class="rank-number rank-${rank}">${rank}</div>
                            <div class="player-name">${player.username}${isCurrentUser ? ' (You)' : ''}</div>
                            <div class="stat-number">${player.totalPoints}</div>
                            <div class="stat-number">${player.streak > 0 ? 'üî• ' + player.streak : '‚Äî'}</div>
                            <div class="stat-number">${player.accuracy}%</div>
                        </div>
                    `;
                }).join('');
            },

            async fetchFixtures() {
                try {
                    document.getElementById('loadingState').style.display = 'block';

                    const response = await fetch(
                        `https://www.thesportsdb.com/api/v1/json/3/eventsseason.php?id=${this.leagueId}&s=${this.currentSeason}`
                    );
                    const data = await response.json();

                    if (data.events) {
                        this.fixtures = data.events
                            .map(event => this.parseEvent(event))
                            .sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

                        this.calculateAllPoints();
                        this.renderUpcoming();
                        this.renderResults();

                        document.getElementById('loadingState').style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.showToast('Error loading fixtures', 'error');
                }
            },

            parseEvent(event) {
                return {
                    id: event.idEvent,
                    homeTeam: event.strHomeTeam,
                    awayTeam: event.strAwayTeam,
                    homeScore: event.intHomeScore ? parseInt(event.intHomeScore) : null,
                    awayScore: event.intAwayScore ? parseInt(event.intAwayScore) : null,
                    dateTime: event.strTimestamp || `${event.dateEvent} ${event.strTime}`,
                    status: event.strStatus,
                    round: event.intRound,
                    difficulty: this.calculateDifficulty(event.strHomeTeam, event.strAwayTeam)
                };
            },

            calculateDifficulty(homeTeam, awayTeam) {
                const topTeams = ['Arsenal', 'Manchester City', 'Liverpool', 'Chelsea', 'Manchester United', 'Tottenham'];
                const isHomeTop = topTeams.includes(homeTeam);
                const isAwayTop = topTeams.includes(awayTeam);

                if (isHomeTop && isAwayTop) return 'hard';
                if (isHomeTop || isAwayTop) return 'medium';
                return 'easy';
            },

            getDifficultyMultiplier(difficulty) {
                return difficulty === 'hard' ? 1.5 : difficulty === 'medium' ? 1.2 : 1;
            },

            isUpcoming(match) {
                const matchDate = new Date(match.dateTime);
                const now = new Date();
                return matchDate > now && match.homeScore === null;
            },

            isFinished(match) {
                return match.homeScore !== null && match.awayScore !== null;
            },

            renderUpcoming() {
                const container = document.getElementById('upcomingMatches');
                const upcoming = this.fixtures.filter(m => this.isUpcoming(m)).slice(0, 20);

                if (upcoming.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No upcoming matches</p>';
                    return;
                }

                container.innerHTML = upcoming.map(match => {
                    const prediction = this.predictions[match.id];
                    const hasPrediction = prediction && prediction.homeScore !== undefined;
                    const multiplier = this.getDifficultyMultiplier(match.difficulty);

                    return `
                        <div class="match-card ${hasPrediction ? 'predicted' : ''}">
                            <div class="match-info">
                                <span>${new Date(match.dateTime).toLocaleDateString('en-GB', {
                                    weekday: 'short',
                                    day: 'numeric',
                                    month: 'short',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}</span>
                                <span class="match-badge difficulty-${match.difficulty}">
                                    ${match.difficulty} ${multiplier}√ó
                                </span>
                            </div>

                            <div class="teams-row">
                                <div class="team-box">
                                    <div class="team-name">${match.homeTeam}</div>
                                    <input
                                        type="number"
                                        class="score-input"
                                        id="home_${match.id}"
                                        min="0"
                                        max="10"
                                        value="${prediction?.homeScore ?? ''}"
                                        placeholder="‚Äî"
                                    >
                                </div>

                                <div class="vs-text">vs</div>

                                <div class="team-box">
                                    <div class="team-name">${match.awayTeam}</div>
                                    <input
                                        type="number"
                                        class="score-input"
                                        id="away_${match.id}"
                                        min="0"
                                        max="10"
                                        value="${prediction?.awayScore ?? ''}"
                                        placeholder="‚Äî"
                                    >
                                </div>
                            </div>

                            <div class="match-actions">
                                <button class="predict-btn" onclick="PredictorGame.savePrediction('${match.id}', '${match.difficulty}')">
                                    ${hasPrediction ? 'Update Prediction' : 'Save Prediction'}
                                </button>

                                <div class="points-info">
                                    <strong>Potential:</strong>
                                    Exact ${Math.round(10 * multiplier)}pts,
                                    Result+GD ${Math.round(7 * multiplier)}pts,
                                    Result ${Math.round(5 * multiplier)}pts
                                    ${this.userStats.streak >= 3 ? ` + ${this.getStreakBonus()} streak bonus` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            getStreakBonus() {
                const streak = this.userStats.streak;
                if (streak >= 10) return 10;
                if (streak >= 5) return 5;
                if (streak >= 3) return 2;
                return 0;
            },

            savePrediction(matchId, difficulty) {
                if (!this.userStats.username) {
                    this.showToast('Please set a username first', 'error');
                    return;
                }

                const homeInput = document.getElementById(`home_${matchId}`);
                const awayInput = document.getElementById(`away_${matchId}`);

                const homeScore = parseInt(homeInput.value);
                const awayScore = parseInt(awayInput.value);

                if (isNaN(homeScore) || isNaN(awayScore) || homeScore < 0 || awayScore < 0) {
                    this.showToast('Please enter valid scores', 'error');
                    return;
                }

                this.predictions[matchId] = {
                    homeScore,
                    awayScore,
                    difficulty,
                    timestamp: new Date().toISOString(),
                    doublePowerup: this.userStats.activePowerup === 'double'
                };

                if (this.userStats.activePowerup === 'double') {
                    this.userStats.activePowerup = null;
                }

                this.userStats.totalPredictions++;
                this.saveUserData();
                this.syncToFirebase();
                this.renderUpcoming();
                this.checkAchievements();

                this.showToast('Prediction saved!', 'success');
            },

            calculatePoints(prediction, actual) {
                if (!prediction || actual.homeScore === null) return 0;

                let basePoints = 0;
                const predHome = prediction.homeScore;
                const predAway = prediction.awayScore;
                const actHome = actual.homeScore;
                const actAway = actual.awayScore;

                if (predHome === actHome && predAway === actAway) {
                    basePoints = 10;
                } else {
                    const predGD = predHome - predAway;
                    const actGD = actHome - actAway;
                    const predResult = predGD > 0 ? 'H' : predGD < 0 ? 'A' : 'D';
                    const actResult = actGD > 0 ? 'H' : actGD < 0 ? 'A' : 'D';

                    if (predResult === actResult && predGD === actGD) {
                        basePoints = 7;
                    } else if (predResult === actResult) {
                        basePoints = 5;
                    }
                }

                const multiplier = this.getDifficultyMultiplier(prediction.difficulty || 'easy');
                let finalPoints = Math.round(basePoints * multiplier);

                if (basePoints > 0) {
                    finalPoints += this.getStreakBonus();
                }

                if (prediction.doublePowerup) {
                    finalPoints *= 2;
                }

                return finalPoints;
            },

            calculateAllPoints() {
                let totalPoints = 0;
                let exactScores = 0;
                let correctPredictions = 0;
                let currentStreak = 0;
                let incorrectHappened = false;

                this.fixtures.forEach(match => {
                    if (this.isFinished(match) && this.predictions[match.id]) {
                        const points = this.calculatePoints(this.predictions[match.id], match);
                        this.predictions[match.id].points = points;

                        totalPoints += points;
                        if (points >= 10) exactScores++;
                        if (points > 0) {
                            correctPredictions++;
                            if (!incorrectHappened) currentStreak++;
                        } else {
                            incorrectHappened = true;
                        }
                    }
                });

                this.userStats.totalPoints = totalPoints;
                this.userStats.exactScores = exactScores;
                this.userStats.correctPredictions = correctPredictions;
                this.userStats.streak = currentStreak;
                if (currentStreak > this.userStats.longestStreak) {
                    this.userStats.longestStreak = currentStreak;
                }

                this.userStats.level = Math.floor(totalPoints / 100) + 1;

                this.saveUserData();
                this.syncToFirebase();
            },

            renderResults() {
                const container = document.getElementById('resultsMatches');
                const finished = this.fixtures
                    .filter(m => this.isFinished(m))
                    .sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime))
                    .slice(0, 30);

                if (finished.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666;">No results yet</p>';
                    return;
                }

                container.innerHTML = finished.map(match => {
                    const prediction = this.predictions[match.id];
                    const points = prediction?.points || 0;

                    return `
                        <div class="match-card">
                            <div class="match-info">
                                <span>${new Date(match.dateTime).toLocaleDateString('en-GB', {
                                    weekday: 'short',
                                    day: 'numeric',
                                    month: 'short'
                                })}</span>
                                <span class="match-badge">Final</span>
                            </div>

                            <div style="text-align: center; margin: 20px 0;">
                                <div style="font-size: 20px; font-weight: 600; margin-bottom: 10px;">
                                    ${match.homeTeam} ${match.homeScore}‚Äì${match.awayScore} ${match.awayTeam}
                                </div>
                            </div>

                            ${prediction ? `
                                <div class="result-card ${points > 0 ? 'result-correct' : 'result-wrong'}">
                                    <strong>Your Prediction:</strong> ${prediction.homeScore}‚Äì${prediction.awayScore}<br>
                                    <strong>Points Earned:</strong> ${points}
                                    ${points >= 10 ? ' (Exact Score!)' : points >= 7 ? ' (Result + GD)' : points >= 5 ? ' (Correct Result)' : ''}
                                </div>
                            ` : `
                                <div class="result-card">No prediction made</div>
                            `}
                        </div>
                    `;
                }).join('');
            },

            renderAchievements() {
                const container = document.getElementById('achievementsGrid');

                container.innerHTML = this.achievements.map(ach => {
                    const unlocked = this.userStats.achievements.includes(ach.id);

                    return `
                        <div class="achievement-card ${unlocked ? 'unlocked' : 'locked'}">
                            <div class="achievement-icon">${ach.icon}</div>
                            <div class="achievement-name">${ach.name}</div>
                            <div class="achievement-desc">${ach.desc}</div>
                            ${unlocked ? '<div style="margin-top: 10px; color: #28a745; font-weight: 600;">‚úì Unlocked</div>' : ''}
                        </div>
                    `;
                }).join('');
            },

            checkAchievements() {
                const newAchievements = [];

                this.achievements.forEach(ach => {
                    if (!this.userStats.achievements.includes(ach.id)) {
                        let unlocked = false;

                        switch(ach.id) {
                            case 'first_prediction':
                                unlocked = this.userStats.totalPredictions >= 1;
                                break;
                            case 'exact_score_1':
                                unlocked = this.userStats.exactScores >= 1;
                                break;
                            case 'exact_score_5':
                                unlocked = this.userStats.exactScores >= 5;
                                break;
                            case 'exact_score_10':
                                unlocked = this.userStats.exactScores >= 10;
                                break;
                            case 'streak_3':
                                unlocked = this.userStats.longestStreak >= 3;
                                break;
                            case 'streak_5':
                                unlocked = this.userStats.longestStreak >= 5;
                                break;
                            case 'streak_10':
                                unlocked = this.userStats.longestStreak >= 10;
                                break;
                            case 'points_100':
                                unlocked = this.userStats.totalPoints >= 100;
                                break;
                            case 'points_500':
                                unlocked = this.userStats.totalPoints >= 500;
                                break;
                            case 'points_1000':
                                unlocked = this.userStats.totalPoints >= 1000;
                                break;
                            case 'level_5':
                                unlocked = this.userStats.level >= 5;
                                break;
                            case 'level_10':
                                unlocked = this.userStats.level >= 10;
                                break;
                        }

                        if (unlocked) {
                            this.userStats.achievements.push(ach.id);
                            newAchievements.push(ach);
                        }
                    }
                });

                if (newAchievements.length > 0) {
                    newAchievements.forEach(ach => {
                        this.showToast(`Achievement Unlocked: ${ach.name}!`, 'success');
                    });
                    this.saveUserData();
                    this.renderAchievements();
                }
            },

            activatePowerup(type) {
                const costs = { double: 50, streak: 100, hint: 30 };
                const cost = costs[type];

                if (this.userStats.totalPoints < cost) {
                    this.showToast(`Need ${cost} points`, 'error');
                    return;
                }

                if (type === 'double') {
                    this.userStats.totalPoints -= cost;
                    this.userStats.activePowerup = 'double';
                    this.showToast('Double Points activated!', 'success');
                } else if (type === 'streak') {
                    this.userStats.totalPoints -= cost;
                    this.userStats.streakSaverActive = true;
                    this.showToast('Streak Saver activated!', 'success');
                } else if (type === 'hint') {
                    this.showToast('Check recent form and head-to-head records', 'success');
                }

                this.saveUserData();
                this.syncToFirebase();
                this.updateStatsDisplay();
            },

            updateStatsDisplay() {
                document.getElementById('userPoints').textContent = this.userStats.totalPoints;
                document.getElementById('userStreak').textContent = this.userStats.streak;

                const totalFinished = Object.keys(this.predictions).filter(id =>
                    this.predictions[id].points !== undefined
                ).length;
                const accuracy = totalFinished > 0 ?
                    Math.round((this.userStats.correctPredictions / totalFinished) * 100) : 0;
                document.getElementById('userAccuracy').textContent = accuracy + '%';
            },

            switchTab(tabName) {
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });

                document.querySelectorAll('.tab-link').forEach(btn => {
                    btn.classList.remove('active');
                });

                document.getElementById(tabName).classList.add('active');
                document.getElementById(tabName).style.display = 'block';
                event.target.classList.add('active');
            },

            showSection(section) {
                document.getElementById(section).style.display = 'block';
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.style.display = 'block';

                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            PredictorGame.init();
        });
    </script>
</body>
</html>
